<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樣品請購簽呈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        /* 隱藏移除按鈕，直到滑鼠懸停在品項列上或有超過一行 */
        .budgetItemRow:hover .removeBudgetItemBtn {
            opacity: 1;
        }
        /* 讓移除按鈕預設透明，在 JavaScript 中控制實際顯示邏輯 */
        .removeBudgetItemBtn {
            opacity: 1; /* 預設顯示，讓使用者知道可以移除 */
        }
        
        /* 針對列印時的樣式調整 */
        @media print {
            /* 隱藏所有非列印內容，只顯示 documentToPrint */
            body > *:not(.documentToPrint) {
                display: none !important;
            }
            .documentToPrint {
                display: block !important;
                margin: 0;
                padding: 0;
                box-shadow: none; /* 移除陰影 */
                width: 100%; /* 佔滿紙張寬度 */
            }
            /* 調整字體大小和邊距以適應列印 */
            .documentToPrint h1 { font-size: 20pt; }
            .documentToPrint h3 { font-size: 14pt; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
            .documentToPrint p, .documentToPrint li, .documentToPrint table { font-size: 10pt; }
            .budget-table, .plan-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .budget-table th, .budget-table td, .plan-table th, .plan-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .budget-table tfoot td { font-weight: bold; }
            /* 移除不需要的元素，例如簽核欄 */
            .documentToPrint .print-remove {
                display: none !important;
            }
        }
        
        /* 建立一個隱藏的容器，用於儲存列印內容 */
        .documentToPrint {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 測試按鈕樣式 */
        #fillTestDataBtn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            line-height: 50px;
            text-align: center;
            z-index: 40;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">樣品請購簽呈</h1>
            <p class="text-gray-500">請填寫詳細的樣品資訊、目的與使用計畫。</p>
        </header>

        <form id="purchaseForm" class="space-y-6">

            <section class="border-b pb-6">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">一、簽呈說明</h2>
                
                <div>
                    <label for="sampleName" class="block text-sm font-medium text-gray-700 mb-1">主旨 (樣品名稱/型號) <span class="text-red-500">*</span></label>
                    <input type="text" id="sampleName" name="sampleName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out" placeholder="例如：申請購買 [供應商] 的 [產品名稱] 樣品">
                </div>

                <div>
                    <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">目的 (為何需要購買此樣品？) <span class="text-red-500">*</span></label>
                    <textarea id="purpose" name="purpose" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm resize-y" placeholder="例如：用於競品拆解分析，研究其散熱結構與材料，以確定產品方向。"></textarea>
                </div>

                <div class="mt-6">
                    <h3 class="block text-sm font-medium text-gray-700 mb-2">使用計畫 (請依步驟列出) <span class="text-red-500">*</span></h3>
                    
                    <div class="grid grid-cols-12 gap-2 text-xs md:text-sm font-semibold text-gray-600 mb-1">
                        <div class="col-span-9">計畫/內容 </div>
                        <div class="col-span-2">負責人 </div>
                        <div class="col-span-1"></div>
                    </div>
                    
                    <div id="usagePlanContainer" class="space-y-2">
                        <div class="planRow flex space-x-2 items-center">
                            <input type="text" name="planDetails" required class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out" placeholder="例如：功能測試與性能評估">
                            <input type="text" name="planResponsible" required class="w-1/5 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="姓名">
                            <button type="button" class="removePlanRowBtn text-red-500 hover:text-red-700 p-1 rounded-full" aria-label="移除計畫">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" id="addPlanRowBtn" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        新增使用計畫項目
                    </button>
                </div>
            </section>

            <section class="pb-6">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">二、請購清單</h2>

                <div class="grid grid-cols-12 gap-4 text-xs md:text-sm font-semibold text-gray-600 mb-2">
                    <div class="col-span-4">品項/型號 <span class="text-red-500">*</span></div>
                    <div class="col-span-4">連結</div>
                    <div class="col-span-2">單價 (NT$) <span class="text-red-500">*</span></div>
                    <div class="col-span-1">數量 <span class="text-red-500">*</span></div>
                    <div class="col-span-1"></div>
                </div>
                
                <div id="budgetItemsContainer" class="space-y-3">
                    <div class="budgetItemRow grid grid-cols-12 gap-4 items-center">
                        <input type="text" name="itemName" required class="col-span-4 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="產品名稱或型號">
                        
                        <div class="col-span-4 flex items-center h-full link-container">
                            <input type="hidden" name="itemLink" value="">
                            </div>

                        <input type="number" name="itemPrice" required min="0" step="1" class="itemPrice col-span-2 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="單價">
                        <input type="number" name="itemQuantity" required min="1" class="itemQuantity col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" value="1">
                        <button type="button" class="removeBudgetItemBtn col-span-1 text-red-500 hover:text-red-700 p-1 rounded-full" aria-label="移除品項">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </div>
                </div>
                
                <button type="button" id="addBudgetItemBtn" class="mt-4 text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    新增品項
                </button>

                <div class="flex justify-end pt-4 mt-6 border-t border-gray-200">
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-700">總金額 (新台幣)</p>
                        <p id="totalAmount" class="text-3xl font-bold text-indigo-700 mt-1">0.00</p>
                    </div>
                </div>
            </section>

            <div class="pt-4 flex justify-end space-x-4">
                <button type="button" id="convertToTextBtn" class="w-full sm:w-auto px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    轉文字說明
                </button>
                <button type="submit" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    提交轉為PDF
                </button>
            </div>
            
            <div id="messageBox" class="hidden mt-6 p-4 rounded-lg bg-green-100 border border-green-300 text-green-700" role="alert">
                <p class="font-medium">✅ 簽呈已整理完成！</p>
                <p id="submissionDetails" class="text-sm mt-1"></p>
                <p class="text-xs mt-2 font-bold">請在彈出的列印視窗中，將目標設定為「另存為 PDF」，即可選擇儲存位置。</p>
            </div>

        </form>
    </div>
    
    <div id="documentToPrint" class="documentToPrint bg-white p-8"></div>
    
    <div id="textModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">簽呈文字說明 (可複製)</h3>
            <textarea id="textOutputArea" rows="15" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm resize-none cursor-text select-all" onclick="this.select()"></textarea>
            
            <div class="mt-4 flex justify-end space-x-3">
                <button id="copyTextBtn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                    複製文字
                </button>
                <button id="closeTextModalBtn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <button id="fillTestDataBtn" class="rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150">
        T
    </button>


    <script>
        // 幫助數字格式化成千分位 (移除小數點)
        const formatNumber = (num) => {
            // 確保數字四捨五入到整數，並使用千分位格式化
            return Math.round(parseFloat(num) || 0).toLocaleString('en-US');
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('purchaseForm');
            const totalAmountDisplay = document.getElementById('totalAmount');
            const messageBox = document.getElementById('messageBox');
            const submissionDetails = document.getElementById('submissionDetails');
            const budgetItemsContainer = document.getElementById('budgetItemsContainer');
            const usagePlanContainer = document.getElementById('usagePlanContainer');
            const documentToPrint = document.getElementById('documentToPrint');
            
            // Modal Elements
            const convertToTextBtn = document.getElementById('convertToTextBtn');
            const textModal = document.getElementById('textModal');
            const textOutputArea = document.getElementById('textOutputArea');
            const closeTextModalBtn = document.getElementById('closeTextModalBtn');
            const copyTextBtn = document.getElementById('copyTextBtn');

            // Test Button Element
            const fillTestDataBtn = document.getElementById('fillTestDataBtn');


            // --- 1. 動態計算總金額的函數 ---
            const calculateTotal = () => {
                let total = 0;
                document.querySelectorAll('#budgetItemsContainer .budgetItemRow').forEach(row => {
                    const priceInput = row.querySelector('.itemPrice');
                    const quantityInput = row.querySelector('.itemQuantity');
                    const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                    const quantity = parseInt(quantityInput ? quantityInput.value : 0, 10) || 0;
                    total += price * quantity;
                });
                totalAmountDisplay.textContent = formatNumber(total);
            };

            // --- 2. 預計花費品項操作 ---
            
            // 建立一個新的品項 HTML 結構
            const createBudgetItemRow = (name = '', price = '', quantity = 1, link = '') => {
                const newItemRow = document.createElement('div');
                newItemRow.className = 'budgetItemRow grid grid-cols-12 gap-4 items-center';
                newItemRow.innerHTML = `
                    <input type="text" name="itemName" required class="col-span-4 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="產品名稱或型號" value="${name}">
                    
                    <div class="col-span-4 flex items-center h-full link-container">
                         <input type="hidden" name="itemLink" value="${link}">
                    </div>

                    <input type="number" name="itemPrice" required min="0" step="1" class="itemPrice col-span-2 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="單價" value="${price}">
                    <input type="number" name="itemQuantity" required min="1" class="itemQuantity col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" value="${quantity}">
                    <button type="button" class="removeBudgetItemBtn col-span-1 text-red-500 hover:text-red-700 p-1 rounded-full" aria-label="移除品項">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                `;
                return newItemRow;
            };
            
            // 【已修正】僅負責更新連結按鈕區塊的顯示樣式
            const handleLinkInsertion = (container) => {
                const hiddenInput = container.querySelector('[name="itemLink"]');
                const currentLink = hiddenInput ? hiddenInput.value.trim() : '';

                // 清空容器，只留下隱藏的 input 標籤
                container.innerHTML = `<input type="hidden" name="itemLink" value="${currentLink}">`;
                
                let displayHTML = '';
                if (currentLink) {
                    // 如果有連結，顯示可點擊的連結圖示和編輯按鈕
                    displayHTML = `
                        <div class="w-full h-full flex items-center justify-between text-sm">
                            <a href="${currentLink}" target="_blank" class="text-indigo-600 font-medium truncate py-2 hover:underline" title="點擊以在新分頁開啟：${currentLink}">
                                ➤ 檢視連結
                            </a>
                            <button type="button" class="editLinkBtn text-gray-500 hover:text-gray-700 p-1" aria-label="編輯連結">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                    `;
                } else {
                    // 如果沒有連結，顯示「插入連結」按鈕
                    displayHTML = `
                        <button type="button" class="insertLinkBtn w-full py-2 bg-gray-100 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-200 transition duration-150">插入連結</button>
                    `;
                }
                container.insertAdjacentHTML('beforeend', displayHTML);
            };

            // 【已還原】新增品項的函式
            const addBudgetItem = (name, price, quantity, link) => {
                const newRow = createBudgetItemRow(name, price, quantity, link);
                budgetItemsContainer.appendChild(newRow);
                // 確保新行中的連結顯示正確
                const newLinkContainer = newRow.querySelector('.link-container');
                if (newLinkContainer) {
                    handleLinkInsertion(newLinkContainer);
                }
                calculateTotal();
            };

            // 【已還原】移除品項的函式
            const removeBudgetItem = (button) => {
                // 確保至少保留一個品項
                if (budgetItemsContainer.children.length > 1) {
                    button.closest('.budgetItemRow').remove();
                    calculateTotal();
                } else {
                    alert('至少需要保留一個品項。');
                }
            };
            
            // 【已還原】「新增品項」按鈕的事件監聽
            document.getElementById('addBudgetItemBtn').addEventListener('click', () => addBudgetItem());

            // 【已修正】使用單一事件委派監聽器處理所有「預計花費」區塊內的點擊事件
            budgetItemsContainer.addEventListener('click', (event) => {
                const target = event.target;

                // 情況 1：點擊了「移除品項」按鈕
                const removeBtn = target.closest('.removeBudgetItemBtn');
                if (removeBtn) {
                    removeBudgetItem(removeBtn);
                    return; // 結束，避免執行後續邏輯
                }

                // 情況 2：點擊了連結容器內的「插入」或「編輯」按鈕
                const linkContainer = target.closest('.link-container');
                if (linkContainer) {
                    const hiddenInput = linkContainer.querySelector('[name="itemLink"]');
                    const isInsert = target.closest('.insertLinkBtn');
                    const isEdit = target.closest('.editLinkBtn');
                    
                    if (isInsert || isEdit) {
                        const currentLink = hiddenInput.value || '';
                        // 提示使用者輸入連結，並將現有連結作為預設值 (方便編輯)
                        const newLink = prompt('請貼上或輸入選購連結 (URL):', currentLink);

                        // 只有當使用者按下「確認」(newLink 不是 null) 時才更新
                        if (newLink !== null) {
                            hiddenInput.value = newLink.trim();
                            handleLinkInsertion(linkContainer); // 更新UI顯示
                        }
                    }
                }
            });

            // 【已還原】監聽單價或數量的變化以即時更新總金額
            budgetItemsContainer.addEventListener('input', (event) => {
                if (event.target.classList.contains('itemPrice') || event.target.classList.contains('itemQuantity')) {
                    calculateTotal();
                }
            });

            // --- 3. 使用計畫項目操作 ---
            
            const createPlanRow = (details = '', responsible = '') => {
                const newPlanRow = document.createElement('div');
                newPlanRow.className = 'planRow flex space-x-2 items-center';
                newPlanRow.innerHTML = `
                    <input type="text" name="planDetails" required class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out" placeholder="例如：功能測試與性能評估" value="${details}">
                    <input type="text" name="planResponsible" required class="w-1/5 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="姓名" value="${responsible}">
                    <button type="button" class="removePlanRowBtn text-red-500 hover:text-red-700 p-1 rounded-full" aria-label="移除計畫">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                `;
                return newPlanRow;
            };

            const addPlanRow = (details, responsible) => {
                usagePlanContainer.appendChild(createPlanRow(details, responsible));
            };

            const removePlanRow = (button) => {
                if (usagePlanContainer.children.length > 1) {
                    button.closest('.planRow').remove();
                } else {
                    console.error('至少需要保留一項使用計畫。');
                }
            };

            document.getElementById('addPlanRowBtn').addEventListener('click', () => addPlanRow());
            
            usagePlanContainer.addEventListener('click', (event) => {
                const removeBtn = event.target.closest('.removePlanRowBtn');
                if (removeBtn) {
                    removePlanRow(removeBtn);
                }
            });

            // --- 4. 測試資料填充邏輯 ---
            
            const clearDynamicRows = () => {
                // 清空所有品項
                while (budgetItemsContainer.children.length > 0) {
                    budgetItemsContainer.children[0].remove();
                }
                
                // 清空所有計畫
                while (usagePlanContainer.children.length > 0) {
                    usagePlanContainer.children[0].remove();
                }
            };

            const fillTestData = () => {
                clearDynamicRows();
                document.getElementById('sampleName').value = '申請購買 Apple M3 Max 晶片樣品機 (MacBook Pro 16")';
                document.getElementById('purpose').value = '為評估競品在高效能運算 (HPC) 與人工智慧模型推論方面的實際表現。主要用於 GPU 性能對比測試、能耗分析，以及散熱結構拆解研究，作為我們下一代 AI 筆記型電腦產品設計的關鍵參考依據。';
                
                addPlanRow('針對 M3 Max 進行 GeekBench 與 CineBench 跑分測試，記錄 CPU/GPU 滿載性能數據。', '王小明 (研發)');
                addPlanRow('執行熱像儀分析，記錄長時間負載下的功耗與表面溫度分佈。', '李大華 (散熱)');
                addPlanRow('購買第二台用於拆機分析，撰寫結構與元件詳細報告。', '陳美麗 (結構)');
                
                addBudgetItem('MacBook Pro 16" (M3 Max)', '120000', '2', 'https://www.apple.com/macbook-pro/');
                addBudgetItem('Tear Down 專用工具組', '3500', '1', 'https://www.ifixit.com/store/kits');
                addBudgetItem('M.2 NVMe SSD 512GB (用於數據傳輸)', '1500', '4', '');

                calculateTotal();
            };

            fillTestDataBtn.addEventListener('click', fillTestData);


            // --- 5. 初始設置與狀態檢查 ---

            // 確保初始時至少有一行品項，並初始化連結顯示
            if (budgetItemsContainer.children.length === 0) {
                addBudgetItem();
            } else {
                document.querySelectorAll('#budgetItemsContainer .link-container').forEach(handleLinkInsertion);
            }
            if (usagePlanContainer.children.length === 0) {
                usagePlanContainer.appendChild(createPlanRow());
            }

            calculateTotal();


            // --- 6. 表單提交與 PDF 轉換模擬 ---

            const formatForPrint = (data, budgetItems, usagePlans, totalAmount) => {
                const budgetTableRows = budgetItems.map(item => {
                    const linkDisplay = item.link 
                        ? `<a href="${item.link}" target="_blank" style="text-decoration: underline; color: blue;">➤ 連結</a>` 
                        : '';
                    const formattedPrice = formatNumber(item.price);
                    const formattedSubtotal = formatNumber(item.subtotal);

                    return `
                        <tr>
                            <td>${item.name}</td>
                            <td>${linkDisplay}</td>
                            <td align="right">NT$${formattedPrice}</td>
                            <td align="right">${item.quantity}</td>
                            <td align="right">NT$${formattedSubtotal}</td>
                        </tr>
                    `;
                }).join('');

                const planTableRows = usagePlans.map((plan, index) => `
                    <tr>
                        <td width="5%">${index + 1}.</td>
                        <td width="75%">${plan.plan}</td>
                        <td width="20%">${plan.responsible}</td>
                    </tr>
                `).join('');


                return `
                    <div class="print-header text-center mb-6">
                        <h1 class="text-xl font-bold">樣品請購簽呈</h1>
                        <p class="text-sm mt-1">文件產生日期: ${new Date().toLocaleDateString('zh-TW')}</p>
                    </div>

                    <h3>一、簽呈說明</h3>
                    <div class="space-y-2 mb-4 p-2 border border-gray-200 rounded-lg">
                        <p><strong>主旨 (樣品名稱/型號)：</strong> ${data.sampleName}</p>
                        <p><strong>目的：</strong> ${data.purpose.replace(/\n/g, '<br>')}</p>
                    </div>

                    <h3>二、使用計畫</h3>
                    <table class="plan-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>計畫/內容</th>
                                <th>負責人</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${planTableRows}
                        </tbody>
                    </table>

                    <h3>三、預計花費</h3>
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th>品項/型號</th>
                                <th>連結</th>
                                <th width="12%">單價 (NT$)</th>
                                <th width="8%">數量</th>
                                <th width="15%">小計 (NT$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${budgetTableRows}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" align="right">總金額：</td>
                                <td align="right">NT$${totalAmount}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            };


            form.addEventListener('submit', (event) => {
                event.preventDefault(); 
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                if (budgetItemsContainer.children.length === 0 || usagePlanContainer.children.length === 0) {
                    console.error('表單提交失敗：請至少填寫一個預計花費品項和一個使用計畫。');
                    return; 
                }

                const budgetItems = [];
                document.querySelectorAll('#budgetItemsContainer .budgetItemRow').forEach(row => {
                    const price = row.querySelector('.itemPrice').value;
                    const quantity = row.querySelector('.itemQuantity').value;
                    const link = row.querySelector('[name="itemLink"]').value; 
                    
                    budgetItems.push({
                        name: row.querySelector('[name="itemName"]').value,
                        link: link,
                        price: price,
                        quantity: quantity,
                        subtotal: Math.round(parseFloat(price || 0) * parseInt(quantity || 0))
                    });
                });

                const usagePlans = [];
                document.querySelectorAll('#usagePlanContainer .planRow').forEach(row => {
                    usagePlans.push({
                        plan: row.querySelector('[name="planDetails"]').value,
                        responsible: row.querySelector('[name="planResponsible"]').value,
                    });
                });

                const totalAmount = totalAmountDisplay.textContent;

                const printableHTML = formatForPrint(data, budgetItems, usagePlans, totalAmount);
                documentToPrint.innerHTML = printableHTML;
                
                messageBox.classList.remove('hidden');
                submissionDetails.innerHTML = `<p>簽呈主旨：「${data.sampleName}」，總金額 NT$${totalAmount}。請檢查下方資訊並列印。</p>`;

                setTimeout(() => {
                    window.print();
                }, 100); 

            });


            // --- 7. Generate Text Summary ---
            const generateTextSummary = () => {
                const data = {
                    sampleName: document.getElementById('sampleName').value || '未填寫',
                    purpose: document.getElementById('purpose').value || '未填寫',
                    totalAmount: totalAmountDisplay.textContent
                };

                const budgetItems = [];
                document.querySelectorAll('#budgetItemsContainer .budgetItemRow').forEach((row) => {
                    const name = row.querySelector('[name="itemName"]').value || '未命名品項';
                    const price = row.querySelector('.itemPrice').value || '0';
                    const quantity = row.querySelector('.itemQuantity').value || '0';
                    budgetItems.push({ name, price, quantity });
                });

                const usagePlans = [];
                document.querySelectorAll('#usagePlanContainer .planRow').forEach((row) => {
                    const plan = row.querySelector('[name="planDetails"]').value || '未填寫計畫';
                    const responsible = row.querySelector('[name="planResponsible"]').value || '未指定負責人';
                    usagePlans.push({ plan, responsible });
                });

                let summary = '';
                summary += `主旨 (樣品名稱/型號)：\n${data.sampleName}\n`;
                summary += `目的：\n${data.purpose}\n`;

                for (let i = 0; i < usagePlans.length; i++) {
                    const plan = usagePlans[i];
                    summary += `---\n`;
                    summary += `計畫${i + 1}負責人：${plan.responsible}\n`;
                    summary += `使用計畫${i + 1}：${plan.plan}\n`;
                }
                
                summary += `---\n預計花費：\n`;
                if (budgetItems.length > 0) {
                    budgetItems.forEach((item, index) => {
                        const formattedPrice = formatNumber(item.price);
                        summary += `${index + 1}. ${item.name}_NT$${formattedPrice}_數量${item.quantity}\n`;
                    });
                } else {
                    summary += "無預計花費項目。\n";
                }

                summary += `---\n總額花費：NT$${data.totalAmount}元`;

                return summary;
            };

            // --- 8. Modal Event Listeners ---
            
            convertToTextBtn.addEventListener('click', () => {
                const textSummary = generateTextSummary();
                textOutputArea.value = textSummary;
                textModal.classList.remove('hidden');
                setTimeout(() => {
                    textOutputArea.select();
                }, 50);
            });

            closeTextModalBtn.addEventListener('click', () => {
                textModal.classList.add('hidden');
            });

            copyTextBtn.addEventListener('click', () => {
                textOutputArea.select();
                try {
                    // Modern way to copy
                    navigator.clipboard.writeText(textOutputArea.value);
                } catch (err) {
                    // Fallback for older browsers
                    document.execCommand('copy');
                }
                
                copyTextBtn.textContent = '已複製！';
                setTimeout(() => {
                    copyTextBtn.textContent = '複製文字';
                }, 1500);
            });
        });
    </script>
</body>
</html>
