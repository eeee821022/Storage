<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寵物飼主健康管理與娛樂需求調查</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.css">
    <!-- 載入 html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* [您的 CSS 樣式...] */
        html { font-size: 106.25%; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f7fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #60a5fa; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        .gradient-bg { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .quiz-card { background-color: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-width: 800px; width: 100%; overflow: hidden; transition: all 0.3s ease-in-out; }
        .progress-bar-inner { background-color: #3b82f6; transition: width 0.5s ease-in-out; }
        .btn { display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; border-radius: 9999px; font-weight: 500; padding: 0.75rem 1.5rem; font-size: 1rem; transition: all 0.2s ease-in-out; border: 2px solid transparent; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-secondary { background-color: #e2e8f0; color: #1f2937; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .radio-option { display: block; width: 100%; padding: 1rem 1.5rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; text-align: left; font-size: 1rem; font-weight: 500; color: #374151; background-color: white; transition: all 0.2s ease-in-out; cursor: pointer; }
        .radio-option:hover { border-color: #93c5fd; background-color: #eff6ff; }
        .radio-option.selected { border-color: #3b82f6; background-color: #dbeafe; color: #1e3a8a; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06); }
        .radio-option input { display: none; }
        .pet-choice { border: 4px solid transparent; transition: all 0.2s ease-in-out; border-radius: 1rem; }
        .pet-choice.selected { border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d1d5db; border-radius: 9999px; outline: none; opacity: 0.9; transition: opacity 0.2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 4px solid white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 4px solid white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .loader { width: 80px; height: 80px; border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success-icon { width: 80px; height: 80px; border-radius: 50%; display: block; stroke-width: 5; stroke: white; stroke-miterlimit: 10; margin: 0 auto; box-shadow: inset 0px 0px 0px #4ade80; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .success-icon__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 5; stroke-miterlimit: 10; stroke: #4ade80; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .success-icon__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 80px #4ade80; } }
        .error-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; background-color: #f87171; }
        .error-icon i { color: white; font-size: 40px; font-weight: bold; }
        .budget-slider::-webkit-slider-runnable-track { background: linear-gradient(to right, #ef4444, #f87171, #d1d5db, #d1d5db, #60a5fa, #3b82f6); }
        .budget-slider::-moz-range-track { background: linear-gradient(to right, #ef4444, #f87171, #d1d5db, #d1d5db, #60a5fa, #3b82f6); }
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; border-radius: 1rem; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .text-input { display: block; width: 100%; border: 2px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 1rem; color: #374151; transition: all 0.2s ease-in-out; }
        .text-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        textarea.text-input { min-height: 100px; }
        #answer-summary { background-color: white; border: 1px solid #d1d5db; border-radius: 0.75rem; padding: 1rem; max-height: 240px; overflow-y: auto; text-align: left; line-height: 1.6; }
        #answer-summary div { padding: 0.25rem 0; border-bottom: 1px dashed #e5e7eb; }
        #answer-summary div:last-child { border-bottom: none; }
        #answer-summary strong { color: #1f2937; }
        #answer-summary span { color: #1d4ed8; font-weight: 500; }
        #answer-summary span pre { font-family: inherit; margin: 0; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div id="app" class="quiz-card relative">
        <!-- 應用程式內容將由 JavaScript 動態渲染 -->
    </div>

    <!-- 快速測試按鈕 -->
    <!-- 
    <button id="debugFillButton" title="快速填寫隨機答案以測試" style="position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; background-color: #f59e0b; color: white; border: none; border-radius: 9999px; width: 50px; height: 50px; font-size: 1.25rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); cursor: pointer; transition: all 0.2s ease;">
        <i class="fas fa-bolt"></i>
    </button>
    --> 

    <script>
        // --- 獲取或設定唯一識別碼 ---
        function getOrSetUniqueID() {
            let id = localStorage.getItem('petSurveyUniqueID_v2');
            if (!id) {
                id = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('petSurveyUniqueID_v2', id);
            }
            return id;
        }

        // --- 應用程式狀態 ---
        let state = {
            page: 'start', // start, survey, interviewSurvey, end
            currentStep: 0,
            answers: {}, // 'Reference' 欄位也會存在這裡
            submissionStatus: 'idle', // idle, submitting, success, error
            startTime: null, 
            uniqueID: getOrSetUniqueID(),
            showInterviewModal: false,
            interviewConsent: null, // null, 'Yes', 'No'
            contactInfo: ''
        };

        // --- 問卷結構 ---
        const TOTAL_STEPS = 6;
        const REQUIRED_QUESTIONS_BY_STEP = [
            ['1.1_寵物類型', '1.2_飼養數量', '1.4_居住型態', /* '1.3_Age_Oldest' 會動態加入 */], 
            ['2.1_視為家人', '2.2_情感慰藉', '2.3_對寵說話', '2.4_擔心想念', '2.5_快樂來源', '2.6_像孩子', '2.7_填補空缺', '2.8_日常話題'], // Step 2
            ['3.1_充滿活力', '3.2_擔心獨處', '3.3_願意陪伴', '3.4_專心時間'], // Step 3
            ['4.1_食品保健花費', '4.2_玩具娛樂花費', '4.3_科技用品數量', '4.4_最高產品金額'], // Step 4
            ['5.1_不好經驗', '5.2_願意添購', '5.3_願意購買金額', '5.4_開心使用', '5.4_安全使用', '5.4_節省時間', '5.4_持久耐用', '5.4_容易清潔'], // Step 5
            ['6.1_性別', '6.2_年齡', '6.3_單身', '6.4_獨居', '6.5_子女', '6.6_寵物相關背景', '6.7_月收入'] // Step 6
        ];

        // --- 問題文字對照表 (QUESTION_MAP) ---
        const QUESTION_MAP = {
            'Reference': '問卷提供者/來由', // *** 新增 ***
            '1.1_寵物類型': '1.1 您的寵物類型是？',
            '1.2_飼養數量': '1.2 您總共飼養了幾隻犬/貓？',
            '1.3_Age_Oldest': '1.3 最年長寵物年齡', 
            '1.3_Age_Youngest': '1.3 最年幼寵物年齡',
            '1.4_居住型態': '1.4 您的居住型態為？',
            '2.1_視為家人': '2.1 我把寵物視為家庭的一份子...',
            '2.2_情感慰藉': '2.2 當我感到壓力或難過時...',
            '2.3_對寵說話': '2.3 我時常會對寵物說話...',
            '2.4_擔心想念': '2.4 若需要短時間與寵物分開...',
            '2.5_快樂來源': '2.5 寵物是我生活中快樂的來源...',
            '2.6_像孩子': '2.6 寵物很大程度上扮演像孩子...',
            '2.7_填補空缺': '2.7 寵物填補了家中空缺...',
            '2.8_日常話題': '2.8 日常話題中常圍繞著寵物...',
            '3.1_充滿活力': '3.1 寵物目前的日常是否充滿活力？',
            '3.2_擔心獨處': '3.2 您是否擔心寵物長時間獨處？',
            '3.3_願意陪伴': '3.3 您是否願意每天花時間陪伴寵物？',
            '3.4_專心時間': '3.4 您每天花多久陪伴寵物？',
            '4.1_食品保健花費': '4.1 每月花費 (食品保健)',
            '4.2_玩具娛樂花費': '4.2 每年花費 (玩具娛樂)',
            '4.3_科技用品數量': '4.3 曾經購買過的科技寵物用品數量？',
            '4.4_最高產品金額': '4.4 曾購買的最高產品金額？',
            '5.1_不好經驗': '5.1 購買昂貴用品時是否有過不好經驗？',
            '5.2_願意添購': '5.2 無法陪伴時, 是否願意添購陪伴產品?',
            '5.3_願意購買金額': '5.3 願意購買的金額為?',
            '5.4_開心使用': '5.4 預算分配 (開心使用)',
            '5.4_安全使用': '5.4 預算分配 (安全使用)',
            '5.4_節省時間': '5.4 預算分配 (節省時間)',
            '5.4_持久耐用': '5.4 預算分配 (持久耐用)',
            '5.4_容易清潔': '5.4 預算分配 (容易清潔)',
            '6.1_性別': '6.1 您的性別？',
            '6.2_年齡': '6.2 您的年齡區間？',
            '6.3_單身': '6.3 您是否單身?',
            '6.4_獨居': '6.4 您是否獨居?',
            '6.5_子女': '6.5 您是否有子女?',
            '6.6_寵物相關背景': '6.6 您是否有寵物相關背景?',
            '6.7_月收入': '6.7 您個人平均月收入？',
            '7.1_願意受訪': '7.1 願意接受訪問嗎？',
            '7.2_聯絡資訊': '7.2 聯絡資訊',
            'Q1_情境連結': 'Q1. 平日生活作息與掛念',
            'Q2_當前痛點': 'Q2. 目前嘗試的方法與效果',
            'Q3_未滿足需求': 'Q3. 難以做到的地方',
            'Q4_產品概念': 'Q4. 對新產品的想法'
        };

        // --- 轉換輔助函數 ---
        const LIKERT_MAP = ['非常不同意', '不同意', '普通', '同意', '非常同意'];
        const likertValueToText = (v) => LIKERT_MAP[parseInt(v, 10)] || '普通';
        const AGE_RANGE_MAP = ['0-1歲', '1-3歲', '3-6歲', '6-9歲', '10歲以上'];
        const ageValueToText = (v) => AGE_RANGE_MAP[parseInt(v, 10)] || '0-1歲';
        const budgetSliderValueToText = (v) => {
            const value = parseInt(v, 10) * 500;
            if (value === 0) return 'NT$ 0';
            return value > 0 ? `NT$ +${value.toLocaleString()}` : `NT$ -${Math.abs(value).toLocaleString()}`;
        };
        const petCountValueToText = (v) => {
            const index = parseInt(v, 10);
            if (index === 0) return '1 隻';
            if (index === 1) return '2 隻';
            if (index === 2) return '2+ 隻';
            return '1 隻'; // 預設
        };

        // --- 動態函數產生器 ---
        const createDynamicFunction = (fnStr) => {
            return new Function('v', `
                const LIKERT_MAP = ['非常不同意', '不同意', '普通', '同意', '非常同意'];
                const AGE_RANGE_MAP = ['0-1歲', '1.3歲', '3-6歲', '6-9歲', '10歲以上'];
                const budgetSliderValueToText = (v) => {
                    const value = parseInt(v, 10) * 500;
                    if (value === 0) return 'NT$ 0';
                    return value > 0 ? \`NT$ +\${value.toLocaleString()}\` : \`NT$ -\${Math.abs(value).toLocaleString()}\`;
                };
                const petCountValueToText = (v) => {
                    const index = parseInt(v, 10);
                    if (index === 0) return '1 隻';
                    if (index === 1) return '2 隻';
                    if (index === 2) return '2+ 隻';
                    return '1 隻';
                };
                const likertValueToText = (v) => LIKERT_MAP[parseInt(v, 10)] || '普通';
                const ageValueToText = (v) => AGE_RANGE_MAP[parseInt(v, 10)] || '0-1歲';
                const fn = ${fnStr};
                return fn(v);
            `);
        };


        // --- 渲染主要應用程式 ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 
            switch (state.page) {
                case 'start':
                    app.innerHTML = renderStartPage();
                    attachStartListeners();
                    break;
                case 'survey':
                    app.innerHTML = renderSurveyPage();
                    attachSurveyListeners();
                    // *** MOD V10: 彈窗現在由 survey 頁面疊加 ***
                    if (state.showInterviewModal) {
                        app.innerHTML += renderInterviewModal();
                        attachModalListeners();
                    }
                    break;
                case 'interviewSurvey':
                    app.innerHTML = renderInterviewSurveyPage();
                    attachInterviewSurveyListeners();
                    break;
                case 'end':
                    app.innerHTML = renderEndPage();
                    // *** MOD V10: 只有在非提交中狀態才綁定結束按鈕 ***
                    if (state.submissionStatus !== 'submitting') {
                        attachEndListeners();
                    }
                    break;
            }
            // 確保 DOM 狀態在渲染後更新
            updateDOMState();
        }

        // --- 頁面渲染函數 (start, end, survey) ---
        
        // *** 修改: renderStartPage ***
        function renderStartPage() {
            return `
                <div class="p-8 md:p-12 text-center space-y-8">
                    <i class="fas fa-paw text-6xl text-blue-500"></i>
                    <h1 class="text-3xl font-bold text-gray-800">台灣寵物飼主健康管理與娛樂需求之市場調查</h1>
                    
                    <div class="w-full max-w-md mx-auto text-left space-y-4">
                        <div>
                            <label for="reference-input" class="font-medium text-gray-700 text-lg">問卷提供者或是來由</label>
                            <input type="text" id="reference-input" data-id="Reference" class="text-input mt-2" placeholder="請輸入提供者/來由 (例如：朋友名稱、FB社團...)">
                            <p id="reference-error" class="text-red-500 text-sm mt-1 hidden">請務必填寫此欄位</p>
                        </div>
                        
                        <button id="startButton" class="btn btn-primary btn-lg text-lg w-full">
                            <i class="fas fa-play h-5 w-5 mr-2"></i> 開始填寫
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 pt-4">(僅限目前正在台灣飼養犬、貓的飼主填寫)</p>
                </div>
            `;
        }

        function renderEndPage() {
            // *** MOD V10: 提交中 (submitting) 狀態會顯示載入畫面 ***
            if (state.submissionStatus === 'submitting') {
                return `
                <div class="p-8 md:p-12 text-center space-y-6">
                    <div class="loader"></div>
                    <h1 class="text-3xl font-bold text-gray-800">問卷提交中...</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">請稍候，正在為您傳送資料。</p>
                </div>
            `;
            } else if (state.submissionStatus === 'success') {
                
                let downloadSection = '';
                let actionButtons = '';
                let message = '';

                // *** MOD V10: 根據 'interviewConsent' 狀態顯示不同訊息 ***
                if (state.interviewConsent === 'Yes') {
                    // --- 狀況 2: 接受訪談 (Yes) ---
                    message = '再次感謝您願意提供聯絡資訊！';
                    actionButtons = `
                        <button id="restartButton" class="btn btn-secondary">
                            <i class="fas fa-redo h-4 w-4 mr-2"></i> 重新填寫
                        </button>
                        <button id="mbtiButton" class="btn btn-primary">
                            <i class="fas fa-paw h-4 w-4 mr-2"></i> 寵物MBTI測驗
                        </button>
                    `;
                    downloadSection = `
                        <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">問卷答案摘要</h3>
                            <p class="text-gray-600 mb-4">您可以下載本次的填答摘要作為備份。</p>
                            <div id="answer-summary" class="mb-4"></div>
                            <button id="downloadPngButton" class="btn btn-secondary w-full">
                                <i class="fas fa-download h-4 w-4 mr-2"></i> 下載答案摘要 (PNG)
                            </button>
                        </div>
                    `;

                } else {
                    // --- 狀況 1: 拒絕訪談 (No) 或尚未決定 (null, 但已成功) ---
                    message = '問卷到此全部結束。再次誠摯地感謝您撥出寶貴的時間提供您的意見！';
                    actionButtons = `
                        <button id="restartButton" class="btn btn-secondary">
                            <i class="fas fa-redo h-4 w-4 mr-2"></i> 重新填寫
                        </button>
                        <button id="mbtiButton" class="btn btn-primary">
                            <i class="fas fa-paw h-4 w-4 mr-2"></i> 寵物MBTI測驗
                        </button>
                    `;
                    downloadSection = '';
                }

                return `
                <div class="p-8 md:p-12 text-center space-y-6">
                    <div>
                        <svg class="success-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="success-icon__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="success-icon__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800">提交成功！</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        ${message}
                    </p>
                    <div class="flex justify-center gap-4 flex-wrap">
                        ${actionButtons}
                    </div>
                    ${downloadSection}
                </div>
            `;
            } else { // 'error'
                return `
                <div class="p-8 md:p-12 text-center space-y-6">
                    <div class="error-icon"><i class="fas fa-times"></i></div>
                    <h1 class="text-3xl font-bold text-gray-800">提交失敗</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">抱歉，提交過程中發生錯誤。請檢查您的網路連線或稍後再試。</p>
                    <p class="text-sm text-gray-500">錯誤訊息: ${state.answers.errorMessage || '未知錯誤'}</p>
                    <button id="restartButton" class="btn btn-secondary">
                        <i class="fas fa-redo h-4 w-4 mr-2"></i> 重新填寫
                    </button>
                </div>
            `;
            }
        }
        function renderSurveyPage() {
            const progress = ((state.currentStep + 1) / TOTAL_STEPS) * 100;
            return `
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-blue-600">第 ${state.currentStep + 1} / ${TOTAL_STEPS} 部分</span>
                        <span class="text-sm font-medium text-gray-600">${Math.round(progress)}%</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar-inner h-full rounded-full" style="width: ${progress}%;"></div>
                    </div>
                </div>
                <div class="p-6 md:p-10 space-y-8" style="max-height: 70vh; overflow-y: auto;">
                    ${renderStepContent(state.currentStep)}
                </div>
                <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                    <button id="prevButton" class="btn btn-secondary" ${state.currentStep === 0 ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left h-4 w-4 mr-2"></i> 上一步
                    </button>
                    <button id="nextButton" class="btn btn-primary">
                        ${state.currentStep === TOTAL_STEPS - 1 ? '完成並提交 <i class="fas fa-check h-4 w-4 ml-2"></i>' : '下一步 <i class="fas fa-arrow-right h-4 w-4 ml-2"></i>'}
                    </button>
                </div>
            `;
        }
        function renderInterviewModal() {
            // *** MOD V10: 這是疊加在 survey 頁面上的彈窗 ***
            return `
                <div id="interview-modal" class="modal-overlay">
                    <div class="modal-content space-y-6">
                        <h2 class="text-2xl font-bold text-gray-800 text-center">感謝您的填寫！</h2>
                        <p class="text-lg text-gray-600 text-center">我們誠摯邀請您參與後續的訪談，<br>請問您是否願意接受深度訪問嗎？</p>
                        <div id="interview-step-1" class="flex justify-around gap-4">
                            <button id="interview-no" class="btn btn-secondary w-full"><i class="fas fa-times h-4 w-4 mr-2"></i> 不用了，謝謝</button>
                            <button id="interview-yes" class="btn btn-primary w-full"><i class="fas fa-check h-4 w-4 mr-2"></i> 願意</button>
                        </div>
                        <div id="interview-step-2" class="hidden space-y-4">
                            <p class="text-gray-600">太好了！請留下您的聯絡資訊 (手機號碼或 LINE ID) 以及方便我們稱呼您的簡稱。</p>
                            <div>
                                <label for="contact-input" class="font-medium text-gray-700">聯絡資訊 (手機 / LINE ID) 及簡稱</label>
                                <input type="text" id="contact-input" class="text-input mt-1" placeholder="例如：0912-345-678 王先生">
                                <p id="contact-error" class="text-red-500 text-sm mt-1 hidden">請勿空白</p>
                            </div>
                            <button id="interview-submit-contact" class="btn btn-primary w-full">下一步</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 渲染訪談問答頁 ---
        function renderInterviewSurveyPage() {
            return `
                <div class="p-6 md:p-10 space-y-8" style="max-height: 70vh; overflow-y: auto;">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">訪談補充問題</h2>
                    <p class="text-gray-600">感謝您！我們想在訪談前，先請教您幾個開放性問題，讓我們能更深入了解您的想法。</p>
                    
                    ${createTextArea('Q1_情境連結', 'Q1. 可以聊聊您平日的生活作息嗎？當您在忙碌或需要外出一整天時，您心裡通常最掛念寵物的什麼事？')}
                    ${createTextArea('Q2_當前痛點', 'Q2. 為了讓牠在家不無聊，或是確保牠有足夠的運動量，您目前都嘗試過哪些方法或買過哪些東西？效果怎麼樣？')}
                    ${createTextArea('Q3_未滿足需求', 'Q3. 您覺得在「確保寵物身心健康」這件事上，有沒有什麼是您一直想做，但因為時間、精力或沒有合適工具而很難做到的地方？')}
                    ${createTextArea('Q4_產品概念', 'Q4. 聽完您的分享，我們其實正在構思一款可以在您忙碌時也可以陪伴寵物運動、娛樂的居家產品。您聽到這個概念，第一個想法是什麼？您會期待或擔心什麼？')}
                </div>
                <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-end items-center">
                    <button id="finalInterviewSubmitButton" class="btn btn-primary">
                        完成並提交所有問卷 <i class="fas fa-check h-4 w-4 ml-2"></i>
                    </button>
                </div>
            `;
        }
        
        // --- 渲染問卷步驟內容 ---
        function renderStepContent(step) {
             switch (step) {
                case 0: return renderStep1();
                case 1: return renderStep2();
                case 2: return renderStep3();
                case 3: return renderStep4();
                case 4: return renderStep5();
                case 5: return renderStep6();
                default: return `<p>錯誤：未知的步驟</p>`;
            }
        }
        
        // --- 輔助函數 ---
        
        // *** 修改: createSlider ***
        // 幫 wrapper div 加上 id="container-${id}"
        function createSlider(id, label, min, max, step, valueTextFn, defaultValue) {
            const currentValue = state.answers[id] || defaultValue || min;
            return `
                <div class="space-y-2 py-2" id="container-${id}"> 
                    <div class="flex justify-between items-center">
                        <label class="font-medium text-gray-700">${label}</label>
                        <span id="slider-value-${id}" class="text-lg font-bold text-blue-600">${valueTextFn(currentValue)}</span>
                    </div>
                    <input type="range" data-id="${id}" id="${id}" min="${min}" max="${max}" step="${step}" value="${currentValue}"
                           data-valuetextfn="${encodeURIComponent(valueTextFn.toString())}">
                </div>
            `;
        }
        function createRadioGroup(id, label, options, gridClass = 'grid-cols-1 sm:grid-cols-2') {
            return `
                <div class="space-y-3">
                    <label class="font-medium text-gray-700 text-lg">${label}</label>
                    <div class="grid ${gridClass} gap-3" data-radio-group="${id}">
                        ${options.map((option, index) => `
                            <label class="radio-option">
                                <input type="radio" name="${id}" value="${option}" data-id="${id}">
                                ${option}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        function createYesNoBlock(id, label, yesText = '是', noText = '否', yesIcon = 'fa-check', noIcon = 'fa-times') {
             return `
                <div class="space-y-3">
                    <label class="font-medium text-gray-700 text-lg">${label}</label>
                    <div class="grid grid-cols-2 gap-4" data-radio-group="${id}">
                        <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                            <input type="radio" name="${id}" value="${yesText}" class="hidden" data-id="${id}">
                            <i class="fas ${yesIcon} text-6xl text-green-400"></i>
                            <span class="block text-xl font-bold text-gray-700">${yesText}</span>
                        </label>
                        <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                            <input type="radio" name="${id}" value="${noText}" class="hidden" data-id="${id}">
                            <i class="fas ${noIcon} text-6xl text-red-400"></i>
                            <span class="block text-xl font-bold text-gray-700">${noText}</span>
                        </label>
                    </div>
                </div>
            `;
        }
        function createLikertSlider(id, label) {
            const currentValue = state.answers[id] !== undefined ? state.answers[id] : 2; // 預設 '普通'
            const currentText = likertValueToText(currentValue);
            const valueTextFnString = likertValueToText.toString();
            // *** 修改: 呼叫 createSlider ***
            return createSlider(id, label, 0, 4, 1, createDynamicFunction(valueTextFnString), currentValue);
        }
        function createBudgetSlider(id, label) {
            const currentValue = state.answers[id] !== undefined ? state.answers[id] : 0;
            const currentText = budgetSliderValueToText(currentValue);
            const valueTextFnString = budgetSliderValueToText.toString();
            // *** 修改: 呼叫 createSlider 並客製化 ***
            // createSlider 會回傳 <div id="container-ID">...</div>
            // 我們需要取得該 HTML，並修改 <input> 標籤
            let sliderHTML = createSlider(id, label, -4, 4, 1, createDynamicFunction(valueTextFnString), currentValue);
            sliderHTML = sliderHTML.replace(
                '<input type="range" data-id', 
                '<input type="range" class="budget-slider" data-type="budget-slider" data-id'
            );
            return sliderHTML;
        }

        // --- 建立 <textarea> ---
        function createTextArea(id, label) {
            const currentValue = state.answers[id] || '';
            return `
                <div class="space-y-3 py-2">
                    <label for="${id}" class="font-medium text-gray-700 text-lg">${label}</label>
                    <textarea id="${id}" data-id="${id}" class="text-input w-full" rows="4" placeholder="請在此輸入您的想法...">${currentValue}</textarea>
                    <p id="error-${id}" class="text-red-500 text-sm mt-1 hidden">請勿空白</p>
                </div>
            `;
        }

        // --- 步驟 1-6 的渲染函數 ---
        
        function renderStep1() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">第一部分：飼主與寵物基本背景</h2>
                    <div class="space-y-3">
                        <label class="font-medium text-gray-700 text-lg">1.1 您的寵物類型是？(一種以上可以多寫幾份!)</label>
                        <div class="grid grid-cols-2 gap-4" data-radio-group="1.1_寵物類型">
                            <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                                <input type="radio" name="1.1_寵物類型" value="犬" class="hidden" data-id="1.1_寵物類型">
                                <i class="fas fa-dog text-6xl text-blue-400"></i>
                                <span class="block text-xl font-bold text-gray-700">犬</span>
                            </label>
                            <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                                <input type="radio" name="1.1_寵物類型" value="貓" class="hidden" data-id="1.1_寵物類型">
                                <i class="fas fa-cat text-6xl text-blue-400"></i>
                                <span class="block text-xl font-bold text-gray-700">貓</span>
                            </label>
                        </div>
                    </div>
                    
                    ${createSlider('1.2_飼養數量', '1.2 您總共飼養了幾隻犬/貓？', 0, 2, 1, 
                        petCountValueToText,
                        0 // 預設值為 0 (代表 1 隻)
                    )}

                    <div class="space-y-4">
                        <label class="font-medium text-gray-700 text-lg">1.3 您的寵物目前分別年齡為幾歲？</label>
                        <p class="text-sm text-gray-500">請為您家中最年長 (和最年幼) 的寵物設定年齡區間。</p>
                        <div id="dynamic-age-sliders" class="space-y-6">
                            <!-- 年齡拉桿將由 JavaScript 動態插入 -->
                        </div>
                    </div>

                    ${createRadioGroup('1.4_居住型態', '1.4 您的居住型態為？', 
                        ['單間(3-10坪)', '多間(含客廳)', '透天(獨棟)', '別墅(有庭院)']
                    )}
                </div>
            `;
        }
        function renderStep2() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">第二部分：您與寵物的關係</h2>
                    <p class="text-gray-600">請根據您與寵物的日常互動，評估您對以下描述的同意程度。</p>
                    <div class="space-y-2 divide-y divide-gray-100">
                        ${createLikertSlider('2.1_視為家人', '2.1 我把寵物視為家庭的一份子，而不僅僅是動物。')}
                        ${createLikertSlider('2.2_情感慰藉', '2.2 當我感到壓力或難過時，寵物能提供重要的情感慰藉。')}
                        ${createLikertSlider('2.3_對寵說話', '2.3 我時常會對寵物說話，就像對待人一樣。')}
                        ${createLikertSlider('2.4_擔心想念', '2.4 若需要短時間與寵物分開（例如：出差、旅遊），我會非常擔心和想念牠。')}
                        ${createLikertSlider('2.5_快樂來源', '2.5 寵物是我生活中快樂與滿足感的重要來源。')}
                        ${createLikertSlider('2.6_像孩子', '2.6 寵物很大程度上扮演著像孩子一樣的角色。')}
                        ${createLikertSlider('2.7_填補空缺', '2.7 寵物填補了家中因子女不在所留下的空缺。')}
                        ${createLikertSlider('2.8_日常話題', '2.8 與伴侶、家人或朋友中的日常話題中，有很大一部分是圍繞著你家寵物。')}
                    </div>
                </div>
            `;
        }
        function renderStep3() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">第三部分：寵物日常照護與陪伴</h2>
                    <div class="space-y-2 divide-y divide-gray-100">
                        ${createLikertSlider('3.1_充滿活力', '3.1 您認為寵物目前的日常是否充滿活力？')}
                        ${createLikertSlider('3.2_擔心獨處', '3.2 您是否擔心出門後，寵物長時間獨處時較無活力？')}
                        ${createLikertSlider('3.3_願意陪伴', '3.3 您是否願意每天花費時間陪伴寵物？')}
                    </div>
                    <hr class="my-6">
                    ${createSlider('3.4_專心時間', '3.4 您每天花多久陪伴您的寵物？', 0, 10, 1,
                        (v) => {
                            if (v == 10) return '5+ 小時';
                            const hours = v * 0.5;
                            return `${hours} 小時`;
                        },
                        0
                    )}
                </div>
            `;
        }
        function renderStep4() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">第四部分：寵物生活品質投入</h2>
                    ${createSlider('4.1_食品保健花費', '4.1 每月花費在「寵物食品與保健品」的金額約？', 0, 10, 1,
                        (v) => {
                            if (v == 0) return '$0';
                            if (v >= 10) return '$5,000+';
                            return `$${v * 500}`;
                        },
                        0
                    )}
                    ${createSlider('4.2_玩具娛樂花費', '4.2 每年花費在「寵物玩具、娛樂用品、智能產品」的金額約？', 0, 30, 1,
                        (v) => {
                            if (v == 0) return '$0';
                            if (v >= 30) return '$30,000+';
                            return `$${v * 1000}`;
                        },
                        0
                    )}
                    ${createSlider('4.3_科技用品數量', '4.3 您曾經購買過幾種科技類的寵物用品？', 0, 5, 1,
                        (v) => v >= 5 ? '5+ 種' : `${v} 種`,
                        0
                    )}
                    ${createSlider('4.4_最高產品金額', '4.4 您曾經購買過的寵物產品最高金額大約是多少？', 0, 30, 1,
                        (v) => {
                            if (v == 0) return '$0';
                            if (v >= 30) return '$30,000+';
                            return `$${v * 1000}`;
                        },
                        0
                    )}
                </div>
            `;
        }
        function renderStep5() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">第五部分：消費考量</h2>
                    
                    ${createRadioGroup('5.1_不好經驗', '5.1 在為寵物購買較昂貴的用品時，您是否曾有過不好的經驗？', 
                        ['經常有', '偶爾有', '幾乎沒有', '從未購買過昂貴用品']
                    )}

                    <hr class="my-6">
                    ${createYesNoBlock('5.2_願意添購', '5.2 您無法陪伴寵物時, 是否願意添購可以陪伴寵物活動和娛樂的家用產品?', '是', '否', 'fa-check', 'fa-times')}

                    <hr class="my-6">
                    ${createSlider('5.3_願意購買金額', '5.3 您願意購買的金額為?', 0, 30, 1,
                        (v) => {
                            if (v == 0) return '$0';
                            if (v >= 30) return '$30,000+';
                            return `$${v * 1000}`;
                        },
                        0
                    )}

                    <hr class="my-6">
                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium text-gray-700 text-lg">5.4 如果您用10,000元選購一項寵物用品時（例如：智能玩具、智能廁所、跳台、清潔機等），您最重視花錢投資的功能是？</h3>
                        <p class="text-sm text-gray-500">請左右拉動滑桿，分配您的 10,000 元預算。正值代表增加預算，負值代表減少預算。</p>
                        
                        <div class="text-center py-4">
                            <span class="text-gray-600 text-lg">剩餘/超出 預算</span>
                            <div id="budget-total-display" class="text-4xl font-bold text-blue-600">NT$ 10,000</div>
                        </div>

                        <div id="budget-sliders-container" class="space-y-2 divide-y divide-gray-100">
                            ${createBudgetSlider('5.4_開心使用', '寵物能開心使用')}
                            ${createBudgetSlider('5.4_安全使用', '寵物能安全使用')}
                            ${createBudgetSlider('5.4_節省時間', '節省飼主時間、精力')}
                            ${createBudgetSlider('5.4_持久耐用', '產品持久耐用')}
                            ${createBudgetSlider('5.4_容易清潔', '產品容易清潔整理')}
                        </div>
                    </div>
                </div>
            `;
        }
        function renderStep6() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">第六部分：個人基本資訊</h2>
                    
                    ${createRadioGroup('6.1_性別', '6.1 您的性別？', 
                        ['男性', '女性', '其他']
                    )}
                    
                    ${createRadioGroup('6.2_年齡', '6.2 您的年齡區間？', 
                        ['24歲以下', '25 - 34歲', '35 - 44歲', '45 - 54歲', '55歲以上'],
                        'grid-cols-1 sm:grid-cols-3'
                    )}
                    
                    <hr class="my-6">

                    ${createYesNoBlock('6.3_單身', '6.3 您是否單身?', '是', '否')}
                    
                    ${createYesNoBlock('6.4_獨居', '6.4 您是否獨居?', '是', '否')}

                    ${createYesNoBlock('6.5_子女', '6.5 您是否有子女?', '有', '無')}
                    
                    <hr class="my-6">

                    ${createYesNoBlock('6.6_寵物相關背景', '6.6 您是否有寵物相關背景 (例如：獸醫、美容、訓練等)?', '是', '否')}

                    ${createRadioGroup('6.7_月收入', '6.7 您個人平均月收入大約是多少？', 
                        ['無閒錢', '小康', '富裕', '多到沒地方花']
                    )}
                </div>
            `;
        }
        
        // --- 渲染動態年齡拉桿 ---
        function renderDynamicAgeSliders(petCountValue) {
            const container = document.getElementById('dynamic-age-sliders');
            if (!container) return;
            
            const countIndex = parseInt(petCountValue, 10); // 0: '1', 1: '2', 2: '2+'
            let html = '';

            if (countIndex === 0) { // 只有 1 隻
                const id = '1.3_Age_Oldest';
                const label = '寵物最大 現況';
                html = createSlider(id, label, 0, 4, 1, ageValueToText, 0); 
            } else { // 2 隻或 2+ 隻
                const idOldest = '1.3_Age_Oldest';
                const labelOldest = '寵物最大';
                const idYoungest = '1.3_Age_Youngest';
                const labelYoungest = '寵物最小';
                html = createSlider(idOldest, labelOldest, 0, 4, 1, ageValueToText, 0);
                html += createSlider(idYoungest, labelYoungest, 0, 4, 1, ageValueToText, 0);
            }
            
            container.innerHTML = html;
            
            // 為新產生的拉桿加上事件監聽和初始值
            container.querySelectorAll('input[type="range"]').forEach(slider => {
                const id = slider.dataset.id;
                if (state.answers[id]) {
                     slider.value = state.answers[id];
                } else {
                     slider.value = 0; // 預設值
                     state.answers[id] = '0'; // 將預設值存入 state
                }
                
                slider.oninput = (e) => {
                    const currentId = e.target.dataset.id;
                    const value = e.target.value;
                    state.answers[currentId] = value;
                    const valueEl = document.getElementById(`slider-value-${currentId}`);
                    if (valueEl) {
                        const valueTextFnStr = decodeURIComponent(e.target.dataset.valuetextfn);
                        const valueTextFn = createDynamicFunction(valueTextFnStr);
                        valueEl.textContent = valueTextFn(value);
                    }
                };
                slider.dispatchEvent(new Event('input', { bubbles: true }));
            });
        }

        // --- 更新 5.4 預算總和 ---
        function updateBudgetTotal() {
            const budgetIds = [
                '5.4_開心使用', '5.4_安全使用', '5.4_節省時間', '5.4_持久耐用', '5.4_容易清潔'
            ];
            let sum = 0;
            budgetIds.forEach(id => {
                sum += parseInt(state.answers[id] || 0, 10);
            });
            const totalValue = 10000 + (sum * 500);
            const displayEl = document.getElementById('budget-total-display');
            if (!displayEl) return;
            displayEl.textContent = `NT$ ${totalValue.toLocaleString()}`;
            displayEl.classList.remove('text-blue-600', 'text-red-500', 'text-yellow-600');
            if (totalValue < 10000) {
                displayEl.classList.add('text-red-500');
            } else if (totalValue > 10000) {
                displayEl.classList.add('text-yellow-600');
            } else {
                displayEl.classList.add('text-blue-600');
            }
        }

        // --- 渲染答案摘要 ---
        function renderAnswerSummary() {
            const container = document.getElementById('answer-summary');
            if (!container) return;
            let html = '<div class="space-y-1 text-sm">';
            for (const [id, question] of Object.entries(QUESTION_MAP)) {
                let answer = state.answers[id];
                
                // 如果是 Qs 且未同意，則跳過
                if (id.startsWith('Q') && state.interviewConsent !== 'Yes') {
                    continue; 
                }

                if (answer === undefined || answer === null || answer === '') {
                     if (id === '1.3_Age_Youngest' && (state.answers['1.2_飼養數量'] || '0') === '0') continue;
                     if (id === '7.2_聯絡資訊' && state.interviewConsent !== 'Yes') continue; 
                }

                // *** 新增: 如果 5.2 是 "否"，則跳過 5.3 ***
                if (id === '5.3_願意購買金額' && state.answers['5.2_願意添購'] === '否') {
                    continue;
                }

                try {
                    // *** 新增: 處理 Reference ***
                    if (id === 'Reference') {
                        answer = state.answers['Reference'] || 'N/A';
                    } else if (id === '1.2_飼養數量') {
                        answer = petCountValueToText(answer);
                    } else if (id === '1.3_Age_Oldest' || id === '1.3_Age_Youngest') {
                        answer = ageValueToText(answer);
                    } else if (id.startsWith('2.') || ['3.1_充滿活力', '3.2_擔心獨處', '3.3_願意陪伴'].includes(id)) {
                        answer = likertValueToText(answer);
                    } else if (id === '3.4_專心時間') {
                        answer = (answer == 10) ? '5+ 小時' : `${answer * 0.5} 小時`;
                    } else if (id === '4.1_食品保健花費') {
                        answer = (answer == 0) ? '$0' : (answer >= 10 ? '$5,000+' : `$${answer * 500}`);
                    } else if (id === '4.2_玩具娛樂花費') {
                        answer = (answer == 0) ? '$0' : (answer >= 30 ? '$30,000+' : `$${answer * 1000}`);
                    } else if (id === '4.3_科技用品數量') {
                        answer = (answer >= 5) ? '5+ 種' : `${answer} 種`;
                    } else if (id === '4.4_最高產品金額' || id === '5.3_願意購買金額') {
                        answer = (answer == 0) ? '$0' : (answer >= 30 ? '$30,000+' : `$${answer * 1000}`);
                    } else if (id.startsWith('5.4_')) {
                        answer = budgetSliderValueToText(answer);
                    } else if (id === '7.1_願意受訪') {
                        answer = state.interviewConsent; 
                    } else if (id === '7.2_聯絡資訊') {
                        answer = state.contactInfo; 
                    } else if (id.startsWith('Q')) { 
                        answer = `<pre>${answer}</pre>`; 
                    }
                } catch (e) {
                    console.warn(`轉換答案時出錯 (ID: ${id}):`, e);
                    answer = state.answers[id] || 'N/A';
                }
                html += `<div><strong>${question}:</strong> <span>${answer || 'N/A'}</span></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        // --- 處理 PNG 下載 ---
        async function handleDownloadPng() { 
            const button = document.getElementById('downloadPngButton');
            const summaryElement = document.getElementById('answer-summary');
            if (!summaryElement || !button) return;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin h-4 w-4 mr-2"></i> 圖片產生中...';

            const originalMaxHeight = summaryElement.style.maxHeight;
            const originalOverflowY = summaryElement.style.overflowY;
            summaryElement.style.maxHeight = 'none';
            summaryElement.style.overflowY = 'visible';

            try {
                const canvas = await html2canvas(summaryElement, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: '#ffffff' 
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `pet-survey-summary-${state.uniqueID.substring(0, 8)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("PNG 產生失敗:", err);
                button.innerHTML = '<i class="fas fa-times h-4 w-4 mr-2"></i> 產生失敗，請重試';
            } finally {
                summaryElement.style.maxHeight = originalMaxHeight;
                summaryElement.style.overflowY = originalOverflowY;
                button.disabled = false;
                if (!button.innerHTML.includes('產生失敗')) {
                    button.innerHTML = '<i class="fas fa-download h-4 w-4 mr-2"></i> 下載答案摘要 (PNG)';
                }
            }
        }

        // --- *** 新增: 5.3 顯隱/重設 輔助函數 *** ---
        function toggleQuestion5_3(value) {
            const container5_3 = document.getElementById('container-5.3_願意購買金額');
            const slider5_3 = document.getElementById('5.3_願意購買金額');

            if (value === '是') {
                // 顯示 5.3
                if (container5_3) container5_3.classList.remove('hidden');
            } else { // '否' 或 undefined (預設)
                // 隱藏 5.3
                if (container5_3) container5_3.classList.add('hidden');
                
                // 將 5.3 的值重設為 '0'
                state.answers['5.3_願意購買金額'] = '0';
                
                // 同步更新 UI 上的滑桿 (即使是隱藏的)
                if (slider5_3) {
                    slider5_3.value = '0';
                    // 觸發 input 事件來更新顯示的文字為 $0
                    slider5_3.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }


        // --- 事件監聽器 ---
        
        // *** 修改: attachStartListeners ***
        function attachStartListeners() {
             document.getElementById('startButton').onclick = () => {
                const input = document.getElementById('reference-input');
                const errorEl = document.getElementById('reference-error');
                const referenceValue = input.value.trim();
                
                if (referenceValue === '') {
                    errorEl.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    input.focus();
                } else {
                    errorEl.classList.add('hidden');
                    input.classList.remove('border-red-500');
                    // 將 Reference 存入 state.answers
                    state.answers['Reference'] = referenceValue;
                    setState({ page: 'survey', startTime: Date.now() });
                }
            };
            
            // 當使用者開始輸入時，隱藏錯誤訊息
            const input = document.getElementById('reference-input');
            if(input) {
                input.oninput = () => {
                    document.getElementById('reference-error').classList.add('hidden');
                    input.classList.remove('border-red-500');
                };
            }
        }
        
        function attachEndListeners() {
            const restartButton = document.getElementById('restartButton');
            if (restartButton) {
                restartButton.onclick = () => {
                    // 重置狀態
                    state = {
                        page: 'start', currentStep: 0, answers: {},
                        submissionStatus: 'idle', startTime: null, uniqueID: state.uniqueID, // 保留 uniqueID
                        showInterviewModal: false, interviewConsent: null, contactInfo: ''
                    };
                    render();
                };
            }

            const mbtiButton = document.getElementById('mbtiButton');
            if (mbtiButton) {
                mbtiButton.onclick = () => {
                    window.top.location.href = 'https://tinyurl.com/2uh8kcva';
                };
            }

            const downloadButton = document.getElementById('downloadPngButton');
            if (downloadButton) {
                renderAnswerSummary(); // 確保摘要已渲染
                downloadButton.onclick = handleDownloadPng;
            }
        }
        
        // *** 修改: attachSurveyListeners ***
        function attachSurveyListeners() {
            document.getElementById('prevButton').onclick = () => {
                if (state.currentStep > 0) {
                    setState({ currentStep: state.currentStep - 1 });
                }
            };
            // *** MOD V10: 下一步按鈕的邏輯已修改 ***
            document.getElementById('nextButton').onclick = handleNextOrSubmit;
            
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.onchange = (e) => {
                    const id = e.target.dataset.id || e.target.name;
                    state.answers[id] = e.target.value;
                    updateRadioSelection(id);

                    // --- [新增 5.3 連動邏輯] ---
                    if (id === '5.2_願意添購') {
                        toggleQuestion5_3(e.target.value);
                    }
                    // --- [新增結束] ---
                };
            });
            
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                if (slider.id.startsWith('1.3_Age_')) return; 

                slider.oninput = (e) => {
                    const id = e.target.dataset.id;
                    const value = e.target.value;
                    state.answers[id] = value;
                    
                    const valueEl = document.getElementById(`slider-value-${id}`);
                    if (valueEl) {
                        const valueTextFnStr = decodeURIComponent(e.target.dataset.valuetextfn);
                        const valueTextFn = createDynamicFunction(valueTextFnStr);
                        valueEl.textContent = valueTextFn(value);
                    }
                    
                    if (id === '1.2_飼養數量') {
                        renderDynamicAgeSliders(value);
                    }
                    
                    if (e.target.dataset.type === 'budget-slider') {
                        updateBudgetTotal();
                    }
                };
            });
            
            document.querySelectorAll('.pet-choice').forEach(label => {
                label.onclick = () => {
                    const input = label.querySelector('input[type="radio"]');
                    input.checked = true;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                };
            });
        }
        
        // --- 訪談問答頁的監聽 ---
        function attachInterviewSurveyListeners() {
            document.getElementById('finalInterviewSubmitButton').onclick = () => {
                // 1. 驗證並儲存答案
                const ids = ['Q1_情境連結', 'Q2_當前痛點', 'Q3_未滿足需求', 'Q4_產品概念'];
                let allValid = true;
                ids.forEach(id => {
                    const textarea = document.getElementById(id);
                    const errorEl = document.getElementById(`error-${id}`);
                    if (textarea.value.trim() === '') {
                        errorEl.classList.remove('hidden');
                        allValid = false;
                    } else {
                        errorEl.classList.add('hidden');
                        state.answers[id] = textarea.value.trim();
                    }
                });

                if (allValid) {
                    // 2. *** MOD V10: 呼叫最終提交 (第二次提交) ***
                    handleFinalSubmit();
                } else {
                    showToast("您有尚未填寫的題目喔！", "error");
                }
            };

            // 儲存用戶輸入
            document.querySelectorAll('#app textarea').forEach(textarea => {
                textarea.oninput = (e) => {
                    state.answers[e.target.dataset.id] = e.target.value;
                };
            });
        }

        // --- *** MOD V10: 修改 Modal 監聽器 *** ---
        function attachModalListeners() { 
            document.getElementById('interview-no').onclick = () => {
                state.interviewConsent = 'No';
                // *** MOD V10: 拒絕。不需再次提交，直接跳轉到 'end' 頁的 'success' 狀態 ***
                // (renderEndPage 會根據 interviewConsent='No' 顯示正確的拒絕訊息)
                setState({ 
                    showInterviewModal: false, 
                    page: 'end', 
                    submissionStatus: 'success' 
                });
            };
            document.getElementById('interview-yes').onclick = () => {
                state.interviewConsent = 'Yes';
                document.getElementById('interview-step-1').classList.add('hidden');
                document.getElementById('interview-step-2').classList.remove('hidden');
            };
            document.getElementById('interview-submit-contact').onclick = () => {
                const input = document.getElementById('contact-input');
                const errorEl = document.getElementById('contact-error');
                if (input.value.trim() === '') {
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                    state.contactInfo = input.value.trim();
                    
                    // *** MOD V10: 同意。跳轉到訪談問答頁 (interviewSurvey) ***
                    setState({ page: 'interviewSurvey', showInterviewModal: false });
                }
            };
        }

        // --- 狀態更新與驗證 ---
        function setState(newState) {
            saveCurrentStepAnswers();
            state = { ...state, ...newState };
            console.log("New State: ", state.page, state.submissionStatus, state.showInterviewModal);
            render();
        }
        
        // *** 修改: updateDOMState ***
        function updateDOMState() {
            // 更新 text, number inputs
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                const id = input.dataset.id;
                // *** 修改: 確保 'Reference' 欄位在 start 頁面被正確填入 ***
                if (id === 'Reference' && state.page === 'start') {
                    if (state.answers[id]) input.value = state.answers[id];
                } else if (state.page === 'survey') { // 只在 survey 頁面更新
                    if (state.answers[id]) input.value = state.answers[id];
                }
            });

            // 更新 textarea
            document.querySelectorAll('textarea').forEach(textarea => {
                const id = textarea.dataset.id;
                if (state.answers[id]) textarea.value = state.answers[id];
            });
            
            // 更新 range sliders (排除動態年齡拉桿)
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const id = slider.dataset.id;
                if (id.startsWith('1.3_Age_')) return; 

                const defaultValue = slider.closest('[data-default-value]') ? slider.closest('[data-default-value]').dataset.defaultValue : undefined;
                
                if (id.startsWith('2.') || id.startsWith('3.')) {
                    slider.value = state.answers[id] !== undefined ? state.answers[id] : 2; // 預設 2 (普通)
                } else if (id.startsWith('5.4_')) {
                    slider.value = state.answers[id] !== undefined ? state.answers[id] : 0; // 預設 0
                } else if (id === '1.2_飼養數量') {
                     slider.value = state.answers[id] !== undefined ? state.answers[id] : 0; // 預設 0 (1隻)
                } else {
                    if (state.answers[id]) {
                        slider.value = state.answers[id];
                    } else if (defaultValue) {
                        slider.value = defaultValue;
                    }
                }
                
                // *** 修改: 5.3 的預設值由 toggleQuestion5_3 控制，這裡確保 '0' 被正確寫入 ***
                if (id === '5.3_願意購買金額' && state.answers[id] === undefined) {
                    slider.value = '0';
                }

                slider.dispatchEvent(new Event('input', { bubbles: true }));
            });
            
            // 更新 radio buttons
            const radioIds = new Set(Object.keys(state.answers).filter(k => 
                document.querySelector(`input[type="radio"][data-id="${k}"]`) ||
                document.querySelector(`input[type="radio"][name="${k}"]`)
            ));
            radioIds.forEach(id => {
                const value = state.answers[id];
                if (value) {
                    const input = document.querySelector(`input[type="radio"][name="${id}"][value="${CSS.escape(value)}"]`);
                    if (input) {
                        input.checked = true;
                        updateRadioSelection(id);
                    }
                }
            });

            // 在 Step 1 呼叫 renderDynamicAgeSliders 來處理初始狀態
            if (state.currentStep === 0 && state.page === 'survey') {
                const petCountValue = state.answers['1.2_飼養數量'] || 0;
                renderDynamicAgeSliders(petCountValue);
            }

            // 更新預算總和
            if (state.currentStep === 4 && state.page === 'survey') {
                updateBudgetTotal();
                
                // --- [新增 5.3 顯隱邏輯] ---
                // 確保在頁面 (重新) 渲染時，5.3 的可見性是正確的
                // ( '是' 顯示, '否' 或 undefined 隱藏 )
                const value5_2 = state.answers['5.2_願意添購'];
                toggleQuestion5_3(value5_2);
                // --- [新增結束] ---
            }
        }
        function updateRadioSelection(id) {
            const group = document.querySelector(`[data-radio-group="${id}"]`);
            if (group) {
                group.querySelectorAll('.radio-option, .pet-choice').forEach(label => {
                    const input = label.querySelector('input');
                    if (input.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });
            }
        }
        function saveCurrentStepAnswers() {
            // *** MOD V10: 確保只在 survey 和 interviewSurvey 頁面儲存 ***
            if (state.page !== 'survey' && state.page !== 'interviewSurvey') return;

            const container = document.getElementById('app');
            if (!container) return;

            // 儲存 inputs 和 ranges
            container.querySelectorAll('input[type="text"], input[type="number"], input[type="range"]').forEach(input => {
                if (input.dataset.id) {
                     state.answers[input.dataset.id] = input.value;
                }
            });
            // 儲存 textareas
            container.querySelectorAll('textarea').forEach(textarea => {
                 if (textarea.dataset.id) {
                     state.answers[textarea.dataset.id] = textarea.value;
                 }
            });
            // 儲存 radios
            container.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                const id = input.dataset.id || input.name;
                state.answers[id] = input.value;
            });
        }
        
        // *** 修改: isStepValid ***
        function isStepValid(stepIndex) {
            const requiredIds = [...REQUIRED_QUESTIONS_BY_STEP[stepIndex]]; 

            if (stepIndex === 0) {
                const petCountValue = parseInt(state.answers['1.2_飼養數量'] || 0, 10);
                requiredIds.push('1.3_Age_Oldest');
                if (petCountValue > 0) {
                    requiredIds.push('1.3_Age_Youngest');
                }
            }

            // --- [新增 5.3 驗證邏輯] ---
            // 如果在第 5 頁 (index 4)，且 5.2 回答 "否"
            if (stepIndex === 4 && state.answers['5.2_願意添購'] === '否') {
                // 則將 5.3 從必填清單中移除
                const index = requiredIds.indexOf('5.3_願意購買金額');
                if (index > -1) {
                    requiredIds.splice(index, 1);
                }
            }
            // --- [新增結束] ---


            let isValid = true;
            for (const id of requiredIds) {
                const answer = state.answers[id];
                if (answer === undefined || answer === null || answer === '') {
                    // 檢查是否為允許空白的特殊情況 (如金額為 0)
                    // *** 修改: 5.3 允許 '0' ***
                    if ((id.startsWith('5.4_') || id === '5.3_願意購買金額' || id.startsWith('1.3_Age_')) && (answer === '0' || answer === 0)) {
                       // 0 is valid for these
                    } else {
                        console.warn(`Validation failed for step ${stepIndex + 1}: ${id} is missing or empty.`);
                        isValid = false;
                    }
                }
            }
            return isValid;
        }

        function validateAllAnswers() {
            for (let i = 0; i < TOTAL_STEPS; i++) {
                if (!isStepValid(i)) {
                    return { valid: false, firstInvalidStep: i };
                }
            }
            return { valid: true };
        }

        // --- *** MOD V10: 修改 "下一步/提交" 邏輯 *** ---
        function handleNextOrSubmit() {
            saveCurrentStepAnswers();
            
            // *** 修改: 檢查當前頁是否有效 ***
            if (!isStepValid(state.currentStep)) {
                showToast(`您在第 ${state.currentStep + 1} 部分有未填寫的題目喔！`, "error");
                return;
            }

            if (state.currentStep < TOTAL_STEPS - 1) {
                // 還沒到最後一步，正常換頁
                setState({ currentStep: state.currentStep + 1 });
                const card = document.querySelector('.quiz-card');
                if (card) card.scrollTop = 0;
            } else {
                // --- 這是最後一步 (Step 6) ---
                // 再次檢查所有答案 (雖然前面已逐頁檢查，但以防萬一)
                const validationResult = validateAllAnswers();
                if (validationResult.valid) {
                    // *** MOD V10: 驗證通過，執行第一次提交 ***
                    handleFirstSubmit();
                } else {
                    // 驗證失敗
                    showToast(`您在第 ${validationResult.firstInvalidStep + 1} 部分有未填寫的題目喔！`, "error");
                    setState({ currentStep: validationResult.firstInvalidStep });
                }
            }
        }

        function showToast(message, type = 'info') {
            let toast = document.getElementById('toast-notification');
            if (toast) { toast.remove(); }
            toast = document.createElement('div');
            toast.id = 'toast-notification';
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed top-5 right-5 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50 animate-bounce`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.transition = 'opacity 0.5s ease-out';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 2500);
        }

        // --- 快速填寫隨機答案 ---
        function fillWithRandomAnswers() {
            const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
            let newAnswers = {};

            // *** 新增: 隨機填寫 Reference ***
            newAnswers['Reference'] = randomChoice(['朋友A', 'FB寵物社團', '測試員']);

            // Step 1
            newAnswers['1.1_寵物類型'] = randomChoice(['犬', '貓']);
            const petCountValue = randomInt(0, 2);
            newAnswers['1.2_飼養數量'] = petCountValue;
            newAnswers['1.3_Age_Oldest'] = randomInt(0, 4);
            if (petCountValue > 0) {
                newAnswers['1.3_Age_Youngest'] = randomInt(0, newAnswers['1.3_Age_Oldest']);
            }
            newAnswers['1.4_居住型態'] = randomChoice(['單間(3-10坪)', '多間(含客廳)', '透天(獨棟)', '別墅(有庭院)']);
            
            // Step 2-6
            ['2.1_視為家人', '2.2_情感慰藉', '2.3_對寵說話', '2.4_擔心想念', '2.5_快樂來源', '2.6_像孩子', '2.7_填補空缺', '2.8_日常話題'].forEach(id => newAnswers[id] = randomInt(0, 4));
            ['3.1_充滿活力', '3.2_擔心獨處', '3.3_願意陪伴'].forEach(id => newAnswers[id] = randomInt(0, 4));
            newAnswers['3.4_專心時間'] = randomInt(0, 10);
            newAnswers['4.1_食品保健花費'] = randomInt(0, 10);
            newAnswers['4.2_玩具娛樂花費'] = randomInt(0, 30);
            newAnswers['4.3_科技用品數量'] = randomInt(0, 5);
            newAnswers['4.4_最高產品金額'] = randomInt(0, 30);
            newAnswers['5.1_不好經驗'] = randomChoice(['經常有', '偶爾有', '幾乎没有', '從未購買過昂貴用品']);
            newAnswers['5.2_願意添購'] = randomChoice(['是', '否']);
            // *** 修改: 根據 5.2 決定 5.3 ***
            if (newAnswers['5.2_願意添購'] === '是') {
                newAnswers['5.3_願意購買金額'] = randomInt(1, 30); // 如果是 "是"，給一個非 0 的值
            } else {
                newAnswers['5.3_願意購買金額'] = '0'; // 如果是 "否"，設為 0
            }
            ['5.4_開心使用', '5.4_安全使用', '5.4_節省時間', '5.4_持久耐用', '5.4_容易清潔'].forEach(id => newAnswers[id] = randomInt(-4, 4)); 
            newAnswers['6.1_性別'] = randomChoice(['男性', '女性', '其他']);
            newAnswers['6.2_年齡'] = randomChoice(['24歲以下', '25 - 34歲', '35 - 44歲', '45 - 54歲', '55歲以上']);
            newAnswers['6.3_單身'] = randomChoice(['是', '否']);
            newAnswers['6.4_獨居'] = randomChoice(['是', '否']);
            newAnswers['6.5_子女'] = randomChoice(['有', '無']);
            newAnswers['6.6_寵物相關背景'] = randomChoice(['是', '否']);
            newAnswers['6.7_月收入'] = randomChoice(['無閒錢', '小康', '富裕', '多到沒地方花']);
            
            // 隨機填寫 Qs (用於測試)
            newAnswers['Q1_情境連結'] = 'e.g 孤單、搗亂、睡一天、缺乏運動';
            newAnswers['Q2_當前痛點'] = 'e.g 玩具、爬架、跑步輪';
            newAnswers['Q3_未滿足需求'] = 'e.g 訓練活動、消耗白天時的體力';
            newAnswers['Q4_產品概念'] = 'e.g 自由奔跑跳躍、自動陪玩、自動打掃';

            showToast("已填入隨機答案，請檢查最後一頁並提交！", "info");
            
            setState({
                answers: newAnswers,
                currentStep: TOTAL_STEPS - 1 // 停在最後一頁
            });
        }

        // --- Google Apps Script 網址 ---
        // !!! 確保這個網址是您更新並重新部署過的 V10 腳本網址 !!!
        const GOOGLE_SHEET_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSC-co1UtcQ0V2faXXuPIr5F7s3pri4ukLq9Tyu5unMfeVseAHsr_F04D0yzDssU-wbA/exec'; 

        // --- *** MOD V10: 第一次提交 (僅 Step 1-6) *** ---
        async function handleFirstSubmit() {
            if (state.submissionStatus === 'submitting') return;
            
            // 顯示載入畫面 (符合需求 1 & 2)
            setState({ page: "end", submissionStatus: 'submitting' });

            // 執行發送 (不含 Q1-Q4)
            const success = await sendDataToGoogle(false);

            if (success) {
                // 提交成功，顯示訪談 Modal (符合需求 3)
                // 我們跳回 'survey' 頁面，並設定 showInterviewModal = true
                setState({ 
                    page: 'survey', 
                    submissionStatus: 'idle', // 重置提交狀態
                    showInterviewModal: true 
                });
            } else {
                // 提交失敗，停留在 'end' 頁面 (會顯示錯誤訊息)
                setState({ 
                    submissionStatus: "error", 
                    answers: { ...state.answers, errorMessage: '首次提交失敗' }
                });
            }
        }

        // --- *** MOD V10: 第二次提交 (含 Q1-Q4) *** ---
        async function handleFinalSubmit() {
            if (state.submissionStatus === 'submitting') return;

            // 顯示載入畫面
            setState({ page: "end", submissionStatus: 'submitting' });

            // 執行發送 (包含 Q1-Q4) (符合需求 5)
            const success = await sendDataToGoogle(true);

            if (success) {
                // 提交成功，顯示 'end' 頁的成功訊息 (符合需求 6)
                // renderEndPage 會根據 interviewConsent='Yes' 顯示正確訊息
                setState({ submissionStatus: "success" });
            } else {
                // 提交失敗
                setState({ 
                    submissionStatus: "error", 
                    answers: { ...state.answers, errorMessage: '最終提交失敗' }
                });
            }
        }


        // --- *** MOD V10: 抽離出的共用提交函數 *** ---
        // isFinalSubmit = true 代表包含 Q1-Q4
        async function sendDataToGoogle(isFinalSubmit = false) {
            
            // --- 確保所有預設值都已填入 (這段邏輯不變) ---
            const likertIds = [
                '2.1_視為家人', '2.2_情感慰藉', '2.3_對寵說話', '2.4_擔心想念', '2.5_快樂來源', '2.6_像孩子', '2.7_填補空缺', '2.8_日常話題',
                '3.1_充滿活力', '3.2_擔心獨處', '3.3_願意陪伴'
            ];
            likertIds.forEach(id => {
                if (state.answers[id] === undefined) state.answers[id] = '2';
            });
            if (state.answers['1.3_Age_Oldest'] === undefined) state.answers['1.3_Age_Oldest'] = '0';
            const petCountValue = parseInt(state.answers['1.2_飼養數量'] || 0, 10);
            if (petCountValue > 0 && state.answers['1.3_Age_Youngest'] === undefined) {
                 state.answers['1.3_Age_Youngest'] = '0';
            }
            // *** 修改: 確保 5.3 預設為 '0' ***
             if (state.answers['5.3_願意購買金額'] === undefined) state.answers['5.3_願意購買金額'] = '0';
            const budgetIds = ['5.4_開心使用', '5.4_安全使用', '5.4_節省時間', '5.4_持久耐用', '5.4_容易清潔'];
            budgetIds.forEach(id => {
                if (state.answers[id] === undefined) state.answers[id] = '0'; 
            });

            const durationSeconds = state.startTime ? Math.round((Date.now() - state.startTime) / 1000) : 0;

            const dataToSend = {
                'Duration': durationSeconds + ' 秒',
                'UniqueID': state.uniqueID,
                'Reference': state.answers['Reference'] || '',
                '1.1_寵物類型': state.answers['1.1_寵物類型'] || 'N/A',
                '1.2_飼養數量': petCountValueToText(state.answers['1.2_飼養數量'] || '0'), 
                '1.3_Age_Oldest': ageValueToText(state.answers['1.3_Age_Oldest'] || '0'),
                '1.3_Age_Youngest': (petCountValue > 0) ? ageValueToText(state.answers['1.3_Age_Youngest'] || '0') : '',
                '1.4_居住型態': state.answers['1.4_居住型態'] || 'N/A',
                '2.1_視為家人': likertValueToText(state.answers['2.1_視為家人']),
                '2.2_情感慰藉': likertValueToText(state.answers['2.2_情感慰藉']),
                '2.3_對寵說話': likertValueToText(state.answers['2.3_對寵說話']),
                '2.4_擔心想念': likertValueToText(state.answers['2.4_擔心想念']),
                '2.5_快樂來源': likertValueToText(state.answers['2.5_快樂來源']),
                '2.6_像孩子': likertValueToText(state.answers['2.6_像孩子']),
                '2.7_填補空缺': likertValueToText(state.answers['2.7_填補空缺']),
                '2.8_日常話題': likertValueToText(state.answers['2.8_日常話題']),
                '3.1_充滿活力': likertValueToText(state.answers['3.1_充滿活力']),
                '3.2_擔心獨處': likertValueToText(state.answers['3.2_擔心獨處']),
                '3.3_願意陪伴': likertValueToText(state.answers['3.3_願意陪伴']),
                '3.4_專心時間': 'N/A',
                '4.1_食品保健花費': 'N/A',
                '4.2_玩具娛樂花費': 'N/A',
                '4.3_科技用品數量': 'N/A',
                '4.4_最高產品金額': 'N/A',
                '5.1_不好經驗': state.answers['5.1_不好經驗'] || 'N/A',
                '5.2_願意添購': state.answers['5.2_願意添購'] || 'N/A',
                '5.3_願意購買金額': 'N/A', 
                '5.4_開心使用': 'N/A', 
                '5.4_安全使用': 'N/A',
                '5.4_節省時間': 'N/A',
                '5.4_持久耐用': 'N/A',
                '5.4_容易清潔': 'N/A',
                '6.1_性別': state.answers['6.1_性別'] || 'N/A',
                '6.2_年齡': state.answers['6.2_年齡'] || 'N/A',
                '6.3_單身': state.answers['6.3_單身'] || 'N/A',
                '6.4_獨居': state.answers['6.4_獨居'] || 'N/A',
                '6.5_子女': state.answers['6.5_子女'] || 'N/A',
                '6.6_寵物相關背景': state.answers['6.6_寵物相關背景'] || 'N/A',
                '6.7_月收入': state.answers['6.7_月收入'] || 'N/A',
                '7.1_願意受訪': state.interviewConsent || (isFinalSubmit ? 'Yes' : 'N/A'),
                '7.2_聯絡資訊': state.contactInfo || '',
                'Q1_情境連結': isFinalSubmit ? (state.answers['Q1_情境連結'] || '') : '',
                'Q2_當前痛點': isFinalSubmit ? (state.answers['Q2_當前痛點'] || '') : '',
                'Q3_未滿足需求': isFinalSubmit ? (state.answers['Q3_未滿足需求'] || '') : '',
                'Q4_產品概念': isFinalSubmit ? (state.answers['Q4_產品概念'] || '') : ''
            };
            
            // [ 資料轉換 ]
            const v3_4 = state.answers['3.4_專心時間'] || '0';
            dataToSend['3.4_專心時間'] = (v3_4 == 10) ? '5+' : (v3_4 * 0.5).toString();
            const v4_1 = state.answers['4.1_食品保健花費'] || '0';
            dataToSend['4.1_食品保健花費'] = (v4_1 == 0) ? '$0' : (v4_1 >= 10 ? '$5,000+' : `$${v4_1 * 500}`);
            const v4_2 = state.answers['4.2_玩具娛樂花費'] || '0';
            dataToSend['4.2_玩具娛樂花費'] = (v4_2 == 0) ? '$0' : (v4_2 >= 30 ? '$30,000+' : `$${v4_2 * 1000}`);
            const v4_3 = state.answers['4.3_科技用品數量'] || '0';
            dataToSend['4.3_科技用品數量'] = (v4_3 >= 5) ? '5+ 種' : `${v4_3} 種`;
            const v4_4 = state.answers['4.4_最高產品金額'] || '0';
            dataToSend['4.4_最高產品金額'] = (v4_4 == 0) ? '$0' : (v4_4 >= 30 ? '$30,000+' : `$${v4_4 * 1000}`);
            
            // *** 修改: 處理 5.3 ***
            const v5_3 = state.answers['5.3_願意購買金額'] || '0';
            // 如果 5.2 是 "否"，則 5.3 強制為 N/A (或 $0)，即使它有值
            if (state.answers['5.2_願意添購'] === '否') {
                dataToSend['5.3_願意購買金額'] = '$0'; // 或是 'N/A'
            } else {
                dataToSend['5.3_願意購買金額'] = (v5_3 == 0) ? '$0' : (v5_3 >= 30 ? '$30,000+' : `$${v5_3 * 1000}`);
            }

            budgetIds.forEach(id => {
                dataToSend[id] = budgetSliderValueToText(state.answers[id] || '0');
            });
            
            console.log(`準備提交資料 (isFinal=${isFinalSubmit}):`, dataToSend);
            
            if (GOOGLE_SHEET_SCRIPT_URL.includes('!!!') || !GOOGLE_SHEET_SCRIPT_URL.startsWith('https:')) {
                console.error("錯誤：尚未設定有效的 Google Apps Script URL！");
                state.answers.errorMessage = '尚未設定 Google Apps Script URL';
                return false; // 返回失敗
            }

            try {
                // 使用 fetch 發送數據
                fetch(GOOGLE_SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // **重要**：這會導致瀏覽器控制台出現錯誤，但這是正常現象！
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(dataToSend).toString()
                });
                
                // 因為是 'no-cors'，我們無法得知是否真的成功，只能假設請求已發出
                console.log("資料已發送到 Google Apps Script。請到 GS 的『執行』紀錄中確認結果。");
                
                // 等待一小段時間確保 no-cors 請求已送出
                await new Promise(resolve => setTimeout(resolve, 800));
                return true; // 返回成功

            } catch (error) {
                // 這個 catch 區塊通常只在網路問題或 URL 格式錯誤時觸發
                console.error("Fetch 請求本身發生錯誤:", error);
                state.answers.errorMessage = error.toString();
                return false; // 返回失敗
            }
        }
        // --- 首次加載時渲染 ---
        document.addEventListener('DOMContentLoaded', () => {
            render();
            const debugButton = document.getElementById('debugFillButton');
            if (debugButton) {
                debugButton.onclick = fillWithRandomAnswers;
            }
        });
    </script>
</body>
</html>

