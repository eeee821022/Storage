<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 1. æ¨™é¡Œå·²æ›´æ–° -->
    <title>å¯µç‰©å¥åº·ç®¡ç†èˆ‡å¨›æ¨‚å¸‚å ´èª¿æŸ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* [æ‚¨çš„ CSS æ¨£å¼...] */
        html { font-size: 106.25%; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f7fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #60a5fa; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        .gradient-bg { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .quiz-card { background-color: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-width: 800px; width: 100%; overflow: hidden; transition: all 0.3s ease-in-out; }
        .progress-bar-inner { background-color: #3b82f6; transition: width 0.5s ease-in-out; }
        .btn { display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; border-radius: 9999px; font-weight: 500; padding: 0.75rem 1.5rem; font-size: 1rem; transition: all 0.2s ease-in-out; border: 2px solid transparent; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-secondary { background-color: #e2e8f0; color: #1f2937; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .radio-option { display: block; width: 100%; padding: 1rem 1.5rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; text-align: left; font-size: 1rem; font-weight: 500; color: #374151; background-color: white; transition: all 0.2s ease-in-out; cursor: pointer; }
        .radio-option:hover { border-color: #93c5fd; background-color: #eff6ff; }
        .radio-option.selected { border-color: #3b82f6; background-color: #dbeafe; color: #1e3a8a; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06); }
        .radio-option input { display: none; }
        
        .checkbox-option { display: block; width: 100%; padding: 1rem 1.5rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; text-align: left; font-size: 1rem; font-weight: 500; color: #374151; background-color: white; transition: all 0.2s ease-in-out; cursor: pointer; }
        .checkbox-option:hover { border-color: #93c5fd; background-color: #eff6ff; }
        .checkbox-option.selected { border-color: #3b82f6; background-color: #dbeafe; color: #1e3a8a; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06); }
        .checkbox-option input { display: none; }
        .pet-choice { border: 4px solid transparent; transition: all 0.2s ease-in-out; border-radius: 1rem; }
        .pet-choice.selected { border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d1d5db; border-radius: 9999px; outline: none; opacity: 0.9; transition: opacity 0.2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 4px solid white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 4px solid white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .loader { width: 80px; height: 80px; border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success-icon { width: 80px; height: 80px; border-radius: 50%; display: block; stroke-width: 5; stroke: white; stroke-miterlimit: 10; margin: 0 auto; box-shadow: inset 0px 0px 0px #4ade80; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .success-icon__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 5; stroke-miterlimit: 10; stroke: #4ade80; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .success-icon__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 80px #4ade80; } }
        .error-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; background-color: #f87171; }
        .error-icon i { color: white; font-size: 40px; font-weight: bold; }
        .budget-slider::-webkit-slider-runnable-track { background: linear-gradient(to right, #ef4444, #f87171, #d1d5db, #d1d5db, #60a5fa, #3b82f6); }
        .budget-slider::-moz-range-track { background: linear-gradient(to right, #ef4444, #f87171, #d1d5db, #d1d5db, #60a5fa, #3b82f6); }
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; border-radius: 1rem; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .text-input { display: block; width: 100%; border: 2px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 1rem; color: #374151; transition: all 0.2s ease-in-out; }
        .text-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        textarea.text-input { min-height: 100px; }
        #answer-summary { background-color: white; border: 1px solid #d1d5db; border-radius: 0.75rem; padding: 1rem; max-height: 240px; overflow-y: auto; text-align: left; line-height: 1.6; }
        #answer-summary div { padding: 0.25rem 0; border-bottom: 1px dashed #e5e7eb; }
        #answer-summary div:last-child { border-bottom: none; }
        #answer-summary strong { color: #1f2937; }
        #answer-summary span { color: #1d4ed8; font-weight: 500; }
        #answer-summary span pre { font-family: inherit; margin: 0; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div id="app" class="quiz-card relative">
        </div>
    <!--
    <button id="debugFillButton" title="å¿«é€Ÿå¡«å¯«éš¨æ©Ÿç­”æ¡ˆä»¥æ¸¬è©¦" style="position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; background-color: #f59e0b; color: white; border: none; border-radius: 9999px; width: 50px; height: 50px; font-size: 1.25rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); cursor: pointer; transition: all 0.2s ease;">
        <i class="fas fa-bolt"></i>
    </button>
    -->

    <script>
        // --- ç²å–æˆ–è¨­å®šå”¯ä¸€è­˜åˆ¥ç¢¼ ---
        const UNIQUE_ID_KEY = 'petSurveyUniqueID_v2';

        function getOrSetUniqueID() {
            let id = localStorage.getItem(UNIQUE_ID_KEY);
            if (!id) {
                id = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(UNIQUE_ID_KEY, id); // <-- é—œéµï¼šå„²å­˜åœ¨è£ç½®/ç€è¦½å™¨
            }
            return id;
        }

        // æ–°å¢å‡½å¼ï¼šæ¸…é™¤ UniqueID
        function clearUniqueID() {
            localStorage.removeItem(UNIQUE_ID_KEY);
            console.log("UniqueID å·²æ¸…é™¤ï¼Œä¸‹æ¬¡é–‹å•Ÿå°‡ç”Ÿæˆæ–°çš„ IDã€‚");
        }


        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let state = {
            page: 'start', // start, survey, interviewSurvey, end
            currentStep: 0,
            answers: {}, // 'Reference' æ¬„ä½ä¹Ÿæœƒå­˜åœ¨é€™è£¡
            submissionStatus: 'idle', // idle, submitting, success, error
            startTime: null, 
            uniqueID: getOrSetUniqueID(),
            showInterviewModal: false,
            interviewConsent: null, // null, 'Yes', 'No', 'æ¥å—æ–‡å­—è¨ªå•'
            contactInfo: ''
        };

        // --- å•å·çµæ§‹ ---
        const TOTAL_STEPS = 7;

        // --- æ­¥é©Ÿä¸€ (æ ¡æ­£)ï¼šä¿®æ­£ REQUIRED_QUESTIONS_BY_STEP (åŒ…å« Step 7 çš„æ–° ID) ---
        const REQUIRED_QUESTIONS_BY_STEP = [
            /* 0: Step 1 */ ['1.1_å¯µç‰©é¡å‹', '1.2_é£¼é¤Šæ•¸é‡', '1.4_å¥åº·éš±æ†‚' /* '1.3_Age_Oldest' etc added dynamically */],
            /* 1: Step 2 */ ['2.1_è¦–ç‚ºå®¶äºº', '2.2_åƒå­©å­', '2.3_å¡«è£œç©ºç¼º', '2.4_æ„Ÿåˆ°ä¸å®‰'],
            /* 2: Step 3 */ ['3.1_æ“”å¿ƒé¤“è‚šå­', '3.2_æ“”å¿ƒé«’äº‚', '3.3_æ“”å¿ƒå­¤å–®', '3.4_æ“”å¿ƒæ²’æ´»å‹•'],
            /* 3: Step 4 */ ['4.1_é¡˜æ„èŠ±æ™‚é–“', '4.2_æ›¾ç„¡æ³•é™ªä¼´', '4.3_ç„¡æ³•é™ªä¼´é »ç‡', '4.4_å¹³å‡é™ªä¼´æ™‚é–“', '4.5_ç„¡é™é™ªä¼´æ™‚é–“'],
            /* 4: Step 5 */ ['5.1_é£Ÿå“ä¿å¥èŠ±è²»', '5.2_æŒ‘é¸å¥åº·å“', '5.3_ç©å…·å¨›æ¨‚èŠ±è²»', '5.4_æœ€é«˜ç”¢å“é‡‘é¡', '5.5_è³¼è²·æ´»å‹•ç”¢å“', '5.7_å¹´åº¦ç¸½æŠ•å…¥'],
            /* 5: Step 6 */ ['6.1_ä¸å¥½ç¶“é©—', '6.2_é¡˜æ„æ·»è³¼', '6.3_é¡˜æ„è³¼è²·é‡‘é¡', '6.4_é–‹å¿ƒä½¿ç”¨', '6.4_å®‰å…¨ä½¿ç”¨', '6.4_ç¯€çœæ™‚é–“', '6.4_æŒä¹…è€ç”¨', '6.4_å®¹æ˜“æ¸…æ½”', '6.4_ç¯€çœç©ºé–“'], // **æ–°å¢ 6.4_ç¯€çœç©ºé–“**
            /* 6: Step 7 */ ['7.1_æ€§åˆ¥', '7.2_å¹´é½¡', '7.3_æœ‰ä¼´ä¾¶', '7.4_ç¨å±…', '7.5_å±…ä½å‹æ…‹', '7.6_å­å¥³', '7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯', '7.8_å¯æ”¯é…æ¶ˆè²»é¡'] // <-- ä¿®æ­£
        ];


        // --- æ­¥é©Ÿä¸€ (æ ¡æ­£)ï¼šä¿®æ­£ QUESTION_MAP (åŒ…å« Step 7 å’Œ Interview çš„æ–° ID å’Œ Label) ---
        const QUESTION_MAP = {
            'Reference': 'å•å·æä¾›è€…/ä¾†ç”±',
            '1.1_å¯µç‰©é¡å‹': '1.1 æ‚¨çš„å¯µç‰©é¡å‹æ˜¯ï¼Ÿ',
            '1.2_é£¼é¤Šæ•¸é‡': '1.2 æ‚¨ç¸½å…±é£¼é¤Šäº†å¹¾éš»çŠ¬/è²“ï¼Ÿ',
            '1.3_Age_Oldest': '1.3 æœ€å¹´é•·å¯µç‰©å¹´é½¡', 
            '1.3_Age_Youngest': '1.3 æœ€å¹´å¹¼å¯µç‰©å¹´é½¡',
            '1.4_å¥åº·éš±æ†‚': '1.4 æ‚¨çš„å¯µç‰©ç›®å‰æœ‰å“ªäº›å¾Œå¤©æ€§å¥åº·éš±æ†‚ï¼Ÿ',
            
            // --- Step 2
            '2.1_è¦–ç‚ºå®¶äºº': '2.1 æŠŠå¯µç‰©è¦–ç‚ºå®¶åº­çš„ä¸€ä»½å­ï¼Œè€Œä¸åƒ…åƒ…æ˜¯å‹•ç‰©ã€‚',
            '2.2_åƒå­©å­': '2.2 å¯µç‰©å¾ˆå¤§ç¨‹åº¦ä¸Šæ‰®æ¼”è‘—åƒå­©å­ä¸€æ¨£çš„è§’è‰²ã€‚',
            '2.3_å¡«è£œç©ºç¼º': '2.3 å¯µç‰©å¡«è£œäº†å®¶ä¸­å› å­å¥³ä¸åœ¨æ‰€ç•™ä¸‹çš„ç©ºç¼ºã€‚',
            '2.4_æ„Ÿåˆ°ä¸å®‰': '2.4 æœƒç‚ºäº†å¯µç‰©ç”Ÿç—…ã€ä¸å¿«æ¨‚ã€å¯‚å¯è€Œæ„Ÿåˆ°ä¸å®‰ã€‚',
            
            // --- Step 3
            '3.1_æ“”å¿ƒé¤“è‚šå­': '3.1 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©é¤“è‚šå­ï¼Ÿ',
            '3.2_æ“”å¿ƒé«’äº‚': '3.2 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©è£½é€ é«’äº‚(å¤§å°ä¾¿ã€ç ´å£æˆ¿é–“)ï¼Ÿ',
            '3.3_æ“”å¿ƒå­¤å–®': '3.3 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©å­¤å–®ç„¡èŠï¼Ÿ',
            '3.4_æ“”å¿ƒæ²’æ´»å‹•': '3.4 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©ç¡æ•´å¤©æ²’æœ‰æ´»å‹•ï¼Ÿ',

            // --- Step 4 (ä¿®æ”¹æ•˜è¿°)
            '4.1_é¡˜æ„èŠ±æ™‚é–“': '4.1 æ‚¨åœ¨å®¶æ™‚ï¼Œæ˜¯å¦é¡˜æ„èŠ±è²»æ™‚é–“é™ªä¼´å¯µç‰©?',
            '4.2_æ›¾ç„¡æ³•é™ªä¼´': '4.2 æ‚¨æ˜¯å¦æ›¾ç¶“åœ¨æŸæ—¥å› ç‚ºç”Ÿæ´»ä¸Šå—é™æ–¼æ™‚é–“ã€å¿ƒåŠ›ã€å€‹äººèˆˆè¶£ç­‰åŸå› ç„¡æ³•é™ªä¼´å¯µç‰©?',
            '4.3_ç„¡æ³•é™ªä¼´é »ç‡': '4.3 æ‚¨é‡åˆ°ä¸Šè¿°æƒ…æ³çš„é »ç‡æ¯å‘¨æ˜¯?',
            '4.4_å¹³å‡é™ªä¼´æ™‚é–“': '4.4 æ‚¨å¹³å‡æ¯æ—¥èŠ±è²»å¤šå°‘æ™‚é–“é™ªä¼´å¯µç‰©ç©æ¨‚ã€æ•£æ­¥?',
            '4.5_ç„¡é™é™ªä¼´æ™‚é–“': '4.5 åœ¨ç”Ÿæ´»ä¸Šæ²’æœ‰å—é™æ™‚ï¼Œæ‚¨é¡˜æ„æ¯æ—¥èŠ±è²»å¤šå°‘æ™‚é–“é™ªä¼´å¯µç‰©ç©æ¨‚ã€æ•£æ­¥?',
            // --- Step 5
            '5.1_é£Ÿå“ä¿å¥èŠ±è²»': '5.1 æ¯æœˆèŠ±è²» (é£Ÿå“ä¿å¥)',
            '5.2_æŒ‘é¸å¥åº·å“': '5.2 æ˜¯å¦æœ‰æ„æŒ‘é¸è¼ƒå¥åº·é£Ÿå“', 
            '5.3_ç©å…·å¨›æ¨‚èŠ±è²»': '5.3 æ¯å¹´èŠ±è²» (ç©å…·å¨›æ¨‚)',
            '5.4_æœ€é«˜ç”¢å“é‡‘é¡': '5.4 æ›¾è³¼è²·çš„æœ€é«˜ç”¢å“é‡‘é¡', 
            '5.5_è³¼è²·æ´»å‹•ç”¢å“': '5.5 æ˜¯å¦è³¼è²·éä¿ƒé€²æ´»å‹•ç”¢å“', 
            '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡': '5.6 è©²æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡', 
            '5.7_å¹´åº¦ç¸½æŠ•å…¥': '5.7 æœ€çµ‚å¹´åº¦æŠ•å…¥é‡‘é¡',
            '5.7_åŸºæº–é‡‘é¡': '5.7 åŸºæº–é‡‘é¡(éš±è—)',
            '5.7_å¹´åº¦èª¿æ•´': '5.7 å¹´åº¦èª¿æ•´(éš±è—)',
            // --- Step 6
            '6.1_ä¸å¥½ç¶“é©—': '6.1 è³¼è²·æ˜‚è²´ç”¨å“æ™‚æ˜¯å¦æœ‰éä¸å¥½ç¶“é©—ï¼Ÿ',
            '6.2_é¡˜æ„æ·»è³¼': '6.2 ç„¡æ³•é™ªä¼´æ™‚, æ˜¯å¦é¡˜æ„æ·»è³¼é™ªä¼´ç”¢å“?',
            '6.3_é¡˜æ„è³¼è²·é‡‘é¡': '6.3 é¡˜æ„è³¼è²·çš„é‡‘é¡ç‚º?',
            '6.4_é–‹å¿ƒä½¿ç”¨': '6.4 é ç®—åˆ†é… (é–‹å¿ƒä½¿ç”¨)',
            '6.4_å®‰å…¨ä½¿ç”¨': '6.4 é ç®—åˆ†é… (å®‰å…¨ä½¿ç”¨)',
            '6.4_ç¯€çœæ™‚é–“': '6.4 é ç®—åˆ†é… (ç¯€çœæ™‚é–“)',
            '6.4_æŒä¹…è€ç”¨': '6.4 é ç®—åˆ†é… (æŒä¹…è€ç”¨)',
            '6.4_å®¹æ˜“æ¸…æ½”': '6.4 é ç®—åˆ†é… (å®¹æ˜“æ¸…æ½”)',
            '6.4_ç¯€çœç©ºé–“': '6.4 é ç®—åˆ†é… (ç¯€çœç©ºé–“)', // **æ–°å¢ 6.4_ç¯€çœç©ºé–“**
            
            // --- Step 7 (æ ¡æ­£) ---
            '7.1_æ€§åˆ¥': '7.1 æ‚¨çš„æ€§åˆ¥ï¼Ÿ',
            '7.2_å¹´é½¡': '7.2 æ‚¨çš„å¹´é½¡å€é–“ï¼Ÿ',
            '7.3_æœ‰ä¼´ä¾¶': '7.3 æ‚¨æ˜¯å¦æœ‰ä¼´ä¾¶(ç”·å¥³æœ‹å‹ã€å¤«å¦»)ï¼Ÿ',
            '7.4_ç¨å±…': '7.4 æ‚¨æ˜¯å¦ç¨è‡ªå±…ä½ï¼Ÿ',
            '7.5_å±…ä½å‹æ…‹': '7.5 æ‚¨çš„å±…ä½å‹æ…‹ç‚ºï¼Ÿ',
            '7.6_å­å¥³': '7.6 æ‚¨æ˜¯å¦æœ‰å­å¥³ï¼Ÿ', // <-- ä¿®æ­£ 7.5_å­å¥³ -> 7.6_å­å¥³
            '7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯': '7.7 æ‚¨æ˜¯å¦æœ‰å¯µç‰©ç›¸é—œèƒŒæ™¯?', // <-- ä¿®æ­£ 7.6_å¯µç‰©ç›¸é—œèƒŒæ™¯ -> 7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯
            '7.8_å¯æ”¯é…æ¶ˆè²»é¡': '7.8 æ‚¨å€‹äººæ¯æœˆå¹³å‡å¯æ”¯é…æ¶ˆè²»é¡ï¼Ÿ', // <-- ä¿®æ­£ 7.7_å¯æ”¯é…æ¶ˆè²»é¡ -> 7.8_å¯æ”¯é…æ¶ˆè²»é¡
            
            // --- Interview (æ ¡æ­£) ---
            '8.1_é¡˜æ„å—è¨ª': '8.1 é¡˜æ„æ¥å—è¨ªå•å—ï¼Ÿ', // <-- ä¿®æ­£ 7.1_é¡˜æ„å—è¨ª -> 8.1_é¡˜æ„å—è¨ª
            '8.2_è¯çµ¡è³‡è¨Š': '8.2 è¯çµ¡è³‡è¨Š', // <-- ä¿®æ­£ 7.2_è¯çµ¡è³‡è¨Š -> 8.2_è¯çµ¡è³‡è¨Š
            'Q1_æƒ…å¢ƒé€£çµ': 'Q1. æ“”å¿ƒé¤“è‚šå­çš„åŸå› ',
            'Q2_ç•¶å‰ç—›é»': 'Q2. æ“”å¿ƒè£½é€ é«’äº‚çš„åŸå› ',
            'Q3_æœªæ»¿è¶³éœ€æ±‚': 'Q3. æ“”å¿ƒå­¤å–®ç„¡èŠçš„åŸå› ',
            'Q4_ç”¢å“æ¦‚å¿µ': 'Q4. æ“”å¿ƒæ²’æœ‰æ´»å‹•çš„åŸå› ',
            'Q4.1_æå‡æ–¹æ³•': 'Q4.1 æå‡æ´»å‹•é‡çš„æ–¹æ³•',
            'Q4.2_æ–¹æ³•æˆæ•ˆ': 'Q4.2 æ–¹æ³•æ˜¯å¦æˆåŠŸ',
            'Q5_å¥åº·æ–¹æ³•': 'Q5. å¥åº·å•é¡Œçš„è™•ç†æ–¹æ³•',
            'Q6_è³¼è²·æ„é¡˜': 'Q6. è³¼è²·è¨­å‚™çš„ä¸»è¦åŸå› /æœŸè¨±æŠ€è¡“ (æ–°å¢)', // æ–°å¢ Q6
            'Q7_è©¦ç”¨æ„é¡˜': 'Q7. è©¦ç”¨æ„é¡˜èˆ‡è¯çµ¡æ–¹å¼' // åŸ Q6 æ”¹ç‚º Q7
        };

        // --- è½‰æ›è¼”åŠ©å‡½æ•¸ ---
        const LIKERT_MAP = ['éå¸¸ä¸åŒæ„', 'ä¸åŒæ„', 'æ™®é€š', 'åŒæ„', 'éå¸¸åŒæ„'];
        const likertValueToText = (v) => LIKERT_MAP[parseInt(v, 10)] || 'æ™®é€š';
        const AGE_RANGE_MAP = ['0-1æ­²', '1-3æ­²', '3-6æ­²', '6-9æ­²', '10æ­²ä»¥ä¸Š'];
        const ageValueToText = (v) => AGE_RANGE_MAP[parseInt(v, 10)] || '0-1æ­²';
        const budgetSliderValueToText = (v) => {
            const value = parseInt(v, 10) * 500;
            if (value === 0) return 'NT$ 0';
            return value > 0 ? `NT$ +${value.toLocaleString()}` : `NT$ -${Math.abs(value).toLocaleString()}`;
        };
        const petCountValueToText = (v) => {
            const index = parseInt(v, 10);
            if (index === 0) return '1 éš»';
            if (index === 1) return '2 éš»';
            if (index === 2) return '2+ éš»';
            return '1 éš»'; // é è¨­
        };

        // --- å‹•æ…‹å‡½æ•¸ç”¢ç”Ÿå™¨ ---
        const createDynamicFunction = (fnStr) => {
            return new Function('v', `
                const LIKERT_MAP = ['éå¸¸ä¸åŒæ„', 'ä¸åŒæ„', 'æ™®é€š', 'åŒæ„', 'éå¸¸åŒæ„'];
                const AGE_RANGE_MAP = ['0-1æ­²', '1-3æ­²', '3-6æ­²', '6-9æ­²', '10æ­²ä»¥ä¸Š'];
                const budgetSliderValueToText = (v) => {
                    const value = parseInt(v, 10) * 500;
                    if (value === 0) return 'NT$ 0';
                    return value > 0 ? \`NT$ +\${value.toLocaleString()}\` : \`NT$ -\${Math.abs(value).toLocaleString()}\`;
                };
                const petCountValueToText = (v) => {
                    const index = parseInt(v, 10);
                    if (index === 0) return '1 éš»';
                    if (index === 1) return '2 éš»';
                    if (index === 2) return '2+ éš»';
                    return '1 éš»';
                };
                const likertValueToText = (v) => LIKERT_MAP[parseInt(v, 10)] || 'æ™®é€š';
                const ageValueToText = (v) => AGE_RANGE_MAP[parseInt(v, 10)] || '0-1æ­²';
                const fn = ${fnStr};
                return fn(v);
            `);
        };


        // --- æ¸²æŸ“ä¸»è¦æ‡‰ç”¨ç¨‹å¼ ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 
            switch (state.page) {
                case 'start':
                    app.innerHTML = renderStartPage();
                    attachStartListeners();
                    break;
                case 'survey':
                    app.innerHTML = renderSurveyPage();
                    attachSurveyListeners();
                    if (state.showInterviewModal) {
                        app.innerHTML += renderInterviewModal();
                        attachModalListeners();
                    }
                    break;
                case 'interviewSurvey':
                    app.innerHTML = renderInterviewSurveyPage();
                    attachInterviewSurveyListeners();
                    break;
                case 'end':
                    app.innerHTML = renderEndPage();
                    if (state.submissionStatus !== 'submitting') {
                        attachEndListeners();
                    }
                    break;
            }
            updateDOMState();
        }

        // --- é é¢æ¸²æŸ“å‡½æ•¸ (start, end, survey) ---
        
        // --- ä¿®æ”¹å¾Œçš„ renderStartPage å‡½æ•¸ï¼šåŠ å…¥äººæ•¸é¡¯ç¤ºå€å¡ŠåŠæ–‡å­— ---
        function renderStartPage() {
            return `
                <div class="p-8 md:p-12 text-center space-y-8 relative pb-12">
                    <!-- æ–°å¢é–‹å§‹ï¼šé¡¯ç¤ºäººæ•¸çš„å€å¡Š (åŠ å…¥æ–‡å­—) -->
                    <div id="survey-count-display" class="absolute top-4 right-4 text-sm font-semibold text-gray-500 flex items-center">
                        <span class="mr-1 text-gray-700">å·²å¡«å•å·æ•¸:</span>
                        <i class="fas fa-users mr-1"></i>
                        <span id="current-total-count" class="text-blue-500 font-bold">è®€å–ä¸­...</span>
                    </div>
                    <!-- æ–°å¢çµæŸ -->
                
                    <i class="fas fa-paw text-6xl text-blue-500"></i>
                    <h1 class="text-3xl font-bold text-gray-800">å°ç£å¯µç‰©é£¼ä¸»å¥åº·ç®¡ç†èˆ‡å¨›æ¨‚éœ€æ±‚ä¹‹å¸‚å ´èª¿æŸ¥</h1>
                    
                    <div class="w-full max-w-md mx-auto text-left space-y-4">
                        <div>
                            <label for="reference-input" class="font-medium text-gray-700 text-lg">å•å·æä¾›è€…æˆ–æ˜¯ä¾†ç”±</label>
                            <input type="text" id="reference-input" data-id="Reference" class="text-input mt-2" placeholder="è«‹è¼¸å…¥æä¾›è€…/ä¾†ç”± (ä¾‹å¦‚ï¼šæœ‹å‹åç¨±ã€FBç¤¾åœ˜...)">
                            <p id="reference-error" class="text-red-500 text-sm mt-1 hidden">è«‹å‹™å¿…å¡«å¯«æ­¤æ¬„ä½</p>
                        </div>
                        
                        <button id="startButton" class="btn btn-primary btn-lg text-lg w-full">
                            <i class="fas fa-play h-5 w-5 mr-2"></i> é–‹å§‹å¡«å¯«
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 pt-4">(åƒ…é™ç›®å‰æ­£åœ¨å°ç£é£¼é¤ŠçŠ¬ã€è²“çš„é£¼ä¸»å¡«å¯«)</p>

                    <!-- ä¿®æ”¹ï¼šèª¿æ•´å¶ºæ±ç§‘å¤§å­—é«”å¤§å°ç‚º text-sm -->
                    <p class="absolute bottom-4 right-8 text-sm text-gray-400">å¶ºæ±ç§‘å¤§å‰µæŠ•å ±å‘Š</p>
                </div>
            `;
        }

        
        
        function renderEndPage() {
            if (state.submissionStatus === 'submitting') {
                return `
                <div class="p-8 md:p-12 text-center space-y-6">
                    <div class="loader"></div>
                    <h1 class="text-3xl font-bold text-gray-800">å•å·æäº¤ä¸­...</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">è«‹ç¨å€™ï¼Œæ­£åœ¨ç‚ºæ‚¨å‚³é€è³‡æ–™ã€‚</p>
                </div>
            `;
            } else if (state.submissionStatus === 'success') {
                
                let downloadSection = '';
                let actionButtons = '';
                let message = '';

                // --- ä¿®æ­£å¾Œçš„é‚è¼¯ ---
                // æª¢æŸ¥æ‰€æœ‰ã€Œæä¾›äº†è¯çµ¡è³‡è¨Šã€çš„ç‹€æ…‹ ('é¡˜æ„', 'Yes', 'æ¥å—æ–‡å­—è¨ªå•')
                if (state.interviewConsent === 'é¡˜æ„' || state.interviewConsent === 'Yes' || state.interviewConsent === 'æ¥å—æ–‡å­—è¨ªå•') {
                    
                    // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºä¸åŒçš„æ„Ÿè¬è¨Šæ¯
                    if (state.interviewConsent === 'æ¥å—æ–‡å­—è¨ªå•') {
                        message = 'æ„Ÿè¬æ‚¨é¡å¤–æä¾›çš„å¯¶è²´æ„è¦‹ï¼å•å·åˆ°æ­¤å…¨éƒ¨çµæŸã€‚';
                    } else {
                        message = 'å†æ¬¡æ„Ÿè¬æ‚¨é¡˜æ„æä¾›è¯çµ¡è³‡è¨Šï¼';
                    }

                    // é¡¯ç¤ºã€Œé‡æ–°å¡«å¯«ã€æŒ‰éˆ•
                    actionButtons = `
                        <button id="restartButton" class="btn btn-secondary">
                            <i class="fas fa-redo h-4 w-4 mr-2"></i> é‡æ–°å¡«å¯« (æ¸…é™¤æ­¤è£ç½®ç´€éŒ„)
                        </button>
                    `;
                    
                    // é¡¯ç¤ºã€Œç­”æ¡ˆæ‘˜è¦ã€å€å¡Š
                    downloadSection = `
                        <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">å•å·ç­”æ¡ˆæ‘˜è¦</h3>
                            <p class="text-gray-600 mb-4">æ‚¨å¯ä»¥ä¸‹è¼‰æœ¬æ¬¡çš„å¡«ç­”æ‘˜è¦ä½œç‚ºå‚™ä»½ã€‚</p>
                            <div id="answer-summary" class="mb-4"></div>
                            <button id="downloadPngButton" class="btn btn-secondary w-full">
                                <i class="fas fa-download h-4 w-4 mr-2"></i> ä¸‹è¼‰ç­”æ¡ˆæ‘˜è¦ (PNG)
                            </button>
                        </div>
                    `;

                } else {
                    // --- é€™è£¡æ˜¯å”¯ä¸€ã€Œæ‹’çµ•ã€çš„ç‹€æ…‹ ('No' æˆ– null) ---
                    message = 'å•å·åˆ°æ­¤å…¨éƒ¨çµæŸã€‚å†æ¬¡èª æ‘¯åœ°æ„Ÿè¬æ‚¨æ’¥å‡ºå¯¶è²´çš„æ™‚é–“æä¾›æ‚¨çš„æ„è¦‹ï¼';
                   
                    actionButtons = `
                        <button id="restartButton" class="btn btn-secondary">
                            <i class="fas fa-redo h-4 w-4 mr-2"></i> é‡æ–°å¡«å¯« (æ¸…é™¤æ­¤è£ç½®ç´€éŒ„)
                        </button>
                    `;
                    
                    // åªæœ‰åœ¨ 'No' (å°šæœªå¡«å¯«æ–‡å­—è¨ªè«‡) æ™‚ï¼Œæ‰é¡¯ç¤ºã€Œç°¡æ˜“æ–‡å­—è¨ªè«‡ã€æŒ‰éˆ•
                    if (state.interviewConsent === 'No' || state.interviewConsent === null) {
                        actionButtons += `
                        <button id="textInterviewButton" class="btn btn-primary">
                            <i class="fas fa-comments h-4 w-4 mr-2"></i> ç°¡æ˜“æ–‡å­—è¨ªè«‡
                        </button>
                        `;
                    }
                    
                    downloadSection = '';
                }
                // --- ä¿®æ­£çµæŸ ---

                return `
                <div class="p-8 md:p-12 text-center space-y-6">
                    <div>
                        <svg class="success-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="success-icon__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="success-icon__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800">æäº¤æˆåŠŸï¼</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                        ${message}
                    </p>
                    <div class="flex justify-center gap-4 flex-wrap">
                        ${actionButtons}
                        <!-- 2. æ–°å¢åˆ†äº«æŒ‰éˆ• (é©ç”¨æ–¼æ‰€æœ‰æˆåŠŸç•«é¢) -->
                        <button id="shareButton" class="btn btn-primary">
                            <i class="fas fa-share-alt h-4 w-4 mr-2"></i> åˆ†äº«å•å·
                        </button>
                    </div>
                    ${downloadSection}
                </div>
            `;
            } else { // 'error'
                return `
                <div class="p-8 md:p-12 text-center space-y-6">
                    <div class="error-icon"><i class="fas fa-times"></i></div>
                    <h1 class="text-3xl font-bold text-gray-800">æäº¤å¤±æ•—</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto">æŠ±æ­‰ï¼Œæäº¤éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>
                    <p class="text-sm text-gray-500">éŒ¯èª¤è¨Šæ¯: ${state.answers.errorMessage || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    <button id="restartButton" class="btn btn-secondary">
                        <i class="fas fa-redo h-4 w-4 mr-2"></i> é‡æ–°å¡«å¯« (æ¸…é™¤æ­¤è£ç½®ç´€éŒ„)
                    </button>
                </div>
            `;
            }
        }


        function renderSurveyPage() {
            const progress = ((state.currentStep + 1) / TOTAL_STEPS) * 100;
            return `
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-blue-600">ç¬¬ ${state.currentStep + 1} / ${TOTAL_STEPS} éƒ¨åˆ†</span>
                        <span class="text-sm font-medium text-gray-600">${Math.round(progress)}%</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar-inner h-full rounded-full" style="width: ${progress}%;"></div>
                    </div>
                </div>
                <div class="p-6 md:p-10 space-y-8" style="max-height: 70vh; overflow-y: auto;">
                    ${renderStepContent(state.currentStep)}
                </div>
                <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                    <button id="prevButton" class="btn btn-secondary" ${state.currentStep === 0 ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left h-4 w-4 mr-2"></i> ä¸Šä¸€æ­¥
                    </button>
                    <button id="nextButton" class="btn btn-primary">
                        ${state.currentStep === TOTAL_STEPS - 1 ? 'å®Œæˆä¸¦æäº¤ <i class="fas fa-check h-4 w-4 ml-2"></i>' : 'ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right h-4 w-4 ml-2"></i>'}
                    </button>
                </div>
            `;
        }
        
        
        function renderInterviewModal() {
            // æª¢æŸ¥æ˜¯å¦ç”±ã€Œç°¡æ˜“æ–‡å­—è¨ªè«‡ã€æŒ‰éˆ•è§¸ç™¼
            const skipStep1 = state.interviewConsent === 'æ¥å—æ–‡å­—è¨ªå•';
            
            // æ ¹æ“šç‹€æ…‹æ±ºå®šé¡¯ç¤ºçš„æ¨™é¡Œ
            const title = skipStep1 
                ? 'æ„Ÿè¬æ‚¨é¡˜æ„æ¥å—æ–‡å­—è¨ªè«‡ï¼' 
                : 'æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼';
            
            const paragraph = skipStep1
                ? 'è«‹ç•™ä¸‹æ‚¨çš„è¯çµ¡è³‡è¨Šï¼Œ<br>å®Œæˆå¾Œå³å¯é–‹å§‹å¡«å¯«è¨ªè«‡å•é¡Œã€‚'
                : 'æˆ‘å€‘èª æ‘¯é‚€è«‹æ‚¨åƒèˆ‡å¾ŒçºŒçš„è¨ªè«‡ï¼Œ<br>è«‹å•æ‚¨æ˜¯å¦é¡˜æ„æ¥å—æ·±åº¦è¨ªå•å—ï¼Ÿ';

            return `
                <div id="interview-modal" class="modal-overlay">
                    <div class="modal-content space-y-6">
                        <h2 class="text-2xl font-bold text-gray-800 text-center">${title}</h2>
                        <p class="text-lg text-gray-600 text-center">${paragraph}</p>
                        
                        <div id="interview-step-1" class="flex justify-around gap-4 ${skipStep1 ? 'hidden' : ''}">
                            <button id="interview-no" class="btn btn-secondary w-full"><i class="fas fa-times h-4 w-4 mr-2"></i> ä¸ç”¨äº†ï¼Œè¬è¬</button>
                            <button id="interview-yes" class="btn btn-primary w-full"><i class="fas fa-check h-4 w-4 mr-2"></i> é¡˜æ„</button>
                        </div>
                        
                        <div id="interview-step-2" class="${skipStep1 ? '' : 'hidden'} space-y-4">
                            <p class="text-gray-600">å¤ªå¥½äº†ï¼è«‹ç•™ä¸‹æ‚¨çš„è¯çµ¡è³‡è¨Š (æ‰‹æ©Ÿè™Ÿç¢¼æˆ– LINE ID) ä»¥åŠæ–¹ä¾¿æˆ‘å€‘ç¨±å‘¼æ‚¨çš„ç°¡ç¨±ã€‚</p>
                            <div>
                                <label for="contact-input" class="font-medium text-gray-700">è¯çµ¡è³‡è¨Š (æ‰‹æ©Ÿ / LINE ID) åŠç°¡ç¨±</label>
                                <input type="text" id="contact-input" class="text-input mt-1" placeholder="ä¾‹å¦‚ï¼š0912-345-678 ç‹å…ˆç”Ÿ">
                                <p id="contact-error" class="text-red-500 text-sm mt-1 hidden">è«‹å‹¿ç©ºç™½</p>
                            </div>
                            <button id="interview-submit-contact" class="btn btn-primary w-full">ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                </div>
            `;
        }



        // --- æ¸²æŸ“è¨ªè«‡å•ç­”é  ---
        function renderInterviewSurveyPage() {
            // æª¢æŸ¥ç¬¬ä¸‰éƒ¨åˆ†çš„ç­”æ¡ˆï¼Œæ±ºå®šè¦é¡¯ç¤ºå“ªäº›è¨ªè«‡é¡Œç›®
            const show_Q1 = (state.answers['3.1_æ“”å¿ƒé¤“è‚šå­'] === '4' || state.answers['3.1_æ“”å¿ƒé¤“è‚šå­'] === 4 || 
                             state.answers['3.1_æ“”å¿ƒé¤“è‚šå­'] === '3' || state.answers['3.1_æ“”å¿ƒé¤“è‚šå­'] === 3);
            const show_Q2 = (state.answers['3.2_æ“”å¿ƒé«’äº‚'] === '4' || state.answers['3.2_æ“”å¿ƒé«’äº‚'] === 4 || 
                             state.answers['3.2_æ“”å¿ƒé«’äº‚'] === '3' || state.answers['3.2_æ“”å¿ƒé«’äº‚'] === 3);
            const show_Q3 = (state.answers['3.3_æ“”å¿ƒå­¤å–®'] === '4' || state.answers['3.3_æ“”å¿ƒå­¤å–®'] === 4 || 
                             state.answers['3.3_æ“”å¿ƒå­¤å–®'] === '3' || state.answers['3.3_æ“”å¿ƒå­¤å–®'] === 3);
            // Q4 é¡¯ç¤ºæ¢ä»¶æª¢æŸ¥: 3.4 ç­”æ¡ˆæ˜¯ 'åŒæ„' (3) æˆ– 'éå¸¸åŒæ„' (4) 
            const show_Q4 = (state.answers['3.4_æ“”å¿ƒæ²’æ´»å‹•'] === '4' || state.answers['3.4_æ“”å¿ƒæ²’æ´»å‹•'] === 4 || 
                             state.answers['3.4_æ“”å¿ƒæ²’æ´»å‹•'] === '3' || state.answers['3.4_æ“”å¿ƒæ²’æ´»å‹•'] === 3);
            
            // **Q6 é¡¯ç¤ºæ¢ä»¶ï¼šæª¢æŸ¥ 6.2 æ˜¯å¦ç‚º 'æ˜¯'**
            const show_Q6_new = (state.answers['6.2_é¡˜æ„æ·»è³¼'] === 'æ˜¯');
            
            // æª¢æŸ¥ 1.4 çš„ç­”æ¡ˆï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤º Q5
            const health_concerns = state.answers['1.4_å¥åº·éš±æ†‚'] || '';
            const show_Q5 = health_concerns && health_concerns !== 'ä»¥ä¸Šçš†ç„¡' && !health_concerns.includes('ä»¥ä¸Šçš†ç„¡');
            
            // å–å¾— 6.3 ç­”æ¡ˆ (ç”¨æ–¼ Q6/Q7)
            const v6_3 = state.answers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] || '0';
            const priceText = (v6_3 == 0) ? '$0' : (v6_3 >= 30 ? '$30,000+' : `$${(v6_3 * 1000).toLocaleString()}`);
            
            return `
                <div class="p-6 md:p-10 space-y-8" style="max-height: 70vh; overflow-y: auto;">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">è¨ªè«‡è£œå……å•é¡Œ</h2>
                    <p class="text-gray-600">æ„Ÿè¬æ‚¨ï¼æˆ‘å€‘æƒ³åœ¨è¨ªè«‡å‰ï¼Œå…ˆè«‹æ•™æ‚¨å¹¾å€‹é–‹æ”¾æ€§å•é¡Œï¼Œè®“æˆ‘å€‘èƒ½æ›´æ·±å…¥äº†è§£æ‚¨çš„æƒ³æ³•ã€‚</p>
                    
                    ${show_Q1 ? createTextArea('Q1_æƒ…å¢ƒé€£çµ', 'Q1. æ‚¨å¹³æ—¥æœƒæ“”å¿ƒå¯µç‰©é¤“è‚šå­çš„ä¸»è¦åŸå› æ˜¯ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šæ”¾ç½®é£¼æ–™æ’ä¸åˆ°ä¸‹ç­å›ä¾†å‰ã€é£²é£Ÿæ§åˆ¶ã€å¿˜è¨˜é¤µé£Ÿ...</span>') : ''}
                    
                    ${show_Q2 ? createTextArea('Q2_ç•¶å‰ç—›é»', 'Q2. æ‚¨å¹³æ—¥æœƒæ“”å¿ƒå¯µç‰©è£½é€ é«’äº‚ä¸»è¦åŸå› æ˜¯ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šå¯µç‰©æ´»åŠ›æ—ºç››ã€å¯µç‰©ç¿’æ…£ä¸å¥½ã€ä¸‹ç­å›ä¾†éƒ½è¦æ•´ç†...</span>') : ''}
                    
                    ${show_Q3 ? createTextArea('Q3_æœªæ»¿è¶³éœ€æ±‚', 'Q3. æ‚¨å¹³æ—¥æœƒæ“”å¿ƒå¯µç‰©å­¤å–®ç„¡èŠä¸»è¦åŸå› æ˜¯ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šå¾ˆé•·æ™‚é–“ç¨è‡ªåœ¨å®¶ã€æ™‚é–“ä¸å¤ é™ªä¼´ä»–...</span>') : ''}
                    
                    ${show_Q4 ? createTextArea('Q4_ç”¢å“æ¦‚å¿µ', 'Q4. æ‚¨å¹³æ—¥æœƒæ“”å¿ƒå¯µç‰©ç¡æ•´å¤©æ²’æœ‰æ´»å‹•ä¸»è¦åŸå› æ˜¯ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šçœ‹åˆ°å¯µç‰©æ™‚éƒ½æ˜¯åœ¨ç¡è¦ºã€å¹³æ—¥æ´»å‹•ç©ºé–“æœ‰é™...</span>') : ''}
                    
                    ${show_Q4 ? createTextArea('Q4.1_æå‡æ–¹æ³•', 'Q4.1 æ‰¿ä¸Šé¡Œï¼Œæ‚¨æ›¾ç¶“å˜—è©¦éç”šéº¼æ–¹æ³•æå‡å¯µç‰©æ´»å‹•é‡ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šå¸¶å‡ºé–€ã€è³¼è²·ç©å…·ã€è¦åŠƒæ´»å‹•ç©ºé–“...</span>') : ''}
                    
                    ${show_Q4 ? createTextArea('Q4.2_æ–¹æ³•æˆæ•ˆ', 'Q4.2 æ‰¿ä¸Šé¡Œï¼Œé‚£äº›æ–¹æ³•æœ‰æˆåŠŸå—ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šæœ‰ï¼Œä»–å€‘ç¾åœ¨å·²ç¶“è®Šå¾—æ›´æœ‰æ´»åŠ›ã€å¦ï¼Œç©ä¸€é™£å­å°±æ²’å†ç¢°äº†</span>') : ''}
                    
                    ${show_Q5 ? createTextArea('Q5_å¥åº·æ–¹æ³•', 'Q5. æ‚¨åœ¨å¯µç‰©' + (health_concerns ? health_concerns.replace(/ã€/g, 'ã€') : '') + 'å¥åº·å•é¡Œä¸Šæœ‰å“ªäº›æ–¹æ³•ï¼Ÿ<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šé£Ÿç‰©ã€ç”¨å“æ¸…æ½”ã€æ—¥å¸¸æ´»å‹•é‡ã€ä¿å¥é£Ÿå“...</span>') : ''}
                    
                    <!-- æ–°å¢ Q6ï¼šå®¶ç”¨é‹å‹•è¨­å‚™è³¼è²·æ„é¡˜ (æ¢ä»¶å·²ä¿®æ”¹) -->
                    ${show_Q6_new ? `
                    <div class="space-y-4 border p-4 rounded-lg bg-yellow-50/50">
                        <h3 class="text-lg font-bold text-gray-800">Q6. å®¶ç”¨é‹å‹•å¨›æ¨‚è¨­å‚™è³¼è²·æ„é¡˜</h3>
                        
                        <div class="w-full max-w-sm mx-auto overflow-hidden rounded-xl shadow-lg">
                           <img src="https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/%E5%AF%B5%E7%89%A9%E7%99%BC%E6%83%B3%E5%9C%96.png" 
                                alt="å®¶ç”¨å¯µç‰©é‹å‹•å¨›æ¨‚è¨­å‚™ç¤ºæ„åœ–" 
                                class="w-full h-auto object-cover"
                                onerror="this.onerror=null; this.src='https://placehold.co/400x250/3b82f6/ffffff?text=Image+Not+Found';">
                        </div>

                        <p class="text-gray-600 text-sm italic border-l-4 border-blue-400 pl-3 py-1">
                            æˆ‘å€‘æ­£åœ¨è¨­è¨ˆä¸€æ¬¾å®¶ç”¨é‹å‹•å¨›æ¨‚è¨­å‚™ï¼Œå¹«åŠ©å¯µç‰©åœ¨å®¶æ™‚ä¸æœƒæ„Ÿåˆ°ç„¡è¶£ï¼Œä»£æ›¿é£¼ä¸»åœ¨ç„¡æš‡æ™‚é™ªä¼´å¯µç‰©ã€‚å‹•ç‰©å°±åƒäººä¸€æ¨£ï¼Œé™¤äº†å¥åº·çš„é£²é£Ÿç¿’æ…£ï¼Œé‚„éœ€è¦æ­é…è¶³å¤ çš„æ´»å‹•é‡ï¼Œä¸åªèƒ½æ¸›å°‘æ©Ÿèƒ½è¡°é€€ã€å¢å¼·å¿ƒè‚ºï¼Œé‚„èƒ½è®“å¯µç‰©é é›¢æ…¢æ€§ç–¾ç—…èˆ‡å‚·ç—›ã€‚
                        </p>
                        
                        ${createTextArea('Q6_è³¼è²·æ„é¡˜', `æ‚¨é¡˜æ„ä»¥ **${priceText}** å…ƒè³¼è²·é€™æ¬¾ç”¢å“çš„ä¸»è¦åŸå› æ˜¯? æ‚¨æœŸè¨±æœ‰å“ªäº›ä¸»è¦æŠ€è¡“æˆ–é™„åŠ åŠŸèƒ½æ‰èƒ½å€¼å¾—æ‚¨çš„è³¼è²·?`)}
                    </div>
                    ` : ''}
                    
                    <!-- åŸ Q6 æ”¹ç‚º Q7 -->
                    ${createTextArea('Q7_è©¦ç”¨æ„é¡˜', 'Q7. æˆ‘å€‘æ˜¯å¦æœ‰æ©Ÿæœƒé‚€è«‹æ‚¨åƒèˆ‡æ¨£å“è©¦ç”¨ï¼Ÿè«‹ç•™ä¸‹æ‚¨çš„è¯çµ¡æ–¹å¼<br><span class="text-sm text-gray-500">ä¾‹å¦‚ï¼šLine IDã€æ‰‹æ©Ÿã€ä¿¡ç®±ã€IGã€FBç­‰ç¤¾ç¾¤å¸³è™Ÿ</span>')}
                    
                    ${!show_Q1 && !show_Q2 && !show_Q3 && !show_Q4 && !show_Q5 && !show_Q6_new ? '<p class="text-gray-600">æ ¹æ“šæ‚¨çš„ç­”æ¡ˆï¼Œé™¤äº†è©¦ç”¨æ„é¡˜å¤–ï¼Œç›®å‰æ²’æœ‰å…¶ä»–éœ€è¦è£œå……çš„è¨ªè«‡å•é¡Œã€‚</p>' : ''}
                </div>
                <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-end items-center">
                    <button id="finalInterviewSubmitButton" class="btn btn-primary">
                        å®Œæˆä¸¦æäº¤æ‰€æœ‰å•å· <i class="fas fa-check h-4 w-4 ml-2"></i>
                    </button>
                </div>
            `;
        }
        
        // --- æ¸²æŸ“å•å·æ­¥é©Ÿå…§å®¹ ---
        function renderStepContent(step) {
             switch (step) {
                case 0: return renderStep1();
                case 1: return renderStep2();
                case 2: return renderStep3();
                case 3: return renderStep4();
                case 4: return renderStep5();
                case 5: return renderStep6();
                case 6: return renderStep7();
    default: return `<p>éŒ¯èª¤ï¼šæœªçŸ¥çš„æ­¥é©Ÿ</p>`;
            }
        }
        
        // --- è¼”åŠ©å‡½æ•¸ ---
        
        // === ğŸš€ æ ¸å¿ƒä¿®æ”¹é»ï¼šå„ªåŒ–æ»‘æ¡¿ (Slider) çš„ HTML çµæ§‹ä»¥è§£æ±ºæ›è¡Œå•é¡Œ ===
        function createSlider(id, label, min, max, step, valueTextFn, defaultValue) {
            const currentValue = state.answers[id] || defaultValue || min;
            // é¡Œç›®ç¨ç«‹ä¸€è¡Œï¼Œç¢ºä¿æœ‰è¶³å¤ çš„æ›è¡Œç©ºé–“
            return `
                <div class="space-y-2 py-2" id="container-${id}"> 
                    <label class="font-medium text-gray-700 block">${label}</label>
                    <div class="flex items-center">
                        <!-- ç­”æ¡ˆé¡¯ç¤ºå€ï¼Œä½¿ç”¨ text-xl (æ¯”åŸä¾†çš„ text-lg æ›´å¤§) å’Œ mr-4 å¢åŠ è¦–è¦ºé‚Šè· -->
                        <span id="slider-value-${id}" class="text-xl font-bold text-blue-600 mr-4 whitespace-nowrap">
                            ${valueTextFn(currentValue)}
                        </span>
                        <!-- æ»‘æ¡¿ä½”ç”¨å‰©é¤˜ç©ºé–“ -->
                        <input type="range" data-id="${id}" id="${id}" min="${min}" max="${max}" step="${step}" value="${currentValue}"
                               data-valuetextfn="${encodeURIComponent(valueTextFn.toString())}" class="flex-grow">
                    </div>
                </div>
            `;
        }
        // =================================================================


        // é‡æ§‹ handleRangeInputï¼Œä½¿å…¶æˆç‚ºæ‰€æœ‰æ»‘æ¡¿äº‹ä»¶çš„çµ±ä¸€è™•ç†ä¸­å¿ƒ
        function handleRangeInput(el) {
            if (!el) return;
            const id = el.getAttribute('data-id');
            const val = el.value; // ä¿ç•™å­—ä¸²æˆ–æ•¸å­—
            state.answers[id] = val;

            // 1. æ›´æ–°å³ä¸Šè§’é¡¯ç¤ºå€¼
            const fnStr = el.getAttribute('data-valuetextfn');
            if (fnStr) {
                try {
                    const decoded = decodeURIComponent(fnStr);
                    const valueTextFn = eval('(' + decoded + ')'); // ä¿æŒåŸå§‹ç¨‹å¼ç¢¼ä¸­çš„ eval
                    const out = valueTextFn(val);
                    const labelEl = document.getElementById('slider-value-' + id);
                    if (labelEl && out != null) labelEl.textContent = out;
                } catch (e) { console.warn('valueTextFn åŸ·è¡ŒéŒ¯èª¤ for', id, e); }
            }

            // 2. ç‰¹ä¾‹ï¼š5.1 æˆ– 5.3 è®Šå‹•æ™‚ï¼Œæ›´æ–° 5.7
            if (id === '5.1_é£Ÿå“ä¿å¥èŠ±è²»' || id === '5.3_ç©å…·å¨›æ¨‚èŠ±è²»') {
                if (id === '5.1_é£Ÿå“ä¿å¥èŠ±è²»') {
                    // æ›´æ–° 5.1 çš„å¹´è²»ä¼°ç®—
                    const monthly = (val >= 30 ? 30000 : val * 1000);
                    const yearly = monthly * 12;
                    const yrEl = document.getElementById('yearly-5_1');
                    if (yrEl) yrEl.textContent = '$' + yearly.toLocaleString();
                }
                // è§¸ç™¼ 5.7 åŸºç¤å€¼é‡ç®—
                if (typeof update5_7BaseAmount === 'function') update5_7BaseAmount();
            }

            // 3. ç‰¹ä¾‹ï¼š1.2 è®Šå‹•æ™‚ï¼Œé‡æ–°æ¸²æŸ“å¹´é½¡æ»‘æ¡¿
            if (id === '1.2_é£¼é¤Šæ•¸é‡') {
                renderDynamicAgeSliders(val);
            }
            
            // 4. ç‰¹ä¾‹ï¼š6.4 é ç®—æ»‘æ¡¿è®Šå‹•æ™‚ï¼Œæ›´æ–°ç¸½å’Œ
            if (el.dataset.type === 'budget-slider') {
                updateBudgetTotal();
            }
        }

        // ä¿®æ”¹ï¼šæ–°å¢ gridClass é è¨­å€¼
        function createRadioGroup(id, label, options, gridClass = 'grid-cols-1 sm:grid-cols-2') {
            return `
                <div class="space-y-3">
                    <label class="font-medium text-gray-700 text-lg">${label}</label>
                    <div class="grid ${gridClass} gap-3" data-radio-group="${id}">
                        ${options.map((option, index) => `
                            <label class="radio-option">
                                <input type="radio" name="${id}" value="${option}" data-id="${id}">
                                ${option}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        function createYesNoBlock(id, label, yesText = 'æ˜¯', noText = 'å¦', yesIcon = 'fa-check', noIcon = 'fa-times') {
             return `
                <div class="space-y-3">
                    <label class="font-medium text-gray-700 text-lg">${label}</label>
                    <div class="grid grid-cols-2 gap-4" data-radio-group="${id}">
                        <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                            <input type="radio" name="${id}" value="${yesText}" class="hidden" data-id="${id}">
                            <i class="fas ${yesIcon} text-6xl text-green-400"></i>
                            <span class="block text-xl font-bold text-gray-700">${yesText}</span>
                        </label>
                        <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                            <input type="radio" name="${id}" value="${noText}" class="hidden" data-id="${id}">
                            <i class="fas ${noIcon} text-6xl text-red-400"></i>
                            <span class="block text-xl font-bold text-gray-700">${noText}</span>
                        </label>
                    </div>
                </div>
            `;
        }
        function createLikertSlider(id, label) {
            const currentValue = state.answers[id] !== undefined ? state.answers[id] : 2; // é è¨­ 'æ™®é€š'
            const currentText = likertValueToText(currentValue);
            const valueTextFnString = likertValueToText.toString();
            return createSlider(id, label, 0, 4, 1, createDynamicFunction(valueTextFnString), currentValue);
        }
        function createBudgetSlider(id, label) {
            const currentValue = state.answers[id] !== undefined ? state.answers[id] : 0;
            const currentText = budgetSliderValueToText(currentValue);
            const valueTextFnString = budgetSliderValueToText.toString();
            let sliderHTML = createSlider(id, label, -4, 4, 1, createDynamicFunction(valueTextFnString), currentValue);
            sliderHTML = sliderHTML.replace(
                '<input type="range" data-id', 
                '<input type="range" class="budget-slider" data-type="budget-slider" data-id'
            );
            return sliderHTML;
        }

        // --- å»ºç«‹ <textarea> ---
        function createTextArea(id, label) {
            const currentValue = state.answers[id] || '';
            return `
                <div class="space-y-3 py-2">
                    <label for="${id}" class="font-medium text-gray-700 text-lg">${label}</label>
                    <textarea id="${id}" data-id="${id}" class="text-input w-full" rows="4" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„æƒ³æ³•...">${currentValue}</textarea>
                    <p id="error-${id}" class="text-red-500 text-sm mt-1 hidden">è«‹å‹¿ç©ºç™½</p>
                </div>
            `;
        }

        // --- æ­¥é©Ÿ 1-6 çš„æ¸²æŸ“å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        
        function renderStep1() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬ä¸€éƒ¨åˆ†ï¼šé£¼ä¸»èˆ‡å¯µç‰©åŸºæœ¬èƒŒæ™¯</h2>
                    <div class="space-y-3">
                        <label class="font-medium text-gray-700 text-lg">1.1 æ‚¨çš„å¯µç‰©é¡å‹æ˜¯ï¼Ÿ(ä¸€ç¨®ä»¥ä¸Šå¯ä»¥å¤šå¯«å¹¾ä»½!)</label>
                        <!-- ä¿®æ”¹ï¼šæ–°å¢ "çš†æœ‰" é¸é …ï¼Œæ”¹ç‚º grid-cols-3 -->
                        <div class="grid grid-cols-3 gap-4" data-radio-group="1.1_å¯µç‰©é¡å‹">
                            <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                                <input type="radio" name="1.1_å¯µç‰©é¡å‹" value="çŠ¬" class="hidden" data-id="1.1_å¯µç‰©é¡å‹">
                                <i class="fas fa-dog text-6xl text-blue-400"></i>
                                <span class="block text-xl font-bold text-gray-700">çŠ¬</span>
                            </label>
                            <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                                <input type="radio" name="1.1_å¯µç‰©é¡å‹" value="è²“" class="hidden" data-id="1.1_å¯µç‰©é¡å‹">
                                <i class="fas fa-cat text-6xl text-blue-400"></i>
                                <span class="block text-xl font-bold text-gray-700">è²“</span>
                            </label>
                            <label class="pet-choice cursor-pointer p-4 bg-white rounded-lg shadow-sm border-2 border-gray-200 text-center space-y-2">
                                <input type="radio" name="1.1_å¯µç‰©é¡å‹" value="çš†æœ‰" class="hidden" data-id="1.1_å¯µç‰©é¡å‹">
                                <i class="fas fa-paw text-6xl text-blue-400"></i>
                                <span class="block text-xl font-bold text-gray-700">çš†æœ‰</span>
                            </label>
                        </div>
                    </div>
                    
                    ${createSlider('1.2_é£¼é¤Šæ•¸é‡', '1.2 æ‚¨ç¸½å…±é£¼é¤Šäº†å¹¾éš»çŠ¬/è²“ï¼Ÿ', 0, 2, 1, 
                        petCountValueToText,
                        0 // é è¨­å€¼ç‚º 0 (ä»£è¡¨ 1 éš»)
                    )}

                    <div class="space-y-4">
                        <label class="font-medium text-gray-700 text-lg">1.3 æ‚¨çš„å¯µç‰©ç›®å‰åˆ†åˆ¥å¹´é½¡ç‚ºå¹¾æ­²ï¼Ÿ</label>
                        <p class="text-sm text-gray-500">è«‹ç‚ºæ‚¨å®¶ä¸­æœ€å¹´é•· (å’Œæœ€å¹´å¹¼) çš„å¯µç‰©è¨­å®šå¹´é½¡å€é–“ã€‚</p>
                        <div id="dynamic-age-sliders" class="space-y-6">
                            </div>
                    </div>

                    <div class="space-y-3">
                        <label class="font-medium text-gray-700 text-lg">1.4 æ‚¨çš„å¯µç‰©ç›®å‰æœ‰å“ªäº›å¾Œå¤©æ€§å¥åº·éš±æ†‚ï¼Ÿï¼ˆè¤‡é¸ï¼‰</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="checkbox-group-1.4_å¥åº·éš±æ†‚">
                            <label class="checkbox-option">
                                <input type="checkbox" value="é«”æ…‹è‚¥èƒ–" data-id="1.4_å¥åº·éš±æ†‚">
                                <span>é«”æ…‹è‚¥èƒ–</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" value="è‚ŒåŠ›ä¸è¶³" data-id="1.4_å¥åº·éš±æ†‚">
                                <span>è‚ŒåŠ›ä¸è¶³</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" value="å¿ƒæƒ…ç„¦æ…®" data-id="1.4_å¥åº·éš±æ†‚">
                                <span>å¿ƒæƒ…ç„¦æ…®</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" value="å¿ƒè‚ºå•é¡Œ" data-id="1.4_å¥åº·éš±æ†‚">
                                <span>å¿ƒè‚ºå•é¡Œ</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" value="ä»¥ä¸Šçš†ç„¡" data-id="1.4_å¥åº·éš±æ†‚">
                                <span>ä»¥ä¸Šçš†ç„¡</span>
                            </label>
                        </div>
                        <p id="error-1.4_å¥åº·éš±æ†‚" class="text-red-500 text-sm mt-1 hidden">è«‹è‡³å°‘é¸æ“‡ä¸€é …</p>
                    </div>
                </div>
            `;
        }
        
        function renderStep2() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬äºŒéƒ¨åˆ†ï¼šæ‚¨èˆ‡å¯µç‰©çš„é—œä¿‚</h2>
                    <p class="text-gray-600">è«‹æ ¹æ“šæ‚¨èˆ‡å¯µç‰©çš„æ—¥å¸¸äº’å‹•ï¼Œè©•ä¼°æ‚¨å°ä»¥ä¸‹æè¿°çš„åŒæ„ç¨‹åº¦ã€‚</p>
                    <div class="space-y-6">
                        ${createLikertSlider('2.1_è¦–ç‚ºå®¶äºº', '2.1 æŠŠå¯µç‰©è¦–ç‚ºå®¶åº­çš„ä¸€ä»½å­ï¼Œè€Œä¸åƒ…åƒ…æ˜¯å‹•ç‰©ã€‚')}
                        ${createLikertSlider('2.2_åƒå­©å­', '2.2 å¯µç‰©å¾ˆå¤§ç¨‹åº¦ä¸Šæ‰®æ¼”è‘—åƒå­©å­ä¸€æ¨£çš„è§’è‰²ã€‚')}
                        ${createLikertSlider('2.3_å¡«è£œç©ºç¼º', '2.3 å¯µç‰©å¡«è£œäº†å®¶ä¸­å› å­å¥³ä¸åœ¨æ‰€ç•™ä¸‹çš„ç©ºç¼ºã€‚')}
                        ${createLikertSlider('2.4_æ„Ÿåˆ°ä¸å®‰', '2.4 æœƒç‚ºäº†å¯µç‰©ç”Ÿç—…ã€ä¸å¿«æ¨‚ã€å¯‚å¯è€Œæ„Ÿåˆ°ä¸å®‰ã€‚')}
                    </div>
                </div>
            `;
        }
        
        function renderStep3() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¹³æ—¥ä¸åœ¨å¯µç‰©èº«é‚Šæ™‚</h2>
                    <p class="text-gray-600">è«‹æ ¹æ“šæ‚¨çš„æ„Ÿå—ï¼Œè©•ä¼°æ‚¨å°ä»¥ä¸‹æè¿°çš„åŒæ„ç¨‹åº¦ã€‚</p>
                    <div class="space-y-6">
                        ${createLikertSlider('3.1_æ“”å¿ƒé¤“è‚šå­', '3.1 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©é¤“è‚šå­ï¼Ÿ')}
                        ${createLikertSlider('3.2_æ“”å¿ƒé«’äº‚', '3.2 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©è£½é€ é«’äº‚(å¤§å°ä¾¿ã€ç ´å£æˆ¿é–“)ï¼Ÿ')}
                        ${createLikertSlider('3.3_æ“”å¿ƒå­¤å–®', '3.3 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©å­¤å–®ç„¡èŠï¼Ÿ')}
                        ${createLikertSlider('3.4_æ“”å¿ƒæ²’æ´»å‹•', '3.4 æ‚¨æ˜¯å¦æœƒæ“”å¿ƒå¯µç‰©ç¡æ•´å¤©æ²’æœ‰æ´»å‹•ï¼Ÿ')}
                    </div>
                </div>
            `;
        }

        function renderStep4() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬å››éƒ¨åˆ†ï¼šå¹³æ—¥åœ¨å®¶èˆ‡å¯µç‰©ç›¸è™•æ™‚</h2>
                    <div class="space-y-6">
                        <!-- ä¿®æ”¹é¡Œç›®æ•˜è¿° -->
                        ${createLikertSlider('4.1_é¡˜æ„èŠ±æ™‚é–“', '4.1 æ‚¨åœ¨å®¶æ™‚ï¼Œæ˜¯å¦é¡˜æ„èŠ±è²»æ™‚é–“é™ªä¼´å¯µç‰©?')}
                        ${createLikertSlider('4.2_æ›¾ç„¡æ³•é™ªä¼´', '4.2 æ‚¨æ˜¯å¦æ›¾ç¶“åœ¨æŸæ—¥å› ç‚ºç”Ÿæ´»ä¸Šå—é™æ–¼æ™‚é–“ã€å¿ƒåŠ›ã€å€‹äººèˆˆè¶£ç­‰åŸå› ç„¡æ³•é™ªä¼´å¯µç‰©?')}
                        ${createSlider('4.3_ç„¡æ³•é™ªä¼´é »ç‡', '4.3 æ‚¨é‡åˆ°ä¸Šè¿°æƒ…æ³çš„é »ç‡æ¯å‘¨æ˜¯?', 0, 7, 1,
                            (v) => `${v} æ—¥`,
                            0
                        )}
                        ${createSlider('4.4_å¹³å‡é™ªä¼´æ™‚é–“', '4.4 æ‚¨å¹³å‡æ¯æ—¥èŠ±è²»å¤šå°‘æ™‚é–“é™ªä¼´å¯µç‰©ç©æ¨‚ã€æ•£æ­¥?', 0, 5, 1,
                            (v) => v >= 5 ? '5+ å°æ™‚' : `${v} å°æ™‚`,
                            0
                        )}
                        ${createSlider('4.5_ç„¡é™é™ªä¼´æ™‚é–“', '4.5 åœ¨ç”Ÿæ´»ä¸Šæ²’æœ‰å—é™æ™‚ï¼Œæ‚¨é¡˜æ„æ¯æ—¥èŠ±è²»å¤šå°‘æ™‚é–“é™ªä¼´å¯µç‰©ç©æ¨‚ã€æ•£æ­¥?', 0, 5, 1,
                            (v) => v >= 5 ? '5+ å°æ™‚' : `${v} å°æ™‚`,
                            0
                        )}
                    </div>
                </div>
            `;
        }
        
function renderStep5() {
  // ç¢ºä¿ 5.7 çš„è¨ˆç®—åœ¨ DOM æ¸²æŸ“å¾ŒåŸ·è¡Œ
  setTimeout(() => {
    if (typeof update5_7BaseAmount === 'function') update5_7BaseAmount();
  }, 100); // ç¨å¾®å»¶é²

  return `
    <div class="page-section active space-y-6">
      <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬äº”éƒ¨åˆ†ï¼šå¯µç‰©ç”Ÿæ´»å“è³ªæŠ•å…¥</h2>

      ${createSlider('5.1_é£Ÿå“ä¿å¥èŠ±è²»', '5.1 æ¯æœˆèŠ±è²»åœ¨ã€Œå¯µç‰©é£Ÿå“èˆ‡ä¿å¥å“ã€çš„é‡‘é¡ç´„ï¼Ÿ', 0, 30, 1,
        v => v >= 30 ? '$30,000+' : `$${(v * 1000).toLocaleString()}`, 0)}
      <div class="text-sm text-gray-500 text-right pr-2">å¹´èŠ±è²»ä¼°ç®—ï¼š
        <span id="yearly-5_1" class="text-blue-600 font-medium">$0</span>
      </div>

      ${createLikertSlider('5.2_æŒ‘é¸å¥åº·å“', '5.2 æ‚¨æ˜¯å¦æœ‰æ„æŒ‘é¸è¼ƒå¥åº·é¡å‹çš„é£Ÿå“æˆ–ä¿å¥å“ï¼Ÿ')}

      ${createSlider('5.3_ç©å…·å¨›æ¨‚èŠ±è²»', '5.3 æ¯å¹´èŠ±è²»åœ¨ã€Œå¯µç‰©ç©å…·ã€å¨›æ¨‚ç”¨å“ã€ç­‰éé£Ÿå“é¡çš„é‡‘é¡ç´„ï¼Ÿ', 0, 30, 1,
        v => v >= 30 ? '$30,000+' : `$${(v * 1000).toLocaleString()}`, 0)}

      ${createSlider('5.4_æœ€é«˜ç”¢å“é‡‘é¡', '5.4 æ‚¨æ›¾ç¶“è³¼è²·éçš„å¯µç‰©ç”¢å“æœ€é«˜é‡‘é¡å¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ', 0, 30, 1,
        v => v >= 30 ? '$30,000+' : `$${(v * 1000).toLocaleString()}`, 0)}

      ${createYesNoBlock('5.5_è³¼è²·æ´»å‹•ç”¢å“', '5.5 æ‚¨æ˜¯å¦æ›¾ç¶“è³¼è²·éä»»ä½•ä¿ƒé€²å¯µç‰©æ´»å‹•çš„ç”¢å“(ç©å…·ã€çˆ¬æ¶ã€å®¶å…·)ï¼Ÿ', 'æ˜¯', 'å¦')}
      
      <div id="container-5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡" style="display: none;">
        ${createSlider('5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡', '5.6 è©²ç”¨é€”çš„ç”¢å“æœ€é«˜é‡‘é¡å¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ', 0, 30, 1,
          v => v >= 30 ? '$30,000+' : `$${(v * 1000).toLocaleString()}`, 0)}
      </div>


      <div class="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="font-medium text-gray-700 text-lg">
          5.7 æ‚¨æ¯å¹´é¡˜æ„åœ¨å¯µç‰©èº«ä¸ŠæŠ•å…¥çš„é‡‘é¡å¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ
        </h3>
        <p class="text-sm text-gray-500">
          æ ¹æ“šæ‚¨5.1ã€5.3çš„å›ç­”è‡ªå‹•è¨ˆç®—:
          <strong id="calc-base-amount" class="text-blue-600">$0</strong>
        </p>
        <p class="text-sm text-gray-500">å¯é€éæ»‘æ¡¿èª¿æ•´å¢æ¸›é‡‘é¡ï¼š</p>

        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <label class="font-medium text-gray-700">èª¿æ•´é‡‘é¡</label>
            <span id="slider-value-5.7_å¹´åº¦ç¸½æŠ•å…¥"
                  class="text-lg font-bold text-blue-600">$0</span>
          </div>
          <input type="range" id="slider-5_7" min="-15" max="15" step="1" 
                 value="${state.answers['5.7_å¹´åº¦èª¿æ•´'] || 0}"
                 oninput="update5_7Slider(this.value)">
          <div class="flex justify-between text-sm text-gray-500">
            <span>-$15,000</span><span>$0</span><span>+$15,000</span>
          </div>
        </div>

        <div class="mt-4 text-center p-4 bg-white rounded-lg shadow-inner">
          <div class="text-sm text-gray-600">æœ€çµ‚å¹´åº¦æŠ•å…¥é‡‘é¡</div>
          <div id="final-yearly-amount" class="text-2xl font-bold text-blue-600">$0</div>
        </div>
      </div>
    </div>
  `;
}

// === 5.7 è¨ˆç®—é‚è¼¯ (ä¿æŒä¸è®Š) ===
function update5_7BaseAmount() {
  const v5_1 = parseInt(state.answers['5.1_é£Ÿå“ä¿å¥èŠ±è²»'] || 0);
  const v5_3 = parseInt(state.answers['5.3_ç©å…·å¨›æ¨‚èŠ±è²»'] || 0);

  const monthly = v5_1 >= 30 ? 30000 : v5_1 * 1000;
  const yearlyToys = v5_3 >= 30 ? 30000 : v5_3 * 1000;
  const base = (monthly * 12) + yearlyToys;

  const baseEl = document.getElementById('calc-base-amount');
  if (baseEl) baseEl.textContent = `$${base.toLocaleString()}`;

  // ç¢ºä¿ 5.1 çš„å¹´è²»ä¹ŸåŒæ­¥æ›´æ–°
  const yearEl = document.getElementById('yearly-5_1');
  if (yearEl) yearEl.textContent = `$${(monthly * 12).toLocaleString()}`;

  state.answers['5.7_åŸºæº–é‡‘é¡'] = base;
  update5_7FinalAmount(); // ç¢ºä¿åŸºç¤å€¼è®Šå‹•æ™‚ï¼Œæœ€çµ‚å€¼ä¹Ÿæ›´æ–°
}

function update5_7Slider(value) {
  const v = parseInt(value);
  state.answers['5.7_å¹´åº¦èª¿æ•´'] = v; // å„²å­˜æ»‘æ¡¿ä½ç½® (-15 ~ 15)
  const adjEl = document.getElementById('slider-value-5.7_å¹´åº¦ç¸½æŠ•å…¥');
  if (adjEl) {
    const amount = v * 1000;
    adjEl.textContent = v === 0 ? '$0'
      : (v > 0 ? `+$${amount.toLocaleString()}` : `-$${Math.abs(amount).toLocaleString()}`);
  }
  update5_7FinalAmount();
}

function update5_7FinalAmount() {
  const base = parseInt(state.answers['5.7_åŸºæº–é‡‘é¡'] || 0);
  const adj = parseInt(state.answers['5.7_å¹´åº¦èª¿æ•´'] || 0);
  const total = base + (adj * 1000);

  const finalEl = document.getElementById('final-yearly-amount');
  if (finalEl) finalEl.textContent = `$${total.toLocaleString()}`;

  // å„²å­˜æœ€çµ‚è¨ˆç®—å€¼ï¼Œç”¨æ–¼é©—è­‰
  state.answers['5.7_å¹´åº¦ç¸½æŠ•å…¥'] = total; 
}

        function renderStep6() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬å…­éƒ¨åˆ†ï¼šæ¶ˆè²»è€ƒé‡</h2>
                    
                    ${createRadioGroup('6.1_ä¸å¥½ç¶“é©—', '6.1 åœ¨ç‚ºå¯µç‰©è³¼è²·è¼ƒæ˜‚è²´çš„ç”¨å“æ™‚ï¼Œæ‚¨æ˜¯å¦æ›¾æœ‰éä¸å¥½çš„ç¶“é©—ï¼Ÿ', 
                        ['ç¶“å¸¸æœ‰', 'å¶çˆ¾æœ‰', 'å¹¾ä¹æ²’æœ‰', 'å¾æœªè³¼è²·éæ˜‚è²´ç”¨å“']
                    )}

                    ${createYesNoBlock('6.2_é¡˜æ„æ·»è³¼', '6.2 æ‚¨ç„¡æ³•é™ªä¼´å¯µç‰©æ™‚ï¼Œæ˜¯å¦é¡˜æ„æ·»è³¼å¯ä»¥é™ªä¼´å¯µç‰©ã€å¢åŠ æ´»å‹•çš„å®¶ç”¨ç”¢å“ï¼Ÿ', 'æ˜¯', 'å¦', 'fa-check', 'fa-times')}

                    <div id="container-6.3_é¡˜æ„è³¼è²·é‡‘é¡" style="display: none;">
                        ${createSlider('6.3_é¡˜æ„è³¼è²·é‡‘é¡', '6.3 æ‚¨é¡˜æ„è³¼è²·çš„é‡‘é¡ç‚ºï¼Ÿ', 0, 30, 1,
                        (v) => {
                            if (v == 0) return '$0';
                            if (v >= 30) return '$30,000+';
                            return `$${(v * 1000).toLocaleString()}`;
                        },
                        0
                    )}
                    </div>

                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- æ›´æ–° 6.4 æ¨™é¡Œå’Œé ç®— -->
                        <h3 class="font-medium text-gray-700 text-lg">6.4 å¦‚æœæ‚¨ç”¨12,000å…ƒé¸è³¼ä¸€é …å¯µç‰©ç”¨å“æ™‚ï¼Œæ‚¨æœ€é‡è¦–èŠ±éŒ¢æŠ•è³‡çš„åŠŸèƒ½æ˜¯ï¼Ÿ</h3>
                        <p class="text-sm text-gray-500">è«‹å·¦å³æ‹‰å‹•æ»‘æ¡¿ï¼Œåˆ†é…æ‚¨çš„ 12,000 å…ƒé ç®—ã€‚æ­£å€¼ä»£è¡¨å¢åŠ é ç®—ï¼Œè² å€¼ä»£è¡¨æ¸›å°‘é ç®—ã€‚</p>
                        
                        <div class="text-center py-4">
                            <span class="text-gray-600 text-lg">å‰©é¤˜/è¶…å‡º é ç®—</span>
                            <div id="budget-total-display" class="text-4xl font-bold text-blue-600">NT$ 12,000</div>
                        </div>

                        <div id="budget-sliders-container" class="space-y-6">
                            ${createBudgetSlider('6.4_é–‹å¿ƒä½¿ç”¨', 'å¯µç‰©èƒ½é–‹å¿ƒä½¿ç”¨')}
                            ${createBudgetSlider('6.4_å®‰å…¨ä½¿ç”¨', 'å¯µç‰©èƒ½å®‰å…¨ä½¿ç”¨')}
                            ${createBudgetSlider('6.4_ç¯€çœæ™‚é–“', 'ç¯€çœé£¼ä¸»æ™‚é–“ã€ç²¾åŠ›')}
                            ${createBudgetSlider('6.4_æŒä¹…è€ç”¨', 'ç”¢å“æŒä¹…è€ç”¨')}
                            ${createBudgetSlider('6.4_å®¹æ˜“æ¸…æ½”', 'ç”¢å“å®¹æ˜“æ¸…æ½”æ•´ç†')}
                            <!-- æ–°å¢ 6.4_ç¯€çœç©ºé–“ -->
                            ${createBudgetSlider('6.4_ç¯€çœç©ºé–“', 'ç”¢å“èƒ½æœ‰æ•ˆç¯€çœç©ºé–“')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // === 6.4 ç¸½å’Œè¨ˆç®—é‚è¼¯æ›´æ–° ===
        function updateBudgetTotal() {
            // æ–°å¢ 6.4_ç¯€çœç©ºé–“
            const budgetIds = [
                '6.4_é–‹å¿ƒä½¿ç”¨', '6.4_å®‰å…¨ä½¿ç”¨', '6.4_ç¯€çœæ™‚é–“', '6.4_æŒä¹…è€ç”¨', '6.4_å®¹æ˜“æ¸…æ½”', '6.4_ç¯€çœç©ºé–“' 
            ];
            let sum = 0;
            budgetIds.forEach(id => {
                sum += parseInt(state.answers[id] || 0, 10);
            });
            const BASE_BUDGET = 12000; // **ä¿®æ”¹ç‚º 12000 å…ƒ**
            
            // ç¸½é ç®—æ‡‰ç‚º 12000 + èª¿æ•´å€¼ (èª¿æ•´å€¼ç‚º sum * 500)
            const remaining = BASE_BUDGET - (sum * 500); 
            const displayEl = document.getElementById('budget-total-display');
            if (!displayEl) return;

            displayEl.textContent = `NT$ ${remaining.toLocaleString()}`;
            displayEl.classList.remove('text-blue-600', 'text-red-500', 'text-yellow-600');
            
            if (remaining < 0) {
                displayEl.textContent = `è¶…å‡º NT$ ${Math.abs(remaining).toLocaleString()}`;
                displayEl.classList.add('text-red-500');
            } else if (remaining > 0) {
                 displayEl.textContent = `å‰©é¤˜ NT$ ${remaining.toLocaleString()}`;
                displayEl.classList.add('text-yellow-600');
            } else {
                 displayEl.textContent = 'NT$ 0 (åˆ†é…å®Œç•¢)';
                displayEl.classList.add('text-blue-600');
            }
        }
        // === 6.4 ç¸½å’Œè¨ˆç®—é‚è¼¯æ›´æ–°çµæŸ ===


        // --- æ­¥é©Ÿä¸€ (æ ¡æ­£)ï¼šæ›¿æ› renderStep7 å‡½æ•¸ ---
        function renderStep7() {
             return `
                <div class="page-section active space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå€‹äººåŸºæœ¬è³‡è¨Š</h2>
                    
                    ${createRadioGroup('7.1_æ€§åˆ¥', '7.1 æ‚¨çš„æ€§åˆ¥ï¼Ÿ', 
                        ['ç”·æ€§', 'å¥³æ€§', 'å…¶ä»–']
                    )}
                    
                    ${createRadioGroup('7.2_å¹´é½¡', '7.2 æ‚¨çš„å¹´é½¡å€é–“ï¼Ÿ', 
                        ['24æ­²ä»¥ä¸‹', '25-34æ­²', '35-44æ­²', '45-54æ­²', '55æ­²ä»¥ä¸Š'],
                        'grid-cols-1 sm:grid-cols-3'
                    )}

                    ${createYesNoBlock('7.3_æœ‰ä¼´ä¾¶', '7.3 æ‚¨æ˜¯å¦æœ‰ä¼´ä¾¶ï¼ˆç”·å¥³æœ‹å‹ã€å¤«å¦»ï¼‰ï¼Ÿ', 'æ˜¯', 'å¦')}
                    
                    ${createYesNoBlock('7.4_ç¨å±…', '7.4 æ‚¨æ˜¯å¦ç¨è‡ªå±…ä½ï¼Ÿ', 'æ˜¯', 'å¦')}

                    ${createRadioGroup('7.5_å±…ä½å‹æ…‹', '7.5 æ‚¨çš„å±…ä½å‹æ…‹ç‚ºï¼Ÿ', 
                        ['å–®é–“(3-10åª)', 'å¤šé–“(å«å®¢å»³)', 'é€å¤©(ç¨æ£Ÿ)', 'åˆ¥å¢…(æœ‰åº­é™¢)']
                    )}

                    ${createYesNoBlock('7.6_å­å¥³', '7.6 æ‚¨æ˜¯å¦æœ‰å­å¥³ï¼Ÿ', 'æœ‰', 'ç„¡')}

                    ${createYesNoBlock('7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯', '7.7 æ‚¨æ˜¯å¦æœ‰å¯µç‰©ç›¸é—œèƒŒæ™¯ï¼ˆä¾‹å¦‚ï¼šç¸é†«ã€ç¾å®¹ã€è¨“ç·´ç­‰ï¼‰ï¼Ÿ', 'æ˜¯', 'å¦')}

                    ${createSlider('7.8_å¯æ”¯é…æ¶ˆè²»é¡', '7.8 æ‚¨å€‹äººæ¯æœˆå¹³å‡å¯æ”¯é…æ¶ˆè²»é¡ï¼ˆæ‰£é™¤è²¸æ¬¾ã€ç”Ÿæ´»æ—¥å¸¸ç­‰ï¼‰ï¼Ÿ', 1, 10, 1,
                        (v) => v >= 10 ? '10+è¬' : `${v}è¬`,
                        1
                    )}
                </div>
            `;
        }
        
        function renderDynamicAgeSliders(petCountValue) {
            const container = document.getElementById('dynamic-age-sliders');
            if (!container) return;
            
            const countIndex = parseInt(petCountValue, 10); // 0: '1', 1: '2', 2: '2+'
            let html = '';

            if (countIndex === 0) { // åªæœ‰ 1 éš»
                const id = '1.3_Age_Oldest';
                const label = 'å¯µç‰©å¹´é½¡';
                html = createSlider(id, label, 0, 4, 1, ageValueToText, state.answers[id] || 0); 
            } else { // 2 éš»æˆ– 2+ éš»
                const idOldest = '1.3_Age_Oldest';
                const labelOldest = 'æœ€å¹´é•·å¯µç‰©å¹´é½¡';
                const idYoungest = '1.3_Age_Youngest';
                const labelYoungest = 'æœ€å¹´å¹¼å¯µç‰©å¹´é½¡';
                html = createSlider(idOldest, labelOldest, 0, 4, 1, ageValueToText, state.answers[idOldest] || 0);
                html += createSlider(idYoungest, labelYoungest, 0, 4, 1, ageValueToText, state.answers[idYoungest] || 0);
            }
            
            container.innerHTML = html;
            
            // ç‚ºæ–°ç”¢ç”Ÿçš„æ‹‰æ¡¿åŠ ä¸Šäº‹ä»¶ç›£è½å’Œåˆå§‹å€¼
            container.querySelectorAll('input[type="range"]').forEach(slider => {
                const id = slider.dataset.id;
                // ç¢ºä¿ state ä¸­æœ‰é è¨­å€¼
                if (!state.answers[id]) {
                     state.answers[id] = '0';
                }
                
                // ç¢ºä¿å‹•æ…‹ç”¢ç”Ÿçš„æ»‘æ¡¿ä¹Ÿä½¿ç”¨çµ±ä¸€çš„ handleRangeInput
                slider.oninput = (e) => {
                    handleRangeInput(e.target);
                };
                
                // è§¸ç™¼ä¸€æ¬¡ input ä¾†æ›´æ–°é¡¯ç¤º
                slider.dispatchEvent(new Event('input', { bubbles: true }));
            });
        }

        // --- æ¸²æŸ“ç­”æ¡ˆæ‘˜è¦ (å·²æ›´æ–° ID) ---
        function renderAnswerSummary() {
            const container = document.getElementById('answer-summary');
            if (!container) return;
            let html = '<div class="space-y-1 text-sm">';
            
            // ä½¿ç”¨ QUESTION_MAP ä¾†ç¢ºä¿é †åºå’Œå®Œæ•´æ€§
            for (const [id, question] of Object.entries(QUESTION_MAP)) {
                let answer = state.answers[id];
                
                // éš±è—ä¸æ‡‰é¡¯ç¤ºçš„é¡Œç›®
                if (id.startsWith('5.7_') && id !== '5.7_å¹´åº¦ç¸½æŠ•å…¥') continue; // éš±è— 5.7 è¨ˆç®—éç¨‹
                
                // éš±è— Qsï¼šåªæœ‰åœ¨ consent ç‚º 'é¡˜æ„' æˆ– 'æ¥å—æ–‡å­—è¨ªå•' æ™‚æ‰é¡¯ç¤º Qs (Q1~Q7)
                if (id.startsWith('Q') && !(state.interviewConsent === 'é¡˜æ„' || state.interviewConsent === 'æ¥å—æ–‡å­—è¨ªå•')) continue;
                if (id === '1.3_Age_Youngest' && (state.answers['1.2_é£¼é¤Šæ•¸é‡'] || '0') === '0') continue; // éš±è—å–®éš»å¯µç‰©çš„ 'æœ€å¹´å¹¼'
                // éš±è— 8.1/8.2ï¼šåªæœ‰åœ¨ consent ç‚º 'é¡˜æ„' æˆ– 'æ¥å—æ–‡å­—è¨ªå•' æ™‚æ‰é¡¯ç¤º
                if (['8.1_é¡˜æ„å—è¨ª', '8.2_è¯çµ¡è³‡è¨Š'].includes(id) && !(state.interviewConsent === 'é¡˜æ„' || state.interviewConsent === 'æ¥å—æ–‡å­—è¨ªå•')) continue; 
                if (id === '6.3_é¡˜æ„è³¼è²·é‡‘é¡' && state.answers['6.2_é¡˜æ„æ·»è³¼'] === 'å¦') continue; // éš±è— 6.3
                if (id === '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡' && state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] === 'å¦') continue; // éš±è— 5.6
                if (id === '8.1_é¡˜æ„å—è¨ª' && state.interviewConsent === 'æ¥å—æ–‡å­—è¨ªå•') answer = 'æ¥å—æ–‡å­—è¨ªå• (ç°¡æ˜“è¨ªè«‡)'; // ç‰¹åˆ¥æ¨™è¨˜
                
                // Q6 æ ¹æ“š 6.2 ç­”æ¡ˆæ±ºå®šæ˜¯å¦é¡¯ç¤º
                const isQ6Conditional = id === 'Q6_è³¼è²·æ„é¡˜';
                const is62Agreed = state.answers['6.2_é¡˜æ„æ·»è³¼'] === 'æ˜¯';
                if (isQ6Conditional && !is62Agreed) continue;


                if (answer === undefined || answer === null || answer === '') {
                     answer = 'N/A'; // æœªå¡«ç­”
                }

                // æ ¼å¼åŒ–ç­”æ¡ˆ
                try {
                    if (id === '1.2_é£¼é¤Šæ•¸é‡') {
                        answer = petCountValueToText(answer);
                    } else if (id === '1.3_Age_Oldest' || id === '1.3_Age_Youngest') {
                        answer = ageValueToText(answer);
                    } 
                    // Likert é¡Œç›®çš„ ID åˆ¤æ–·
                    else if (id.startsWith('2.') || id.startsWith('3.') || ['4.1_é¡˜æ„èŠ±æ™‚é–“', '4.2_æ›¾ç„¡æ³•é™ªä¼´', '5.2_æŒ‘é¸å¥åº·å“'].includes(id)) { 
                        answer = likertValueToText(answer);
                    } 
                    else if (id === '4.3_ç„¡æ³•é™ªä¼´é »ç‡') {
                        answer = `${answer} æ—¥`;
                    } else if (id === '4.4_å¹³å‡é™ªä¼´æ™‚é–“' || id === '4.5_ç„¡é™é™ªä¼´æ™‚é–“') {
                        answer = (answer >= 5) ? '5+ å°æ™‚' : `${answer} å°æ™‚`;
                    } else if (['5.1_é£Ÿå“ä¿å¥èŠ±è²»', '5.3_ç©å…·å¨›æ¨‚èŠ±è²»', '5.4_æœ€é«˜ç”¢å“é‡‘é¡', '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡', '6.3_é¡˜æ„è³¼è²·é‡‘é¡'].includes(id)) {
                        answer = (answer == 0) ? '$0' : (answer >= 30 ? '$30,000+' : `$${(answer * 1000).toLocaleString()}`);
                    } else if (id === '5.7_å¹´åº¦ç¸½æŠ•å…¥') {
                        answer = `$${parseInt(answer, 10).toLocaleString()}`;
                    } else if (id.startsWith('6.4_')) {
                        answer = budgetSliderValueToText(answer);
                    } else if (id === '8.1_é¡˜æ„å—è¨ª') { // ä½¿ç”¨ 8.1
                        answer = state.interviewConsent; 
                    } else if (id === '8.2_è¯çµ¡è³‡è¨Š') { // ä½¿ç”¨ 8.2
                        answer = state.contactInfo; 
                    } else if (id.startsWith('Q')) { 
                        answer = `<pre>${answer}</pre>`; 
                    }
                } catch (e) {
                    console.warn(`è½‰æ›ç­”æ¡ˆæ™‚å‡ºéŒ¯ (ID: ${id}):`, e);
                    answer = state.answers[id] || 'N/A';
                }
                html += `<div><strong>${question}:</strong> <span>${answer}</span></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        // --- è™•ç† PNG ä¸‹è¼‰ (ä¿æŒä¸è®Š) ---
        async function handleDownloadPng() { 
            const button = document.getElementById('downloadPngButton');
            const summaryElement = document.getElementById('answer-summary');
            if (!summaryElement || !button) return;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin h-4 w-4 mr-2"></i> åœ–ç‰‡ç”¢ç”Ÿä¸­...';

            const originalMaxHeight = summaryElement.style.maxHeight;
            const originalOverflowY = summaryElement.style.overflowY;
            summaryElement.style.maxHeight = 'none';
            summaryElement.style.overflowY = 'visible';

            try {
                const canvas = await html2canvas(summaryElement, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: '#ffffff' 
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `pet-survey-summary-${state.uniqueID.substring(0, 8)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("PNG ç”¢ç”Ÿå¤±æ•—:", err);
                button.innerHTML = '<i class="fas fa-times h-4 w-4 mr-2"></i> ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹é‡è©¦';
            } finally {
                summaryElement.style.maxHeight = originalMaxHeight;
                summaryElement.style.overflowY = originalOverflowY;
                button.disabled = false;
                if (!button.innerHTML.includes('ç”¢ç”Ÿå¤±æ•—')) {
                    button.innerHTML = '<i class="fas fa-download h-4 w-4 mr-2"></i> ä¸‹è¼‰ç­”æ¡ˆæ‘˜è¦ (PNG)';
                }
            }
        }
        
        // --- 2. æ–°å¢ï¼šè™•ç†åˆ†äº«æŒ‰éˆ•é»æ“Šçš„å‡½å¼ ---
        async function handleShare() {
            const shareText = "Hi ~é€™æ˜¯ä»½é—œæ–¼ã€å¯µç‰©å¥åº·ç®¡ç†èˆ‡å¨›æ¨‚ã€‘çš„å¸‚å ´èª¿æŸ¥\né»é¸é€£çµä½œç­”å–”~https://tinyurl.com/yc2htzfc";
            
            try {
                // å˜—è©¦ä½¿ç”¨ç¾ä»£çš„ Clipboard API
                await navigator.clipboard.writeText(shareText);
                showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "info");
            } catch (err) {
                console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                // å‚™ç”¨æ–¹æ¡ˆ (é©ç”¨æ–¼ http æˆ–èˆŠç‰ˆç€è¦½å™¨)
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = shareText;
                    textArea.style.position = "fixed";  // é¿å…æ»¾å‹•
                    textArea.style.top = 0;
                    textArea.style.left = 0;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "info");
                } catch (fallbackErr) {
                     console.error('å‚™ç”¨è¤‡è£½æ–¹æ¡ˆå¤±æ•—: ', fallbackErr);
                     showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", "error");
                }
            }
        }


        // --- é¡¯éš± 6.3 è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        function toggleQuestion5_3(value) {
            const container5_3 = document.getElementById('container-6.3_é¡˜æ„è³¼è²·é‡‘é¡');
            const slider5_3 = document.getElementById('6.3_é¡˜æ„è³¼è²·é‡‘é¡');

            if (value === 'æ˜¯') {
                if (container5_3) container5_3.style.display = 'block';
            } else { // 'å¦' æˆ– undefined
                if (container5_3) container5_3.style.display = 'none';
                
                // å°‡ 6.3 çš„å€¼é‡è¨­ç‚º '0'
                state.answers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = '0';
                
                if (slider5_3) {
                    slider5_3.value = '0';
                    slider5_3.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }
        
        // --- é¡¯éš± 5.6 è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        function toggleQuestion5_6(value) {
            const container = document.getElementById('container-5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡');
            const slider = document.getElementById('5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡');

            if (value === 'æ˜¯') {
                if (container) container.style.display = 'block';
            } else { // 'å¦' æˆ– undefined
                if (container) container.style.display = 'none';
                
                // å°‡ 5.6 çš„å€¼é‡è¨­ç‚º '0'
                state.answers['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] = '0';
                
                if (slider) {
                    slider.value = '0';
                    slider.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }


        // --- äº‹ä»¶ç›£è½å™¨ (ä¿®æ”¹ï¼šåœ¨é‡æ–°å¡«å¯«æ™‚æ¸…é™¤ UniqueID) ---
        
        function attachStartListeners() {
             document.getElementById('startButton').onclick = () => {
                const input = document.getElementById('reference-input');
                const errorEl = document.getElementById('reference-error');
                const referenceValue = input.value.trim();
                
                if (referenceValue === '') {
                    errorEl.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    input.focus();
                } else {
                    errorEl.classList.add('hidden');
                    input.classList.remove('border-red-500');
                    state.answers['Reference'] = referenceValue;
                    setState({ page: 'survey', startTime: Date.now() });
                }
            };
            
            const input = document.getElementById('reference-input');
            if(input) {
                input.oninput = () => {
                    document.getElementById('reference-error').classList.add('hidden');
                    input.classList.remove('border-red-500');
                };
            }
        }
        
        
        
        function attachEndListeners() {
            const restartButton = document.getElementById('restartButton');
            if (restartButton) {
                restartButton.onclick = async () => { // é€™è£¡æ”¹æˆ async
                    // **æ–°å¢é‚è¼¯ï¼šåœ¨é‡ç½®å•å·ç‹€æ…‹å‰ï¼Œæ¸…é™¤ UniqueID**
                    clearUniqueID(); 
                    
                    // é‡ç½®ç‹€æ…‹
                    state = {
                        page: 'start', currentStep: 0, answers: {},
                        submissionStatus: 'idle', startTime: null, uniqueID: getOrSetUniqueID(), // é‡æ–°ç²å–æ–°çš„ ID
                        showInterviewModal: false, interviewConsent: null, contactInfo: ''
                    };
                    render();
                    
                    // **æ–°å¢ï¼šé‡æ–°è¼‰å…¥äººæ•¸é¡¯ç¤º**
                    const totalCount = await getSurveyCount();
                    const countEl = document.getElementById('current-total-count');
                    if (countEl) {
                        countEl.textContent = totalCount.toLocaleString();
                    }
                };
            }

            // textInterviewButton çš„ onclick é‚è¼¯
            const textInterviewButton = document.getElementById('textInterviewButton');
            if (textInterviewButton) {
                textInterviewButton.onclick = () => {
                    // 1. ç´€éŒ„ consent ç‹€æ…‹
                    //    é€™æœƒè¢« renderInterviewModal() ç”¨ä¾†åˆ¤æ–·æ˜¯å¦è¦è·³é S1
                    state.interviewConsent = 'æ¥å—æ–‡å­—è¨ªå•';
                    
                    // 2. è¿”å› 'survey' é é¢ä¸¦é¡¯ç¤ºå½ˆçª—
                    //    é€™æœƒè§¸ç™¼ render() -> renderSurveyPage() + renderInterviewModal()
                    setState({ 
                        page: 'survey', 
                        showInterviewModal: true 
                    });
                };
            }

            const downloadButton = document.getElementById('downloadPngButton');
            if (downloadButton) {
                renderAnswerSummary(); // ç¢ºä¿æ‘˜è¦å·²æ¸²æŸ“
                downloadButton.onclick = handleDownloadPng;
            }
            
            // 3. ç¶å®šåˆ†äº«æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            const shareButton = document.getElementById('shareButton');
            if (shareButton) {
                shareButton.onclick = handleShare;
            }
        }


        
        // è¼”åŠ©å‡½æ•¸
        function handle6_2Change(value) {
            const container = document.getElementById('container-6.3_é¡˜æ„è³¼è²·é‡‘é¡');
            if (container) {
                if (value === 'æ˜¯') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    // å°‡ 6.3 é‡è¨­ç‚º 0
                    state.answers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = '0';
                    const slider = document.getElementById('6.3_é¡˜æ„è³¼è²·é‡‘é¡');
                    if (slider) {
                        slider.value = '0';
                        slider.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        }
        
        function attachSurveyListeners() {
            
            // æ¢å¾© 1.4 å¥åº·éš±æ†‚çš„è¤‡é¸æ¡†ç‹€æ…‹
            const healthConcerns = state.answers['1.4_å¥åº·éš±æ†‚'];
            if (healthConcerns) {
                const values = healthConcerns.split('ã€');
                document.querySelectorAll('input[type="checkbox"][data-id="1.4_å¥åº·éš±æ†‚"]').forEach(checkbox => {
                    if (values.includes(checkbox.value)) {
                        checkbox.checked = true;
                        checkbox.parentElement.classList.add('selected');
                    }
                });
            }

            // ç›£è½ 6.2 è®ŠåŒ–
            document.querySelectorAll('input[name="6.2_é¡˜æ„æ·»è³¼"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.checked) handle6_2Change(e.target.value);
                });
            });
            // åˆå§‹æª¢æŸ¥ 6.2 ç‹€æ…‹
            if (state.answers['6.2_é¡˜æ„æ·»è³¼']) {
                 handle6_2Change(state.answers['6.2_é¡˜æ„æ·»è³¼']);
            } else {
                 handle6_2Change(null); // é è¨­éš±è—
            }
            
            // ç›£è½ä¸Šä¸‹ä¸€æ­¥
            document.getElementById('prevButton').onclick = () => {
                if (state.currentStep > 0) {
                    setState({ currentStep: state.currentStep - 1 });
                }
            };
            document.getElementById('nextButton').onclick = handleNextOrSubmit;
            
            // ç›£è½æ‰€æœ‰ Radio
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.onchange = (e) => {
                    const id = e.target.dataset.id || e.target.name;
                    state.answers[id] = e.target.value;
                    updateRadioSelection(id);

                    if (id === '6.2_é¡˜æ„æ·»è³¼') {
                        toggleQuestion5_3(e.target.value);
                    }
                    // 5.5 é¡¯éš± 5.6
                    if (id === '5.5_è³¼è²·æ´»å‹•ç”¢å“') {
                        toggleQuestion5_6(e.target.value);
                    }
                };
            });
            
            // ç›£è½æ‰€æœ‰ Checkboxï¼ˆ1.4 å¥åº·éš±æ†‚ï¼‰
            document.querySelectorAll('input[type="checkbox"][data-id="1.4_å¥åº·éš±æ†‚"]').forEach(checkbox => {
                checkbox.onchange = (e) => {
                    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-id="1.4_å¥åº·éš±æ†‚"]');
                    
                    // æ›´æ–° selected class
                    if (e.target.checked) {
                        e.target.parentElement.classList.add('selected');
                    } else {
                        e.target.parentElement.classList.remove('selected');
                    }
                    
                    // å¦‚æœé¸æ“‡ã€Œä»¥ä¸Šçš†ç„¡ã€ï¼Œå‰‡å–æ¶ˆå…¶ä»–é¸é …
                    if (e.target.value === 'ä»¥ä¸Šçš†ç„¡' && e.target.checked) {
                        checkboxes.forEach(cb => {
                            if (cb.value !== 'ä»¥ä¸Šçš†ç„¡') {
                                cb.checked = false;
                                cb.parentElement.classList.remove('selected');
                            }
                        });
                        state.answers['1.4_å¥åº·éš±æ†‚'] = 'ä»¥ä¸Šçš†ç„¡';
                    } 
                    // å¦‚æœé¸æ“‡å…¶ä»–é¸é …ï¼Œå‰‡å–æ¶ˆã€Œä»¥ä¸Šçš†ç„¡ã€
                    else if (e.target.value !== 'ä»¥ä¸Šçš†ç„¡' && e.target.checked) {
                        checkboxes.forEach(cb => {
                            if (cb.value === 'ä»¥ä¸Šçš†ç„¡') {
                                cb.checked = false;
                                cb.parentElement.classList.remove('selected');
                            }
                        });
                        const newCheckedValues = Array.from(checkboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.value);
                        state.answers['1.4_å¥åº·éš±æ†‚'] = newCheckedValues.join('ã€');
                    }
                    // æ›´æ–°ç­”æ¡ˆ
                    else {
                        const finalCheckedValues = Array.from(checkboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.value);
                        state.answers['1.4_å¥åº·éš±æ†‚'] = finalCheckedValues.length > 0 ? finalCheckedValues.join('ã€') : '';
                    }
                };
            });
            
            // ç›£è½æ‰€æœ‰ Range Sliders
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                // 1.3_Age_... æ»‘æ¡¿ç”± renderDynamicAgeSliders() ç¨ç«‹ç¶å®š
                if (slider.id.startsWith('1.3_Age_')) return; 

                // 5.7 æ»‘æ¡¿ç”± renderStep5() é€é oninput="" ç¨ç«‹ç¶å®š
                if (slider.id === 'slider-5_7') return;
                
                // ç¶å®šæ‰€æœ‰å…¶ä»–çš„æ»‘æ¡¿ (åŒ…å« 1.2, 3.4, 4.x, 5.1, 5.3, 6.3, 6.4_x, 7.7)
                slider.oninput = (e) => {
                    handleRangeInput(e.target);
                };
            });
            
            // ç›£è½æ‰€æœ‰ Pet Choice (Yes/No)
            document.querySelectorAll('.pet-choice').forEach(label => {
                label.onclick = () => {
                    const input = label.querySelector('input[type="radio"]');
                    input.checked = true;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                };
            });
        }
        
        // --- ä¿®æ­£ BUG 2ï¼šæ›¿æ› attachInterviewSurveyListeners å‡½æ•¸ ---
        function attachInterviewSurveyListeners() {
            document.getElementById('finalInterviewSubmitButton').onclick = () => {
                // ä¿®æ­£ 1ï¼šæ›´æ–° ids é™£åˆ—ä»¥åŒ…å«æ‰€æœ‰è¨ªè«‡å•é¡Œ (Q1 ~ Q7)
                const ids = [
                    'Q1_æƒ…å¢ƒé€£çµ', 'Q2_ç•¶å‰ç—›é»', 'Q3_æœªæ»¿è¶³éœ€æ±‚', 'Q4_ç”¢å“æ¦‚å¿µ',
                    'Q4.1_æå‡æ–¹æ³•', 'Q4.2_æ–¹æ³•æˆæ•ˆ', 'Q5_å¥åº·æ–¹æ³•', 'Q6_è³¼è²·æ„é¡˜', // æ–°å¢ Q6
                    'Q7_è©¦ç”¨æ„é¡˜' // Q6 æ”¹ç‚º Q7
                ];
                let allValid = true;
                
                ids.forEach(id => {
                    const textarea = document.getElementById(id);
                    const errorEl = document.getElementById(`error-${id}`);
                    const isConditionalQ6 = id === 'Q6_è³¼è²·æ„é¡˜';

                    // ä¿®æ­£ 2ï¼šæª¢æŸ¥ textarea æ˜¯å¦å­˜åœ¨ (ä¸æ˜¯ null)ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡è·³éé©—è­‰
                    if (textarea) {Â 
                        if (textarea.value.trim() === '') {
                            // åªæœ‰ Q7 (åŸ Q6) å…è¨±ç©ºç™½ï¼Œå…¶ä»– Q1-Q5, Q6 åªè¦å‡ºç¾äº†å°±æ˜¯å¿…å¡«
                            if (id !== 'Q7_è©¦ç”¨æ„é¡˜') {Â 
                                // å° Q6 é€²è¡ŒäºŒæ¬¡æª¢æŸ¥ï¼Œå¦‚æœå®ƒä¸æ‡‰è©²å‡ºç¾ï¼Œå‰‡è·³éé©—è­‰
                                if (isConditionalQ6) {
                                    // **ä¿®æ”¹æ¢ä»¶æª¢æŸ¥ï¼šå¾ 3.4 æ”¹ç‚º 6.2**
                                    const is62Agreed = state.answers['6.2_é¡˜æ„æ·»è³¼'] === 'æ˜¯';
                                    if (!is62Agreed) return; // ä¸é¡¯ç¤º Q6ï¼Œå‰‡è·³éå¿…å¡«é©—è­‰
                                }
                                
                                errorEl.classList.remove('hidden');
                                allValid = false;
                            } else {
                                // Q7 æ˜¯ç©ºç™½çš„ï¼Œä½†ä»ç„¶å„²å­˜å®ƒ
                                errorEl.classList.add('hidden');
                                state.answers[id] = textarea.value.trim();
                            }
                        } else {
                            errorEl.classList.add('hidden');
                            state.answers[id] = textarea.value.trim();
                        }
                    }Â 
                    // å¦‚æœ textarea ä¸å­˜åœ¨ (å› ç‚ºæ¢ä»¶éš±è—äº†)ï¼Œæˆ‘å€‘ä»€éº¼éƒ½ä¸åšï¼Œç›´æ¥è·³éé©—è­‰
                });

                if (allValid) {
                    // æäº¤å‰ï¼Œæ‰‹å‹•å„²å­˜ Q7 (å¦‚æœ Q7 å­˜åœ¨ä½†ç‚ºç©º)
                    const q7_textarea = document.getElementById('Q7_è©¦ç”¨æ„é¡˜');
                    if (q7_textarea) {
                          state.answers['Q7_è©¦ç”¨æ„é¡˜'] = q7_textarea.value.trim();
                    }
                    
                    handleFinalSubmit();
                } else {
                    showToast("æ‚¨æœ‰å°šæœªå¡«å¯«çš„é¡Œç›®å–”ï¼(Q7é™¤å¤–)", "error");
                }
            };

            document.querySelectorAll('#app textarea').forEach(textarea => {
                textarea.oninput = (e) => {
                    state.answers[e.target.dataset.id] = e.target.value;
                };
            });
        }

        // --- Modal ç›£è½å™¨ (ä¿æŒä¸è®Š) ---
        function attachModalListeners() { 
            document.getElementById('interview-no').onclick = () => {
                // æ¢å¾©ç‚ºã€Œæ‹’çµ•ã€é‚è¼¯
                state.interviewConsent = 'No'; // ç´€éŒ„é¸æ“‡
                setState({ 
                    showInterviewModal: false, 
                    page: 'end', 
                    submissionStatus: 'success' 
                });
            };
            document.getElementById('interview-yes').onclick = () => {
                state.interviewConsent = 'é¡˜æ„'; // ç´€éŒ„é¸æ“‡
                document.getElementById('interview-step-1').classList.add('hidden');
                document.getElementById('interview-step-2').classList.remove('hidden');
            };
            document.getElementById('interview-submit-contact').onclick = () => {
                const input = document.getElementById('contact-input');
                const errorEl = document.getElementById('contact-error');
                if (input.value.trim() === '') {
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                    state.contactInfo = input.value.trim();
                    setState({ page: 'interviewSurvey', showInterviewModal: false });
                }
            };
        }


        // --- ç‹€æ…‹æ›´æ–°èˆ‡é©—è­‰ (ä¿æŒä¸è®Š) ---
        function setState(newState) {
            saveCurrentStepAnswers();
            state = { ...state, ...newState };
            console.log("New State: ", state.page, state.submissionStatus, state.showInterviewModal);
            render();
        }
        
        function updateDOMState() {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                const id = input.dataset.id;
                if (id === 'Reference' && state.page === 'start') {
                    if (state.answers[id]) input.value = state.answers[id];
                } else if (state.page === 'survey') {
                    if (state.answers[id]) input.value = state.answers[id];
                }
            });

            document.querySelectorAll('textarea').forEach(textarea => {
                const id = textarea.dataset.id;
                if (state.answers[id]) textarea.value = state.answers[id];
            });
            
            // æ›´æ–° range sliders
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const id = slider.dataset.id;
                // 1.3 ç”± renderDynamicAgeSliders è™•ç†
                if (id && id.startsWith('1.3_Age_')) return; 
                // 5.7 ç”± renderStep5() å’Œ update5_7Slider() è™•ç†
                if (slider.id === 'slider-5_7') return;

                const defaultValue = slider.closest('[data-default-value]') ? slider.closest('[data-default-value]').dataset.defaultValue : undefined;
                
                if (id) {
                     // Likert questions (Step 2, 3, 4, 5.2)
                     if (id.startsWith('2.') || id.startsWith('3.') || id.startsWith('4.') || id === '5.2_æŒ‘é¸å¥åº·å“') { 
                        slider.value = state.answers[id] !== undefined ? state.answers[id] : 2; // Likert é è¨­ 2 (æ™®é€š)
                    } else if (id.startsWith('6.4_')) {
                        slider.value = state.answers[id] !== undefined ? state.answers[id] : 0; // Budget é è¨­ 0
                    } else if (id === '1.2_é£¼é¤Šæ•¸é‡') {
                         slider.value = state.answers[id] !== undefined ? state.answers[id] : 0; // é è¨­ 0 (1éš»)
                    } else {
                        if (state.answers[id]) {
                            slider.value = state.answers[id];
                        } else if (defaultValue) {
                            slider.value = defaultValue;
                        }
                    }
                    
                    // ç¢ºä¿ 5.6 å’Œ 6.3 é è¨­ç‚º 0
                    if (id === '6.3_é¡˜æ„è³¼è²·é‡‘é¡' && state.answers[id] === undefined) {
                        slider.value = '0';
                    }
                    if (id === '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡' && state.answers[id] === undefined) {
                        slider.value = '0';
                    }
                    
                    // è§¸ç™¼ input ä¾†æ›´æ–°é¡¯ç¤ºå€¼å’Œè§¸ç™¼é€£å‹• (e.g. 5.1 -> 5.7)
                    slider.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            // æ›´æ–° radio buttons
            const radioIds = new Set(Object.keys(state.answers).filter(k => 
                document.querySelector(`input[type="radio"][data-id="${k}"]`) ||
                document.querySelector(`input[type="radio"][name="${k}"]`)
            ));
            radioIds.forEach(id => {
                const value = state.answers[id];
                if (value) {
                    const input = document.querySelector(`input[type="radio"][name="${id}"][value="${CSS.escape(value)}"]`);
                    if (input) {
                        input.checked = true;
                        updateRadioSelection(id);
                    }
                }
            });

            if (state.currentStep === 0 && state.page === 'survey') {
                const petCountValue = state.answers['1.2_é£¼é¤Šæ•¸é‡'] || 0;
                renderDynamicAgeSliders(petCountValue);
            }

            if (state.currentStep === 5 && state.page === 'survey') { // 6.4 åœ¨ Step 6 (index 5)
                updateBudgetTotal();
                const value6_2 = state.answers['6.2_é¡˜æ„æ·»è³¼'];
                toggleQuestion5_3(value6_2); // ç¢ºä¿ 6.3 é¡¯éš±æ­£ç¢º
            }
            
            if (state.currentStep === 4 && state.page === 'survey') { // 5.7 åœ¨ Step 5 (index 4)
                update5_7BaseAmount(); // ç¢ºä¿ 5.7 è¨ˆç®—æ­£ç¢º
                const value5_5 = state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'];
                toggleQuestion5_6(value5_5); // ç¢ºä¿ 5.6 é¡¯éš±æ­£ç¢º
            }
        }
        function updateRadioSelection(id) {
            const group = document.querySelector(`[data-radio-group="${id}"]`);
            if (group) {
                group.querySelectorAll('.radio-option, .pet-choice').forEach(label => {
                    const input = label.querySelector('input');
                    if (input.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });
            }
        }
        function saveCurrentStepAnswers() {
            if (state.page !== 'survey' && state.page !== 'interviewSurvey') return;

            const container = document.getElementById('app');
            if (!container) return;

            container.querySelectorAll('input[type="text"], input[type="number"], input[type="range"]').forEach(input => {
                if (input.dataset.id) {
                     state.answers[input.dataset.id] = input.value;
                }
                // 5.7 æ»‘æ¡¿æ²’æœ‰ data-idï¼Œå®ƒç”± update5_7Slider() ç›´æ¥å­˜å…¥ state.answers
            });
            container.querySelectorAll('textarea').forEach(textarea => {
                 if (textarea.dataset.id) {
                     state.answers[textarea.dataset.id] = textarea.value;
                 }
            });
            container.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                const id = input.dataset.id || input.name;
                state.answers[id] = input.value;
            });
        }
        
        // ä¿®æ­£å¾Œçš„ isStepValid
        function isStepValid(stepIndex) {
            // è¤‡è£½ä¸€ä»½å¿…å¡« ID
            const requiredIds = [...REQUIRED_QUESTIONS_BY_STEP[stepIndex]]; 

            // --- å‹•æ…‹é©—è­‰é‚è¼¯ ---
            if (stepIndex === 0) { // Step 1
                const petCountValue = parseInt(state.answers['1.2_é£¼é¤Šæ•¸é‡'] || 0, 10);
                requiredIds.push('1.3_Age_Oldest');
                if (petCountValue > 0) { // 2éš»æˆ– 2+
                    requiredIds.push('1.3_Age_Youngest');
                }
            }
            
            if (stepIndex === 4) { // Step 5
                // 5.6 åƒ…åœ¨ 5.5 å›ç­” 'æ˜¯' æ™‚æ‰ç‚ºå¿…å¡«
                if (state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] === 'æ˜¯') {
                    requiredIds.push('5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡');
                }
            }

            if (stepIndex === 5) { // Step 6
                // å¦‚æœ 6.2 å›ç­” "å¦"
                if (state.answers['6.2_é¡˜æ„æ·»è³¼'] === 'å¦') {
                    // å‰‡å°‡ 6.3 å¾å¿…å¡«æ¸…å–®ä¸­ç§»é™¤
                    const index = requiredIds.indexOf('6.3_é¡˜æ„è³¼è²·é‡‘é¡');
                    if (index > -1) {
                        requiredIds.splice(index, 1);
                    }
                }
            }
            // --- çµæŸå‹•æ…‹é©—è­‰ ---

            let isValid = true;
            for (const id of requiredIds) {
                const answer = state.answers[id];
                
                if (answer === undefined || answer === null || answer === '') {
                    // æª¢æŸ¥æ˜¯å¦ç‚º '0' (å…è¨± '0' çš„æƒ…æ³)
                    if (['6.3_é¡˜æ„è³¼è²·é‡‘é¡', '5.7_å¹´åº¦ç¸½æŠ•å…¥', '5.4_æœ€é«˜ç”¢å“é‡‘é¡', '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'].includes(id) && (answer === 0 || answer === '0')) {
                        // 0 is valid
                    }
                    // æª¢æŸ¥ 6.4 (budget sliders)ï¼Œ '0' ä¹Ÿæ˜¯æœ‰æ•ˆå€¼
                    else if (id.startsWith('6.4_') && (answer === 0 || answer === '0')) {
                         // 0 is valid
                    }
                    else {
                        console.warn(`Validation failed for step ${stepIndex + 1}: ${id} is missing or empty.`);
                        isValid = false;
                    }
                }
            }
            return isValid;
        }

        function validateAllAnswers() {
            for (let i = 0; i < TOTAL_STEPS; i++) {
                if (!isStepValid(i)) {
                    return { valid: false, firstInvalidStep: i };
                }
            }
            return { valid: true };
        }

        function handleNextOrSubmit() {
            saveCurrentStepAnswers();
            
            if (!isStepValid(state.currentStep)) {
                showToast(`æ‚¨åœ¨ç¬¬ ${state.currentStep + 1} éƒ¨åˆ†æœ‰æœªå¡«å¯«çš„é¡Œç›®å–”ï¼`, "error");
                return;
            }

            if (state.currentStep < TOTAL_STEPS - 1) {
                // æ­£å¸¸æ›é 
                setState({ currentStep: state.currentStep + 1 });
                const card = document.querySelector('.quiz-card');
                if (card) card.scrollTop = 0;
            } else {
                // --- é€™æ˜¯æœ€å¾Œä¸€æ­¥ (Step 7) ---
                const validationResult = validateAllAnswers();
                if (validationResult.valid) {
                    handleFirstSubmit();
                } else {
                    showToast(`æ‚¨åœ¨ç¬¬ ${validationResult.firstInvalidStep + 1} éƒ¨åˆ†æœ‰æœªå¡«å¯«çš„é¡Œç›®å–”ï¼`, "error");
                    setState({ currentStep: validationResult.firstInvalidStep });
                }
            }
        }

        function showToast(message, type = 'info') {
            let toast = document.getElementById('toast-notification');
            if (toast) { toast.remove(); }
            toast = document.createElement('div');
            toast.id = 'toast-notification';
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            // èª¿æ•´ Toast æ¨£å¼
            toast.className = `fixed top-5 right-5 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ease-out translate-x-full`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Slide in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);

            // Slide out
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // --- å¿«é€Ÿå¡«å¯«éš¨æ©Ÿç­”æ¡ˆ (å·²æ›´æ–° ID) ---
        function fillWithRandomAnswers() {
            const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
            let newAnswers = {};

            newAnswers['Reference'] = randomChoice(['æœ‹å‹A', 'FBå¯µç‰©ç¤¾åœ˜', 'æ¸¬è©¦å“¡']);

            // Step 1
            newAnswers['1.1_å¯µç‰©é¡å‹'] = randomChoice(['çŠ¬', 'è²“', 'çš†æœ‰']); // å¢åŠ  'çš†æœ‰'
            const petCountValue = randomInt(0, 2);
            newAnswers['1.2_é£¼é¤Šæ•¸é‡'] = petCountValue;
            newAnswers['1.3_Age_Oldest'] = randomInt(0, 4);
            if (petCountValue > 0) {
                newAnswers['1.3_Age_Youngest'] = randomInt(0, newAnswers['1.3_Age_Oldest']);
            }
            newAnswers['1.4_å¥åº·éš±æ†‚'] = randomChoice(['é«”æ…‹è‚¥èƒ–', 'è‚ŒåŠ›ä¸è¶³', 'å¿ƒæƒ…ç„¦æ…®', 'å¿ƒè‚ºå•é¡Œ', 'ä»¥ä¸Šçš†ç„¡', 'é«”æ…‹è‚¥èƒ–ã€è‚ŒåŠ›ä¸è¶³', 'å¿ƒæƒ…ç„¦æ…®ã€å¿ƒè‚ºå•é¡Œ']);
            
            // Step 2
            ['2.1_è¦–ç‚ºå®¶äºº', '2.2_åƒå­©å­', '2.3_å¡«è£œç©ºç¼º', '2.4_æ„Ÿåˆ°ä¸å®‰'].forEach(id => newAnswers[id] = randomInt(0, 4));
            
            // Step 3
            ['3.1_æ“”å¿ƒé¤“è‚šå­', '3.2_æ“”å¿ƒé«’äº‚', '3.3_æ“”å¿ƒå­¤å–®', '3.4_æ“”å¿ƒæ²’æ´»å‹•'].forEach(id => newAnswers[id] = randomInt(0, 4));
            
            // Step 4 
            ['4.1_é¡˜æ„èŠ±æ™‚é–“', '4.2_æ›¾ç„¡æ³•é™ªä¼´'].forEach(id => newAnswers[id] = randomInt(0, 4));
            newAnswers['4.3_ç„¡æ³•é™ªä¼´é »ç‡'] = randomInt(0, 7);
            newAnswers['4.4_å¹³å‡é™ªä¼´æ™‚é–“'] = randomInt(0, 5);
            newAnswers['4.5_ç„¡é™é™ªä¼´æ™‚é–“'] = randomInt(0, 5);
            
            // Step 5
            newAnswers['5.1_é£Ÿå“ä¿å¥èŠ±è²»'] = randomInt(1, 10); // 1k-10k
            newAnswers['5.2_æŒ‘é¸å¥åº·å“'] = randomInt(0, 4); 
            newAnswers['5.3_ç©å…·å¨›æ¨‚èŠ±è²»'] = randomInt(1, 10); // 1k-10k
            newAnswers['5.4_æœ€é«˜ç”¢å“é‡‘é¡'] = randomInt(0, 30); 
            newAnswers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] = randomChoice(['æ˜¯', 'å¦']); 
            if (newAnswers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] === 'æ˜¯') { 
                newAnswers['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] = randomInt(1, 30);
            } else {
                newAnswers['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] = '0';
            }
            newAnswers['5.7_å¹´åº¦èª¿æ•´'] = randomInt(-5, 5); // -5k ~ +5k
            
            // Step 6
            newAnswers['6.1_ä¸å¥½ç¶“é©—'] = randomChoice(['ç¶“å¸¸æœ‰', 'å¶çˆ¾æœ‰', 'å¹¾ä¹æ²’æœ‰', 'å¾æœªè³¼è²·éæ˜‚è²´ç”¨å“']);
            newAnswers['6.2_é¡˜æ„æ·»è³¼'] = randomChoice(['æ˜¯', 'å¦']);
            if (newAnswers['6.2_é¡˜æ„æ·»è³¼'] === 'æ˜¯') {
                newAnswers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = randomInt(1, 30);
            } else {
                newAnswers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = '0';
            }
            // **æ›´æ–°éš¨æ©Ÿé ç®—åˆ†é…é …ç›®ï¼Œæ–°å¢ 6.4_ç¯€çœç©ºé–“**
            ['6.4_é–‹å¿ƒä½¿ç”¨', '6.4_å®‰å…¨ä½¿ç”¨', '6.4_ç¯€çœæ™‚é–“', '6.4_æŒä¹…è€ç”¨', '6.4_å®¹æ˜“æ¸…æ½”', '6.4_ç¯€çœç©ºé–“'].forEach(id => newAnswers[id] = randomInt(-4, 4)); 
            
            // Step 7 (å·²æ ¡æ­£ ID)
            newAnswers['7.1_æ€§åˆ¥'] = randomChoice(['ç”·æ€§', 'å¥³æ€§', 'å…¶ä»–']);
            newAnswers['7.2_å¹´é½¡'] = randomChoice(['24æ­²ä»¥ä¸‹', '25-34æ­²', '35-44æ­²', '45-54æ­²', '55æ­²ä»¥ä¸Š']);
            newAnswers['7.3_æœ‰ä¼´ä¾¶'] = randomChoice(['æ˜¯', 'å¦']);
            newAnswers['7.4_ç¨å±…'] = randomChoice(['æ˜¯', 'å¦']);
            newAnswers['7.5_å±…ä½å‹æ…‹'] = randomChoice(['å–®é–“(3-10åª)', 'å¤šé–“(å«å®¢å»³)', 'é€å¤©(ç¨æ£Ÿ)', 'åˆ¥å¢…(æœ‰åº­é™¢)']);
            newAnswers['7.6_å­å¥³'] = randomChoice(['æœ‰', 'ç„¡']);
            newAnswers['7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯'] = randomChoice(['æ˜¯', 'å¦']);
            newAnswers['7.8_å¯æ”¯é…æ¶ˆè²»é¡'] = randomInt(1, 10);

            showToast("å·²å¡«å…¥éš¨æ©Ÿç­”æ¡ˆï¼Œè«‹æª¢æŸ¥æœ€å¾Œä¸€é ä¸¦æäº¤ï¼", "info");
            
            setState({
                answers: newAnswers,
                currentStep: TOTAL_STEPS - 1 // åœåœ¨æœ€å¾Œä¸€é 
            });
        }

        // --- Google Apps Script ç¶²å€ ---
        const GOOGLE_SHEET_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSC-co1UtcQ0V2faXXuPIr5F7s3pri4ukLq9Tyu5unMfeVseAHsr_F04D0yzDssU-wbA/exec'; // è«‹æ›¿æ›æˆæ‚¨çš„ Google Apps Script ç¶²å€ 

        async function handleFirstSubmit() {
            if (state.submissionStatus === 'submitting') return;
            setState({ page: "end", submissionStatus: 'submitting' });
            const success = await sendDataToGoogle(false);
            if (success) {
                setState({ 
                    page: 'survey', 
                    submissionStatus: 'idle',
                    showInterviewModal: true 
                });
            } else {
                setState({ 
                    submissionStatus: "error", 
                    answers: { ...state.answers, errorMessage: 'é¦–æ¬¡æäº¤å¤±æ•—' }
                });
            }
        }

        async function handleFinalSubmit() {
            if (state.submissionStatus === 'submitting') return;
            setState({ page: "end", submissionStatus: 'submitting' });
            // æäº¤å‰æ‰‹å‹•å„²å­˜ Q6/Q7
            const q6_textarea = document.getElementById('Q6_è³¼è²·æ„é¡˜');
            if (q6_textarea) state.answers['Q6_è³¼è²·æ„é¡˜'] = q6_textarea.value.trim();
            const q7_textarea = document.getElementById('Q7_è©¦ç”¨æ„é¡˜');
            if (q7_textarea) state.answers['Q7_è©¦ç”¨æ„é¡˜'] = q7_textarea.value.trim();
            
            const success = await sendDataToGoogle(true);
            if (success) {
                setState({ submissionStatus: "success" });
            } else {
                setState({ 
                    submissionStatus: "error", 
                    answers: { ...state.answers, errorMessage: 'æœ€çµ‚æäº¤å¤±æ•—' }
                });
            }
        }


        // --- æ–°å¢å‡½å¼ï¼šå–å¾—å•å·å¡«å¯«äººæ•¸ ---
        const BASE_COUNT = 613; 

        /**
         * é€é GET è«‹æ±‚å¾ Google Apps Script ç²å–è©¦ç®—è¡¨ä¸­çš„è³‡æ–™ç­†æ•¸ã€‚
         * @returns {Promise<number>} - ç¸½å¡«å¯«äººæ•¸ (åŸºç¤äººæ•¸ + GSè³‡æ–™ç­†æ•¸)ã€‚
         */
        async function getSurveyCount() {
            if (GOOGLE_SHEET_SCRIPT_URL.includes('!!!') || !GOOGLE_SHEET_SCRIPT_URL.startsWith('https:')) {
                console.error("éŒ¯èª¤ï¼šå°šæœªè¨­å®šæœ‰æ•ˆçš„ Google Apps Script URLï¼ç„¡æ³•è®€å–äººæ•¸ã€‚");
                return BASE_COUNT;
            }
            
            try {
                // ç™¼é€ GET è«‹æ±‚
                const response = await fetch(GOOGLE_SHEET_SCRIPT_URL, {
                    method: 'GET',
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.result === 'success' && data.count !== undefined) {
                    const sheetCount = parseInt(data.count, 10);
                    const totalCount = BASE_COUNT + sheetCount;
                    console.log(`æˆåŠŸè®€å– GS ç­†æ•¸: ${sheetCount}ï¼Œé¡¯ç¤ºç¸½æ•¸: ${totalCount}`);
                    return totalCount;
                } else {
                    console.warn("GS å›å‚³æ ¼å¼éŒ¯èª¤æˆ–å¤±æ•—:", data.message || 'æœªçŸ¥éŒ¯èª¤');
                    return BASE_COUNT; 
                }
            } catch (error) {
                console.error("è®€å–å•å·ç­†æ•¸å¤±æ•—:", error);
                // åœ¨ Canvas ç’°å¢ƒä¸­ï¼ŒCORS éŒ¯èª¤å¯èƒ½æœƒå°è‡´é€™è£¡å¤±æ•—ï¼Œä½†æˆ‘å€‘æœƒé¡¯ç¤ºåŸºç¤äººæ•¸
                return BASE_COUNT; 
            }
        }
        // --- å‡½å¼æ–°å¢çµæŸ ---

        async function sendDataToGoogle(isFinalSubmit = false) {
            
            // --- ç¢ºä¿æ‰€æœ‰é è¨­å€¼éƒ½å·²å¡«å…¥ ---
            const likertIds = [
                // Step 2 Likert ID
                '2.1_è¦–ç‚ºå®¶äºº', '2.2_åƒå­©å­', '2.3_å¡«è£œç©ºç¼º', '2.4_æ„Ÿåˆ°ä¸å®‰', 
                // Step 3 Likert ID
                '3.1_æ“”å¿ƒé¤“è‚šå­', '3.2_æ“”å¿ƒé«’äº‚', '3.3_æ“”å¿ƒå­¤å–®', '3.4_æ“”å¿ƒæ²’æ´»å‹•',
                // Step 4 & 5 Likert ID
                '4.1_é¡˜æ„èŠ±æ™‚é–“', '4.2_æ›¾ç„¡æ³•é™ªä¼´',
                '5.2_æŒ‘é¸å¥åº·å“' 
            ];
            likertIds.forEach(id => {
                if (state.answers[id] === undefined) state.answers[id] = '2'; // é è¨­ 'æ™®é€š'
            });
            if (state.answers['1.3_Age_Oldest'] === undefined) state.answers['1.3_Age_Oldest'] = '0';
            const petCountValue = parseInt(state.answers['1.2_é£¼é¤Šæ•¸é‡'] || 0, 10);
            if (petCountValue > 0 && state.answers['1.3_Age_Youngest'] === undefined) {
                 state.answers['1.3_Age_Youngest'] = '0';
            }
            if (state.answers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] === undefined) state.answers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = '0';
            if (state.answers['5.4_æœ€é«˜ç”¢å“é‡‘é¡'] === undefined) state.answers['5.4_æœ€é«˜ç”¢å“é‡‘é¡'] = '0';
            if (state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] === undefined) state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] = 'å¦'; // é è¨­ 'å¦'
            if (state.answers['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] === undefined) state.answers['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] = '0';
            
            // **æ›´æ–°é ç®—åˆ†é…é …ç›®**
            const budgetIds = ['6.4_é–‹å¿ƒä½¿ç”¨', '6.4_å®‰å…¨ä½¿ç”¨', '6.4_ç¯€çœæ™‚é–“', '6.4_æŒä¹…è€ç”¨', '6.4_å®¹æ˜“æ¸…æ½”', '6.4_ç¯€çœç©ºé–“']; 
            budgetIds.forEach(id => {
                if (state.answers[id] === undefined) state.answers[id] = '0'; 
            });

            const durationSeconds = state.startTime ? Math.round((Date.now() - state.startTime) / 1000) : 0;

            // --- å»ºç«‹è¦ç™¼é€çš„è³‡æ–™ç‰©ä»¶ ---
            const dataToSend = {
                'Duration': durationSeconds + ' ç§’',
                'UniqueID': state.uniqueID,
                'Reference': state.answers['Reference'] || '',
                // Step 1
                '1.1_å¯µç‰©é¡å‹': state.answers['1.1_å¯µç‰©é¡å‹'] || 'N/A',
                '1.2_é£¼é¤Šæ•¸é‡': petCountValueToText(state.answers['1.2_é£¼é¤Šæ•¸é‡'] || '0'), 
                '1.3_Age_Oldest': ageValueToText(state.answers['1.3_Age_Oldest'] || '0'),
                '1.3_Age_Youngest': (petCountValue > 0) ? ageValueToText(state.answers['1.3_Age_Youngest'] || '0') : '',
                '1.4_å¥åº·éš±æ†‚': state.answers['1.4_å¥åº·éš±æ†‚'] || 'N/A',
                
                // Step 2
                '2.1_è¦–ç‚ºå®¶äºº': likertValueToText(state.answers['2.1_è¦–ç‚ºå®¶äºº']),
                '2.2_åƒå­©å­': likertValueToText(state.answers['2.2_åƒå­©å­']),
                '2.3_å¡«è£œç©ºç¼º': likertValueToText(state.answers['2.3_å¡«è£œç©ºç¼º']),
                '2.4_æ„Ÿåˆ°ä¸å®‰': likertValueToText(state.answers['2.4_æ„Ÿåˆ°ä¸å®‰']),
                
                // Step 3
                '3.1_æ“”å¿ƒé¤“è‚šå­': likertValueToText(state.answers['3.1_æ“”å¿ƒé¤“è‚šå­']),
                '3.2_æ“”å¿ƒé«’äº‚': likertValueToText(state.answers['3.2_æ“”å¿ƒé«’äº‚']),
                '3.3_æ“”å¿ƒå­¤å–®': likertValueToText(state.answers['3.3_æ“”å¿ƒå­¤å–®']),
                '3.4_æ“”å¿ƒæ²’æ´»å‹•': likertValueToText(state.answers['3.4_æ“”å¿ƒæ²’æ´»å‹•']),

                // Step 4
                '4.1_é¡˜æ„èŠ±æ™‚é–“': likertValueToText(state.answers['4.1_é¡˜æ„èŠ±æ™‚é–“']),
                '4.2_æ›¾ç„¡æ³•é™ªä¼´': likertValueToText(state.answers['4.2_æ›¾ç„¡æ³•é™ªä¼´']),
                '4.3_ç„¡æ³•é™ªä¼´é »ç‡': (state.answers['4.3_ç„¡æ³•é™ªä¼´é »ç‡'] || '0') + ' æ—¥',
                '4.4_å¹³å‡é™ªä¼´æ™‚é–“': (state.answers['4.4_å¹³å‡é™ªä¼´æ™‚é–“'] >= 5) ? '5+ å°æ™‚' : (state.answers['4.4_å¹³å‡é™ªä¼´æ™‚é–“'] || '0') + ' å°æ™‚',
                '4.5_ç„¡é™é™ªä¼´æ™‚é–“': (state.answers['4.5_ç„¡é™é™ªä¼´æ™‚é–“'] >= 5) ? '5+ å°æ™‚' : (state.answers['4.5_ç„¡é™é™ªä¼´æ™‚é–“'] || '0') + ' å°æ™‚',
                // Step 5
                '5.1_é£Ÿå“ä¿å¥èŠ±è²»': (state.answers['5.1_é£Ÿå“ä¿å¥èŠ±è²»'] == 0) ? '$0' : (state.answers['5.1_é£Ÿå“ä¿å¥èŠ±è²»'] >= 30 ? '$30,000+' : `$${(state.answers['5.1_é£Ÿå“ä¿å¥èŠ±è²»'] * 1000).toLocaleString()}`),
                '5.2_æŒ‘é¸å¥åº·å“': likertValueToText(state.answers['5.2_æŒ‘é¸å¥åº·å“']), 
                '5.3_ç©å…·å¨›æ¨‚èŠ±è²»': (state.answers['5.3_ç©å…·å¨›æ¨‚èŠ±è²»'] == 0) ? '$0' : (state.answers['5.3_ç©å…·å¨›æ¨‚èŠ±è²»'] >= 30 ? '$30,000+' : `$${(state.answers['5.3_ç©å…·å¨›æ¨‚èŠ±è²»'] * 1000).toLocaleString()}`),
                '5.4_æœ€é«˜ç”¢å“é‡‘é¡': 'N/A', 
                '5.5_è³¼è²·æ´»å‹•ç”¢å“': state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] || 'N/A', 
                '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡': 'N/A', 
                '5.7_å¹´åº¦ç¸½æŠ•å…¥': `$${parseInt(state.answers['5.7_å¹´åº¦ç¸½æŠ•å…¥'] || 0, 10).toLocaleString()}`,
                // Step 6
                '6.1_ä¸å¥½ç¶“é©—': state.answers['6.1_ä¸å¥½ç¶“é©—'] || 'N/A',
                '6.2_é¡˜æ„æ·»è³¼': state.answers['6.2_é¡˜æ„æ·»è³¼'] || 'N/A',
                '6.3_é¡˜æ„è³¼è²·é‡‘é¡': 'N/A', // ä¸‹æ–¹æœƒè¦†å¯«
                // 6.4 é …ç›®
                '6.4_é–‹å¿ƒä½¿ç”¨': 'N/A',
                '6.4_å®‰å…¨ä½¿ç”¨': 'N/A',
                '6.4_ç¯€çœæ™‚é–“': 'N/A',
                '6.4_æŒä¹…è€ç”¨': 'N/A',
                '6.4_å®¹æ˜“æ¸…æ½”': 'N/A',
                '6.4_ç¯€çœç©ºé–“': 'N/A', // **æ–°å¢ 6.4_ç¯€çœç©ºé–“**
                
                // Step 7 (å·²æ ¡æ­£)
                '7.1_æ€§åˆ¥': state.answers['7.1_æ€§åˆ¥'] || 'N/A',
                '7.2_å¹´é½¡': state.answers['7.2_å¹´é½¡'] || 'N/A',
                '7.3_æœ‰ä¼´ä¾¶': state.answers['7.3_æœ‰ä¼´ä¾¶'] || 'N/A',Â 
                '7.4_ç¨å±…': state.answers['7.4_ç¨å±…'] || 'N/A',
                '7.5_å±…ä½å‹æ…‹': state.answers['7.5_å±…ä½å‹æ…‹'] || 'N/A', // <-- (BUG 1) å·²è£œä¸Š
                '7.6_å­å¥³': state.answers['7.6_å­å¥³'] || 'N/A', // <-- (æ ¡æ­£) 7.5_å­å¥³ -> 7.6_å­å¥³
                '7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯': state.answers['7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯'] || 'N/A', // <-- (æ ¡æ­£) 7.6_å¯µç‰©ç›¸é—œèƒŒæ™¯ -> 7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯
                '7.8_å¯æ”¯é…æ¶ˆè²»é¡': (state.answers['7.8_å¯æ”¯é…æ¶ˆè²»é¡'] >= 10) ? '10+è¬' : (state.answers['7.8_å¯æ”¯é…æ¶ˆè²»é¡'] || '1') + 'è¬', // <-- (æ ¡æ­£) 7.7_å¯æ”¯é…æ¶ˆè²»é¡ -> 7.8_å¯æ”¯é…æ¶ˆè²»é¡

                // Interview (å·²æ ¡æ­£ + è£œä¸Š Q4.1, Q4.2, Q5, Q6, Q7)
                '8.1_é¡˜æ„å—è¨ª': state.interviewConsent || (isFinalSubmit ? 'Yes' : 'N/A'), 
                '8.2_è¯çµ¡è³‡è¨Š': state.contactInfo || '', 
                'Q1_æƒ…å¢ƒé€£çµ': isFinalSubmit ? (state.answers['Q1_æƒ…å¢ƒé€£çµ'] || '') : '',
                'Q2_ç•¶å‰ç—›é»': isFinalSubmit ? (state.answers['Q2_ç•¶å‰ç—›é»'] || '') : '',
                'Q3_æœªæ»¿è¶³éœ€æ±‚': isFinalSubmit ? (state.answers['Q3_æœªæ»¿è¶³éœ€æ±‚'] || '') : '',
                'Q4_ç”¢å“æ¦‚å¿µ': isFinalSubmit ? (state.answers['Q4_ç”¢å“æ¦‚å¿µ'] || '') : '',
                'Q4.1_æå‡æ–¹æ³•': isFinalSubmit ? (state.answers['Q4.1_æå‡æ–¹æ³•'] || '') : '', 
                'Q4.2_æ–¹æ³•æˆæ•ˆ': isFinalSubmit ? (state.answers['Q4.2_æ–¹æ³•æˆæ•ˆ'] || '') : '', 
                'Q5_å¥åº·æ–¹æ³•': isFinalSubmit ? (state.answers['Q5_å¥åº·æ–¹æ³•'] || '') : '', 
                'Q6_è³¼è²·æ„é¡˜': isFinalSubmit ? (state.answers['Q6_è³¼è²·æ„é¡˜'] || '') : '', // æ–°å¢ Q6
                'Q7_è©¦ç”¨æ„é¡˜': isFinalSubmit ? (state.answers['Q7_è©¦ç”¨æ„é¡˜'] || '') : '' // åŸ Q6 æ”¹ç‚º Q7
            };
            
            // [ è³‡æ–™è½‰æ› ] (ä¿æŒä¸è®Š)
            const v6_3 = state.answers['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] || '0';
            if (state.answers['6.2_é¡˜æ„æ·»è³¼'] === 'å¦') {
                dataToSend['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = '$0'; // æˆ–æ˜¯ 'N/A'
            } else {
                dataToSend['6.3_é¡˜æ„è³¼è²·é‡‘é¡'] = (v6_3 == 0) ? '$0' : (v6_3 >= 30 ? '$30,000+' : `$${(v6_3 * 1000).toLocaleString()}`);
            }

            const v5_4 = state.answers['5.4_æœ€é«˜ç”¢å“é‡‘é¡'] || '0';
            dataToSend['5.4_æœ€é«˜ç”¢å“é‡‘é¡'] = (v5_4 == 0) ? '$0' : (v5_4 >= 30 ? '$30,000+' : `$${(v5_4 * 1000).toLocaleString()}`);
            
            const v5_6 = state.answers['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] || '0';
            if (state.answers['5.5_è³¼è²·æ´»å‹•ç”¢å“'] === 'å¦') {
                dataToSend['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] = '$0'; // or 'N/A'
            } else {
                dataToSend['5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡'] = (v5_6 == 0) ? '$0' : (v5_6 >= 30 ? '$30,000+' : `$${(v5_6 * 1000).toLocaleString()}`);
            }

            budgetIds.forEach(id => {
                dataToSend[id] = budgetSliderValueToText(state.answers[id] || '0');
            });
            
            console.log(`æº–å‚™æäº¤è³‡æ–™ (isFinal=${isFinalSubmit}):`, dataToSend);
            
            if (GOOGLE_SHEET_SCRIPT_URL.includes('!!!') || !GOOGLE_SHEET_SCRIPT_URL.startsWith('https:')) {
                console.error("éŒ¯èª¤ï¼šå°šæœªè¨­å®šæœ‰æ•ˆçš„ Google Apps Script URLï¼");
                state.answers.errorMessage = 'å°šæœªè¨­å®š Google Apps Script URL';
                return false;
            }

            try {
                fetch(GOOGLE_SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(dataToSend).toString()
                });
                
                console.log("è³‡æ–™å·²ç™¼é€åˆ° Google Apps Scriptã€‚è«‹åˆ° GS çš„ã€åŸ·è¡Œã€ç´€éŒ„ä¸­ç¢ºèªçµæœã€‚");
                await new Promise(resolve => setTimeout(resolve, 800));
                return true; 

            } catch (error) {
                console.error("Fetch è«‹æ±‚æœ¬èº«ç™¼ç”ŸéŒ¯èª¤:", error);
                state.answers.errorMessage = error.toString();
                return false;
            }
        }
        // --- é¦–æ¬¡åŠ è¼‰æ™‚æ¸²æŸ“ ---
        document.addEventListener('DOMContentLoaded', async () => {
            render();
            
            // **æ–°å¢ï¼šåœ¨é é¢è¼‰å…¥å¾Œï¼Œç«‹å³è®€å–äººæ•¸ä¸¦æ›´æ–°é¡¯ç¤º**
            const totalCount = await getSurveyCount();
            const countEl = document.getElementById('current-total-count');
            if (countEl) {
                countEl.textContent = totalCount.toLocaleString(); // é¡¯ç¤ºäººæ•¸ä¸¦åŠ ä¸Šåƒåˆ†ä½
            }

            const debugButton = document.getElementById('debugFillButton');
            if (debugButton) {
                debugButton.onclick = fillWithRandomAnswers;
            }
        });
    
</script>
</body>
</html>

