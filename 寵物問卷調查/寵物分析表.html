<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樞紐分析儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Font Awesome for swap icon/settings icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- ** 引入 D3.js 和 D3-Sankey (新增) ** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <!-- ** 截圖功能 ** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            transition: height 0.3s ease-in-out;
            min-height: 500px;
        }
        /* -- 還原：單一欄位圖表容器 (長條圖) -- */
        .small-chart-container {
            position: relative;
            width: 100%;
            /* 修正：移除固定高度，交給 JS 動態計算 */
        }
        
        /* --- 篩選器樣式 --- */
        .filter-dropdown summary {
            cursor: pointer; padding: 0.5rem 1rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; background-color: white;
            transition: background-color 0.2s, border-color 0.2s;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .filter-dropdown summary:hover { background-color: #f9fafb; }
        .filter-dropdown[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .filter-dropdown .filter-panel {
            max-height: 250px; overflow-y: auto; border: 1px solid #d1d5db; border-top: none;
            padding: 0.75rem; background-color: white; z-index: 10; position: absolute;
            width: 100%; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem;
        }
        .filter-dropdown { position: relative; }
        
        /* 多重選取框樣式 */
        .multi-select-box {
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            padding: 0.5rem; max-height: 150px; overflow-y: auto;
            background-color: white;
        }
        .multi-select-box label { display: block; margin-bottom: 0.25rem; }
        
        .question-annotation {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #4b5563;
            min-height: 40px;
            font-style: italic;
        }
        .filter-active {
            background-color: #fefce8 !important; /* bg-yellow-50 */
            border-color: #fde047 !important; /* border-yellow-300 */
            font-weight: 600; /* semibold */
        }
        
        /* --- 標記樣式 (箭頭/分位數/平均) --- */
        #markerContainer {
             position: absolute; top: 0; left: 0; width: 100%; height: 100%;
             pointer-events: none; overflow: hidden;
        }
        /* 1. 上方圖例箭頭 (藍色) */
        .chart-arrow {
            position: absolute; display: none; pointer-events: none; z-index: 10;
            width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent; 
            border-top: 8px solid #2563eb; /* blue-600 */
            transform: translateX(-50%);
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
        }
        /* 2. 下方分位數標記 (紅色/粉色) */
        .quantile-marker {
            position: absolute; display: none; pointer-events: none; z-index: 10;
            width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-bottom: 8px solid #dc2626; /* red-600 */
            transform: translateX(-50%);
        }
        .quantile-marker-q2 { /* 中位數 Q2 */
            border-left-width: 8px; border-right-width: 8px;
            border-bottom-width: 10px;
            border-bottom-color: #f472b6; /* pink-400 */
        }
         /* 3. 平均數標籤 (長條圖末端外側) */
        .average-label {
            position: absolute; display: none; pointer-events: none; z-index: 10;
            background-color: rgba(255, 255, 255, 0.9); /* 白色半透明背景 */
            color: black; /* 黑色文字 */
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: bold;
            transform: translateY(-50%); /* 垂直置中 */
            border-radius: 3px;
            border: 1px solid #e5e7eb; /* 淡灰色邊框 */
            white-space: nowrap; /* 防止文字換行 */
        }
        /* --- 結束標記樣式 --- */

        /* 圖例樣式 */
        #arrowSelectContainer label { font-size: 0.875rem; font-weight: 600; color: #4b5563; }
        #arrowSelect { margin-left: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .legend-item { cursor: pointer; transition: opacity 0.2s; }
        .legend-item-hidden { opacity: 0.5; text-decoration: line-through; }
        
        /* -- 收折區塊樣式 -- */
        details summary {
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e3a8a; /* text-blue-900 */
            background-color: #eef2ff; /* bg-indigo-50 */
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        details summary:hover {
            background-color: #e0e7ff; /* bg-indigo-100 */
        }
        details > div {
            border: 1px solid #e0e7ff;
            border-top: none;
            padding: 1.5rem;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        /* --- 設定 Modal 樣式 --- */
        .modal {
            display: none; position: fixed; z-index: 50; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            line-height: 1; cursor: pointer; transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; }

        /* --- Sankey 專用樣式 (優化) --- */
        #sankeyChart svg { 
            width: 100%; 
            height: 100%; 
            max-height: 600px; /* 限制桑基圖最大高度 */
        }
        .sankey-link {
            fill: none;
            stroke-opacity: 0.4; /* 調整透明度，讓流動感更強 */
            transition: stroke-opacity 0.2s;
        }
        .sankey-link:hover {
            stroke-opacity: 0.7; /* 滑鼠懸停時更明顯 */
        }
        .sankey-node rect {
            fill-opacity: 1; /* 節點實色 */
            shape-rendering: crispEdges;
            cursor: pointer;
            border-radius: 4px; /* 增加圓角 */
            transition: fill-opacity 0.2s;
            /* 修正：移除節點框線 */
            stroke-width: 0; 
        }
        /* 修正 Sankey 標籤，讓圖例取代原本的標籤 */
        .sankey-node text {
            display: none; /* 隱藏 D3 內建的標籤 */
        }
        /* 新增 Sankey 圖例樣式 */
        .sankey-legend-item {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        /* --- 單欄分析排版修正樣式 --- */
        .small-chart-header {
             /* 確保標題和圖例對齊 */
             min-height: 20px;
             line-height: 1.2;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    
    <!-- 頂部設定按鈕 -->
    <div class="fixed top-4 right-4 z-40">
        <!-- ** 修正：使用 w-10 h-10 確保正圓形 ** -->
        <button id="settingsButton" class="w-10 h-10 flex justify-center items-center bg-white rounded-full shadow-lg text-blue-600 hover:bg-gray-50 transition" title="設定"><i class="fas fa-cog text-xl"></i></button>
    </div>

    <!-- 設定 Modal 視窗 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <h2 class="text-2xl font-bold text-blue-800 mb-6">圖表外觀設定</h2>

            <div class="space-y-6">
                <!-- 1. 數值標籤字體大小 -->
                <div>
                    <label for="datalabelsSize" class="block text-lg font-medium text-gray-700 mb-2">
                        數值標籤字體大小 (<span id="datalabelsSizeValue">13</span> px)
                    </label>
                    <input type="range" id="datalabelsSize" min="8" max="16" value="13" step="1" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    <p class="text-sm text-gray-500 mt-1">控制長條圖上百分比/筆數文字的大小。</p>
                </div>
                
                <!-- 2. BAR 的高度 (固定像素) -->
                <div>
                    <label for="barThickness" class="block text-lg font-medium text-gray-700 mb-2">
                        單欄分析長條圖高度 (<span id="barThicknessValue">4</span> px)
                    </label>
                    <!-- 固定像素高度：4px 到 25px -->
                    <input type="range" id="barThickness" min="4" max="25" value="4" step="1" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    <p class="text-sm text-gray-500 mt-1">設定單欄分析的長條圖高度（4-25 像素）。</p>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800">樞紐分析儀表板</h1>
            <p class="text-gray-600 mt-2">動態長條圖分析</p>
        </header>

        <!-- 設定步驟 -->
        <div id="setupInstructions" class="max-w-4xl mx-auto mb-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-lg">
            <h2 class="text-xl font-bold text-blue-800 mb-4">📋 設定狀態</h2>
            <p class="text-gray-700">資料將於頁面開啟時自動載入。如需變更資料來源，請修改程式碼內 <code>DEFAULT_SCRIPT_URL</code> 變數。</p>
        </div>

        <!-- 載入中 -->
        <!-- 修正 2.1: 初始時移除 hidden，讓載入畫面顯示 -->
        <div id="loading" class="text-center p-8"> 
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-lg" id="loadingMessage">正在載入資料，請稍候...</p>
            <!-- 修正 2.3: 新增錯誤資訊顯示區塊 (初始隱藏) -->
            <div id="debugInfoContainer" class="hidden mt-4 max-w-xl mx-auto">
                <h3 class="font-bold text-gray-700">載入日誌:</h3>
                <div id="debugInfo" class="mt-2 text-sm text-red-600 text-left bg-white p-4 rounded shadow border border-gray-200"></div>
            </div>
        </div>

        <!-- 儀表板 -->
        <main id="dashboard" class="hidden lg:grid lg:grid-cols-6 lg:gap-6">
            <div class="lg:col-span-5 space-y-6">
                
                <!-- 
                  =================================
                  新增: 樞紐圖表分析
                  =================================
                -->
                <details id="pivotTableSection">
                    <summary>樞紐圖表分析</summary>
                    <div class="space-y-6">
                        <div class="p-4 bg-white rounded-lg shadow-md">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- 列設定 -->
                                <div class="space-y-3">
                                    <h3 class="text-sm font-semibold text-gray-700 border-b pb-1">列 (Row)</h3>
                                    
                                    <!-- 主要列 -->
                                    <div>
                                        <label for="pivotRowMainSelect" class="block text-xs font-medium text-gray-600">主要分組</label>
                                        <select id="pivotRowMainSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">請選擇</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 次要列 -->
                                    <div>
                                        <label for="pivotRowSubSelect" class="block text-xs font-medium text-gray-600">次要分組（可選）</label>
                                        <select id="pivotRowSubSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">無</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- 欄設定 -->
                                <div class="space-y-3">
                                    <h3 class="text-sm font-semibold text-gray-700 border-b pb-1">欄 (Column) - 數據欄位</h3>
                                    <div id="pivotColumnsContainer" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- 動態生成的欄位選擇器將顯示在這裡 -->
                                    </div>
                                    <button id="addPivotColumn" class="w-full py-1.5 px-3 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-md border border-indigo-200">
                                        + 新增數據欄
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 樞紐分析表格顯示區 -->
                        <div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto">
                            <!-- 添加截圖按鈕 -->
                            <div class="flex justify-end mb-2">
                                <button id="pivotTable-download-screenshot" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700">
                                    <i class="fas fa-camera mr-1"></i> 下載截圖
                                </button>
                            </div>
                            <div id="pivotTable-screenshot-status" class="text-sm text-green-700 hidden mb-2 text-right"></div>
                            
                            <div id="pivotTableContainer" class="text-sm">
                                <p class="text-gray-500">請選擇列和欄以生成樞紐分析表</p>
                            </div>
                        </div>
                    </div>
                </details>
                
                <!-- 
                  =================================
                  區塊 1: 交叉長條圖分析 (交叉比較)
                  =================================
                -->
                <details id="pivotSection">
                    <!-- 修正名稱 -->
                    <summary>交叉長條圖分析</summary>
                    <div class="space-y-6">
                        <div class="p-4 bg-white rounded-lg shadow-md">
                            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-4">
                                <div class="w-full md:flex-1">
                                    <div id="yAxisQuestion" class="question-annotation">請選擇「列」欄位...</div>
                                    <label for="yAxisSelect" class="block text-sm font-medium text-gray-700">樞紐分析「列」</label>
                                    <select id="yAxisSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                                <div class="w-full md:w-auto flex justify-center">
                                    <button id="swapAxesButton" class="p-2 mt-0 md:mt-10 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition" title="交換「列」與「欄」"><i class="fas fa-exchange-alt"></i></button>
                                </div>
                                <div class="w-full md:flex-1">
                                    <div id="colorByQuestion" class="question-annotation">請選擇「欄」欄位...</div>
                                    <label for="colorBySelectContainer" class="block text-sm font-medium text-gray-700">樞紐分析「欄」</label>
                                    <!-- 「欄」的容器 (單選) -->
                                    <div id="colorBySelectContainer" class="mt-1">
                                        <select id="colorBySelect" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="none">不分組 (單一顏色)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="valueSelect" class="block text-sm font-medium text-gray-700">樞紐分析「值」 (Value)</label>
                                <select id="valueSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="count" selected>筆數 (COUNTA)</option>
                                    <option value="percent">各列佔比 (%)</option>
                                </select>
                                <!-- ** 修正 2：移除共用提示 ** -->
                                <!-- <p class="mt-1 text-xs text-gray-500">此選項會同時套用到下方的「單一欄位分析」。</p> -->
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <!-- 添加截圖按鈕 -->
                            <div class="flex justify-end mb-2">
                                <button id="pivot-download-screenshot" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700">
                                    <i class="fas fa-camera mr-1"></i> 下載截圖
                                </button>
                            </div>
                            <div id="pivot-screenshot-status" class="text-sm text-green-700 hidden mb-2 text-right"></div>
                            
                            <div id="chartHeader" class="flex justify-between items-start mb-2">
                                <div class="flex flex-col items-start">
                                    <h3 id="yAxisChartTitle" class="text-lg font-bold text-gray-800"></h3>
                                    <!-- 次要分組選單 -->
                                    <div id="subGroupContainer" class="mt-2 hidden">
                                        <label for="subGroupSelect" class="text-xs font-medium text-gray-600 mr-2">次要分組:</label>
                                        <select id="subGroupSelect" class="text-xs py-1 px-2 border border-gray-300 bg-white rounded shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="">無</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="customLegendContainer" class="text-right space-y-2">
                                    <h3 id="cAxisChartTitle" class="text-lg font-bold text-gray-800"></h3>
                                    <div id="customLegend" class="flex flex-wrap gap-x-4 gap-y-1 justify-end"></div>
                                    <div id="arrowSelectContainer" class="text-right mt-2 hidden">
                                        <label for="arrowSelect">箭頭:</label>
                                        <select id="arrowSelect"><option value="">請選擇</option></select>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" id="pivotChartContainer">
                                <canvas id="mainChart"></canvas>
                                <!-- 容器：放置所有標記 (箭頭/分位數/平均) -->
                                <div id="markerContainer"></div>
                            </div>
                        </div>
                    </div>
                </details>
                
                <!-- 
                  =================================
                  區塊 3: 桑基圖 (Sankey Diagram)
                  =================================
                -->
                <details id="sankeySection">
                    <!-- 修正名稱 -->
                    <summary>桑基分析</summary>
                    <div class="space-y-6">
                        <div class="p-4 bg-white rounded-lg shadow-md">
                            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-4">
                                <div class="w-full md:flex-1">
                                    <label for="sankeySourceSelect" class="block text-sm font-medium text-gray-700">流動「來源」 (Source)</label>
                                    <select id="sankeySourceSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                                <!-- 新增桑基圖交換按鈕 -->
                                <div class="w-full md:w-auto flex justify-center">
                                    <button id="swapSankeyAxesButton" class="p-2 mt-0 md:mt-10 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition" title="交換「來源」與「目標」"><i class="fas fa-exchange-alt"></i></button>
                                </div>
                                <div class="w-full md:flex-1">
                                    <label for="sankeyTargetSelect" class="block text-sm font-medium text-gray-700">流動「目標」 (Target)</label>
                                    <select id="sankeyTargetSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="sankeyMinThreshold" class="block text-sm font-medium text-gray-700">最小筆數門檻 (Min Count: <span id="sankeyMinThresholdValue">3</span>)</label>
                                <input type="range" id="sankeyMinThreshold" min="1" max="10" value="3" step="1" 
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                                <p class="text-xs text-gray-500 mt-1">低於此門檻的連線將被忽略，以簡化圖表。</p>
                            </div>
                        </div>

                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">資料流動路徑</h3>
                            <!-- 桑基圖例 -->
                            <div class="flex flex-col md:flex-row justify-between mb-4">
                                <div id="sankeySourceLegend" class="w-full md:w-1/2 pr-4 space-y-1">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2" id="sourceLegendTitle">來源圖例 (Source)</h4>
                                </div>
                                <div id="sankeyTargetLegend" class="w-full md:w-1/2 pl-4 space-y-1 md:text-right">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2" id="targetLegendTitle">目標圖例 (Target)</h4>
                                </div>
                            </div>

                            <div id="sankeyChart" class="w-full overflow-x-auto">
                                <!-- D3 繪製 SVG 區塊 -->
                            </div>
                        </div>
                    </div>
                </details>


                <!-- 
                  =================================
                  區塊 2: 單一欄位分析 (儀表板)
                  =================================
                -->
                <details id="smallMultiplesSection" class="mt-6">
                    <!-- 修正名稱 -->
                    <summary>單欄分析</summary>
                    <div>
                        <!-- ** 修正 2：新增獨立的「值」切換器 ** -->
                        <div class="p-4 bg-white rounded-lg shadow-md mb-6">
                            <div class="mb-4">
                                <label for="smallValueSelect" class="block text-sm font-medium text-gray-700">樞紐分析「值」 (Value)</label>
                                <select id="smallValueSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="count" selected>筆數 (COUNTA)</option>
                                    <option value="percent">各列佔比 (%)</option>
                                </select>
                            </div>

                            <label class="block text-sm font-medium text-gray-700 mb-2">請選擇要分析的欄位 (可複選)</label>
                            
                            <!-- ** 新增 Q2 & Q3：功能按鈕 ** -->
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button id="sm-select-all" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">全選</button>
                                <button id="sm-deselect-all" class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">全部清除</button>
                                <button id="sm-download-screenshot" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 ml-auto">
                                    <i class="fas fa-camera mr-1"></i> 下載截圖
                                </button>
                            </div>
                            <div id="sm-screenshot-status" class="text-sm text-green-700 hidden mb-2"></div>
                            
                            <div id="smallMultiplesControls" class="multi-select-box">
                                <!-- JS 會動態填入此處 -->
                            </div>
                        </div>
                        
                        <!-- 放置多個小圖表 -->
                        <!-- ** 修正 1：移除間距 ** -->
                        <div id="smallMultiplesContainer" class="space-y-0">
                            <!-- JS 會動態填入圖表 -->
                        </div>
                    </div>
                </details>
                
            </div>
            
            <!-- 
              =================================
              側邊欄: 篩選器 (共用)
              =================================
            -->
            <div class="lg:col-span-1">
                <div class="bg-white p-4 rounded-lg shadow-md sticky top-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">智慧篩選 (可複選)</h3>
                    <div id="filtersContainer" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        // ** 修正 1.1: 設定預設 Apps Script 網址 **
        const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSC-co1UtcQ0V2faXXuPIr5F7s3pri4ukLq9Tyu5unMfeVseAHsr_F04D0yzDssU-wbA/exec';
        
        // --- 設定預設值 (已修改) ---
        let DATALABELS_FONT_SIZE = 13; // 預設改為 13px
        let SMALL_CHART_BAR_HEIGHT = 4; // 單欄分析BAR高度（像素）- 改為4px
        // 樞紐分析使用的比例設定
        let BAR_CATEGORY_PERCENTAGE = 0.5; 
        let BAR_PERCENTAGE = 0.5;

        // 1. 高對比度的「類別」調色盤 (用於文字類別，或少量的數值類別)
        const CATEGORICAL_PALETTE = ['#1e40af','#dc2626','#16a34a','#ea580c','#9333ea','#0891b2','#ca8a04','#db2777','#65a30d','#7c3aed','#0d9488','#c026d3','#475569','#f59e0b','#059669','#be185d'];
        // 2. 「冷至暖」漸層調色盤 (用於 4 個以上的數值類別)
        const GRADIENT_PALETTE = ['#2563eb','#3b82f6','#06b6d4','#10b981','#84cc16','#eab308','#f59e0b','#f97316','#ef4444','#dc2626']; // 10-step cold-to-warm
        
        // ** FIXED_ANSWER_COLORS: 根據「分析題目圖例整理」文件全面更新 **
        const FIXED_ANSWER_COLORS = {
            // 1.1 寵物類型
            "犬": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "貓": "#F35555",
            
            // 1.2 飼養數量
            "1 隻": "#9AD8F5",
            "2 隻": "#023047",
            "2+ 隻": "#F35555", 
            
            // 1.3 年齡
            "0-1歲": "#9AD8F5",
            "1-3歲": "#22BDB5",
            "3-6歲": "#023047",
            "6-9歲": "#FFB703",
            "10歲以上": "#F35555",
            
            // 1.4 居住型態
            "單間(3-10坪)": "#9AD8F5",
            "多間(含客廳)": "#22BDB5",
            "透天(獨棟)": "#FFB703",
            "別墅(有庭院)": "#F35555",

            // 2.x, 3.x (Likert Scale)
            "1": "#9AD8F5", 
            "2": "#22BDB5", 
            "3": "#023047", 
            "4": "#FFB703",
            "5": "#F35555",

            // 3.4 專心時間 (數值)
            "3.4_0": "#BED1DB", // 使用題目鍵前綴以避免與 4.1 衝突
            "3.4_0.5": "#9AD8F5",
            "3.4_1": "#5ECBD5",
            "3.4_1.5": "#22BDB5",
            "3.4_2": "#12777E",
            "3.4_2.5": "#023047",
            "3.4_3": "#425236",
            "3.4_3.5": "#817425",
            "3.4_4": "#FFB703",
            "3.4_4.5": "#F9862C",
            "3.4_5": "#F35555",
            
            // 4.1 食品保健花費 (數值)
    "4.1_0": "#81D5E9",
    "4.1_500": "#3322E7",
    "4.1_1000": "#D9D009",
    "4.1_1500": "#E00418",
    "4.1_2000": "#F51A9A",
    "4.1_2500": "#1C8E73",
    "4.1_3000": "#5C441E",
    "4.1_3500": "#3B01AF",
    "4.1_4000": "#515AF9",
    "4.1_4500": "#CEE6E8",
    "4.1_5000": "#D70B9F",
    "4.1_5500": "#A81923",
    "4.1_6000": "#511F7F",
    "4.1_6500": "#6985AC",
    "4.1_7000": "#A95315",
    "4.1_7500": "#C7E331",
    "4.1_8000": "#289C00",
    "4.1_8500": "#CC1E93",
    "4.1_9000": "#6335EC",
    "4.1_9500": "#F72F8B",
    "4.1_10000": "#C09C59",
    "4.1_10500": "#97E431",
    "4.1_11000": "#2C4EAE",
    "4.1_11500": "#9658E2",
    "4.1_12000": "#10F2BE",
    "4.1_12500": "#CE3D95",
    "4.1_13000": "#0F1082",
    "4.1_13500": "#EBE4D5",
    "4.1_14000": "#E71991",
    "4.1_14500": "#2E03FB",
    "4.1_15000": "#3C2A58",
    "4.1_15500": "#C95794",
    "4.1_16000": "#3A1E65",
    "4.1_16500": "#FBE4C1",
    "4.1_17000": "#8B4C08",
    "4.1_17500": "#E438DE",
    "4.1_18000": "#03C5A5",
    "4.1_18500": "#E1A7D0",
    "4.1_19000": "#537751",
    "4.1_19500": "#5317E3",
    "4.1_20000": "#CCB019",
    "4.1_20500": "#055271",
    "4.1_21000": "#65D5EB",
    "4.1_21500": "#0639D2",
    "4.1_22000": "#03A2B5",
    "4.1_22500": "#57A212",
    "4.1_23000": "#5E61E0",
    "4.1_23500": "#DE5420",
    "4.1_24000": "#D2CE15",
    "4.1_24500": "#B04F4C",
    "4.1_25000": "#172FDC",
    "4.1_25500": "#F29584",
    "4.1_26000": "#D8B09F",
    "4.1_26500": "#B634CD",
    "4.1_27000": "#79B8C5",
    "4.1_27500": "#50D517",
    "4.1_28000": "#807B4D",
    "4.1_28500": "#388484",
    "4.1_29000": "#43485E",
    "4.1_29500": "#ED0D65",
    "4.1_30000": "#604278",
    "4.2_0": "#81D5E9",
    "4.2_500": "#3322E7",
    "4.2_1000": "#D9D009",
    "4.2_1500": "#E00418",
    "4.2_2000": "#F51A9A",
    "4.2_2500": "#1C8E73",
    "4.2_3000": "#5C441E",
    "4.2_3500": "#3B01AF",
    "4.2_4000": "#515AF9",
    "4.2_4500": "#CEE6E8",
    "4.2_5000": "#D70B9F",
    "4.2_5500": "#A81923",
    "4.2_6000": "#511F7F",
    "4.2_6500": "#6985AC",
    "4.2_7000": "#A95315",
    "4.2_7500": "#C7E331",
    "4.2_8000": "#289C00",
    "4.2_8500": "#CC1E93",
    "4.2_9000": "#6335EC",
    "4.2_9500": "#F72F8B",
    "4.2_10000": "#C09C59",
    "4.2_10500": "#97E431",
    "4.2_11000": "#2C4EAE",
    "4.2_11500": "#9658E2",
    "4.2_12000": "#10F2BE",
    "4.2_12500": "#CE3D95",
    "4.2_13000": "#0F1082",
    "4.2_13500": "#EBE4D5",
    "4.2_14000": "#E71991",
    "4.2_14500": "#2E03FB",
    "4.2_15000": "#3C2A58",
    "4.2_15500": "#C95794",
    "4.2_16000": "#3A1E65",
    "4.2_16500": "#FBE4C1",
    "4.2_17000": "#8B4C08",
    "4.2_17500": "#E438DE",
    "4.2_18000": "#03C5A5",
    "4.2_18500": "#E1A7D0",
    "4.2_19000": "#537751",
    "4.2_19500": "#5317E3",
    "4.2_20000": "#CCB019",
    "4.2_20500": "#055271",
    "4.2_21000": "#65D5EB",
    "4.2_21500": "#0639D2",
    "4.2_22000": "#03A2B5",
    "4.2_22500": "#57A212",
    "4.2_23000": "#5E61E0",
    "4.2_23500": "#DE5420",
    "4.2_24000": "#D2CE15",
    "4.2_24500": "#B04F4C",
    "4.2_25000": "#172FDC",
    "4.2_25500": "#F29584",
    "4.2_26000": "#D8B09F",
    "4.2_26500": "#B634CD",
    "4.2_27000": "#79B8C5",
    "4.2_27500": "#50D517",
    "4.2_28000": "#807B4D",
    "4.2_28500": "#388484",
    "4.2_29000": "#43485E",
    "4.2_29500": "#ED0D65",
    "4.2_30000": "#604278",
    "4.4_0": "#81D5E9",
    "4.4_500": "#3322E7",
    "4.4_1000": "#D9D009",
    "4.4_1500": "#E00418",
    "4.4_2000": "#F51A9A",
    "4.4_2500": "#1C8E73",
    "4.4_3000": "#5C441E",
    "4.4_3500": "#3B01AF",
    "4.4_4000": "#515AF9",
    "4.4_4500": "#CEE6E8",
    "4.4_5000": "#D70B9F",
    "4.4_5500": "#A81923",
    "4.4_6000": "#511F7F",
    "4.4_6500": "#6985AC",
    "4.4_7000": "#A95315",
    "4.4_7500": "#C7E331",
    "4.4_8000": "#289C00",
    "4.4_8500": "#CC1E93",
    "4.4_9000": "#6335EC",
    "4.4_9500": "#F72F8B",
    "4.4_10000": "#C09C59",
    "4.4_10500": "#97E431",
    "4.4_11000": "#2C4EAE",
    "4.4_11500": "#9658E2",
    "4.4_12000": "#10F2BE",
    "4.4_12500": "#CE3D95",
    "4.4_13000": "#0F1082",
    "4.4_13500": "#EBE4D5",
    "4.4_14000": "#E71991",
    "4.4_14500": "#2E03FB",
    "4.4_15000": "#3C2A58",
    "4.4_15500": "#C95794",
    "4.4_16000": "#3A1E65",
    "4.4_16500": "#FBE4C1",
    "4.4_17000": "#8B4C08",
    "4.4_17500": "#E438DE",
    "4.4_18000": "#03C5A5",
    "4.4_18500": "#E1A7D0",
    "4.4_19000": "#537751",
    "4.4_19500": "#5317E3",
    "4.4_20000": "#CCB019",
    "4.4_20500": "#055271",
    "4.4_21000": "#65D5EB",
    "4.4_21500": "#0639D2",
    "4.4_22000": "#03A2B5",
    "4.4_22500": "#57A212",
    "4.4_23000": "#5E61E0",
    "4.4_23500": "#DE5420",
    "4.4_24000": "#D2CE15",
    "4.4_24500": "#B04F4C",
    "4.4_25000": "#172FDC",
    "4.4_25500": "#F29584",
    "4.4_26000": "#D8B09F",
    "4.4_26500": "#B634CD",
    "4.4_27000": "#79B8C5",
    "4.4_27500": "#50D517",
    "4.4_28000": "#807B4D",
    "4.4_28500": "#388484",
    "4.4_29000": "#43485E",
    "4.4_29500": "#ED0D65",
    "4.4_30000": "#604278",
    "5.3_0": "#81D5E9",
    "5.3_500": "#3322E7",
    "5.3_1000": "#D9D009",
    "5.3_1500": "#E00418",
    "5.3_2000": "#F51A9A",
    "5.3_2500": "#1C8E73",
    "5.3_3000": "#5C441E",
    "5.3_3500": "#3B01AF",
    "5.3_4000": "#515AF9",
    "5.3_4500": "#CEE6E8",
    "5.3_5000": "#D70B9F",
    "5.3_5500": "#A81923",
    "5.3_6000": "#511F7F",
    "5.3_6500": "#6985AC",
    "5.3_7000": "#A95315",
    "5.3_7500": "#C7E331",
    "5.3_8000": "#289C00",
    "5.3_8500": "#CC1E93",
    "5.3_9000": "#6335EC",
    "5.3_9500": "#F72F8B",
    "5.3_10000": "#C09C59",
    "5.3_10500": "#97E431",
    "5.3_11000": "#2C4EAE",
    "5.3_11500": "#9658E2",
    "5.3_12000": "#10F2BE",
    "5.3_12500": "#CE3D95",
    "5.3_13000": "#0F1082",
    "5.3_13500": "#EBE4D5",
    "5.3_14000": "#E71991",
    "5.3_14500": "#2E03FB",
    "5.3_15000": "#3C2A58",
    "5.3_15500": "#C95794",
    "5.3_16000": "#3A1E65",
    "5.3_16500": "#FBE4C1",
    "5.3_17000": "#8B4C08",
    "5.3_17500": "#E438DE",
    "5.3_18000": "#03C5A5",
    "5.3_18500": "#E1A7D0",
    "5.3_19000": "#537751",
    "5.3_19500": "#5317E3",
    "5.3_20000": "#CCB019",
    "5.3_20500": "#055271",
    "5.3_21000": "#65D5EB",
    "5.3_21500": "#0639D2",
    "5.3_22000": "#03A2B5",
    "5.3_22500": "#57A212",
    "5.3_23000": "#5E61E0",
    "5.3_23500": "#DE5420",
    "5.3_24000": "#D2CE15",
    "5.3_24500": "#B04F4C",
    "5.3_25000": "#172FDC",
    "5.3_25500": "#F29584",
    "5.3_26000": "#D8B09F",
    "5.3_26500": "#B634CD",
    "5.3_27000": "#79B8C5",
    "5.3_27500": "#50D517",
    "5.3_28000": "#807B4D",
    "5.3_28500": "#388484",
    "5.3_29000": "#43485E",
    "5.3_29500": "#ED0D65",
    "5.3_30000": "#604278",
    "5.5_0": "#81D5E9",
    "5.5_500": "#3322E7",
    "5.5_1000": "#D9D009",
    "5.5_1500": "#E00418",
    "5.5_2000": "#F51A9A",
    "5.5_2500": "#1C8E73",
    "5.5_3000": "#5C441E",
    "5.5_3500": "#3B01AF",
    "5.5_4000": "#515AF9",
    "5.5_4500": "#CEE6E8",
    "5.5_5000": "#D70B9F",
    "5.5_5500": "#A81923",
    "5.5_6000": "#511F7F",
    "5.5_6500": "#6985AC",
    "5.5_7000": "#A95315",
    "5.5_7500": "#C7E331",
    "5.5_8000": "#289C00",
    "5.5_8500": "#CC1E93",
    "5.5_9000": "#6335EC",
    "5.5_9500": "#F72F8B",
    "5.5_10000": "#C09C59",
    "5.5_10500": "#97E431",
    "5.5_11000": "#2C4EAE",
    "5.5_11500": "#9658E2",
    "5.5_12000": "#10F2BE",
    "5.5_12500": "#CE3D95",
    "5.5_13000": "#0F1082",
    "5.5_13500": "#EBE4D5",
    "5.5_14000": "#E71991",
    "5.5_14500": "#2E03FB",
    "5.5_15000": "#3C2A58",
    "5.5_15500": "#C95794",
    "5.5_16000": "#3A1E65",
    "5.5_16500": "#FBE4C1",
    "5.5_17000": "#8B4C08",
    "5.5_17500": "#E438DE",
    "5.5_18000": "#03C5A5",
    "5.5_18500": "#E1A7D0",
    "5.5_19000": "#537751",
    "5.5_19500": "#5317E3",
    "5.5_20000": "#CCB019",
    "5.5_20500": "#055271",
    "5.5_21000": "#65D5EB",
    "5.5_21500": "#0639D2",
    "5.5_22000": "#03A2B5",
    "5.5_22500": "#57A212",
    "5.5_23000": "#5E61E0",
    "5.5_23500": "#DE5420",
    "5.5_24000": "#D2CE15",
    "5.5_24500": "#B04F4C",
    "5.5_25000": "#172FDC",
    "5.5_25500": "#F29584",
    "5.5_26000": "#D8B09F",
    "5.5_26500": "#B634CD",
    "5.5_27000": "#79B8C5",
    "5.5_27500": "#50D517",
    "5.5_28000": "#807B4D",
    "5.5_28500": "#388484",
    "5.5_29000": "#43485E",
    "5.5_29500": "#ED0D65",
    "5.5_30000": "#604278",











            // 4.3 科技用品數量
            "4.3_0": "#9AD8F5", 
            "4.3_1": "#22BDB5", 
            "4.3_2": "#023047", 
            "4.3_3": "#FFB703", 
            "4.3_4": "#F9862C", 
            "4.3_5": "#F35555",
            
            // 5.1 不好經驗
            "5.1_3": "#9AD8F5",
            "5.1_2": "#22BDB5",
            "5.1_1": "#FFB703",
            "5.1_0": "#F35555",
            
            // 5.2 願意添購
            "是": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "否": "#F35555",
            
            // 5.4 願意購買金額 (標籤為 -2000 到 2000)
            "-2000": "#F35555",
            "-1500": "#F9862C",
            "-1000": "#FFB703",
            "-500": "#817425",
            "0": "#023047", // 這裡的 "0" 與 3.4/4.1 的 "0" 顏色不同，但 5.4 題組優先使用，因此不加前綴
            "500": "#12777E", // 同樣不加前綴，交給 CUSTOM_SORT_ORDERS 處理
            "1000": "#22BDB5",
            "1500": "#5ECBD5",
            "2000": "#9AD8F5",
            
            // 6.1 性別
            "男性": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "女性": "#F35555",
            
            // 6.2 年齡
            "24歲以下": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "25 - 34歲": "#22BDB5",
            "35 - 44歲": "#023047",
            "45 - 54歲": "#FFB703",
            "55歲以上": "#F35555",
            
            // 6.3, 6.4, 6.5, 6.6 (是/否)
            "6.3_是": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "6.3_否": "#F35555",
            "6.4_是": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "6.4_否": "#F35555",
            "6.5_有": "#9AD8F5", 
            "6.5_無": "#F35555", 
            "6.6_是": "#9AD8F5", // 已將 #FB8500 更改為 #9AD8F5
            "6.6_否": "#F35555",
            
            // 6.7 月收入
            "無閒錢": "#9AD8F5",
            "小康": "#22BDB5",
            "富裕": "#FFB703",
            "多到沒地方花": "#F35555",



























































































































































        };
        
        const QUESTION_MAP = {'1.1_寵物類型':'您目前飼養的寵物類型為？','1.2_飼養數量':'您目前飼養的寵物數量為？','1.3_Age_Oldest':'您目前飼養的寵物中，最年長的年紀為？','1.3_Age_Youngest':'您目前飼養的寵物中，最年幼的年紀為？','1.4_居住型態':'您目前的居住型態為？','2.1_視為家人':'我視我的寵物為家人','2.2_情感慰藉':'寵物是我的重要情感慰藉','2.3_對寵說話':'我經常對我的寵物說話','2.4_擔心想念':'當我不在寵物身邊時，我會擔心或想念牠','2.5_快樂來源':'寵物是我快樂的重要來源','2.6_像孩子':'我常覺得我的寵物像我的孩子','2.7_填補空缺':'寵物填補了我生活中的空缺','2.8_日常話題':'寵物是我日常生活中的重要話題','3.1_充滿活力':'我希望我的寵物總是充滿活力','3.2_擔心獨處':'我擔心寵物獨處時感到孤單或焦慮','3.3_願意陪伴':'我願意花更多時間陪伴我的寵物','3.4_專心時間':'我每天都會有一段專心陪伴寵物的時間','4.1_食品保健花費':'您平均每月在寵物「食品與保健品」上花費多少？','4.2_玩具娛樂花費':'您平均每月在寵物「玩具與娛樂用品」上花費多少？','4.3_科技用品數量':'您目前擁有多少「寵物科技用品」（如：自動餵食器、飲水器、寵物攝影機、智能玩具等）？','4.4_最高產品金額':'您願意為單一「寵物科技產品」支付的最高金額約為？','5.1_不好經驗':'您過去是否有使用寵物科技產品的不良經驗？','5.2_願意添購':'未來 6 個月內，您是否考慮添購 neuen 「寵物科技產品」？','5.3_願意購買金額':'若有一款「寵物陪伴機器人」，您願意購買的金額範圍是？','5.4_開心使用':'我樂於看到寵物開心使用科技產品','5.4_安全使用':'我最擔心寵物科技產品的安全性','5.4_節省時間':'我希望寵物科技產品能幫我節省照顧時間','5.4_持久耐用':'我重視寵物科技產品的持久耐用性','5.4_容易清潔':'我希望寵物科技產品容易清潔','6.1_性別':'您的性別','6.2_年齡':'您的年齡','6.3_單身':'您目前的婚姻狀況','6.4_獨居':'您目前是否獨居','6.5_子女':'您目前是否有子女同住','6.6_寵物相關背景':'您是否具有寵物相關背景（如：獸醫、寵物美容、訓練師等）？','6.7_月收入':'您的個人平均月收入'};
        
        // ** CUSTOM_SORT_ORDERS: 根據「分析題目圖例整理」文件全面更新 **
        const CUSTOM_SORT_ORDERS = {
            '1.1_寵物類型': ["犬", "貓"],
            '1.2_飼養數量': ["1 隻", "2 隻", "2+ 隻"],
            '1.3_Age_Oldest': ["0-1歲", "1-3歲", "3-6歲", "6-9歲", "10歲以上"],
            '1.3_Age_Youngest': ["0-1歲", "1-3歲", "3-6歲", "6-9歲", "10歲以上"],
            '1.4_居住型態': ["單間(3-10坪)", "多間(含客廳)", "透天(獨棟)", "別墅(有庭院)"],
            
            // Likert Scale (2.x, 3.x)
            '2.1_視為家人': ["1", "2", "3", "4", "5"],
            '2.2_情感慰藉': ["1", "2", "3", "4", "5"],
            '2.3_對寵說話': ["1", "2", "3", "4", "5"],
            '2.4_擔心想念': ["1", "2", "3", "4", "5"],
            '2.5_快樂來源': ["1", "2", "3", "4", "5"],
            '2.6_像孩子': ["1", "2", "3", "4", "5"],
            '2.7_填補空缺': ["1", "2", "3", "4", "5"],
            '2.8_日常話題': ["1", "2", "3", "4", "5"],
            '3.1_充滿活力': ["1", "2", "3", "4", "5"],
            '3.2_擔心獨處': ["1", "2", "3", "4", "5"],
            '3.3_願意陪伴': ["1", "2", "3", "4", "5"],
            
            // 3.4 專心時間
            '3.4_專心時間': ["0", "0.5", "1", "1.5", "2", "2.5", "3", "3.5", "4", "4.5", "5"],
            
            // 4.1 食品保健花費

            // 4.3 科技用品數量
            '4.3_科技用品數量': ["0", "1", "2", "3", "4", "5"],
            
            // 5.1 不好經驗 (0-3 排序)
            '5.1_不好經驗': ["3", "2", "1", "0"],
            
            // 5.2 願意添購
            '5.2_願意添購': ["是", "否"],
            
            // 5.4 題組 (移除 NT$ 和 +)
            '5.4_開心使用': ["-2000", "-1500", "-1000", "-500", "0", "500", "1000", "1500", "2000"],
            '5.4_安全使用': ["-2000", "-1500", "-1000", "-500", "0", "500", "1000", "1500", "2000"],
            '5.4_節省時間': ["-2000", "-1500", "-1000", "-500", "0", "500", "1000", "1500", "2000"],
            '5.4_持久耐用': ["-2000", "-1500", "-1000", "-500", "0", "500", "1000", "1500", "2000"],
            '5.4_容易清潔': ["-2000", "-1500", "-1000", "-500", "0", "500", "1000", "1500", "2000"],
            
            // 6.x 個人基本資訊
            '6.1_性別': ["男性", "女性"],
            '6.2_年齡': ["24歲以下", "25 - 34歲", "35 - 44歲", "45 - 54歲", "55歲以上"],
            '6.3_單身': ["是", "否"],
            '6.4_獨居': ["是", "否"],
            '6.5_子女': ["有", "無"],
            '6.6_寵物相關背景': ["是", "否"],
            '6.7_月收入': ["無閒錢", "小康", "富裕", "多到沒地方花"],
            '4.2_玩具娛樂花費': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],
    '4.4_最高產品金額': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],
    '5.3_願意購買金額': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],
    '5.5_總額': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],
    '4.1_食品保健花費': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],

        
    '4.1': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],

    '4.2': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],

    '4.4': ["0", "500", "1000", "1500", "2000", "2500", "3000", "3500", "4000", "4500", "5000", "5500", "6000", "6500", "7000", "7500", "8000", "8500", "9000", "9500", "10000", "10500", "11000", "11500", "12000", "12500", "13000", "13500", "14000", "14500", "15000", "15500", "16000", "16500", "17000", "17500", "18000", "18500", "19000", "19500", "20000", "20500", "21000", "21500", "22000", "22500", "23000", "23500", "24000", "24500", "25000", "25500", "26000", "26500", "27000", "27500", "28000", "28500", "29000", "29500", "30000"],

    '5.3': ["0", "750", "1500", "2250", "3000", "3750", "4500", "5250", "6000", "6750", "7500", "8250", "9000", "9750", "10500", "11250", "12000", "12750", "13500", "14250", "15000", "15750", "16500", "17250", "18000", "18750", "19500", "20250", "21000", "21750", "22500", "23250", "24000", "24750", "25500", "26250", "27000", "27750", "28500", "29250", "30000", "30750", "31500", "32250", "33000", "33750", "34500", "35250", "36000", "36750", "37500", "38250", "39000", "39750", "40500", "41250", "42000", "42750", "43500", "44250", "45000"],

    '5.5': ["0", "750", "1500", "2250", "3000", "3750", "4500", "5250", "6000", "6750", "7500", "8250", "9000", "9750", "10500", "11250", "12000", "12750", "13500", "14250", "15000", "15750", "16500", "17250", "18000", "18750", "19500", "20250", "21000", "21750", "22500", "23250", "24000", "24750", "25500", "26250", "27000", "27750", "28500", "29250", "30000", "30750", "31500", "32250", "33000", "33750", "34500", "35250", "36000", "36750", "37500", "38250", "39000", "39750", "40500", "41250", "42000", "42750", "43500", "44250", "45000"],
};
        
        // --- 佔比模式 25/50/75% 虛線外掛 ---
        const percentageGridLinesPlugin = {
            id: 'percentageGridLines',
            afterDraw: (chart) => {
                // ** 修正：檢查圖表 ID，只在主圖表上運作 **
                if (chart.canvas.id !== 'mainChart') return;
                
                const valueType = document.getElementById('valueSelect')?.value;
                if (valueType !== 'percent') {
                    return; // 只在佔比模式下繪製
                }
                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;
                const lines = [25, 50, 75]; // 25%, 50%, 75%

                ctx.save();
                ctx.strokeStyle = '#e0e0e0'; // 淡淡的灰色
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]); // 虛線

                lines.forEach(value => {
                    const xPos = xAxis.getPixelForValue(value);
                    ctx.beginPath();
                    ctx.moveTo(xPos, yAxis.top);
                    ctx.lineTo(xPos, yAxis.bottom);
                    ctx.stroke();
                });

                ctx.restore();
            }
        };
        Chart.register(percentageGridLinesPlugin); // 註冊外掛

        
        // 以自訂順序排序；若找不到於順序表，則回退為「數值由小到大」；再不行回到字串比較
        function compareWithOrder(a, b, orderArr) {
            const aRaw = String(a).trim();
            const bRaw = String(b).trim();
            const aNumStr = aRaw.replace(/[^0-9.+-]/g, '');
            const bNumStr = bRaw.replace(/[^0-9.+-]/g, '');
            const aIdx = orderArr.indexOf(aNumStr);
            const bIdx = orderArr.indexOf(bNumStr);
            if (aIdx !== -1 || bIdx !== -1) {
                const av = (aIdx === -1) ? Infinity : aIdx;
                const bv = (bIdx === -1) ? Infinity : bIdx;
                if (av !== bv) return av - bv;
            }
            const aNum = parseFloat(aNumStr);
            const bNum = parseFloat(bNumStr);
            if (!Number.isNaN(aNum) && !Number.isNaN(bNum)) {
                if (aNum !== bNum) return aNum - bNum;
            }
            return aRaw.localeCompare(bRaw);
        }
// --- Helper 函數 ---
        function parseNumericValue(val) {
            const valStr = String(val).trim(); // ** 修正：Trim 空白 **
            // 移除 NT$ 或其他貨幣符號
            const cleanedStr = valStr.replace(/[$NT$]/g, '').trim(); 
            
            const hasPlusSuffix = cleanedStr.endsWith('+') || cleanedStr.includes('以上');
            // 匹配包含正負號、空格或逗號的數字
            const numMatch = cleanedStr.match(/([+-]?[\s]*[\d,]+(\.\d+)?)/); 
            
            if (numMatch) {
                const numStr = numMatch[1].replace(/[,]/g, '').replace(/\s/g, '');
                const num = parseFloat(numStr);
                if (!isNaN(num)) {
                    // 對於有 + 號結尾或「以上」的，標記為有後綴
                    if (hasPlusSuffix && num >= 0) {
                        return { num: num, hasPlus: true, original: valStr, isNumeric: true };
                    }
                    return { num: num, hasPlus: false, original: valStr, isNumeric: true };
                }
            }
            return { num: null, hasPlus: false, original: valStr, isNumeric: false };
        }
        function smartSort(a, b) {
            const valA = parseNumericValue(a);
            const valB = parseNumericValue(b);
            if (!valA.isNumeric && !valB.isNumeric) {
                return String(a).localeCompare(String(b));
            }
            if (!valA.isNumeric) return 1;
            if (!valB.isNumeric) return -1;
            if (valA.hasPlus && !valB.hasPlus) return 1;
            if (!valA.hasPlus && valB.hasPlus) return -1;
            if (valA.num !== valB.num) {
                return valA.num - valB.num;
            }
            return valA.original.localeCompare(valB.original);
        }

        // ** 修正 1.1：新增取得題目前綴的函數 **
        function getQuestionPrefix(key) {
            // Extracts '1.1' from '1.1_寵物類型', or '6.5' from '6.5_子女'
            const match = key.match(/^(\d+\.\d+)/);
            return match ? match[1] : key; // Return the prefix or the whole key if no match
        }

        // ** 新增 Q1：Debounce 函數 **
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
        };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
        };
        }

        let chart; // 主圖表 (樞紐)
        let rawData = [];
        let allColumns = [];
        let controls = {};
        let isUpdatingFilters = false;
        let smallCharts = {}; // ** 儲存小圖表的物件 **
        
        // --- 初始化 ---
        window.addEventListener('DOMContentLoaded', () => {
            // ** 修正 1.1: 設定預設 Apps Script 網址 **
            const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSC-co1UtcQ0V2faXXuPIr5F7s3pri4ukLq9Tyu5unMfeVseAHsr_F04D0yzDssU-wbA/exec';

            // 修正 1.2: 移除載入按鈕相關的 DOM 元素
            document.getElementById('setupInstructions').classList.remove('max-w-4xl', 'mx-auto', 'mb-8', 'p-6', 'bg-blue-50', 'border-2', 'border-blue-200', 'rounded-lg');
            document.getElementById('setupInstructions').innerHTML = `<h2 class="text-xl font-bold text-blue-800 mb-4">📋 設定狀態</h2><p class="text-gray-700">資料將於頁面開啟時自動載入。如需變更資料來源，請修改程式碼內 <code>DEFAULT_SCRIPT_URL</code> 變數。</p>`;
            
            const settingsModal = document.getElementById('settingsModal');
            const settingsButton = document.getElementById('settingsButton');
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const datalabelsSize = document.getElementById('datalabelsSize');
            const datalabelsSizeValue = document.getElementById('datalabelsSizeValue');
            const barThickness = document.getElementById('barThickness');
            const barThicknessValue = document.getElementById('barThicknessValue');
            
            // 桑基圖控制項
            const sankeySourceSelect = document.getElementById('sankeySourceSelect');
            const sankeyTargetSelect = document.getElementById('sankeyTargetSelect');
            const sankeyMinThreshold = document.getElementById('sankeyMinThreshold');
            const sankeyMinThresholdValue = document.getElementById('sankeyMinThresholdValue');
            // 新增桑基圖交換按鈕
            const swapSankeyAxesButton = document.getElementById('swapSankeyAxesButton');

            settingsButton.addEventListener('click', () => settingsModal.style.display = 'block');
            closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });

            // 初始化設定值顯示 (使用全域變數的預設值)
            datalabelsSize.value = DATALABELS_FONT_SIZE;
            datalabelsSizeValue.textContent = DATALABELS_FONT_SIZE;
            barThickness.value = SMALL_CHART_BAR_HEIGHT;
            barThicknessValue.textContent = SMALL_CHART_BAR_HEIGHT;
            sankeyMinThresholdValue.textContent = sankeyMinThreshold.value;

            // 綁定設定調整事件
            datalabelsSize.addEventListener('input', () => {
                DATALABELS_FONT_SIZE = parseInt(datalabelsSize.value);
                datalabelsSizeValue.textContent = DATALABELS_FONT_SIZE;
                if (chart) updateChartSettings(true); 
                updateSmallMultiplesSettings(true); 
            });

            barThickness.addEventListener('input', () => {
                SMALL_CHART_BAR_HEIGHT = parseInt(barThickness.value);
                barThicknessValue.textContent = SMALL_CHART_BAR_HEIGHT;
                // 不影響樞紐分析，只更新單欄分析
                updateSmallMultiplesSettings(true); 
            });
            
            // 綁定 Sankey 控制項事件
            sankeySourceSelect.addEventListener('change', updateSankeyChart);
            sankeyTargetSelect.addEventListener('change', updateSankeyChart);
            sankeyMinThreshold.addEventListener('input', () => {
                sankeyMinThresholdValue.textContent = sankeyMinThreshold.value;
                debounce(updateSankeyChart, 300)();
            });
            
            // 桑基圖交換按鈕事件
            swapSankeyAxesButton.addEventListener('click', () => {
                const sourceValue = sankeySourceSelect.value;
                const targetValue = sankeyTargetSelect.value;
                sankeySourceSelect.value = targetValue;
                sankeyTargetSelect.value = sourceValue;
                updateSankeyChart();
            });

            // ** 修正 1.4: 頁面載入後自動載入數據 **
            initDashboard(DEFAULT_SCRIPT_URL);
        });

        document.addEventListener('click', (e) => {
            const openFilters = document.querySelectorAll('.filter-dropdown[open]');
            openFilters.forEach(filter => {
                if (!filter.contains(e.target)) {
                    filter.open = false;
                }
            });
        });

        async function loadData(scriptUrl) {
            const debugInfo = document.getElementById('debugInfo');
            const loadingMessage = document.getElementById('loadingMessage');
            try {
                loadingMessage.textContent = '正在從 Google Sheet 擷取資料...';
                
                const url = scriptUrl;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`伺服器錯誤: ${response.status}`);
                }
                const jsonData = await response.json();
                if (jsonData.error) {
                    throw new Error(`Apps Script 錯誤: ${jsonData.error}`);
                }
                if (!Array.isArray(jsonData) || jsonData.length === 0) {
                    throw new Error('未收到任何資料或資料格式不符。');
                }
                return jsonData;
            } catch (error) {
                // 修正 2.2: 如果載入失敗，顯示錯誤資訊，並將 loading 隱藏
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('setupInstructions').classList.remove('hidden');
                const errorContainer = document.getElementById('debugInfo');
                if (errorContainer) {
                    errorContainer.innerHTML = `<p class="text-red-600 ml-4">❌ <strong>載入失敗: ${error.message}</strong></p>`;
                    errorContainer.innerHTML += `<p class="text-red-700 ml-6 mt-2">請檢查：<br>1. 程式碼中 <code>DEFAULT_SCRIPT_URL</code> 網址是否正確。<br>2. Apps Script 部署權限是否設定為「任何人」。<br>3. Google Sheet 的欄位是否有資料。</p>`;
                    document.getElementById('debugInfoContainer').classList.remove('hidden');
                }
                return [];
            }
        }

        async function initDashboard(scriptUrl) {
            rawData = await loadData(scriptUrl);
            if (rawData.length > 0) {
                allColumns = Object.keys(rawData[0]);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('setupInstructions').classList.remove('hidden'); // 顯示設定狀態
                // 修正 2.4: 成功載入後，隱藏錯誤資訊
                document.getElementById('debugInfoContainer').classList.add('hidden');
                setupControls();
                createChart(); // 建立主圖表
                updateChart(); // 更新主圖表
                updateSankeyChart(); // 建立桑基圖
                updateSmallMultiples(); // 更新小圖表
            }
        }

        function updateAnnotations() {
            // ** 簡化：只更新主圖表的註釋 **
            const yKey = controls.yAxisSelect.value;
            const cKey = controls.colorBySelect.value;
            const yEl = document.getElementById('yAxisQuestion');
            const cEl = document.getElementById('colorByQuestion');
            
            yEl.textContent = QUESTION_MAP[yKey] || '未找到問題描述';
            if (cKey === 'none') {
                cEl.textContent = '未分組';
            } else {
                cEl.textContent = QUESTION_MAP[cKey] || '未找到問題描述';
            }
        }

        function setupControls() {
            controls.yAxisSelect = document.getElementById('yAxisSelect');
            controls.colorBySelect = document.getElementById('colorBySelect'); // ** 簡化：固定為單選 **
            controls.valueSelect = document.getElementById('valueSelect');
            controls.smallValueSelect = document.getElementById('smallValueSelect'); // ** 修正 2：加入新的控制器 **
            controls.swapButton = document.getElementById('swapAxesButton');
            controls.arrowSelect = document.getElementById('arrowSelect');
            controls.subGroupSelect = document.getElementById('subGroupSelect'); // 次要分組選單
            
            // Pivot Table Controls
            controls.pivotRowMainSelect = document.getElementById('pivotRowMainSelect');
            controls.pivotRowSubSelect = document.getElementById('pivotRowSubSelect');
            controls.addPivotColumnBtn = document.getElementById('addPivotColumn');
            controls.pivotColumns = []; // 存儲動態添加的欄位配置
            
            // Sankey Controls
            controls.sankeySourceSelect = document.getElementById('sankeySourceSelect');
            controls.sankeyTargetSelect = document.getElementById('sankeyTargetSelect');

            // ** 簡化：移除 (總計) 選項 **
            controls.yAxisSelect.innerHTML = '';
            controls.colorBySelect.innerHTML = '<option value="none">不分組 (單一顏色)</option>';
            controls.sankeySourceSelect.innerHTML = '<option value="">請選擇</option>';
            controls.sankeyTargetSelect.innerHTML = '<option value="">請選擇</option>';
            controls.subGroupSelect.innerHTML = '<option value="">無</option>'; // 次要分組預設選項
            controls.pivotRowMainSelect.innerHTML = '<option value="">請選擇</option>';
            controls.pivotRowSubSelect.innerHTML = '<option value="">無</option>';

            allColumns.forEach(key => {
                controls.yAxisSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.colorBySelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.sankeySourceSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.sankeyTargetSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.subGroupSelect.innerHTML += `<option value="${key}">${key}</option>`; // 添加到次要分組選單
                controls.pivotRowMainSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.pivotRowSubSelect.innerHTML += `<option value="${key}">${key}</option>`;
            });
            
            // ** 新增：設定「單一欄位分析」的複選框 **
            const smallMultiplesControls = document.getElementById('smallMultiplesControls');
            let multiSelectHTML = '';
            allColumns.forEach(key => {
                multiSelectHTML += `
                    <label class="flex items-center">
                        <input type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 small-multiple-checkbox">
                        <span class="ml-2 text-sm text-gray-900">${key}</span>
                    </label>
                `;
            });
            smallMultiplesControls.innerHTML = multiSelectHTML;
            
            // ** 綁定新複選框的事件 **
            smallMultiplesControls.querySelectorAll('.small-multiple-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSmallMultiples);
            });
            
            // ** 新增 Q2 & Q3：綁定按鈕事件 **
            document.getElementById('sm-select-all').addEventListener('click', () => {
                smallMultiplesControls.querySelectorAll('.small-multiple-checkbox').forEach(cb => cb.checked = true);
                updateSmallMultiples();
            });
            document.getElementById('sm-deselect-all').addEventListener('click', (e) => {
                e.preventDefault();
                smallMultiplesControls.querySelectorAll('.small-multiple-checkbox').forEach(cb => cb.checked = false);
                updateSmallMultiples();
            });
            document.getElementById('sm-download-screenshot').addEventListener('click', downloadScreenshot);
            
            // 綁定樞紐分析截圖按鈕
            document.getElementById('pivot-download-screenshot').addEventListener('click', downloadPivotScreenshot);
            
            // 綁定樞紐分析表格截圖按鈕
            document.getElementById('pivotTable-download-screenshot').addEventListener('click', downloadPivotTableScreenshot);


            // --- 篩選器 (共用) ---
            const filtersContainer = document.getElementById('filtersContainer');
            filtersContainer.innerHTML = '';
            allColumns.forEach(colKey => {
                const details = document.createElement('details');
                details.className = 'filter-dropdown';
                details.innerHTML = `<summary class="text-sm font-medium" title="${colKey}">${colKey}</summary><div class="filter-panel space-y-2" id="filter-${colKey}-panel"></div>`;
                filtersContainer.appendChild(details);
            });

            // --- 綁定主圖表事件 ---
            controls.yAxisSelect.addEventListener('change', () => { 
                updateAnnotations(); 
                updateChart(); 
                updateSankeyChart(); // 篩選器變更也更新 Sankey
            });
            controls.colorBySelect.addEventListener('change', () => {
                updateAnnotations();
                updateChart();
                updateSankeyChart(); // 篩選器變更也更新 Sankey
            });
            controls.swapButton.addEventListener('click', () => {
                const yValue = controls.yAxisSelect.value;
                const cValue = controls.colorBySelect.value;
                controls.yAxisSelect.value = cValue;
                controls.colorBySelect.value = yValue;
                updateAnnotations();
                updateChart();
                updateSankeyChart(); // 篩選器變更也更新 Sankey
            });
            controls.arrowSelect.addEventListener('change', () => {
                // 立即更新一次
                updateArrowPosition();
                // 延遲再更新一次，確保圖表已完全渲染
                setTimeout(() => updateArrowPosition(), 50);
            });
            
            // 次要分組選單事件
            controls.subGroupSelect.addEventListener('change', () => {
                updateChart();
            });
            
            // 樞紐圖表分析事件
            controls.pivotRowMainSelect.addEventListener('change', updatePivotTable);
            controls.pivotRowSubSelect.addEventListener('change', updatePivotTable);
            controls.addPivotColumnBtn.addEventListener('click', addPivotColumnField);
            
            // 初始化時添加一個欄位
            addPivotColumnField();

            // ** 修正 2：「值」和「篩選器」需要*分開*更新兩個圖表區塊 **
            controls.valueSelect.addEventListener('change', updateChart); // ** 只更新主圖表 **
            controls.smallValueSelect.addEventListener('change', updateSmallMultiples); // ** 只更新小圖表 **

            updateFilterOptions(true); // updateFilterOptions 內部會綁定篩選器的 change 事件
            updateAnnotations();
        }

        
        function updateFilterOptions(isInitial = false) {
            if (isUpdatingFilters) return;
            const selections = {};
            allColumns.forEach(key => {
                const panel = document.getElementById(`filter-${key}-panel`);
                if (panel) {
                    const checkedCbs = panel.querySelectorAll('input:checked');
                    selections[key] = Array.from(checkedCbs).map(cb => cb.value);
                }
            });

            allColumns.forEach(targetKey => {
                let availableValues = [...new Set(rawData.map(d => d[targetKey]))];
                
                // ** 修正：使用 .trim() 進行排序列表比對 **
                if (CUSTOM_SORT_ORDERS[targetKey]) {
                    const customOrder = CUSTOM_SORT_ORDERS[targetKey];
                    const getSortIndex = (val) => {
                        const raw = String(val).trim();
                        const numeric = raw.replace(/[^0-9.+-]/g, '');
                        let idx = -1;
                        if (numeric !== '') { idx = customOrder.indexOf(numeric); }
                        if (idx === -1) { idx = customOrder.indexOf(raw); }
                        return idx === -1 ? Infinity : idx;
        };
                    availableValues.sort((a, b) => getSortIndex(a) - getSortIndex(b));
                } else {
                    availableValues.sort(smartSort);
                }
                
                const panel = document.getElementById(`filter-${targetKey}-panel`);
                if (!panel) return;
                const currentSelections = selections[targetKey] || [];
                panel.innerHTML = '';
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex gap-2 mb-2 sticky top-0 bg-white py-1';
                buttonsDiv.innerHTML = `
                    <button class="select-all-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">全選</button>
                    <button class="deselect-all-btn text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">清除</button>
                `;
                panel.appendChild(buttonsDiv);
                
                availableValues.forEach(val => {
                    const valAsString = String(val);
                    const checkboxId = `cb-${targetKey}-${valAsString.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const isChecked = isInitial || currentSelections.includes(valAsString);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${valAsString}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 filter-checkbox" ${isChecked ? 'checked' : ''}>
                        <label for="${checkboxId}" class="ml-2 block text-sm text-gray-900">${valAsString}</label>
                    `;
                    panel.appendChild(itemDiv);
                });
                
                // ** 修正 3：確認篩選器會更新三個圖表 **
                panel.querySelector('.select-all-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    panel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                    updateChart();
                    updateSmallMultiples(); 
                    updateSankeyChart(); // 篩選器變更也更新 Sankey
                });
                panel.querySelector('.deselect-all-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    panel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    updateChart();
                    updateSmallMultiples(); 
                    updateSankeyChart(); // 篩選器變更也更新 Sankey
                });
                panel.querySelectorAll('.filter-checkbox').forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateChart();
                        updateSmallMultiples(); 
                        updateSankeyChart(); // 篩選器變更也更新 Sankey
                    });
                });
            });
        }

        // --- 標記建立函數 (Marker Creation Functions) ---
        // (這些只給主圖表使用)
        function createOrUpdateArrows(count) {
            const arrowContainer = document.getElementById('markerContainer');
            if (!arrowContainer) return;
            const existing = arrowContainer.querySelectorAll('.chart-arrow');
            
            for (let i = existing.length - 1; i >= count; i--) {
                arrowContainer.removeChild(existing[i]);
            }
            for (let i = existing.length; i < count; i++) {
                const arrowEl = document.createElement('div');
                arrowEl.id = `chartArrow-${i}`;
                arrowEl.className = 'chart-arrow';
                arrowContainer.appendChild(arrowEl);
            }
        }
        function createOrUpdateQuantileMarkers(count) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const markers = ['q1', 'q2', 'q3']; 
            const existing = container.querySelectorAll('.quantile-marker');
            const targetCount = count * markers.length;
            for (let i = existing.length - 1; i >= targetCount; i--) container.removeChild(existing[i]);
            for (let i = existing.length; i < targetCount; i++) {
                const yIndex = Math.floor(i / markers.length);
                const markerType = markers[i % markers.length];
                const markerEl = document.createElement('div');
                markerEl.id = `quantileMarker-${yIndex}-${markerType}`;
                markerEl.className = `quantile-marker ${markerType === 'q2' ? 'quantile-marker-q2' : ''}`;
                container.appendChild(markerEl);
            }
        }
        function createOrUpdateAverageLabels(count) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const existing = container.querySelectorAll('.average-label');
            for (let i = existing.length - 1; i >= count; i--) container.removeChild(existing[i]);
            for (let i = existing.length; i < count; i++) {
                const labelEl = document.createElement('div');
                labelEl.id = `averageLabel-${i}`;
                labelEl.className = 'average-label';
                container.appendChild(labelEl);
            }
        }

        // --- 標記更新函數 (Marker Update Functions) ---
        // (這些只給主圖表使用)
        function updateArrowPosition(hide = false) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const arrows = container.querySelectorAll('.chart-arrow');
            if (hide) {
                arrows.forEach(arrow => arrow.style.display = 'none');
                return;
            }
            const selectEl = document.getElementById('arrowSelect');
            const selectedLabelString = selectEl.value;
            arrows.forEach(arrow => arrow.style.display = 'none'); 
            if (!chart || !selectedLabelString) return;
            
            // 強制圖表更新以確保所有元素位置正確
            chart.update('none'); // 使用 'none' 模式避免動畫延遲
            
            const datasets = chart.data.datasets;
            let datasetIndex = -1;
            for (let i = 0; i < datasets.length; i++) {
                if (String(datasets[i].label) === selectedLabelString) {
                    datasetIndex = i;
                    break;
                }
            }
            if (datasetIndex === -1) return; 
            const meta = chart.getDatasetMeta(datasetIndex);
            if (!meta || !meta.data || meta.data.length === 0) return;
            meta.data.forEach((element, index) => {
                const arrowEl = document.getElementById(`chartArrow-${index}`);
                if (!arrowEl || !element || typeof element.getProps !== 'function' || element.hidden) {
                    if (arrowEl) arrowEl.style.display = 'none';
                    return;
                }
                const props = element.getProps(['x', 'y', 'height', 'base'], true);
                const hasVisibleWidth = props && (props.x > props.base + 0.01);
                if (hasVisibleWidth) {
                    const xPos = props.x;
                    const yPos = props.y - (props.height / 2);
                    const arrowHeight = 8;
                    const margin = 2;
                    arrowEl.style.left = `${xPos}px`;
                    arrowEl.style.top = `${yPos - arrowHeight - margin}px`;
                    arrowEl.style.display = 'block';
                } else {
                    arrowEl.style.display = 'none';
                }
            });
        }
        function updateQuantileMarkers(hide = false, yKey, groupKey, yLabels, filteredData) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const allMarkers = container.querySelectorAll('.quantile-marker');
            allMarkers.forEach(marker => marker.style.display = 'none'); 
            if (hide || !chart) return;
            yLabels.forEach((yLabel, yIndex) => {
                
                // ** BUG 1 修正 (第二次)：使用 bar element 的屬性來定位 **
                // 我們需要 bar element 的屬性來找到它的底部邊緣
                let barProps = null;
                for (let i = 0; i < chart.data.datasets.length; i++) {
                    const meta = chart.getDatasetMeta(i);
                    if (meta && meta.data[yIndex]) {
                        const el = meta.data[yIndex];
                        if (el && !el.hidden && typeof el.getProps === 'function') {
                            // 找到了第一個可見的 bar，取得它的屬性
                            barProps = el.getProps(['y', 'height'], true);
                            break; // 找到就跳出迴圈
                        }
                    }
                }

                // 如果沒有可見的 bar，就無法放置 marker
                if (!barProps) return; 

                // barProps.y 是 bar 的中心 Y 軸位置
                // barProps.height 是 bar 的厚度
                const barBottomEdge = barProps.y + (barProps.height / 2);
                // ** BUG 1 修正結束 **

                let groupData = filteredData
                    .filter(d => String(d[yKey]) === String(yLabel))
                    .map(d => d[groupKey])
                    .filter(val => val !== undefined && val !== null);
                if (groupData.length === 0) return;
                
                // ** 修正：使用 .trim() 進行排序列表比對 **
                const customOrder = CUSTOM_SORT_ORDERS[groupKey];
                const sortedIndices = Array.from(Array(groupData.length).keys()).sort((a, b) => {
                    if (customOrder) {
                        const getSortIndex = (val) => {
                            const raw = String(val).trim();
                        const numeric = raw.replace(/[^0-9.+-]/g, '');
                        let idx = -1;
                        if (numeric !== '') { idx = customOrder.indexOf(numeric); }
                        if (idx === -1) { idx = customOrder.indexOf(raw); }
                        return idx === -1 ? Infinity : idx;
        };
                        return getSortIndex(groupData[a]) - getSortIndex(groupData[b]);
                    }
                    return smartSort(groupData[a], groupData[b]);
                });
                
                const q1Index = sortedIndices[Math.floor(groupData.length * 0.25)];
                const q2Index = sortedIndices[Math.floor(groupData.length * 0.50)];
                const q3Index = sortedIndices[Math.floor(groupData.length * 0.75)];
                const q1Value = groupData[q1Index];
                const q2Value = groupData[q2Index];
                const q3Value = groupData[q3Index];
                const datasets = chart.data.datasets;
                const q1DatasetIndex = datasets.findIndex(ds => String(ds.label) === String(q1Value));
                const q2DatasetIndex = datasets.findIndex(ds => String(ds.label) === String(q2Value));
                const q3DatasetIndex = datasets.findIndex(ds => String(ds.label) === String(q3Value));

                // ** 修正 2：獲取長條區塊的中心點 X 軸位置 **
                const getXPixel = (targetDatasetIndex) => {
                    if (targetDatasetIndex === -1) return null;
                    const datasetMeta = chart.getDatasetMeta(targetDatasetIndex);
                    if (!datasetMeta || !datasetMeta.data[yIndex]) return null;
                    const dataElement = datasetMeta.data[yIndex];
                    if (dataElement.hidden || !dataElement.getProps) return null; 
                    
                    // 取得 bar segment 的中心點 X 軸位置
                    return dataElement.getCenterPoint().x;
        };
                // ** 修正結束 **

                const xPixels = { q1: getXPixel(q1DatasetIndex), q2: getXPixel(q2DatasetIndex), q3: getXPixel(q3DatasetIndex) };
                ['q1', 'q2', 'q3'].forEach(q => {
                    const markerEl = document.getElementById(`quantileMarker-${yIndex}-${q}`);
                    // 箭頭距離長條底部邊緣 4px
                    const markerMargin = 4; 
                    if (markerEl && xPixels[q] !== null) {
                        markerEl.style.left = `${xPixels[q]}px`;
                        // ** 關鍵修正：使用 barBottomEdge **
                        markerEl.style.top = `${barBottomEdge + markerMargin}px`; 
                        markerEl.style.display = 'block';
                    }
                });
            });
        }
        function updateAverageLabels(hide = false, yKey, groupKey, yLabels, filteredData, subGroupKey = null) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const allLabels = container.querySelectorAll('.average-label');
            allLabels.forEach(label => label.style.display = 'none');
            if (hide || !chart) return;
            
            yLabels.forEach((yItem, yIndex) => {
                // 如果是字串（舊格式），轉換為物件
                const labelObj = typeof yItem === 'string' ? { primary: yItem, secondary: null, isSpacer: false, isTotal: false } : yItem;
                
                // 跳過間距標籤
                if (labelObj.isSpacer) return;
                
                let numericData;
                if (subGroupKey && labelObj.secondary && !labelObj.isTotal) {
                    // 有次要分組且不是總計：過濾主要和次要分組
                    numericData = filteredData
                        .filter(d => String(d[yKey]) === String(labelObj.primary) && String(d[subGroupKey]) === String(labelObj.secondary))
                        .map(d => parseNumericValue(d[groupKey]))
                        .filter(val => val.isNumeric)
                        .map(val => val.num);
                } else {
                    // 無次要分組或是總計BAR：只過濾主要分組
                    numericData = filteredData
                        .filter(d => String(d[yKey]) === String(labelObj.primary))
                        .map(d => parseNumericValue(d[groupKey]))
                        .filter(val => val.isNumeric)
                        .map(val => val.num);
                }
                
                if (numericData.length === 0) return; 
                const sum = numericData.reduce((a, b) => a + b, 0);
                const average = sum / numericData.length;
                const meta = chart.getDatasetMeta(0); 
                if (!meta || !meta.data[yIndex]) return;
                const element = meta.data[yIndex];
                if (!element || typeof element.getProps !== 'function') return;
                const lastDatasetMeta = chart.getDatasetMeta(chart.data.datasets.length - 1);
                if (!lastDatasetMeta || !lastDatasetMeta.data[yIndex]) return;
                const lastElement = lastDatasetMeta.data[yIndex];
                const props = lastElement.getProps(['x', 'y', 'height'], true);
                const yPixel = props.y; 
                let xPixel = props.x; 
                const valueType = controls.valueSelect.value;
                if(valueType === 'percent') {
                    xPixel = chart.scales.x.getPixelForValue(100);
                }
                
                // 修改：將標籤放在圖表右邊緣外側（加上5px間距）
                const chartRightEdge = chart.scales.x.right;
                const labelX = chartRightEdge + 5;
                
                const labelEl = document.getElementById(`averageLabel-${yIndex}`);
                if (labelEl) {
                    labelEl.textContent = `${average.toFixed(1)}`; 
                    labelEl.style.left = `${labelX}px`;
                    labelEl.style.top = `${yPixel}px`;
                    labelEl.style.display = 'block';
                }
            });
        }

        // ** 修正 3.0: 更新主圖表設定的函數 (加入 forceUpdate 參數) **
        function updateChartSettings(forceUpdate = false) {
            if (!chart) return;
            
            // ** 修正 1.1: 如果用戶調整了設定，我們強制將設定值寫入 Options **
            chart.options.scales.y.barPercentage = BAR_PERCENTAGE;
            chart.options.scales.y.categoryPercentage = BAR_CATEGORY_PERCENTAGE;
            chart.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE;
            
            if (forceUpdate) {
                 // 重新觸發完整更新，這會重新計算高度並重繪
                 updateChart();
                 updateSankeyChart(); // 重新繪製 Sankey 圖
            } else {
                chart.update();
                const yKey = controls.yAxisSelect.value;
                const groupKey = controls.colorBySelect.value;
                // 注意：filteredData 在這裡可能不是最新的，但我們假設它足夠用於 marker 的大致定位
                const isGroupKeyNumeric = groupKey !== 'none' && rawData.length > 0 && parseNumericValue(rawData[0][groupKey]).isNumeric; // 簡化判斷
                setTimeout(() => triggerMarkerUpdates(yKey, groupKey, chart.data.labels, rawData, isGroupKeyNumeric), 50);
            }
        }

        // --- 主更新函數 (樞紐分析) ---
        function updateChart() {
            if (!chart || !controls.yAxisSelect) return;
            isUpdatingFilters = true;

            const yKey = controls.yAxisSelect.value;
            const groupKey = controls.colorBySelect.value;
            const subGroupKey = controls.subGroupSelect.value; // 次要分組
            const valueType = controls.valueSelect.value;
            updateAnnotations();
            
            // 控制次要分組選單的顯示
            const subGroupContainer = document.getElementById('subGroupContainer');
            if (yKey) {
                subGroupContainer.classList.remove('hidden');
            } else {
                subGroupContainer.classList.add('hidden');
            }

            // 抓取篩選 (與小圖表共用)
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            const getSortIndex = (val, customOrder) => {
                const index = customOrder.indexOf(String(val).trim()); // ** 修正：Trim 空白 **
                return index === -1 ? Infinity : index;
        };

            // 處理次要分組
            let yLabels;
            if (subGroupKey) {
                // 有次要分組：創建組合標籤（例如："無閒錢-犬", "無閒錢-貓"）
                const primaryLabels = [...new Set(filteredData.map(d => d[yKey]))];
                if (CUSTOM_SORT_ORDERS[yKey]) primaryLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[yKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[yKey]));
                else primaryLabels.sort(smartSort);
                
                const secondaryLabels = [...new Set(filteredData.map(d => d[subGroupKey]))];
                if (CUSTOM_SORT_ORDERS[subGroupKey]) secondaryLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[subGroupKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[subGroupKey]));
                else secondaryLabels.sort(smartSort);
                
                // 創建組合標籤，在主要分組之間添加固定1個間距
                yLabels = [];
                primaryLabels.forEach((primary, pIdx) => {
                    // 1. 先添加主要分組的總計BAR
                    yLabels.push({ primary, secondary: null, label: String(primary), isSpacer: false, isTotal: true });
                    
                    // 2. 再添加各個次要分組的BAR
                    secondaryLabels.forEach(secondary => {
                        // 檢查這個組合是否有資料
                        const hasData = filteredData.some(d => String(d[yKey]) === String(primary) && String(d[subGroupKey]) === String(secondary));
                        if (hasData) {
                            yLabels.push({ primary, secondary, label: `${primary}-${secondary}`, isSpacer: false, isTotal: false });
                        }
                    });
                    
                    // 3. 在每個主要分組後添加1個間距標籤（除了最後一個）
                    if (pIdx < primaryLabels.length - 1) {
                        yLabels.push({ primary: null, secondary: null, label: '', isSpacer: true, isTotal: false }); // 空字串隱藏標籤
                    }
                });
            } else {
                // 無次要分組：使用原本的邏輯
                yLabels = [...new Set(filteredData.map(d => d[yKey]))];
                if (CUSTOM_SORT_ORDERS[yKey]) yLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[yKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[yKey]));
                else yLabels.sort(smartSort);
                yLabels = yLabels.map(label => ({ primary: label, secondary: null, label, isSpacer: false, isTotal: false }));
            }
            
            chart.data.labels = yLabels.map(item => item.label);

            let groupLabels;
            let colorMap = {};
            const isPercent = valueType === 'percent';
            
            let isGroupKeyNumeric = false;
            if (groupKey !== 'none' && filteredData.length > 0) {
                const firstValue = filteredData.find(d => d[groupKey] !== null && d[groupKey] !== undefined);
                if(firstValue) {
                    isGroupKeyNumeric = parseNumericValue(firstValue[groupKey]).isNumeric;
                }
            }

            if (groupKey !== 'none') {
                groupLabels = [...new Set(filteredData.map(d => d[groupKey]))];
                if (CUSTOM_SORT_ORDERS[groupKey]) groupLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[groupKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[groupKey]));
                else groupLabels.sort(smartSort);

                // ** 修正：使用固定顏色地圖和優先檢查邏輯 **
                let activePalette;
                if (isGroupKeyNumeric && groupLabels.length > 3) activePalette = GRADIENT_PALETTE; 
                else activePalette = CATEGORICAL_PALETTE;
                
                let paletteIndex = 0;
                colorMap = {};
                groupLabels.forEach((val) => {
                    const valStr = String(val).trim();
                    const prefix = getQuestionPrefix(groupKey); // <-- 取得題號前綴

                    // 1. 優先檢查 (問題前綴 + 選項值) 的組合 e.g., '6.5_有'
                    const keyedColor = FIXED_ANSWER_COLORS[prefix + '_' + valStr]; // <-- 使用前綴查找
                    if (keyedColor) {
                        colorMap[String(val)] = keyedColor;
                    // 2. 接著檢查單純的選項值
                    } else if (FIXED_ANSWER_COLORS[valStr]) {
                        colorMap[String(val)] = FIXED_ANSWER_COLORS[valStr];
                    } else {
                        // 3. 都不匹配時，使用漸層或類別調色盤
                        colorMap[String(val)] = activePalette[paletteIndex % activePalette.length];
                        paletteIndex++;
                    }
                });
                // ** 修正結束 **

                const totalsPerYLabel = yLabels.map(yItem => {
                    if (yItem.isSpacer) return 1; // 間距標籤
                    let count;
                    if (subGroupKey && !yItem.isTotal) {
                        // 次要分組的細分BAR：需要過濾主要和次要
                        count = filteredData.filter(d => String(d[yKey]) === String(yItem.primary) && String(d[subGroupKey]) === String(yItem.secondary)).length;
                    } else {
                        // 主要分組的總計BAR或無次要分組：只過濾主要
                        count = filteredData.filter(d => String(d[yKey]) === String(yItem.primary)).length;
                    }
                    return count > 0 ? count : 1;
                });

                chart.data.datasets = groupLabels.map(groupVal => {
                    const dataValues = yLabels.map((yItem, yIdx) => {
                        if (yItem.isSpacer) return 0; // 間距標籤顯示為0
                        let count;
                        if (subGroupKey && !yItem.isTotal) {
                            // 次要分組的細分BAR：需要過濾主要、次要和顏色分組
                            count = filteredData.filter(d => 
                                String(d[yKey]) === String(yItem.primary) && 
                                String(d[subGroupKey]) === String(yItem.secondary) &&
                                String(d[groupKey]) === String(groupVal)
                            ).length;
                        } else {
                            // 主要分組的總計BAR或無次要分組：只過濾主要和顏色分組
                            count = filteredData.filter(d => 
                                String(d[yKey]) === String(yItem.primary) && 
                                String(d[groupKey]) === String(groupVal)
                            ).length;
                        }
                        return isPercent ? (count / totalsPerYLabel[yIdx]) * 100 : count;
                    });
                    const originalLabel = [...new Set(rawData.map(d => d[groupKey]))].find(l => String(l) === String(groupVal)) ?? groupVal;
                    // ** 修正：使用 colorMap 取得顏色 **
                    const color = colorMap[String(groupVal)] || CATEGORICAL_PALETTE[0]; 
                    return { 
                        label: originalLabel, 
                        data: dataValues, 
                        backgroundColor: color + 'CC', 
                        borderColor: color, 
                        borderWidth: 0, 
                        borderRadius: 0 
        };
                });
                
                document.getElementById('yAxisChartTitle').textContent = subGroupKey ? `${yKey} (次要分組: ${subGroupKey})` : yKey;
                document.getElementById('cAxisChartTitle').textContent = groupKey;
                
            } else { // 無分組
                const dataCounts = yLabels.map(yItem => {
                    if (yItem.isSpacer) return 0; // 間距標籤顯示為0
                    if (subGroupKey && !yItem.isTotal) {
                        // 次要分組的細分BAR
                        return filteredData.filter(d => 
                            String(d[yKey]) === String(yItem.primary) && 
                            String(d[subGroupKey]) === String(yItem.secondary)
                        ).length;
                    } else {
                        // 主要分組的總計BAR或無次要分組
                        return filteredData.filter(d => String(d[yKey]) === String(yItem.primary)).length;
                    }
                });
                chart.data.datasets = [{
                    label: '筆數', data: dataCounts,
                    backgroundColor: CATEGORICAL_PALETTE[0] + 'CC', borderColor: CATEGORICAL_PALETTE[0], 
                    borderWidth: 0, // ** 修正：移除間距 **
                    borderRadius: 0 // ** 新增：移除圓角 **
                }];
                document.getElementById('yAxisChartTitle').textContent = subGroupKey ? `${yKey} (次要分組: ${subGroupKey})` : yKey;
                document.getElementById('cAxisChartTitle').textContent = '';
            }

            // --- 更新圖表選項 (X軸, Tooltip, Datalabels) ---
            chart.options.plugins.tooltip.callbacks = {
                // ** 修正 2.1: 突出顯示當前 hover 的 dataset **
                label: function(context) {
                    let label = context.dataset.label || '';
                    const rawCount = filteredData.filter(d => 
                        String(d[yKey]) === String(chart.data.labels[context.dataIndex]) && 
                        String(d[groupKey]) === String(context.dataset.label)
                    ).length;

                    if (label) {
                        label += ': ';
                    } else {
                        label = '筆數: ';
                    }

                    if (isPercent) {
                        label += context.parsed.x !== null ? context.parsed.x.toFixed(1) + '%' : 'N/A';
                        label += ` (${rawCount}筆)`;
                    } else {
                        label += context.parsed.x !== null ? context.parsed.x : 'N/A';
                    }
                    return label;
                },
                // ** 新增 footer: 顯示當前 hover 的總數和百分比 **
                footer: function(context) {
                    const yValue = chart.data.labels[context[0].dataIndex];
                    const total = filteredData.filter(d => String(d[yKey]) === String(yValue)).length;
                    const totalText = total > 0 ? `總計: ${total} 筆` : '總計: N/A';
                    return totalText;
                }
        };
            
            // ** 修正 2.2: 突出顯示 hover 的 bar **
            chart.options.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            chart.options.plugins.tooltip.titleFont = { weight: 'bold', size: 14 }; // 確保標題粗體
            chart.options.plugins.tooltip.footerFont = { weight: 'bold', size: 12 };
            chart.options.plugins.tooltip.mode = 'nearest'; // 確保能抓到單獨的 bar
            chart.options.plugins.tooltip.position = 'nearest'; 


            if (isPercent) {
                chart.options.scales.x.max = 100;
                chart.options.scales.x.title.text = '各列佔比 (%)';
                chart.options.plugins.datalabels.display = true;
                // ** 修正 3.1: 使用全局設定的字體大小 **
                chart.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE;
                chart.options.plugins.datalabels.formatter = (value) => value > 5 ? Math.round(value) + '%' : '';
            } else { // 筆數模式
                chart.options.scales.x.max = undefined;
                chart.options.scales.x.title.text = '筆數 (Count)';
                chart.options.plugins.datalabels.display = false;
            }
            
            // ** 修正 1.1: 套用長條粗度設定 (Pivot) **
            chart.options.scales.y.barPercentage = BAR_PERCENTAGE;
            chart.options.scales.y.categoryPercentage = BAR_CATEGORY_PERCENTAGE;
            chart.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE; // 確保 datalabels size 也同步

            // --- 動態調整圖表高度 ---
            const chartContainer = document.querySelector('.chart-container');
            const heightPerLabel = 30;
            // ** 修正 1.2: 考慮 BAR_CATEGORY_PERCENTAGE 來調整高度 **
            const adjustedHeightPerLabel = heightPerLabel * BAR_CATEGORY_PERCENTAGE;
            const baseHeight = 150;
            const newHeight = baseHeight + yLabels.length * adjustedHeightPerLabel;
            const finalHeight = Math.min(Math.max(newHeight, 350), 8000); // 最小高度降低
            chartContainer.style.height = `${finalHeight}px`;
            if (chart) chart.resize();

            // --- 更新圖例 ---
            const legendContainer = document.getElementById('customLegend');
            const arrowSelectContainer = document.getElementById('arrowSelectContainer');
            if (groupKey !== 'none') {
                let legendHTML = '';
                chart.data.datasets.forEach((dataset, index) => {
                    const label = dataset.label;
                    const color = dataset.borderColor || dataset.backgroundColor;
                    const isHidden = dataset.hidden || false;
                    legendHTML += `<div class="flex items-center legend-item ${isHidden ? 'legend-item-hidden' : ''}" data-label="${label}" data-dataset-index="${index}">
                                     <span class="w-3 h-3 mr-1" style="background-color: ${color}; border-radius: 2px;"></span>
                                     <span class="text-sm text-gray-700">${label}</span>
                                   </div>`;
                });
                legendContainer.innerHTML = legendHTML;
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const datasetIndex = parseInt(item.getAttribute('data-dataset-index'));
                        if (!chart || isNaN(datasetIndex) || datasetIndex < 0 || datasetIndex >= chart.data.datasets.length) return;
                        chart.data.datasets[datasetIndex].hidden = !chart.data.datasets[datasetIndex].hidden;
                        item.classList.toggle('legend-item-hidden', chart.data.datasets[datasetIndex].hidden);
                        chart.update();
                        setTimeout(() => triggerMarkerUpdates(yKey, groupKey, yLabels, filteredData, isGroupKeyNumeric), 10);
                    });
                });
                controls.arrowSelect.innerHTML = '<option value="">請選擇</option>';
                groupLabels.forEach(label => controls.arrowSelect.innerHTML += `<option value="${label}">${label}</option>`);
                arrowSelectContainer.classList.remove('hidden'); 
            } else { 
                legendContainer.innerHTML = '';
                arrowSelectContainer.classList.add('hidden');
                controls.arrowSelect.value = "";
            }

            // --- 更新篩選器狀態 ---
            updateFilterActiveStates();

            // --- 更新圖表與標記 ---
            chart.update();
            createOrUpdateArrows(yLabels.length);
            createOrUpdateQuantileMarkers(yLabels.length);
            createOrUpdateAverageLabels(yLabels.length);
            setTimeout(() => {
                triggerMarkerUpdates(yKey, groupKey, yLabels, filteredData, isGroupKeyNumeric, subGroupKey);
            }, 50); 
            isUpdatingFilters = false;
        }
        
        // --- 提取篩選器狀態 (通用函數) ---
        function getActiveFilters() {
            const activeFilters = {};
            allColumns.forEach(catKey => {
                const panel = document.getElementById(`filter-${catKey}-panel`);
                if (panel) {
                    const checkedCbs = panel.querySelectorAll('input:checked');
                    activeFilters[catKey] = Array.from(checkedCbs).map(cb => cb.value);
                }
            });
            return activeFilters;
        }
        
        // --- 更新篩選器視覺狀態 (通用函數) ---
        function updateFilterActiveStates() {
            allColumns.forEach(catKey => {
                const panel = document.getElementById(`filter-${catKey}-panel`);
                if (!panel) return;
                const summary = panel.closest('.filter-dropdown').querySelector('summary');
                if (!summary) return;
                const allCheckboxes = panel.querySelectorAll('input[type="checkbox"].filter-checkbox');
                const checkedCheckboxes = panel.querySelectorAll('input[type="checkbox"].filter-checkbox:checked');
                if (allCheckboxes.length > 0) {
                    const isFiltered = checkedCheckboxes.length < allCheckboxes.length;
                    summary.classList.toggle('filter-active', isFiltered);
                } else {
                    summary.classList.remove('filter-active');
                }
            });
        }
        
        // --- 主標記觸發 (樞紐分析) ---
        function triggerMarkerUpdates(yKey, groupKey, yLabels, filteredData, isGroupKeyNumeric, subGroupKey = null) {
            // ** 修正：從 controls 重新獲取 valueType **
            const valueType = controls.valueSelect.value;
            const hideQuantiles = valueType === 'percent' || groupKey === 'none' || !isGroupKeyNumeric;
            const hideAverage = groupKey === 'none' || !isGroupKeyNumeric;
            
            updateArrowPosition(false);
            updateQuantileMarkers(hideQuantiles, yKey, groupKey, yLabels, filteredData);
            updateAverageLabels(hideAverage, yKey, groupKey, yLabels, filteredData, subGroupKey);
        }

        // 建立圖表 (只執行一次)
        function createChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 20, right: 60 } }, // 添加右側padding為平均數標籤留空間
                    scales: {
                        x: { stacked: true, title: { display: true, text: '筆數 (Count)', font: { size: 14 } } },
                        y: { 
                            stacked: true, 
                            ticks: { autoSkip: false },
                            barPercentage: BAR_PERCENTAGE,  // ** 使用全局變數 **
                            categoryPercentage: BAR_CATEGORY_PERCENTAGE // ** 使用全局變數 **
                        }
                    },
                    plugins: {
                        datalabels: { 
                            display: false, 
                            color: '#333', 
                            font: { weight: 'bold', size: DATALABELS_FONT_SIZE } // ** 使用全局變數 **
                        },
                        tooltip: { 
                            enabled: true, 
                            mode: 'index', 
                            intersect: false,
                            // ** 修正 Tooltip 顯示 **
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { weight: 'bold', size: 14 }, 
                            footerFont: { weight: 'bold', size: 12 },
                            mode: 'nearest', 
                            position: 'nearest' 
                        },
                        legend: { display: false }
                    }
                }
            });
            
            // ** 修正 Q1：修改 Resize 事件 **
            window.addEventListener('resize', debounce(() => {
                // 完整重繪，才能在 Zoom 之後正確定為
                updateChart();
                updateSankeyChart(); // 縮放時重繪 Sankey
                updateSmallMultiples();
            }, 250));
        }
        
        // ===============================================
        // == 桑基圖 (Sankey Diagram) 函數 (新增/替換) ==
        // ===============================================
        
        // ** Helper for Sankey Color **
        const getColorForValue = (value, key) => {
                const valStr = String(value).trim();
                const prefix = getQuestionPrefix(key);
                
                // 1. 優先檢查 (問題前綴 + 選項值) 的組合 e.g., '6.5_有'
                const keyedColor = FIXED_ANSWER_COLORS[prefix + '_' + valStr];
                if (keyedColor) return keyedColor;
                
                // 2. 接著檢查單純的選項值
                if (FIXED_ANSWER_COLORS[valStr]) return FIXED_ANSWER_COLORS[valStr];

                // 3. 都不匹配時，使用通用調色盤
                const uniqueValues = [...new Set(rawData.map(d => String(d[key]).trim()))];
                const categoryIndex = uniqueValues.indexOf(valStr);
                return CATEGORICAL_PALETTE[categoryIndex % CATEGORICAL_PALETTE.length];
        };
        
        function generateSankeyLegend(nodes, key, isSource) {
            const legendContainer = document.getElementById(isSource ? 'sankeySourceLegend' : 'sankeyTargetLegend');
            const legendTitle = document.getElementById(isSource ? 'sourceLegendTitle' : 'targetLegendTitle');
            
            // v8 修正：確保 DOM 元素存在
            if (!legendContainer || !legendTitle) {
                console.error("Sankey legend container or title not found.");
                return;
            }

            // v8 修正：絕對確保 itemsContainer 存在
            let itemsContainer = legendContainer.querySelector('.sankey-legend-items-wrapper');
            if (!itemsContainer) {
                itemsContainer = document.createElement('div');
                // 修正 2.3: 調整 itemsContainer 的 flex wrap 和對齊方式
                itemsContainer.className = `sankey-legend-items-wrapper flex flex-wrap gap-x-4 gap-y-1 ${isSource ? 'justify-start' : 'md:justify-end'}`;
                // 修正 2.5: 確保移除任何舊的 no-data 提示
                const oldNoData = legendContainer.querySelector('.sankey-no-data');
                if (oldNoData) oldNoData.remove();
                legendTitle.after(itemsContainer);
            }
            
            itemsContainer.innerHTML = ''; 

            // 修正 2.1: 標題使用問題名稱
            legendTitle.textContent = `${QUESTION_MAP[key] || key} 圖例 (${isSource ? '來源' : '目標'})`;

            const getSortIndex = (val, customOrder) => {
                const index = customOrder.indexOf(String(val).trim());
                return index === -1 ? Infinity : index;
        };
            const customOrder = CUSTOM_SORT_ORDERS[key];
            const sortedNodes = [...nodes].sort((a, b) => {
                const valA = a.name.split(': ')[1];
                const valB = b.name.split(': ')[1];
                
                // 確保排序只在該側節點上進行
                if (a.category !== (isSource ? 'Source' : 'Target') && b.category !== (isSource ? 'Source' : 'Target')) return 0;
                
                if (customOrder) {
                    return getSortIndex(valA, customOrder) - getSortIndex(valB, customOrder);
                }
                return smartSort(valA, valB);
            });

            // 過濾並取得該側節點
            const sideNodes = sortedNodes.filter(d => d.category === (isSource ? 'Source' : 'Target'));
            
            if (sideNodes.length === 0) {
                 const p = document.createElement('p');
                 p.className = 'text-gray-400 sankey-no-data';
                 p.textContent = '無圖例資料。';
                 itemsContainer.appendChild(p);
                 return;
            }
            
            sideNodes.forEach(node => {
                const value = node.name.split(': ')[1];
                // 修正 2.4: 傳入問題鍵 key，確保 getColorForValue 使用正確的前綴查找
                const color = getColorForValue(value, key); 
                
                const itemDiv = document.createElement('div');
                // 修正 2.5: 確保對齊方式
                itemDiv.className = `flex items-center sankey-legend-item ${isSource ? 'justify-start' : 'md:justify-end'}`;
                
                const textSpan = document.createElement('span');
                textSpan.textContent = `${value}`;
                textSpan.className = 'text-sm';

                const colorBlock = `<span class="w-3 h-3 mx-1 flex-shrink-0" style="background-color: ${color}; border-radius: 2px;"></span>`;

                if (isSource) {
                    itemDiv.innerHTML = colorBlock + textSpan.outerHTML;
                } else {
                    itemDiv.innerHTML = textSpan.outerHTML + colorBlock;
                }
                
                itemsContainer.appendChild(itemDiv);
            });
        }
        
        // ===============================================
        // == 樞紐圖表分析函數 ==
        // ===============================================
        // ===============================================
        // == 樞紐圖表分析函數 (新版) ==
        // ===============================================
        
        let pivotColumnCounter = 0;
        
        // 添加新的數據欄
        function addPivotColumnField() {
            const container = document.getElementById('pivotColumnsContainer');
            const id = pivotColumnCounter++;
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex gap-2 items-center p-2 bg-gray-50 rounded border border-gray-200';
            fieldDiv.id = `pivotCol_${id}`;
            
            // 欄位選擇
            const fieldSelect = document.createElement('select');
            fieldSelect.className = 'flex-1 py-1.5 px-2 border border-gray-300 bg-white rounded text-xs';
            fieldSelect.innerHTML = '<option value="">選擇欄位</option>';
            allColumns.forEach(key => {
                fieldSelect.innerHTML += `<option value="${key}">${key}</option>`;
            });
            
            // 聚合函數選擇
            const aggSelect = document.createElement('select');
            aggSelect.className = 'w-24 py-1.5 px-2 border border-gray-300 bg-white rounded text-xs';
            aggSelect.innerHTML = `
                <option value="count">COUNT</option>
                <option value="countunique">UNIQUE</option>
                <option value="sum">SUM</option>
                <option value="average">AVG</option>
                <option value="max">MAX</option>
                <option value="min">MIN</option>
                <option value="median">MEDIAN</option>
                <option value="stdev">STDEV</option>
                <option value="var">VAR</option>
                <option value="countx">X</option>
            `;
            
            // 格式輸入框
            const formatInput = document.createElement('input');
            formatInput.type = 'text';
            formatInput.placeholder = '格式/X值 例:1或"元"';
            formatInput.className = 'w-32 py-1.5 px-2 border border-gray-300 bg-white rounded text-xs';
            formatInput.title = '格式：#,##0 "單位" 或直接輸入單位\nX函數：輸入要計算的值（如：1、0、是）';
            
            // 刪除按鈕
            const removeBtn = document.createElement('button');
            removeBtn.className = 'px-2 py-1 text-red-600 hover:bg-red-50 rounded text-xs';
            removeBtn.innerHTML = '✕';
            removeBtn.onclick = () => {
                fieldDiv.remove();
                updatePivotTable();
            };
            
            fieldDiv.appendChild(fieldSelect);
            fieldDiv.appendChild(aggSelect);
            fieldDiv.appendChild(formatInput);
            fieldDiv.appendChild(removeBtn);
            container.appendChild(fieldDiv);
            
            fieldSelect.addEventListener('change', updatePivotTable);
            aggSelect.addEventListener('change', updatePivotTable);
            formatInput.addEventListener('change', updatePivotTable);
            formatInput.addEventListener('blur', updatePivotTable);
        }
        
        // 獲取所有已配置的欄位
        function getPivotColumns() {
            const container = document.getElementById('pivotColumnsContainer');
            const columns = [];
            
            container.querySelectorAll('[id^="pivotCol_"]').forEach(div => {
                const fieldSelect = div.querySelector('select:nth-of-type(1)');
                const aggSelect = div.querySelector('select:nth-of-type(2)');
                const formatInput = div.querySelector('input[type="text"]');
                const field = fieldSelect.value;
                const agg = aggSelect.value;
                const format = formatInput ? formatInput.value.trim() : '';
                
                if (field) {
                    columns.push({ 
                        field, 
                        agg, 
                        format,
                        label: `${field} (${agg.toUpperCase()})` 
                    });
                }
            });
            
            return columns;
        }
        
        function updatePivotTable() {
            const rowMainKey = controls.pivotRowMainSelect.value;
            const rowSubKey = controls.pivotRowSubSelect.value;
            const columns = getPivotColumns();
            const container = document.getElementById('pivotTableContainer');
            
            if (!rowMainKey || columns.length === 0) {
                container.innerHTML = '<p class="text-gray-500">請選擇主要列和至少一個數據欄</p>';
                return;
            }
            
            // 獲取篩選後的數據
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });
            
            // 構建行標籤
            let rowLabels = [];
            
            // 定義排序輔助函數
            const getSortIndex = (val, customOrder) => {
                const index = customOrder.indexOf(String(val).trim());
                return index === -1 ? Infinity : index;
            };
            
            // 主要列排序 - 優先使用自定義排序
            const mainValues = [...new Set(filteredData.map(d => d[rowMainKey]))];
            if (CUSTOM_SORT_ORDERS[rowMainKey]) {
                mainValues.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[rowMainKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[rowMainKey]));
            } else {
                mainValues.sort(smartSort);
            }
            
            if (rowSubKey) {
                // 有次要分組
                const subValues = [...new Set(filteredData.map(d => d[rowSubKey]))];
                if (CUSTOM_SORT_ORDERS[rowSubKey]) {
                    subValues.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[rowSubKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[rowSubKey]));
                } else {
                    subValues.sort(smartSort);
                }
                mainValues.forEach(main => {
                    rowLabels.push({ main, sub: null, label: String(main), isTotal: true });
                    subValues.forEach(sub => {
                        const hasData = filteredData.some(d => 
                            String(d[rowMainKey]) === String(main) && 
                            String(d[rowSubKey]) === String(sub)
                        );
                        if (hasData) {
                            rowLabels.push({ main, sub, label: `  ${main}-${sub}`, isTotal: false });
                        }
                    });
                });
            } else {
                // 無次要分組
                rowLabels = mainValues.map(main => ({ main, sub: null, label: String(main), isTotal: false }));
            }
            
            // 生成HTML表格
            let html = '<table class="min-w-full border-collapse border border-gray-300">';
            
            // 表頭
            html += '<thead><tr class="bg-gray-100">';
            html += `<th class="border border-gray-300 px-3 py-2 text-left font-bold sticky left-0 bg-gray-100">${rowMainKey}${rowSubKey ? ' / ' + rowSubKey : ''}</th>`;
            html += `<th class="border border-gray-300 px-3 py-2 text-center font-medium bg-blue-50">筆數</th>`;
            columns.forEach(col => {
                html += `<th class="border border-gray-300 px-3 py-2 text-center font-medium">${col.label}</th>`;
            });
            html += '</tr></thead>';
            
            // 表身
            html += '<tbody>';
            rowLabels.forEach(row => {
                html += '<tr>';
                const bgClass = row.isTotal ? 'bg-yellow-50 font-bold' : 'bg-white';
                html += `<td class="border border-gray-300 px-3 py-2 font-medium ${bgClass} sticky left-0">${row.label}</td>`;
                
                // 添加筆數欄(移到第2欄)
                let rowCount;
                if (rowSubKey && !row.isTotal) {
                    rowCount = filteredData.filter(d => 
                        String(d[rowMainKey]) === String(row.main) && 
                        String(d[rowSubKey]) === String(row.sub)
                    ).length;
                } else {
                    rowCount = filteredData.filter(d => String(d[rowMainKey]) === String(row.main)).length;
                }
                html += `<td class="border border-gray-300 px-3 py-2 text-right ${bgClass} bg-blue-50 font-medium">${rowCount}</td>`;
                
                columns.forEach(col => {
                    // 過濾該行的數據
                    let rowData;
                    if (rowSubKey && !row.isTotal) {
                        // 次要分組的細分行
                        rowData = filteredData.filter(d => 
                            String(d[rowMainKey]) === String(row.main) && 
                            String(d[rowSubKey]) === String(row.sub)
                        );
                    } else {
                        // 主要分組或總計行
                        rowData = filteredData.filter(d => String(d[rowMainKey]) === String(row.main));
                    }
                    
                    // 計算聚合值
                    const value = calculateAggregation(rowData, col.field, col.agg, col.format);
                    
                    // X函數返回的是百分比，直接添加%號
                    let displayValue;
                    if (col.agg === 'countx') {
                        displayValue = (value === null || value === undefined || isNaN(value)) ? '' : value.toFixed(2) + '%';
                    } else {
                        displayValue = formatValueWithCustomFormat(value, col.format);
                    }
                    
                    html += `<td class="border border-gray-300 px-3 py-2 text-right ${bgClass}">${displayValue}</td>`;
                });
                
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }
        
        // 計算聚合值
        function calculateAggregation(data, field, aggFunc, format) {
            if (aggFunc === 'count') {
                return data.length;
            } else if (aggFunc === 'countunique') {
                return new Set(data.map(d => d[field])).size;
            } else if (aggFunc === 'countx') {
                // X = COUNT(X) / COUNTA × 100%
                // X的值從format參數中取得
                if (!format || format.trim() === '') {
                    return null; // 沒有指定X值
                }
                
                const allValues = data.map(d => String(d[field]).trim());
                const totalCount = allValues.length; // COUNTA
                
                if (totalCount === 0) return null;
                
                // 從format中提取X值
                // 支援直接輸入值，或從引號中提取
                let targetValue = format.trim();
                const quoteMatch = format.match(/"([^"]*)"/);
                if (quoteMatch) {
                    targetValue = quoteMatch[1];
                } else {
                    // 移除常見的格式字符，只保留值
                    targetValue = format.replace(/#|,|0|\.|%/g, '').trim();
                    // 如果還有引號，移除它
                    targetValue = targetValue.replace(/["']/g, '');
                }
                
                if (targetValue === '') return null;
                
                // 計算匹配的數量
                const matchCount = allValues.filter(v => v === targetValue).length;
                return (matchCount / totalCount) * 100; // 返回百分比
            }
            
            // 提取數值
            const values = data.map(d => parseFloat(d[field])).filter(v => !isNaN(v));
            if (values.length === 0) return null;
            
            switch(aggFunc) {
                case 'sum':
                    return values.reduce((a, b) => a + b, 0);
                case 'average':
                    return values.reduce((a, b) => a + b, 0) / values.length;
                case 'max':
                    return Math.max(...values);
                case 'min':
                    return Math.min(...values);
                case 'median':
                    const sorted = [...values].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
                case 'stdev':
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const squareDiffs = values.map(v => Math.pow(v - avg, 2));
                    return Math.sqrt(squareDiffs.reduce((a, b) => a + b, 0) / (values.length - 1));
                case 'var':
                    const avgv = values.reduce((a, b) => a + b, 0) / values.length;
                    const squareDiffsv = values.map(v => Math.pow(v - avgv, 2));
                    return squareDiffsv.reduce((a, b) => a + b, 0) / (values.length - 1);
                default:
                    return values.length;
            }
        }
        
        // 格式化顯示值
        function formatValue(value) {
            if (value === null || value === undefined || isNaN(value)) return '';
            if (Number.isInteger(value)) return value;
            return value.toFixed(2);
        }
        
        // 使用自訂格式格式化數值
        function formatValueWithCustomFormat(value, format) {
            if (value === null || value === undefined || isNaN(value)) return '';
            
            // 如果沒有自訂格式，使用預設格式
            if (!format) {
                return formatValue(value);
            }
            
            // 解析格式字串
            // 支援格式：#,##0 "元"、0.00 "%"、或直接輸入單位
            
            let formattedNumber = '';
            let suffix = '';
            
            // 檢查是否包含引號（單位）
            const quoteMatch = format.match(/"([^"]*)"/);
            if (quoteMatch) {
                suffix = quoteMatch[1];
                format = format.replace(/"[^"]*"/, '').trim();
            } else if (format && !format.includes('#') && !format.includes('0') && !format.includes(',')) {
                // 如果格式只是純文字（沒有#或0），直接當作單位
                suffix = format;
                format = '';
            }
            
            // 處理數字格式
            if (format.includes('#,##0') || format.includes(',')) {
                // 千分位格式
                const decimals = (format.match(/\.0+/) || [''])[0].length - 1;
                if (decimals > 0) {
                    formattedNumber = value.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                } else {
                    formattedNumber = Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
            } else if (format.includes('0.')) {
                // 小數格式
                const decimals = (format.match(/\.0+/) || [''])[0].length - 1;
                formattedNumber = value.toFixed(decimals);
            } else {
                // 預設格式
                formattedNumber = Number.isInteger(value) ? value.toString() : value.toFixed(2);
            }
            
            return formattedNumber + suffix;
        }
        
        function updateSankeyChart() {
            const sourceKey = controls.sankeySourceSelect.value;
            const targetKey = controls.sankeyTargetSelect.value;
            const minThreshold = parseInt(document.getElementById('sankeyMinThreshold').value) || 1;
            const sankeyContainer = d3.select("#sankeyChart");
            
            sankeyContainer.html(""); // 清除舊圖表

            const sourceLegendContainer = document.getElementById('sankeySourceLegend');
            const targetLegendContainer = document.getElementById('sankeyTargetLegend');
            
            // 清理舊的 no-data 標籤
            if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-no-data')?.remove();
            if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-no-data')?.remove();

            if (!sourceKey || !targetKey || sourceKey === targetKey) {
                sankeyContainer.html('<p class="text-gray-500 text-center py-8">請選擇不同的「來源」和「目標」欄位。</p>');
                // 清空圖例
                if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                document.getElementById('sourceLegendTitle').textContent = '來源圖例 (Source)';
                document.getElementById('targetLegendTitle').textContent = '目標圖例 (Target)';
                return;
            }

            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            if (filteredData.length === 0) {
                 sankeyContainer.html('<p class="text-red-500 text-center py-8">在當前篩選條件下，無資料可供分析。</p>');
                 if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                 if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                 document.getElementById('sourceLegendTitle').textContent = '來源圖例 (Source)';
                 document.getElementById('targetLegendTitle').textContent = '目標圖例 (Target)';
                 return;
            }

            const linkCounts = new Map();
            const allNodes = new Set();
            
            filteredData.forEach(d => {
                const sourceVal = String(d[sourceKey]).trim();
                const targetVal = String(d[targetKey]).trim();
                
                if (sourceVal && targetVal) {
                    const linkId = `${sourceVal}->${targetVal}`;
                    linkCounts.set(linkId, (linkCounts.get(linkId) || 0) + 1);
                    allNodes.add(`Source: ${sourceVal}`);
                    allNodes.add(`Target: ${targetVal}`);
                }
            });

            const nodeMap = new Map();
            const nodes = Array.from(allNodes).map((name, index) => {
                const node = { id: index, name: name, category: name.split(': ')[0], value: 0 };
                nodeMap.set(name, node);
                return node;
            });

            const links = [];
            linkCounts.forEach((count, linkId) => {
                if (count >= minThreshold) {
                    const [sourceVal, targetVal] = linkId.split('->');
                    const sourceName = `Source: ${sourceVal}`;
                    const targetName = `Target: ${targetVal}`;
                    
                    if (nodeMap.has(sourceName) && nodeMap.has(targetName)) {
                        links.push({
                            source: nodeMap.get(sourceName).id,
                            target: nodeMap.get(targetName).id,
                            value: count,
                            sourceLabel: sourceVal,
                            targetLabel: targetVal
                        });
                    }
                }
            });

            const graph = { nodes, links };
            
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };
            const containerEl = document.getElementById('sankeyChart');
            const availableWidth = containerEl.clientWidth;
            const innerWidth = availableWidth - margin.left - margin.right;
            const height = Math.min(nodes.length * 25 + 100, 600) - margin.top - margin.bottom; 
            
            const svgWidth = availableWidth; 
            const svgHeight = height + margin.top + margin.bottom;

            const svg = sankeyContainer.append("svg")
                .attr("width", svgWidth) 
                .attr("height", svgHeight)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // *** 關鍵修正 1: 應用自定義排序 ***
            const getSortIndex = (val, customOrder) => {
                const index = customOrder.indexOf(String(val).trim());
                return index === -1 ? Infinity : index;
        };

            const sortNodesByCustomOrder = (a, b) => {
                const aName = a.name.split(': ')[1];
                const bName = b.name.split(': ')[1];
                const key = a.category === 'Source' ? sourceKey : targetKey;
                const customOrder = CUSTOM_SORT_ORDERS[key];

                if (customOrder) {
                    return getSortIndex(aName, customOrder) - getSortIndex(bName, customOrder);
                }
                // 如果沒有自定義排序，則使用默認的智能排序 (smartSort)
                return smartSort(aName, bName);
        };

            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[0, 0], [innerWidth, height]])
                .nodeSort(sortNodesByCustomOrder); // <-- 應用自定義排序

            sankey(graph);
            
            svg.append("g")
                .attr("fill", "none")
                .selectAll(".sankey-link")
                .data(graph.links)
                .join("path")
                .attr("class", "sankey-link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke-width", d => Math.max(1, d.width))
                .attr("stroke", d => getColorForValue(d.sourceLabel, sourceKey))
                .append("title")
                .text(d => `${d.sourceLabel} → ${d.targetLabel}\n筆數: ${d.value}`);

            const node = svg.append("g")
                .selectAll(".sankey-node")
                .data(graph.nodes)
                .join("g")
                .attr("class", "sankey-node")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            node.append("rect")
                .attr("height", d => d.y1 - d.y0)
                .attr("width", sankey.nodeWidth())
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("fill", d => {
                    const value = d.name.split(': ')[1];
                    const isSourceNode = d.category === 'Source';
                    return getColorForValue(value, isSourceNode ? sourceKey : targetKey);
                })
                .each(function(d) {
                    // 修正 4：計算節點的總值 (用於圖例)
                    d.value = d.sourceLinks.reduce((sum, link) => sum + link.value, 0) || d.targetLinks.reduce((sum, link) => sum + link.value, 0);
                })
                .append("title")
                .text(d => {
                    const val = d.sourceLinks.reduce((sum, link) => sum + link.value, 0) || d.targetLinks.reduce((sum, link) => sum + link.value, 0);
                    return `${d.name.split(': ')[1]}\n總筆數: ${val}`
                });

            // 7. 移除 D3 標籤並生成自訂圖例 (Legend)
            if (links.length > 0) {
                 generateSankeyLegend(graph.nodes, sourceKey, true); 
                 generateSankeyLegend(graph.nodes, targetKey, false);
            } else {
                if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                
                const sourceP = document.createElement('p');
                sourceP.className = 'text-gray-400 sankey-no-data';
                sourceP.textContent = '無連結資料。';
                
                const targetP = document.createElement('p');
                targetP.className = 'text-gray-400 sankey-no-data md:text-right';
                targetP.textContent = '無連結資料。';
                
                // 確保標題存在才 append
                const sourceTitle = document.getElementById('sourceLegendTitle');
                const targetTitle = document.getElementById('targetLegendTitle');

                if (sourceTitle) sourceTitle.after(sourceP);
                if (targetTitle) targetTitle.after(targetP);

                document.getElementById('sourceLegendTitle').textContent = `${QUESTION_MAP[sourceKey] || sourceKey} 圖例 (來源)`;
                document.getElementById('targetLegendTitle').textContent = `${QUESTION_MAP[targetKey] || targetKey} 圖例 (目標)`;
            }
        }


        // ===============================================
        // == 單一欄位分析 (儀表板) 函數 ==
        // ===============================================

        // ** 修正 3.0: 更新所有小圖表設定的函數 (加入 forceUpdate 參數) **
        function updateSmallMultiplesSettings(forceUpdate = false) {
            // ** 修正 1: 確保所有選項在 Chart.js 實例上被更新 **
            Object.values(smallCharts).forEach(chartInstance => {
                chartInstance.options.scales.y.barPercentage = BAR_PERCENTAGE;
                chartInstance.options.scales.y.categoryPercentage = BAR_CATEGORY_PERCENTAGE;
                chartInstance.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE;
                chartInstance.update('none'); // 强制更新视图
            });
            
            // ** 修正 4.1: 如果是 BAR 粗度調整，需要重新創建/繪製圖表容器 **
            if (forceUpdate) {
                // 重新調用 updateSmallMultiples 重新繪製整個區塊，
                // 這會重新計算每個小圖表的 wrapperHeight。
                updateSmallMultiples();
                return;
            }
        }
        
        function updateSmallMultiples() {
            const container = document.getElementById('smallMultiplesContainer');
            const selectedColumns = Array.from(document.querySelectorAll('.small-multiple-checkbox:checked')).map(cb => cb.value);
            // ** 修正 2：讀取獨立的 valueSelect **
            const valueType = controls.smallValueSelect.value;
            const isPercent = valueType === 'percent';

            // 抓取共用篩選
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            // 摧毀舊圖表
            Object.values(smallCharts).forEach(chart => chart.destroy());
            smallCharts = {};
            container.innerHTML = '';

            if (selectedColumns.length === 0) {
                container.innerHTML = '<p class="text-gray-500">請從上方勾選欄位以顯示分析圖表。</p>';
                return;
            }
            
            const getSortIndex = (val, customOrder) => {
                const index = customOrder.indexOf(String(val).trim()); // ** 修正：Trim 空白 **
                return index === -1 ? Infinity : index;
        };
            
            // ** 修正 5.0: 使用固定像素高度 **
            // 直接使用 SMALL_CHART_BAR_HEIGHT 作為BAR的實際高度
            const chartAreaHeight = SMALL_CHART_BAR_HEIGHT + 10; // BAR高度 + 上下留白
            // 整體 wrapper 的高度 = 圖表區 + X軸刻度 (35px) + 上下 padding/margin (5px)
            const headerHeight = 30; // 為標題和圖例預留 30px 的空間
            const wrapperHeight = chartAreaHeight + 35 + 5 + headerHeight; 

            // 為每一個勾選的欄位建立一個圖表
            selectedColumns.forEach((colKey, index) => {
                const chartId = `smallChart-${index}`;
                const legendId = `smallLegend-${index}`;
                const avgId = `smallAvg-${index}`;

                // 2. 準備資料
                const yLabels = [colKey]; 
                let groupLabels = [...new Set(filteredData.map(d => d[colKey]))];
                
                if (CUSTOM_SORT_ORDERS[colKey]) groupLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[colKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[colKey]));
                else groupLabels.sort(smartSort);

                let isGroupKeyNumeric = false;
                if (filteredData.length > 0) {
                    const firstValue = filteredData.find(d => d[colKey] !== null && d[colKey] !== undefined);
                    if(firstValue) isGroupKeyNumeric = parseNumericValue(firstValue[colKey]).isNumeric;
                }

                // ** 顏色映射邏輯 (與主圖表一致) **
                let activePalette;
                if (isGroupKeyNumeric && groupLabels.length > 3) activePalette = GRADIENT_PALETTE; 
                else activePalette = CATEGORICAL_PALETTE;
                
                let colorMap = {};
                let paletteIndex = 0;
                groupLabels.forEach((val) => {
                    const valStr = String(val).trim();
                    const prefix = getQuestionPrefix(colKey);
                    
                    const keyedColor = FIXED_ANSWER_COLORS[prefix + '_' + valStr]; 
                    if (keyedColor) {
                        colorMap[String(val)] = keyedColor;
                    } else if (FIXED_ANSWER_COLORS[valStr]) {
                        colorMap[String(val)] = FIXED_ANSWER_COLORS[valStr];
                    } else {
                        colorMap[String(val)] = activePalette[paletteIndex % activePalette.length]; 
                        paletteIndex++;
                    }
                });

                const total = filteredData.filter(d => d[colKey] !== undefined && d[colKey] !== null).length;
                const totalForPercent = total > 0 ? total : 1;
                
                const datasets = groupLabels.map(groupVal => {
                    const count = filteredData.filter(d => String(d[colKey]) === String(groupVal)).length;
                    const dataValue = isPercent ? (count / totalForPercent) * 100 : count;
                    const color = colorMap[String(groupVal)] || CATEGORICAL_PALETTE[0]; 
                    return {
                        label: groupVal,
                        data: [dataValue], // 只有一筆資料
                        backgroundColor: color + 'CC', 
                        borderColor: color, 
                        borderWidth: 0, 
                        borderRadius: 0, 
                        rawCount: count // 儲存原始筆數給 tooltip
        };
                });


                // 1. 建立 HTML 結構 (優化排版)
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'bg-white pt-2 pb-1 px-4'; // 減少垂直 padding
                if (index > 0) {
                    chartWrapper.className += ' border-t border-gray-200'; 
                }
                
                // 標題/平均數/圖例 整合在一個 flex 容器中
                chartWrapper.innerHTML = `
                    <div class="small-chart-header flex justify-between items-start pt-1">
                        <div class="flex items-baseline space-x-2">
                            <h3 class="text-base font-bold text-gray-800 leading-none">${colKey}</h3>
                            <span id="${avgId}" class="text-sm font-medium text-blue-700 leading-none"></span>
                        </div>
                        <div id="${legendId}" class="flex flex-wrap gap-x-2 gap-y-0.5 justify-end"></div>
                    </div>
                    <!-- 修正：將 chartAreaHeight 寫入，確保高度緊湊 -->
                    <div class="small-chart-container" style="height: ${wrapperHeight}px;">
                        <canvas id="${chartId}"></canvas>
                    </div>
                `;
                container.appendChild(chartWrapper);

                // 3. 建立新圖表 (長條圖)
                const ctx = document.getElementById(chartId).getContext('2d');
                smallCharts[chartId] = new Chart(ctx, {
                    type: 'bar', 
                    data: { 
                        labels: yLabels, 
                        datasets: datasets 
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { 
                            padding: { left: -10 } // 隱藏 Y 軸標籤
                        }, 
                        scales: {
                            x: {
                                display: true,
                                stacked: true,
                                max: isPercent ? 100 : undefined,
                                // 修正 2.1: 隱藏 X 軸標題，但顯示刻度數字 (ticks)
                                ticks: {
                                    display: true, 
                                    font: { size: 10 }
                                },
                                title: { 
                                    display: false // 隱藏軸標題
                                }
                            },
                            y: {
                                stacked: true,
                                display: false, // 隱藏 Y 軸
                                barPercentage: 1.0, // 填滿整個category空間
                                categoryPercentage: 1.0 // 填滿整個軸空間
                            }
                        },
                        plugins: {
                            datalabels: {
                                display: true, 
                                color: '#fff',
                                textShadow: '0 1px 2px rgba(0,0,0,0.4)',
                                font: { weight: 'bold', size: DATALABELS_FONT_SIZE },
                                formatter: (value, context) => {
                                    if (value === 0) return ''; 
                                    
                                    if (isPercent) {
                                        if (value < 8) return ''; 
                                        return Math.round(value) + '%';
                                    } else {
                                        const allData = context.chart.data.datasets.map(ds => ds.data[0]);
                                        const total = allData.reduce((sum, val) => sum + val, 0);
                                        if (total > 0 && (value / total) < 0.08) return ''; 
                                        return value; 
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        const rawCount = context.dataset.rawCount || 0;
                                        if (isPercent) {
                                            if (context.parsed.x !== null) label += context.parsed.x.toFixed(1) + '%';
                                            label += ` (${rawCount}筆)`;
                                        } else {
                                            if (context.parsed.x !== null) label += context.parsed.x;
                                        }
                                        return label;
                                    }
                                }
                            },
                            legend: { display: false } // 使用自訂圖例
                        }
                    }
                });

                // 4. 填入圖例 - 添加點擊隱藏功能
                const legendContainer = document.getElementById(legendId);
                let legendHTML = '';
                datasets.forEach((dataset, index) => { 
                    const label = dataset.label;
                    const color = dataset.borderColor;
                    const isHidden = dataset.hidden || false;
                    legendHTML += `<div class="flex items-center legend-item ${isHidden ? 'legend-item-hidden' : ''}" data-dataset-index="${index}">
                                     <span class="w-3 h-3 mr-1 flex-shrink-0" style="background-color: ${color}; border-radius: 2px;"></span>
                                     <span class="text-xs text-gray-700">${label}</span>
                                   </div>`; // 圖例文字縮小為 text-xs
                });
                legendContainer.innerHTML = legendHTML;
                
                // 添加點擊事件來隱藏/顯示dataset
                const chart = smallCharts[chartId];
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const datasetIndex = parseInt(item.getAttribute('data-dataset-index'));
                        if (!chart || isNaN(datasetIndex) || datasetIndex < 0 || datasetIndex >= chart.data.datasets.length) return;
                        chart.data.datasets[datasetIndex].hidden = !chart.data.datasets[datasetIndex].hidden;
                        item.classList.toggle('legend-item-hidden', chart.data.datasets[datasetIndex].hidden);
                        chart.update();
                    });
                });

                
                // 5. 還原平均數計算
                if (isGroupKeyNumeric) {
                    let numericData = filteredData
                        .map(d => parseNumericValue(d[colKey]))
                        .filter(val => val.isNumeric)
                        .map(val => val.num);
                    if (numericData.length > 0) {
                        const sum = numericData.reduce((a, b) => a + b, 0);
                        const average = sum / numericData.length;
                        document.getElementById(avgId).textContent = `平均數: ${average.toFixed(1)}`;
                    }
                }
            });
        }
        
        // ** 新增 Q2：單欄分析截圖函數 **
        async function downloadScreenshot() {
            const statusEl = document.getElementById('sm-screenshot-status');
            const buttonEl = document.getElementById('sm-download-screenshot');
            // ** 修正：只擷取圖表容器 **
            const targetEl = document.getElementById('smallMultiplesContainer'); 
            
            if (!targetEl) return;
            
            // ** 新增：檢查是否有圖表 **
            if (targetEl.children.length === 0 || (targetEl.children.length === 1 && targetEl.children[0].tagName === 'P')) {
                statusEl.textContent = '沒有圖表可供擷取。';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                return;
            }

            statusEl.textContent = '正在產生截圖... 請稍候...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                const canvas = await html2canvas(targetEl, {
                    useCORS: true, // 允許跨域圖片 (雖然我們沒有)
                    scale: 2 // 提高解析度
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'smallmultiples-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = '截圖已下載！';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('截圖失敗:', error);
                statusEl.textContent = '截圖失敗，請檢查 console。';
            } finally {
                buttonEl.disabled = false;
            }
        }
        
        // ** 新增：樞紐分析截圖函數 **
        async function downloadPivotScreenshot() {
            const statusEl = document.getElementById('pivot-screenshot-status');
            const buttonEl = document.getElementById('pivot-download-screenshot');
            // 擷取整個樞紐圖表分析區域（包含標題、圖例、圖表）
            const targetEl = document.getElementById('pivotChartContainer').parentElement;
            
            if (!targetEl) return;
            
            // 檢查是否有圖表
            if (!chart || !chart.data || chart.data.labels.length === 0) {
                statusEl.textContent = '沒有圖表可供擷取。';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                return;
            }

            statusEl.textContent = '正在產生截圖... 請稍候...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                const canvas = await html2canvas(targetEl, {
                    useCORS: true,
                    scale: 2 // 提高解析度
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'pivot-chart-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = '截圖已下載！';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('截圖失敗:', error);
                statusEl.textContent = '截圖失敗，請檢查 console。';
            } finally {
                buttonEl.disabled = false;
            }
        }
        
        // 樞紐分析表格截圖函數
        async function downloadPivotTableScreenshot() {
            const statusEl = document.getElementById('pivotTable-screenshot-status');
            const buttonEl = document.getElementById('pivotTable-download-screenshot');
            const targetEl = document.getElementById('pivotTableContainer');
            
            if (!targetEl) return;
            
            // 檢查是否有表格
            const table = targetEl.querySelector('table');
            if (!table) {
                statusEl.textContent = '沒有表格可供擷取。';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                return;
            }

            statusEl.textContent = '正在產生截圖... 請稍候...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                const canvas = await html2canvas(targetEl, {
                    useCORS: true,
                    scale: 2 // 提高解析度
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'pivot-table-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = '截圖已下載！';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('截圖失敗:', error);
                statusEl.textContent = '截圖失敗，請檢查 console。';
            } finally {
                buttonEl.disabled = false;
            }
        }
        
    </script>
</body>
</html>
