<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯µç‰©MBTI 2.0: æ¯›å­©æ€§æ ¼æ¢ç´¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* åƒè€ƒä½ æä¾›çš„ mbti-cat-quizzer æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* å®šç¾©åƒè€ƒæ¨£å¼ä¸­çš„è‡ªè¨‚é¡è‰² */
        .bg-brand-orange { background-color: #F39800; }
        .text-brand-orange { color: #F39800; }
        .border-brand-orange { border-color: #F39800; }
        .hover\:bg-brand-orange-dark:hover { background-color: #D98900; }
        
        .text-brand-brown { color: #8B5E3C; }
        .text-brand-dark-gray { color: #4A4A4A; }
        .text-brand-gray { color: #757575; }

        /* æ¼¸å±¤èƒŒæ™¯ */
        .bg-brand-gradient {
            background-image: linear-gradient(to bottom right, #FFF7E0, #FFFAF0, #FFF7E0);
        }

        /* éš±è—å…ƒç´  */
        .hidden {
            display: none;
        }

        /* ç­”é¡Œé¸é …æ¨£å¼ */
        .quiz-option {
            transition: all 0.3s ease;
        }
        .quiz-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #F39800;
        }
        .quiz-option.selected {
            background-color: #FFF7E0; /* æ·ºæ©˜è‰²èƒŒæ™¯ */
            border-color: #F39800;
            box-shadow: 0 2px 8px rgba(243, 152, 0, 0.2);
        }
    </style>
</head>
<body class="bg-brand-gradient min-h-screen">

    <div class="container mx-auto max-w-2xl p-4 py-8">

        <div id="start-screen" class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 text-center relative overflow-hidden">
            <div class="absolute top-4 left-4 text-brand-orange opacity-20"><i class="fas fa-paw text-3xl"></i></div>
            <div class="absolute top-8 right-8 text-brand-brown opacity-20"><i class="fas fa-paw text-2xl transform rotate-45"></i></div>
            
            <img src="https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/MBTI.png" alt="å¯æ„›å¯µç‰©æ’åœ–" class="max-w-full h-32 mx-auto object-contain mb-6 rounded-lg">
            
            <h1 class="text-4xl md:text-5xl font-bold text-brand-dark-gray mb-4">å¯µç‰© MBTI 2.0</h1>
            <p class="text-xl text-brand-gray mb-8">æ¯›å­©æ€§æ ¼æ¢ç´¢æ¸¬é©—</p>
            
            <div class="text-left text-brand-gray mb-8 px-4">
                <p>é€™æ˜¯ä¸€ä»½ä»¥ MBTI ç‚ºéˆæ„Ÿçš„å¯µç‰©å¿ƒç†æ¸¬é©—, å°‡è¤‡é›œçš„è¡Œç‚ºç‰¹è³ªç°¡åŒ–ç‚ºå…©å€‹æ ¸å¿ƒç¶­åº¦ï¼š</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li><strong>E/I (å¤–å‘/å…§å‘):</strong> ç‰ å¦‚ä½•ç²å–èƒ½é‡ï¼Ÿ</li>
                    <li><strong>N/S (å¥½å¥‡/å®‰é€¸):</strong> ç‰ å°æ–°äº‹ç‰©çš„é–‹æ”¾ç¨‹åº¦ï¼Ÿ</li>
                </ul>
                <p class="mt-2">æº–å‚™å¥½æ¢ç´¢ä½ å®¶æ¯›å­©çš„çœŸå¯¦æ€§æ ¼äº†å—ï¼Ÿ</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-lg font-bold text-brand-dark-gray text-center mb-4">ğŸ± å‘Šè¨´æˆ‘å€‘ä½ å®¶å¯µç‰©çš„åå­—</h3>
                <div class="max-w-md mx-auto">
                    <input type="text" id="petName" class="flex h-10 w-full text-center text-lg p-3 border-2 border-brand-orange/30 focus:border-brand-orange rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-orange/50" placeholder="ä¾‹å¦‚ï¼šå°ç™½ã€å’ªå’ªã€æ©˜å­..." maxlength="15">
                    <p class="text-sm text-brand-gray mt-2 text-center">ä¸å¡«å¯«çš„è©±ï¼Œæ¸¬é©—ä¸­æœƒé¡¯ç¤ºã€Œä½ çš„å¯µç‰©ã€</p>
                </div>
            </div>

            <button onclick="startGame()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap bg-brand-orange hover:bg-brand-orange-dark h-12 text-white px-12 py-4 rounded-full text-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-300 border-0">
                <i class="fas fa-play mr-2"></i>é–‹å§‹æ¸¬é©—
            </button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-brand-orange h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            
            <div id="question-container">
                <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
                    <p class="text-lg text-brand-gray mb-4 text-center">
                        ç¬¬ <span id="current-question-num">1</span> é¡Œ / å…± <span id="total-questions">10</span> é¡Œ
                    </p>
                    <h2 id="question-text" class="text-2xl font-bold text-brand-dark-gray mb-8 text-center">é¡Œç›®æ–‡å­—...</h2>
                    <div id="options-container" class="space-y-4 mb-6">
                        </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="prevQuestion()" id="prev-btn" class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-full text-lg font-semibold border-2 border-brand-orange text-brand-orange hover:bg-brand-orange/10 transition-colors duration-200" disabled>
                            <i class="fas fa-arrow-left"></i> ä¸Šä¸€é¡Œ
                        </button>
                        <button onclick="nextQuestion()" id="next-btn" class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-full text-lg font-semibold bg-brand-orange text-white hover:bg-brand-orange-dark transition-colors duration-200" disabled>
                            ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden">
            <div id="result-capture-area" class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 text-center relative overflow-hidden">
                <p class="text-lg text-brand-gray mb-2"><span id="result-pet-name">ä½ å®¶å¯µç‰©</span> çš„æ¸¬é©—çµæœæ˜¯...</p>
                <h1 id="result-type" class="text-5xl font-bold text-brand-orange mb-4">EN</h1>
                <h2 id="result-title" class="text-3xl font-bold text-brand-dark-gray mb-6">æ´»åŠ›æ¢éšªå®¶</h2>
                
                <img id="result-image" src="https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/EN.png" alt="çµæœæ’åœ–" class="max-w-full w-full h-auto object-contain mb-6 rounded-lg">

                <div id="result-description" class="text-left text-brand-gray space-y-3 mb-8">
                    <p><strong>å€‹æ€§æ¦‚è¿°:</strong> å……æ»¿æ´»åŠ›ã€å¤©ç”Ÿç¤¾äº¤é«˜æ‰‹,å°ä¸–ç•Œæ°¸é ä¿æŒç†±æƒ…ã€‚ç‰ å€‘æ¸´æœ›äº’å‹•ã€æ¢ç´¢æ–°äº‹ç‰©,ç„¡è«–æ˜¯æˆ¶å¤–å¥”è·‘é‚„æ˜¯çµäº¤æ–°æœ‹å‹,éƒ½æ˜¯ç”Ÿæ´»çš„æ¨‚è¶£ä¾†æºã€‚</p><p><strong>äº’å‹•æŒ‡å—:</strong><br>â€¢ ç¶“å¸¸å¸¶ç‰ å¤–å‡ºå†’éšªã€ç™»å±±ã€å…¬åœ’æ´»å‹•ã€‚<br>â€¢ æä¾›å¤šè®Šç©å…·èˆ‡äº’å‹•è¨“ç·´,åˆºæ¿€èº«å¿ƒã€‚<br>â€¢ æ­£å‘çå‹µé¼“å‹µç‰ æ¢ç´¢æ–°äº‹ç‰©ã€‚</p>
                </div>
                
                <p class="text-sm text-gray-400">Â© å¯µç‰©MBTI 2.0 æ¸¬é©—</p>
            </div>
            
            <div class="text-center mt-8 space-y-4">
                <button onclick="saveResultAndRedirect()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap bg-brand-orange hover:bg-brand-orange-dark h-12 text-white px-12 py-4 rounded-full text-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-300 border-0">
                    <i class="fas fa-download mr-2"></i>å„²å­˜çµæœä¸¦å¡«å¯«å•å·
                </button>
                <button onclick="resetGame()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap bg-gray-200 hover:bg-gray-300 h-12 text-gray-800 px-12 py-4 rounded-full text-xl font-semibold transition-all duration-300 border-0">
                    <i class="fas fa-redo mr-2"></i>é‡æ–°æ¸¬è©¦
                </button>
            </div>
        </div>

    </div>

    <!-- ===== Email è¼¸å…¥å½ˆçª— (å·²ç§»é™¤) ===== -->
    <!-- <div id="email-modal" class="hidden ..."> ... </div> -->


    <script>
        // ==========================================
        // 1. Google Apps Script éƒ¨ç½²å¾Œçš„ç¶²å€
        // ==========================================
        // !!! è«‹å°‡ 'YOUR_WEB_APP_URL_HERE' æ›æˆä½ è‡ªå·±çš„ Google Apps Script ç¶²å€ !!!
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyBrsg70HFrb5M0LGH44FbB4iYzrUvaN2ewQg62vZnvYppxMcy1Dymo4RskTe7BsGEPmA/exec';
        
        // ==========================================
        // 2. ä½ çš„æ¸¬é©—é¡Œç›® (å·²æ ¹æ“šæ–°ç‰ˆ PDF æ›´æ–°)
        // ==========================================
        // ç¢ºä¿ 'value' å°æ‡‰åˆ° MBTI çš„å…©å€‹ç¶­åº¦ (E/I, N/S)
        const quizData = [
            {
                question: "Q1. ç•¶æœ‰å®¢äººä¾†è¨ªæ™‚, æ¯›å­©æœƒ:",
                options: [
                    { text: "A. ç†±æƒ…è¿æ¥ã€ç¹è‘—å®¢äººè½‰åœˆåœˆ", value: "E" },
                    { text: "B. èº²åœ¨æ²™ç™¼å¾Œè§€å¯Ÿ, ç­‰æ°£æ°›å®‰éœæ‰å‡ºä¾†", value: "I" }
                ]
            },
            {
                question: "Q2. å‡ºé–€åˆ°æ–°å…¬åœ’, ç‰ çš„åæ‡‰æ˜¯:",
                options: [
                    { text: "A. ç«‹åˆ»èˆˆå¥®å¥”è·‘ã€èæ¯å€‹è§’è½", value: "N" },
                    { text: "B. è¬¹æ…è§€å¯Ÿã€ç·Šè·Ÿè‘—ä¸»äºº", value: "S" }
                ]
            },
            {
                question: "Q3. æœ€å–œæ­¡çš„ç©å…·é¡å‹æ˜¯:",
                options: [
                    { text: "A. äº’å‹•çƒã€é€—è²“æ£’ã€è¿½é€å‹ç©å…·", value: "E" },
                    { text: "B. çµ¨æ¯›å¨ƒå¨ƒæˆ–è‡ªå·±å¯ç©çš„ç›Šæ™ºç©å…·", value: "I" }
                ]
            },
            {
                question: "Q4. é¢å°æ–°é£Ÿç‰©æ™‚:",
                options: [
                    { text: "A. æ¯«ä¸çŒ¶è±«åœ°åšé®®, åƒå€‹å°ç¾é£Ÿå®¶", value: "N" },
                    { text: "B. å…ˆèå†ç­‰, ç¢ºå®šå®‰å…¨æ‰åƒ", value: "S" }
                ]
            },
            {
                question: "Q5. ç©äº†ä¸€æ•´å¤©å¾Œ, ç‰ æœƒ:",
                options: [
                    { text: "A. é åœ¨ä½ èº«é‚Šæ’’å¬Œã€è¨æ‘¸", value: "E" },
                    { text: "B. è‡ªè¡Œå›çª©éœéœç¡è¦º", value: "I" }
                ]
            },
            {
                question: "Q6. è½åˆ°ä½ æ‹¿å‡ºå¤–å‡ºç¹©/æç± æ™‚:",
                options: [
                    { text: "A. èˆˆå¥®åˆ°æ–å°¾å·´ã€æƒ³ç«‹åˆ»å‡ºé–€", value: "N" },
                    { text: "B. ç¨å¾®æŠ—æ‹’ã€åå¥½å¾…åœ¨ç†Ÿæ‚‰çš„ç’°å¢ƒ", value: "S" }
                ]
            },
            {
                question: "Q7. åœ¨å¯µç‰©èšæœƒä¸­:",
                options: [
                    { text: "A. ä¸»å‹•çµäº¤æ–°æœ‹å‹, åƒå€‹ç¤¾äº¤å°æ˜æ˜Ÿ", value: "E" },
                    { text: "B. å®‰éœè§€å¯Ÿ, æ…¢ç†±åœ°æŒ‘äººäº’å‹•", value: "I" }
                ]
            },
            {
                question: "Q8. å®¶è£¡æ›äº†æ–°å‚¢ä¿±å¾Œ:",
                options: [
                    { text: "A. é¦¬ä¸Šæ¢ç´¢ã€å—…èã€è·³ä¸Šå»è©¦è©¦çœ‹", value: "N" },
                    { text: "B. é¿é–‹æ–°ç‰©å“å¹¾å¤©å†é è¿‘", value: "S" }
                ]
            },
            {
                question: "Q9. ç„¡èŠæ™‚, ç‰ æœƒ:",
                options: [
                    { text: "A. ä¸»å‹•æ‰¾ä½ äº’å‹•, ç”¨å«è²æˆ–æ’²æ’²æé†’", value: "E" },
                    { text: "B. è‡ªå·±æ‰¾äº‹åš, çœ‹çª—å¤–ã€èˆ”æ¯›ã€æ‰“ç›¹", value: "I" }
                ]
            },
            {
                question: "Q10. é—œæ–¼æ—¥å¸¸ä½œæ¯:",
                options: [
                    { text: "A. å–œæ­¡å°é©šå–œ, æ¯å¤©è®Šä¸€é»é»", value: "N" },
                    { text: "B. å–œæ­¡å›ºå®šæ™‚é–“åƒé£¯èˆ‡ç¡è¦º", value: "S" }
                ]
            }
        ];

        // ==========================================
        // 3. ä½ çš„æ¸¬é©—çµæœæè¿° (å·²æ ¹æ“šæ–°ç‰ˆ PDF å’Œåœ–ç‰‡ URL æ›´æ–°)
        // ==========================================
        const resultDescriptions = {
            "EN": {
                title: "æ´»åŠ›æ¢éšªå®¶",
                description: "<p><strong>å€‹æ€§æ¦‚è¿°:</strong> å……æ»¿æ´»åŠ›ã€å¤©ç”Ÿç¤¾äº¤é«˜æ‰‹,å°ä¸–ç•Œæ°¸é ä¿æŒç†±æƒ…ã€‚ç‰ å€‘æ¸´æœ›äº’å‹•ã€æ¢ç´¢æ–°äº‹ç‰©,ç„¡è«–æ˜¯æˆ¶å¤–å¥”è·‘é‚„æ˜¯çµäº¤æ–°æœ‹å‹,éƒ½æ˜¯ç”Ÿæ´»çš„æ¨‚è¶£ä¾†æºã€‚</p><p><strong>äº’å‹•æŒ‡å—:</strong><br>â€¢ ç¶“å¸¸å¸¶ç‰ å¤–å‡ºå†’éšªã€ç™»å±±ã€å…¬åœ’æ´»å‹•ã€‚<br>â€¢ æä¾›å¤šè®Šç©å…·èˆ‡äº’å‹•è¨“ç·´,åˆºæ¿€èº«å¿ƒã€‚<br>â€¢ æ­£å‘çå‹µé¼“å‹µç‰ æ¢ç´¢æ–°äº‹ç‰©ã€‚</p>",
                image: "https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/EN.png"
            },
            "ES": {
                title: "è²¼å¿ƒå°è·Ÿç­",
                description: "<p><strong>å€‹æ€§æ¦‚è¿°:</strong> æº«æŸ”ã€ä¾æˆ€å‹æ€§æ ¼,æ˜¯æœ€å¿ èª çš„é™ªä¼´è€…ã€‚å–œæ­¡è·Ÿåœ¨ä¸»äººèº«é‚Š,äº«å—è¢«é—œæ³¨ã€è¢«æ“æŠ±çš„æ„Ÿè¦ºã€‚æ–°ç’°å¢ƒæœƒè®“ç‰ ç·Šå¼µ,ä½†ç†Ÿæ‚‰çš„å®¶å°±æ˜¯å®‰å…¨å ¡å£˜ã€‚</p><p><strong>äº’å‹•æŒ‡å—:</strong><br>â€¢ æ¯å¤©çµ¦äºˆæ“æŠ±ã€æ¢³æ¯›ã€å°è©±çš„æ™‚é–“ã€‚<br>â€¢ åå¥½å®¤å…§éŠæˆ²,ä¾‹å¦‚èº²è²“è²“ã€æ‹‰æ‰¯ç¹©ã€‚<br>â€¢ å‡ºé–€å‰å¯ç”¨å°é»å¿ƒæ¸›ç·©ç„¦æ…®ã€‚</p>",
                image: "https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/ES.png"
            },
            "IN": {
                title: "æ²‰æ€è§€å¯Ÿè€…",
                description: "<p><strong>å€‹æ€§æ¦‚è¿°:</strong> è°æ˜ã€ç¨ç«‹ã€æœ‰æ´å¯ŸåŠ›,å–œæ­¡å®‰éœåœ°ç ”ç©¶ä¸–ç•Œã€‚ç‰ ä¸æ„›ç†±é¬§,ä½†å°ç’°å¢ƒè®ŠåŒ–å’Œç´°ç¯€æ¥µåº¦æ•éŠ³ã€‚åƒå€‹å°ç§‘å­¸å®¶,ç”¨æ™‚é–“è§€å¯Ÿä¸¦å­¸ç¿’ã€‚</p><p><strong>äº’å‹•æŒ‡å—:</strong><br>â€¢ çµ¦äºˆç‰ ç§äººç©ºé–“èˆ‡ç›Šæ™ºå‹ç©å…·ã€‚<br>â€¢ è¨­ç½®éœ€è¦å‹•è…¦çš„å°‹å¯¶éŠæˆ²ã€‚<br>â€¢ ä¸éœ€é »ç¹æ’«æ‘¸,é™ªä¼´å³å¯è®“ç‰ æ„Ÿåˆ°å®‰å…¨ã€‚</p>",
                image: "https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/IN.png"
            },
            "IS": {
                title: "å±…å®¶é‘‘è³å®¶",
                description: "<p><strong>å€‹æ€§æ¦‚è¿°:</strong> å®‰éœã€ç©©å®šã€äº«å—ç”Ÿæ´»å“è³ªã€‚å–œæ­¡ç†Ÿæ‚‰çš„ç¯€å¥èˆ‡èˆ’é©çš„è§’è½,æ˜¯ã€Œç”Ÿæ´»å“å‘³è€…ã€ã€‚ä»»ä½•çªå¦‚å…¶ä¾†çš„è®ŠåŒ–éƒ½æœƒè®“ç‰ æ„Ÿåˆ°ä¸å®‰ã€‚</p><p><strong>äº’å‹•æŒ‡å—:</strong><br>â€¢ ä¿æŒè¦å¾‹æ™‚é–“è¡¨ã€‚<br>â€¢ æº–å‚™èˆ’é©åºŠå¢Šèˆ‡ä¹¾æ·¨é£²é£Ÿç’°å¢ƒã€‚<br>â€¢ ä»¥è¼•æŸ”æ’«æ‘¸ã€ä½èªäº’å‹•æœ€åˆé©ã€‚</p>",
                image: "https://eeee821022.github.io/Storage/%E5%AF%B5%E7%89%A9%E5%95%8F%E5%8D%B7%E8%AA%BF%E6%9F%A5/IS.png"
            },
            "DEFAULT": { // é€™æ˜¯ç‚ºäº†é˜²æ­¢è¨ˆç®—éŒ¯èª¤æ™‚çš„å‚™ç”¨çµæœ
                title: "ç¨ç‰¹çš„æ¯›å­©å­",
                description: "<p>ä½ çš„å¯µç‰©æ€§æ ¼éå¸¸ç¨ç‰¹ï¼</p><p><strong>ç…§é¡§å°æç¤ºï¼š</strong> è«‹ä¾ç…§ä½ å°ç‰ çš„äº†è§£ï¼Œçµ¦ç‰ æœ€å¤šçš„æ„›èˆ‡é—œæ‡·ã€‚</p>",
                image: "https://placehold.co/150x100/AAAAAA/FFFFFF?text=PET&font=noto+sans+tc"
            }
        };

        // ==========================================
        // ä»¥ä¸‹æ˜¯éŠæˆ²é‹ä½œçš„ç¨‹å¼ç¢¼ (å·²æ›´æ–°)
        // ==========================================

        // éŠæˆ²ç‹€æ…‹
        let currentQuestionIndex = 0;
        let scores = { E: 0, I: 0, N: 0, S: 0 };
        let finalResult = "";
        let userPetName = "";
        // *** ä¿®æ”¹ï¼š userAnswers ç¾åœ¨å„²å­˜çš„æ˜¯æ¯å€‹é¸é …çš„åŸå§‹ 'value'ï¼Œä¾‹å¦‚ "E", "N" ***
        // *** ç‚ºäº†æ–¹ä¾¿è¿½è¹¤ä½¿ç”¨è€…é¸äº†å“ªå€‹é¸é …ï¼Œæ–°å¢ä¸€å€‹å„²å­˜é¸é …ç´¢å¼•çš„é™£åˆ— ***
        let selectedOptionIndexes = new Array(quizData.length).fill(null); 

        // DOM å…ƒç´ 
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        // const emailModal = document.getElementById('email-modal'); // <-- ç§»é™¤
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const currentQuestionNum = document.getElementById('current-question-num');
        const totalQuestions = document.getElementById('total-questions');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // åˆå§‹åŒ–ç¸½é¡Œæ•¸é¡¯ç¤º
        totalQuestions.innerText = quizData.length;

        // é–‹å§‹éŠæˆ²
        function startGame() {
            userPetName = document.getElementById('petName').value || "ä½ çš„å¯µç‰©";
            currentQuestionIndex = 0;
            scores = { E: 0, I: 0, N: 0, S: 0 };
            selectedOptionIndexes = new Array(quizData.length).fill(null); // é‡ç½®å·²é¸é¸é …
            
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            loadQuestion();
        }

        // è¼‰å…¥é¡Œç›®
        function loadQuestion() {
            // æ›´æ–°é€²åº¦æ¢
            const progress = ((currentQuestionIndex + 1) / quizData.length) * 100;
            progressBar.style.width = `${progress}%`;
            currentQuestionNum.innerText = currentQuestionIndex + 1; // æ›´æ–°é¡Œè™Ÿ

            const q = quizData[currentQuestionIndex];
            questionText.innerText = q.question.replace(/æ¯›å­©/g, userPetName);
            optionsContainer.innerHTML = ""; // æ¸…ç©ºèˆŠé¸é …

            q.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = "w-full text-left p-5 bg-gray-50 rounded-xl border-2 border-gray-200 quiz-option text-brand-dark-gray text-lg";
                button.innerText = option.text.replace(/æ¯›å­©/g, userPetName);
                button.onclick = () => selectAnswer(option.value, index); // å‚³å…¥é¸é …ç´¢å¼•
                
                // *** æ ¹æ“šä¹‹å‰é¸éçš„ç­”æ¡ˆï¼Œæ¨™ç¤ºé¸ä¸­ç‹€æ…‹ ***
                if (selectedOptionIndexes[currentQuestionIndex] === index) {
                    button.classList.add('selected');
                }
                optionsContainer.appendChild(button);
            });

            updateNavigationButtons(); // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
        }

        // é¸æ“‡ç­”æ¡ˆ
        function selectAnswer(value, optionIndex) {
            // ç§»é™¤å‰ä¸€å€‹é¸ä¸­çš„é¸é …æ¨£å¼
            const prevSelected = optionsContainer.querySelector('.quiz-option.selected');
            if (prevSelected) {
                prevSelected.classList.remove('selected');
            }

            // æ·»åŠ ç•¶å‰é¸ä¸­é¸é …çš„æ¨£å¼
            event.target.classList.add('selected');

            // è¨˜éŒ„ç­”æ¡ˆ
            selectedOptionIndexes[currentQuestionIndex] = optionIndex; // è¨˜éŒ„é¸é …ç´¢å¼•
            
            // å¦‚æœæ‰€æœ‰é¡Œç›®éƒ½ç­”å®Œäº†ï¼Œæ‰è‡ªå‹•è·³åˆ°ä¸‹ä¸€é¡Œ
            if (currentQuestionIndex < quizData.length - 1) {
                setTimeout(nextQuestion, 200); 
            } else {
                // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œä¸”å·²é¸ï¼Œå•Ÿç”¨ã€Œå®Œæˆæ¸¬é©—ã€æŒ‰éˆ•
                updateNavigationButtons();
            }
        }

        // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
        function updateNavigationButtons() {
            // ä¸Šä¸€é¡ŒæŒ‰éˆ•
            prevBtn.disabled = currentQuestionIndex === 0;

            // ä¸‹ä¸€é¡Œ / å®Œæˆæ¸¬é©—æŒ‰éˆ•
            if (currentQuestionIndex === quizData.length - 1) {
                nextBtn.innerText = "å®Œæˆæ¸¬é©—";
                nextBtn.innerHTML = `<i class="fas fa-check-circle mr-2"></i> å®Œæˆæ¸¬é©—`;
                // åªæœ‰ç•¶æœ€å¾Œä¸€é¡Œè¢«é¸ä¸­æ™‚æ‰å•Ÿç”¨å®ŒæˆæŒ‰éˆ•
                nextBtn.disabled = selectedOptionIndexes[currentQuestionIndex] === null;
            } else {
                nextBtn.innerText = "ä¸‹ä¸€é¡Œ";
                nextBtn.innerHTML = `ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i>`;
                // åªæœ‰ç•¶å‰é¡Œç›®è¢«é¸ä¸­æ™‚æ‰å•Ÿç”¨ä¸‹ä¸€é¡ŒæŒ‰éˆ•
                nextBtn.disabled = selectedOptionIndexes[currentQuestionIndex] === null;
            }
        }

        // å‰å¾€ä¸Šä¸€é¡Œ
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        // å‰å¾€ä¸‹ä¸€é¡Œæˆ–å®Œæˆæ¸¬é©—
        function nextQuestion() {
            // ç¢ºä¿ç•¶å‰é¡Œç›®æœ‰è¢«é¸ä¸­
            if (selectedOptionIndexes[currentQuestionIndex] === null) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼");
                return;
            }

            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œç›´æ¥è™•ç†æ¸¬é©—å®Œæˆ
                handleTestCompletion();
            }
        }

        // (ç§»é™¤ showEmailModal å‡½æ•¸)

        // ===== ä¿®æ”¹é»ï¼šç§»é™¤ handleEmailSubmitï¼Œæ”¹ç‚º handleTestCompletion =====
        /**
         * è™•ç†æ¸¬é©—å®Œæˆ (è¨ˆç®—ã€æäº¤ã€é¡¯ç¤ºçµæœ)
         */
        async function handleTestCompletion() {
            // é¡¯ç¤ºè®€å–ä¸­... (ä¾‹å¦‚ï¼Œå¯ä»¥æš«æ™‚ç¦ç”¨æŒ‰éˆ•)
            nextBtn.disabled = true;
            nextBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> æ­£åœ¨è¨ˆç®—...`;

            // 1. å–å¾—æˆ–å»ºç«‹ Device ID
            let deviceID = localStorage.getItem('petMBTI_DeviceID');
            if (!deviceID) {
                deviceID = crypto.randomUUID(); // ç”¢ç”Ÿä¸€çµ„éš¨æ©Ÿ ID
                localStorage.setItem('petMBTI_DeviceID', deviceID);
            }
            
            // 2. é‡æ–°è¨ˆç®—åˆ†æ•¸ (å› ç‚ºä½¿ç”¨è€…å¯èƒ½å›é ­ä¿®æ”¹ç­”æ¡ˆ)
            scores = { E: 0, I: 0, N: 0, S: 0 };
            const actualAnswers = []; // å„²å­˜æœ€çµ‚ç­”æ¡ˆçš„å¯¦éš› value (E, I, N, S)

            selectedOptionIndexes.forEach((optionIndex, qIndex) => {
                if (optionIndex !== null) {
                    const selectedValue = quizData[qIndex].options[optionIndex].value;
                    scores[selectedValue]++;
                    actualAnswers.push(selectedValue); // è¨˜éŒ„å¯¦éš›ç­”æ¡ˆ value
                } else {
                    actualAnswers.push("æœªé¸"); // å¦‚æœæœ‰é¡Œç›®æœªé¸ï¼Œè¨˜éŒ„ "æœªé¸"
                }
            });

            // 3. è¨ˆç®—çµæœ
            finalResult = calculateResult(); // "EN", "ES", "IN", "IS"
            
            // 4. æäº¤åˆ° Google Script
            try {
                // *** ä¿®æ”¹ï¼šå‚³å…¥ deviceID è€Œä¸æ˜¯ email ***
                await submitToGoogleScript(deviceID, finalResult, actualAnswers);
            } catch (error) {
                console.error("æäº¤åˆ° Google Script å¤±æ•—:", error);
                // å³ä½¿æäº¤å¤±æ•—ï¼Œæˆ‘å€‘ä»ç„¶é¡¯ç¤ºçµæœçµ¦ä½¿ç”¨è€…
            }
            
            // 5. é¡¯ç¤ºçµæœ
            quizScreen.classList.add('hidden'); // éš±è—æ¸¬é©—ç•«é¢
            showResultScreen(finalResult);

            // (é‡è¨­æŒ‰éˆ•ç‹€æ…‹ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨)
            nextBtn.disabled = false;
            updateNavigationButtons(); // æ¢å¾©æŒ‰éˆ•æ–‡å­— (ä¾‹å¦‚ "å®Œæˆæ¸¬é©—")
        }

        // è¨ˆç®— MBTI çµæœ (E/I + N/S)
        function calculateResult() {
            let result = "";
            // å¦‚æœ E å’Œ I åˆ†æ•¸ç›¸åŒï¼Œé è¨­ç‚º E
            result += (scores.E >= scores.I) ? "E" : "I"; 
            // å¦‚æœ N å’Œ S åˆ†æ•¸ç›¸åŒï¼Œé è¨­ç‚º N
            result += (scores.N >= scores.S) ? "N" : "S"; 
            return result;
        }

        // ===== ä¿®æ”¹é»ï¼šæäº¤ DeviceID è€Œä¸æ˜¯ Email =====
        // æäº¤åˆ° Google Apps Script
        function submitToGoogleScript(deviceID, result, answers) {
            if (GAS_WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
                console.warn("å°šæœªè¨­å®š Google Apps Script ç¶²å€ï¼Œç•¥éæäº¤ã€‚");
                return Promise.resolve(); // ç›´æ¥æˆåŠŸ
            }
            
            const data = { 
                deviceID: deviceID, // <-- ä¿®æ”¹
                result: result, // "EN", "ES", "IN", "IS"
                petName: userPetName,
                answers: answers // ["E", "N", ..., "S"] (10å€‹ç­”æ¡ˆ)
            };
            
            return fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', // Google Script Web App éœ€è¦ no-cors æˆ–ç‰¹å®šè¨­å®š
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                redirect: 'follow'
            });
            // æ³¨æ„ï¼šä½¿ç”¨ mode: 'no-cors'ï¼Œæˆ‘å€‘ç„¡æ³•å¾—çŸ¥è«‹æ±‚æ˜¯å¦çœŸçš„æˆåŠŸ
            // ä½†é€™æ˜¯è·¨åŸŸ POST åˆ° Google Script æœ€ç°¡å–®çš„æ–¹å¼
            // GAS ç«¯çš„ doPost éœ€è¦æ­£ç¢ºè™•ç†
        }

        // é¡¯ç¤ºçµæœç•«é¢
        function showResultScreen(result) {
            const resultData = resultDescriptions[result] || resultDescriptions["DEFAULT"];

            document.getElementById('result-pet-name').innerText = userPetName;
            document.getElementById('result-type').innerText = result;
            document.getElementById('result-title').innerText = resultData.title;
            document.getElementById('result-description').innerHTML = resultData.description;
            document.getElementById('result-image').src = resultData.image; 

            resultScreen.classList.remove('hidden');
        }

        // å„²å­˜çµæœåœ–ç‰‡ä¸¦è·³è½‰
        function saveResultAndRedirect() {
            const resultElement = document.getElementById('result-capture-area');
            
            // é¡¯ç¤ºä¸€å€‹çŸ­æš«çš„ "å„²å­˜ä¸­..." æç¤º
            const saveButton = event.target;
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>å„²å­˜ä¸­...`;
            saveButton.disabled = true;

            html2canvas(resultElement, {
                scale: 2, // æé«˜åœ–ç‰‡è§£æåº¦
                useCORS: true // å…è¨±è·¨åŸŸåœ–ç‰‡ (å› ç‚ºä½ çš„åœ–ç‰‡ä¾†æºæ˜¯ github)
            }).then(canvas => {
                // å»ºç«‹ä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                link.download = `${userPetName}_MBTI_${finalResult}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // åŸ·è¡Œä¸‹è¼‰å¾Œï¼Œæ¢å¾©æŒ‰éˆ•ä¸¦è·³è½‰
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
                
                // è·³è½‰åˆ°ä½ çš„å•å·
                window.location.href = 'https://tinyurl.com/yc2htzfc';

            }).catch(err => {
                console.error("å„²å­˜åœ–ç‰‡å¤±æ•—:", err);
                // å³ä½¿å¤±æ•—ï¼Œä¹Ÿè¦æ¢å¾©æŒ‰éˆ•ä¸¦è·³è½‰
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
                alert("å„²å­˜åœ–ç‰‡å¤±æ•—ï¼Œå³å°‡å‰å¾€å•å·é é¢ã€‚");
                window.location.href = 'https://tinyurl.com/yc2htzfc';
            });
        }

        // é‡æ–°æ¸¬è©¦
        function resetGame() {
            // é‡ç½®æ‰€æœ‰éŠæˆ²ç‹€æ…‹
            currentQuestionIndex = 0;
            scores = { E: 0, I: 0, N: 0, S: 0 };
            finalResult = "";
            userPetName = "";
            selectedOptionIndexes = new Array(quizData.length).fill(null); 

            // é¡¯ç¤ºé–‹å§‹ç•«é¢
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            document.getElementById('petName').value = ""; // æ¸…ç©ºå¯µç‰©åç¨±è¼¸å…¥æ¡†
        }

    </script>
</body>
</html>


