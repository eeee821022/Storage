<!-- Revision 4 - Codex adjustments -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube å¤šåŠŸèƒ½ä¸‹è¼‰å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #0d1117; 
        }
        button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #transcriptionBox {
            background-color: #161b22;
            border-color: #30363d;
        }
        /* ç¾åŒ–æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• */
        input[type="file"]::file-selector-button {
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            background-color: #3b82f6; /* è—è‰² */
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 1rem;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #2563eb;
        }
        input[type="file"] {
            color: #9ca3af; /* æª”æ¡ˆåç¨±æ–‡å­—é¡è‰² */
        }
        /* èªè¨€åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .lang-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid #374151;
            background-color: #1f2937;
            color: #9ca3af;
        }
        .lang-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .lang-btn:hover:not(.active) {
            border-color: #4b5563;
            background-color: #374151;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700">
        <h1 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-3">
            <span class="text-red-500">YouTube</span> å¤šåŠŸèƒ½ä¸‹è¼‰å·¥å…·
        </h1>
        
        <div class="mb-6 p-3 bg-blue-900/50 text-blue-300 rounded-lg text-xs">
            ğŸ’¡ <span class="font-bold">é€£ç·šç›®æ¨™ï¼š</span> <code class="bg-blue-800/70 p_1 rounded">http://127.0.0.1:5000</code>
        </div>

        <!-- èªè¨€é¸æ“‡å€å¡Š -->
        <div class="mb-6 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold text-gray-300 mb-1">èªè¨€é¸æ“‡ / Language</h2>
                    <p class="text-xs text-gray-500">é¸æ“‡è™•ç†èªè¨€æ¨¡å¼</p>
                </div>
                <div class="flex gap-2">
                    <button id="langZh" class="lang-btn active">ä¸­æ–‡ (ç¹é«”)</button>
                    <button id="langEn" class="lang-btn">English</button>
                </div>
            </div>
            <div id="langDescZh" class="mt-3 text-xs text-gray-400 border-l-2 border-blue-500 pl-3">
                <strong>ä¸­æ–‡æ¨¡å¼ï¼š</strong>éœ€è¦é€å­—ç¨¿ï¼ŒGeminiæœƒå…ˆæ ¡æ­£å†æ•´ç†å…§å®¹
            </div>
            <div id="langDescEn" class="mt-3 text-xs text-gray-400 border-l-2 border-green-500 pl-3 hidden">
                <strong>English Mode:</strong> No transcript needed, Gemini will directly organize video content
            </div>
        </div>

        <!-- 1. é€šç”¨è¼¸å…¥ -->
        <div class="space-y-6">
            <div>
                <label for="youtubeUrl" class="block text-sm font-medium text-gray-300 mb-2">YouTube å½±ç‰‡é€£çµ (URL)</label>
                <textarea id="youtubeUrl" rows="4" 
                          placeholder="å¯åœ¨æ­¤è²¼ä¸Šå¤šå€‹ YouTube ç¶²å€ï¼Œä¸€è¡Œä¸€å€‹ã€‚&#10;æˆ–ç›´æ¥å°‡ .txt æª”æ¡ˆæ‹–æ›³åˆ°æ­¤è™•ã€‚"
                          class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500 transition-all duration-200"></textarea>
            </div>

            <!-- 2. åŸ·è¡Œé¸é … -->
            <div class="border-t border-gray-700 pt-6">
                <h2 class="text-lg font-semibold text-white mb-4">åŸ·è¡Œé¸é …</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 bg-gray-900/50 rounded-lg">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-mp4" value="mp4" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-red-600 focus:ring-red-500">
                        <span class="ml-3 text-white font-medium">ä¸‹è¼‰ MP4 å½±ç‰‡</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-mp3" value="mp3" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <span class="ml-3 text-white font-medium">ä¸‹è¼‰ MP3 éŸ³è¨Š</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-thumbnail" value="thumbnail" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-gray-500 focus:ring-gray-400">
                        <span class="ml-3 text-white font-medium">ä¸‹è¼‰å°é¢ç¸®åœ–</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-transcript" value="transcript" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-teal-600 focus:ring-teal-500">
                        <span class="ml-3 text-white font-medium">ç”¢ç”Ÿé€å­—ç¨¿ (Whisper)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-gemini" value="gemini" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                        <span class="ml-3 text-white font-medium">AI åˆ†æèˆ‡æ•´ç† (Gemini)</span>
                    </label>
                </div>
            </div>

            <!-- 3. æ§åˆ¶é¢æ¿ -->
            <div class="border-t border-gray-700 pt-6">
                <div id="mainControls" class="flex justify-center items-center space-x-4">
                    <button id="startProcessingBtn" title="é–‹å§‹" class="w-16 h-16 text-green-400 rounded-full bg-gray-900/50 border-2 border-gray-700 hover:border-green-400 hover:text-white transition duration-200 flex items-center justify-center disabled:bg-gray-800 disabled:text-gray-600 disabled:border-gray-700 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 16 16"><path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
                    </button>
                    <button id="pauseBtn" title="æš«åœ" class="w-16 h-16 text-yellow-400 rounded-full bg-gray-900/50 border-2 border-gray-700 hover:border-yellow-400 hover:text-white transition duration-200 flex items-center justify-center disabled:bg-gray-800 disabled:text-gray-600 disabled:border-gray-700 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>
                    </button>
                    <button id="resumeBtn" title="ç¹¼çºŒ" class="w-16 h-16 text-blue-400 rounded-full bg-gray-900/50 border-2 border-gray-700 hover:border-blue-400 hover:text-white transition duration-200 flex items-center justify-center disabled:bg-gray-800 disabled:text-gray-600 disabled:border-gray-700 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 16 16"><path d="m12.5 8.236-6.5 4.258A.5.5 0 0 1 5 12.066V3.934a.5.5 0 0 1 .5-.434l6.5 4.258a.5.5 0 0 1 0 .868zM5 3.566v8.868L11.596 8 5 3.566z"/></svg>
                    </button>
                    <button id="stopBtn" title="å¼·åˆ¶çµæŸ" class="w-16 h-16 text-red-400 rounded-full bg-gray-900/50 border-2 border-gray-700 hover:border-red-400 hover:text-white transition duration-200 flex items-center justify-center disabled:bg-gray-800 disabled:text-gray-600 disabled:border-gray-700 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 16 16"><path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/></svg>
                    </button>
                </div>
            </div>

            <!-- 8. å…¨æ–°ï¼šæ‰¹é‡å‹¾é¸æ¸…å–® -->
            <div id="checklistContainer" class="hidden mt-6 pt-6 border-t border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">å‹¾é¸è¦è™•ç†çš„å½±ç‰‡</h3>
                    <div>
                        <input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                        <label for="selectAllCheckbox" class="ml-2 text-sm font-medium text-gray-300">å…¨é¸ / å…¨ä¸é¸</label>
                    </div>
                </div>
                <div class="space-y-2 max-h-96 overflow-y-auto pr-2" id="checklist">
                    <!-- JS å‹•æ…‹ç”Ÿæˆé …ç›® -->
                </div>
            </div>

            <!-- 4. æ–°å¢ï¼šä¸Šå‚³ MP3 è½‰éŒ„ -->
            <div class="border-t border-gray-700 pt-6">
                <h2 class="text-lg font-semibold text-white mb-4">ä¸Šå‚³ MP3 è½‰éŒ„</h2>
                <p class="text-sm text-gray-400 mb-4">
                    æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä¸Šå‚³é›»è…¦ä¸­çš„ MP3 æª”æ¡ˆé€²è¡Œè½‰éŒ„ã€‚
                </p>
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    <input type="file" id="mp3Uploader" accept=".mp3" 
                           class="flex-grow w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-lg">
                    <button id="uploadTranscribeBtn" 
                            class="w-full sm:w-auto px-6 py-3 text-white font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition duration-200 shadow-md">
                        ä¸Šå‚³ä¸¦è½‰éŒ„
                    </button>
                </div>
            </div>

        </div>

        <!-- è¨Šæ¯/çµæœå€å¡Š -->
        <div id="messageBox" class="mt-8 p-4 border-l-4 rounded-lg transition-all duration-300 hidden">
            <p id="messageText" class="text-sm"></p>
        </div>

        <!-- 7. å…¨æ–°ï¼šæ‰¹é‡è™•ç†é€²åº¦è¿½è¹¤ -->
        <div id="progressTracker" class="hidden mt-6 pt-6 border-t border-gray-700">
            <h3 class="text-xl font-semibold text-white mb-4">è™•ç†é€²åº¦</h3>

            <!-- é€²åº¦åˆ—è¡¨ -->
            <div class="space-y-2" id="progressList">
                <!-- JS å‹•æ…‹ç”Ÿæˆé …ç›® -->
            </div>
            <div id="failedLinksBox" class="mt-6 p-4 bg-red-900/20 border border-red-700/50 rounded-lg space-y-3">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <h4 class="text-red-200 font-semibold text-sm flex items-center gap-2">
                        <span>å¤±æ•—çš„é€£çµ</span>
                        <span class="text-red-400 text-xs">ï¼ˆå¯è¤‡è£½é‡è©¦ï¼‰</span>
                    </h4>
                    <div class="flex items-center gap-2 text-xs">
                        <span id="failedLinksCount" class="text-red-300"></span>
                        <button id="copyFailedLinksBtn" class="px-3 py-1 rounded bg-red-500/20 border border-red-400/60 text-red-200 hover:bg-red-500/40 transition disabled:opacity-40 disabled:cursor-not-allowed">
                            è¤‡è£½æ¸…å–®
                        </button>
                    </div>
                </div>
                <p id="failedLinksEmpty" class="text-xs text-red-200/70">ç›®å‰æ²’æœ‰å¤±æ•—çš„é€£çµã€‚</p>
                <ul id="failedLinksList" class="space-y-2 text-sm"></ul>
            </div>
        </div>
        
        <!-- 6. å…¨æ–°ï¼šé€å­—ç¨¿å°ˆå±¬çµæœå€å¡Š -->
        <div id="transcriptionResultBox" class="hidden mt-6 pt-6 border-t border-gray-700">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xl font-semibold text-white">é€å­—ç¨¿çµæœ</h2>
                <button id="copyTranscriptionBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow transition duration-200">
                    è¤‡è£½é€å­—ç¨¿
                </button>
            </div>
            <textarea id="transcriptionBox" readonly rows="12" class="w-full p-3 text-gray-200 border rounded-lg text-sm leading-relaxed font-mono resize-none"></textarea>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        // DOM Elements
        const urlInput = document.getElementById('youtubeUrl');
        const startProcessingBtn = document.getElementById('startProcessingBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const progressTracker = document.getElementById('progressTracker');
        const progressList = document.getElementById('progressList');
        let failedLinksBox = document.getElementById('failedLinksBox');
        let failedLinksList = document.getElementById('failedLinksList');
        let failedLinksCount = document.getElementById('failedLinksCount');
        let failedLinksEmpty = document.getElementById('failedLinksEmpty');
        let copyFailedLinksBtn = document.getElementById('copyFailedLinksBtn');
        const mp3Uploader = document.getElementById('mp3Uploader');
        const uploadTranscribeBtn = document.getElementById('uploadTranscribeBtn');
        const transcriptionResultBox = document.getElementById('transcriptionResultBox');
        const transcriptionBox = document.getElementById('transcriptionBox');
        const copyTranscriptionBtn = document.getElementById('copyTranscriptionBtn');
        
        // Language Selection
        const langZhBtn = document.getElementById('langZh');
        const langEnBtn = document.getElementById('langEn');
        const langDescZh = document.getElementById('langDescZh');
        const langDescEn = document.getElementById('langDescEn');
        let selectedLanguage = 'zh'; // Default to Chinese
        
        // Task Checkboxes
        const taskCheckboxes = {
            mp4: document.getElementById('task-mp4'),
            mp3: document.getElementById('task-mp3'),
            thumbnail: document.getElementById('task-thumbnail'),
            transcript: document.getElementById('task-transcript'),
            gemini: document.getElementById('task-gemini')
        };

        let pollingInterval = null;

        // Language Selection Handlers
        langZhBtn.addEventListener('click', function() {
            selectedLanguage = 'zh';
            langZhBtn.classList.add('active');
            langEnBtn.classList.remove('active');
            langDescZh.classList.remove('hidden');
            langDescEn.classList.add('hidden');
            handleTaskDependencies(); // Update task dependencies for Chinese mode
        });

        langEnBtn.addEventListener('click', function() {
            selectedLanguage = 'en';
            langEnBtn.classList.add('active');
            langZhBtn.classList.remove('active');
            langDescEn.classList.remove('hidden');
            langDescZh.classList.add('hidden');
            handleTaskDependencies(); // Update task dependencies for English mode
        });

        // === UI Helpers ===
        function showMessage(text, type = 'blue') {
            const colors = {
                'blue': { bg: 'bg-blue-900/30', border: 'border-blue-500', text: 'text-blue-300' },
                'green': { bg: 'bg-green-900/30', border: 'border-green-500', text: 'text-green-300' },
                'yellow': { bg: 'bg-yellow-900/30', border: 'border-yellow-500', text: 'text-yellow-300' },
                'red': { bg: 'bg-red-900/30', border: 'border-red-500', text: 'text-red-300' }
            };
            const style = colors[type] || colors.blue;
            messageBox.className = `mt-8 p-4 border-l-4 rounded-lg transition-all duration-300 ${style.bg} ${style.border}`;
            messageText.className = `text-sm ${style.text}`;
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        function updateButtonStates(state) {
            const states = {
                initial: { start: false, pause: true, resume: true, stop: true },
                running: { start: true, pause: false, resume: true, stop: false },
                paused: { start: true, pause: true, resume: false, stop: false },
                completed: { start: false, pause: true, resume: true, stop: true }
            };
            const s = states[state] || states.initial;
            startProcessingBtn.disabled = s.start;
            pauseBtn.disabled = s.pause;
            resumeBtn.disabled = s.resume;
            stopBtn.disabled = s.stop;
        }

        function resetUI() {
            progressList.innerHTML = '';
            progressTracker.classList.add('hidden');
            transcriptionResultBox.classList.add('hidden');
            ensureFailedLinksSection();
            if (failedLinksList) failedLinksList.innerHTML = '';
            if (failedLinksCount) failedLinksCount.textContent = 'å…± 0 ç­†';
            if (failedLinksEmpty) failedLinksEmpty.classList.remove('hidden');
            if (copyFailedLinksBtn) copyFailedLinksBtn.disabled = true;
        }

        function getUrlList() {
            const rawText = urlInput.value.trim();
            if (!rawText) {
                showMessage('éŒ¯èª¤ï¼šè«‹è¼¸å…¥è‡³å°‘ä¸€å€‹ YouTube ç¶²å€ã€‚', 'yellow');
                return null;
            }
            const urls = rawText.split('\n')
                .map(line => line.trim())
                .filter(line => line && (line.includes('youtube.com') || line.includes('youtu.be')));
            if (urls.length === 0) {
                showMessage('éŒ¯èª¤ï¼šæ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ YouTube ç¶²å€ã€‚', 'yellow');
                return null;
            }
            return urls;
        }

        function renderInitialProgress(taskData, requestedTasks) {
            progressList.innerHTML = '';
            progressTracker.classList.remove('hidden');
            ensureFailedLinksSection();
            failedLinksEmpty.classList.remove('hidden');
            failedLinksList.innerHTML = '';
            failedLinksCount.textContent = 'å…± 0 ç­†';
            copyFailedLinksBtn.disabled = true;

            // Task name mapping
            const taskNames = {
                'mp4': 'MP4',
                'mp3': 'MP3',
                'thumbnail': 'ç¸®åœ–',
                'transcript': 'é€å­—ç¨¿',
                'gemini': 'Gemini'
            };

            // Create table header with dynamic columns
            const tableHeader = document.createElement('div');
            const colCount = requestedTasks.length + 1;
            tableHeader.className = `grid gap-4 p-3 bg-gray-900/70 rounded-lg border border-gray-700 font-semibold text-gray-300 text-sm mb-2`;
            tableHeader.style.gridTemplateColumns = `2fr ${requestedTasks.map(() => '1fr').join(' ')}`;
            
            let headerHTML = '<div class="text-left">å½±ç‰‡</div>';
            requestedTasks.forEach(taskId => {
                headerHTML += `<div class="text-center">${taskNames[taskId] || taskId}</div>`;
            });
            tableHeader.innerHTML = headerHTML;
            progressList.appendChild(tableHeader);

            // Create table rows
            for (const task of taskData) {
                const taskDiv = document.createElement('div');
                taskDiv.id = `task-${encodeURIComponent(task.link)}`;
                taskDiv.className = `grid gap-4 p-3 bg-gray-900/30 rounded border border-gray-700 hover:border-gray-600 transition-colors text-sm`;
                taskDiv.style.gridTemplateColumns = `2fr ${requestedTasks.map(() => '1fr').join(' ')}`;

                let rowHTML = `<div class="text-white truncate" title="${task.title}">${task.title}</div>`;
                
                // Add status cells for requested tasks only
                requestedTasks.forEach(taskId => {
                    rowHTML += `<div id="status-${encodeURIComponent(task.link)}-${taskId}" class="text-center text-gray-500">-</div>`;
                });

                taskDiv.innerHTML = rowHTML;
                progressList.appendChild(taskDiv);
            }
        }

        let latestFailedEntries = [];

        function renderFailedLinks(failedEntries = []) {
            ensureFailedLinksSection();
            if (!Array.isArray(failedEntries)) {
                latestFailedEntries = [];
            } else {
                latestFailedEntries = [...failedEntries];
            }

            failedLinksList.innerHTML = '';
            failedLinksCount.textContent = `å…± ${latestFailedEntries.length} ç­†`;

            if (latestFailedEntries.length === 0) {
                failedLinksEmpty.classList.remove('hidden');
                copyFailedLinksBtn.disabled = true;
                return;
            }

            failedLinksEmpty.classList.add('hidden');
            copyFailedLinksBtn.disabled = false;

            latestFailedEntries.forEach(entry => {
                const item = document.createElement('li');
                item.className = 'p-3 bg-gray-900/40 border border-gray-700 rounded text-sm space-y-1';

                const titleEl = document.createElement('div');
                titleEl.className = 'text-white font-semibold truncate';
                titleEl.textContent = entry.title || entry.link || 'æœªçŸ¥é€£çµ';
                item.appendChild(titleEl);

                const linkEl = document.createElement('a');
                linkEl.className = 'text-red-300 break-all underline';
                if (entry.link) {
                    linkEl.href = entry.link;
                    linkEl.target = '_blank';
                    linkEl.rel = 'noopener noreferrer';
                    linkEl.textContent = entry.link;
                } else {
                    linkEl.textContent = 'ç„¡æ³•å–å¾—é€£çµ';
                }
                item.appendChild(linkEl);

                if (entry.error) {
                    const errorEl = document.createElement('p');
                    errorEl.className = 'text-xs text-red-400 break-words';
                    errorEl.textContent = entry.error;
                    item.appendChild(errorEl);
                }

                failedLinksList.appendChild(item);
            });
        }
        
        function buildFallbackFailures(tasksData = {}) {
            const fallback = [];
            for (const [url, taskData] of Object.entries(tasksData)) {
                const hasFailedStep = Object.values(taskData.steps || {}).some(step => step.status === 'failed');
                if (!hasFailedStep) continue;
                fallback.push({
                    title: taskData.title || url,
                    link: taskData.link || url,
                    error: taskData.error || 'æœªçŸ¥åŸå› é€ æˆå¤±æ•—'
                });
            }
            return fallback;
        }
        
        function ensureFailedLinksSection() {
            if (failedLinksBox && failedLinksList && failedLinksCount && failedLinksEmpty && copyFailedLinksBtn) {
                return;
            }
            if (!progressTracker) return;
            if (!document.getElementById('failedLinksBox')) {
                const container = document.createElement('div');
                container.innerHTML = `
                    <div id="failedLinksBox" class="hidden mt-6 p-4 bg-red-900/20 border border-red-700/50 rounded-lg space-y-3">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <h4 class="text-red-200 font-semibold text-sm flex items-center gap-2">
                                <span>å¤±æ•—çš„é€£çµ</span>
                                <span class="text-red-400 text-xs">ï¼ˆå¯è¤‡è£½é‡è©¦ï¼‰</span>
                            </h4>
                            <div class="flex items-center gap-2 text-xs">
                                <span id="failedLinksCount" class="text-red-300"></span>
                                <button id="copyFailedLinksBtn" class="px-3 py-1 rounded bg-red-500/20 border border-red-400/60 text-red-200 hover:bg-red-500/40 transition disabled:opacity-40 disabled:cursor-not-allowed">
                                    è¤‡è£½é€£çµ
                                </button>
                            </div>
                        </div>
                        <p id="failedLinksEmpty" class="text-xs text-red-200/70">ç›®å‰æ²’æœ‰å¤±æ•—çš„é€£çµã€‚</p>
                        <ul id="failedLinksList" class="space-y-2 text-sm"></ul>
                    </div>
                `;
                progressTracker.appendChild(container.firstElementChild);
            }
            failedLinksBox = document.getElementById('failedLinksBox');
            failedLinksList = document.getElementById('failedLinksList');
            failedLinksCount = document.getElementById('failedLinksCount');
            failedLinksEmpty = document.getElementById('failedLinksEmpty');
            copyFailedLinksBtn = document.getElementById('copyFailedLinksBtn');
            bindFailedLinksCopyButton();
        }

        function bindFailedLinksCopyButton() {
            if (!copyFailedLinksBtn || copyFailedLinksBtn.dataset.copyBound === 'true') return;
            copyFailedLinksBtn.addEventListener('click', copyFailedLinksToClipboard);
            copyFailedLinksBtn.dataset.copyBound = 'true';
        }

        async function copyFailedLinksToClipboard() {
            if (!latestFailedEntries.length) return;
            const text = latestFailedEntries
                .map(entry => entry.link || entry.title || 'ï¼ˆç„¡æ³•å–å¾—é€£çµï¼‰')
                .join('\n');
            try {
                await navigator.clipboard.writeText(text);
                showMessage('å·²è¤‡è£½å¤±æ•—é€£çµï¼Œè²¼ä¸Šå³å¯é‡æ–°è™•ç†ã€‚', 'green');
            } catch (err) {
                showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—å€å¡Šã€‚', 'red');
            }
        }

        bindFailedLinksCopyButton();

        async function pollStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/get_batch_status');
                const status = await response.json();

                if (!status.tasks) return;

                for (const [url, taskData] of Object.entries(status.tasks)) {
                    for (const [taskId, stepInfo] of Object.entries(taskData.steps)) {
                        const statusElement = document.getElementById(`status-${encodeURIComponent(url)}-${taskId}`);
                        if (!statusElement) continue;

                        const statusDisplay = {
                            'pending': { text: '-', color: 'text-gray-500' },
                            'running': { text: 'â³', color: 'text-blue-400' },
                            'completed': { text: 'âœ“', color: 'text-green-400' },
                            'failed': { text: 'âœ—', color: 'text-red-400' }
                        };

                        const s = statusDisplay[stepInfo.status] || statusDisplay['pending'];
                        
                        // Check if status just changed to completed
                        const wasCompleted = statusElement.getAttribute('data-completed') === 'true';
                        if (stepInfo.status === 'completed' && !wasCompleted) {
                            statusElement.setAttribute('data-completed', 'true');
                            
                            // Auto-download completed files
                            if (stepInfo.file) {
                                setTimeout(() => {
                                    const downloadUrl = `${API_BASE_URL}/download/${encodeURIComponent(stepInfo.file)}`;
                                    const a = document.createElement('a');
                                    a.href = downloadUrl;
                                    a.download = stepInfo.file;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                }, 100);
                            }
                        }
                        
                        statusElement.textContent = s.text;
                        statusElement.className = `text-center ${s.color}`;
                    }
                }

                const backendFailed = status.failed_urls || [];
                const derivedFailed = (backendFailed && backendFailed.length) ? backendFailed : buildFallbackFailures(status.tasks);
                renderFailedLinks(derivedFailed);

                if (status.is_complete) {
                    stopPolling();
                    showMessage('æ‰€æœ‰ä»»å‹™å·²å®Œæˆï¼æª”æ¡ˆå·²è‡ªå‹•ä¸‹è¼‰åˆ°æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾ã€‚', 'green');
                    updateButtonStates('completed');
                }

            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(pollStatus, 1000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        async function sendControlCommand(endpoint) {
            try {
                const response = await fetch(API_BASE_URL + endpoint, { method: 'POST' });
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage(result.message, 'green');
                    if (endpoint === '/pause_batch') {
                        updateButtonStates('paused');
                    } else if (endpoint === '/resume_batch') {
                        updateButtonStates('running');
                    } else if (endpoint === '/stop_batch') {
                        stopPolling();
                        updateButtonStates('completed');
                    }
                } else {
                    showMessage(`æ“ä½œå¤±æ•—ï¼š${result.message}`, 'red');
                }
            } catch (error) {
                showMessage(`æ“ä½œå¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ä¼ºæœå™¨ã€‚`, 'red');
            }
        }

        function handleTaskDependencies() {
            const isGeminiChecked = taskCheckboxes.gemini.checked;
            const isTranscriptChecked = taskCheckboxes.transcript.checked;
            
            // In English mode, Gemini doesn't depend on transcript or mp3
            if (selectedLanguage === 'en') {
                // Re-enable transcript and mp3 if they were disabled by Gemini
                taskCheckboxes.transcript.disabled = false;
                taskCheckboxes.mp3.disabled = false;
                
                // But transcript still depends on mp3
                if (isTranscriptChecked) {
                    taskCheckboxes.mp3.checked = true;
                    taskCheckboxes.mp3.disabled = true;
                } else {
                    taskCheckboxes.mp3.disabled = false;
                }
            } else {
                // Chinese mode: original logic
                // Gemini depends on Transcript and MP3
                if (isGeminiChecked) {
                    taskCheckboxes.transcript.checked = true;
                    taskCheckboxes.transcript.disabled = true;
                    taskCheckboxes.mp3.checked = true;
                    taskCheckboxes.mp3.disabled = true;
                } else {
                    taskCheckboxes.transcript.disabled = false;
                    // Only re-enable mp3 if transcript is also not checked
                    if (!isTranscriptChecked) {
                        taskCheckboxes.mp3.disabled = false;
                    }
                }
                
                // Transcript depends on MP3
                if (isTranscriptChecked) {
                    taskCheckboxes.mp3.checked = true;
                    taskCheckboxes.mp3.disabled = true;
                } else {
                    // Only re-enable mp3 if gemini is also not checked
                     if (!isGeminiChecked) {
                        taskCheckboxes.mp3.disabled = false;
                     }
                }
            }
        }

        async function startProcessing() {
            showMessage('DEBUG: "Start" button clicked.', 'blue');
            
            const urls = getUrlList();
            if (!urls) {
                showMessage('DEBUG: getUrlList failed or returned no URLs.', 'red');
                return;
            }
            showMessage('DEBUG: Got URLs successfully.', 'green');

            const selectedTasks = Object.values(taskCheckboxes)
                .filter(cb => cb && cb.checked)
                .map(cb => cb.value);
            
            if (selectedTasks.length === 0) {
                showMessage('éŒ¯èª¤ï¼šè«‹è‡³å°‘é¸æ“‡ä¸€å€‹åŸ·è¡Œé¸é …ã€‚', 'yellow');
                return;
            }
            showMessage('DEBUG: Got selected tasks successfully.', 'green');
            
            resetUI();
            showMessage('DEBUG: UI reset successfully.', 'green');

            updateButtonStates('running');
            showMessage('DEBUG: Button states updated to "running".', 'green');

            showMessage(`æ­£åœ¨åˆå§‹åŒ– ${urls.length} å€‹å½±ç‰‡çš„ ${selectedTasks.length} é …ä»»å‹™...`, 'blue');

            try {
                showMessage('DEBUG: Sending request to backend...', 'blue');
                const response = await fetch(API_BASE_URL + '/process_videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        urls, 
                        tasks: selectedTasks,
                        language: selectedLanguage  // Send language parameter
                    })
                });
                showMessage('DEBUG: Got response from backend.', 'green');

                const result = await response.json();
                showMessage('DEBUG: Parsed backend response.', 'green');

                if (response.ok && result.success) {
                    showMessage(result.message, 'green');
                    renderInitialProgress(result.initial_tasks, result.requested_tasks);
                    startPolling();
                } else {
                    showMessage(`å•Ÿå‹•å¤±æ•—ï¼š${result.message || 'å¾Œç«¯ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚'}`, 'red');
                    updateButtonStates('initial');
                }

            } catch (error) {
                console.error('Processing start error:', error);
                showMessage(`å•Ÿå‹•å¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ä¼ºæœå™¨ã€‚ Error: ${error.message}`, 'red');
                updateButtonStates('initial');
            }
        }

        // --- Event Listeners ---
        startProcessingBtn.addEventListener('click', startProcessing);
        pauseBtn.addEventListener('click', () => sendControlCommand('/pause_batch'));
        resumeBtn.addEventListener('click', () => sendControlCommand('/resume_batch'));
        stopBtn.addEventListener('click', () => sendControlCommand('/stop_batch'));

        Object.values(taskCheckboxes).forEach(checkbox => {
            checkbox.addEventListener('change', handleTaskDependencies);
        });

        // Drag and drop for URL input
        urlInput.addEventListener('dragover', (e) => { e.preventDefault(); urlInput.classList.add('border-red-500', 'bg-gray-600'); });
        urlInput.addEventListener('dragleave', (e) => { e.preventDefault(); urlInput.classList.remove('border-red-500', 'bg-gray-600'); });
        urlInput.addEventListener('drop', (e) => {
            e.preventDefault();
            urlInput.classList.remove('border-red-500', 'bg-gray-600');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = (ev) => { urlInput.value = ev.target.result; };
                reader.readAsText(file);
            }
        });

        // Standalone MP3 upload logic (kept as is)
        uploadTranscribeBtn.addEventListener('click', async function() {
            const file = mp3Uploader.files[0];
            if (!file) {
                showMessage('éŒ¯èª¤ï¼šè«‹å…ˆé¸æ“‡ä¸€å€‹ MP3 æª”æ¡ˆã€‚', 'yellow');
                return;
            }
            resetUI();
            const formData = new FormData();
            formData.append('audio_file', file);
            this.disabled = true;
            this.textContent = 'ä¸Šå‚³ä¸¦è½‰éŒ„ä¸­...';
            showMessage('æ­£åœ¨ä¸Šå‚³æª”æ¡ˆä¸¦ä½¿ç”¨ Whisper è½‰éŒ„ï¼Œè«‹ç¨å€™...', 'blue');
            
            try {
                const response = await fetch(API_BASE_URL + '/upload_and_transcribe', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage('ä¸Šå‚³è½‰éŒ„æˆåŠŸï¼', 'green');
                    transcriptionBox.value = result.transcription;
                    transcriptionResultBox.classList.remove('hidden');
                    transcriptionResultBox.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showMessage(`è½‰éŒ„å¤±æ•—ï¼š${result.message || 'è½‰éŒ„æ™‚å¾Œç«¯ç™¼ç”ŸéŒ¯èª¤ã€‚'}`, 'red');
                }
            } catch (error) {
                showMessage(`ä¸Šå‚³é€£ç·šå¤±æ•—ï¼šè«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨ (backend_server.py) ä»åœ¨é‹è¡Œã€‚`, 'red');
            } finally {
                this.disabled = false;
                this.textContent = 'ä¸Šå‚³ä¸¦è½‰éŒ„';
            }
        });

        copyTranscriptionBtn.addEventListener('click', function() {
            const textToCopy = transcriptionBox.value;
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showMessage('å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'green');
                }).catch(err => {
                    showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚', 'red');
                });
            }
        });

        // Initial call to set up dependencies correctly if any are pre-checked
        handleTaskDependencies();
        // Initial call to set button states on page load
        updateButtonStates('initial');
    });
    </script>
</body>
</html>
