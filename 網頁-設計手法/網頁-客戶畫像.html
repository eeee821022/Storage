<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona æ¬Šé‡è©é›²åˆ†æå·¥å…·</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    
    <style>
        /* ==================== åŸºç¤è¨­å®š ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-800 */
            line-height: 1.6;
        }
        
        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            padding-top: 5rem;
        }
        
        /* ==================== å…§å®¹å€ä½ˆå±€ ==================== */
        .content-wrapper {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .left-content {
            flex: 1;
            min-width: 0;
        }
        
        .right-sidebar {
            width: 360px;
            flex-shrink: 0;
        }
        
        /* ==================== æ¨™é¡Œå€ ==================== */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
            color: #111827; /* gray-900 */
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            font-size: 1rem; /* 16px */
            font-weight: 400;
            color: #4b5563; /* gray-600 */
        }
        
        /* ==================== å³ä¸Šè§’æŒ‰éˆ•çµ„ ==================== */
        .top-right-buttons {
            position: fixed;
            top: 1.5rem;
            right: 5.75rem;
            z-index: 50;
            display: flex;
            gap: 0.75rem;
        }
        
        .icon-button {
            background-color: #ffffff;
            padding: 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #2563eb;
            transition: background-color 0.15s ease-in-out;
            border: none;
            cursor: pointer;
        }
        
        .icon-button:hover {
            background-color: #eff6ff;
        }
        
        .icon-button svg {
            width: 1.5rem;
            height: 1.5rem;
            display: block;
        }

        .floating-action-button {
            position: fixed;
            padding: 0.75rem;
            border-radius: 9999px;
            background-color: #ffffff;
            color: #2563eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            z-index: 60;
        }

        .floating-action-button:hover {
            background-color: #eff6ff;
            transform: translateY(-1px);
        }

        .floating-action-button svg {
            width: 1.5rem;
            height: 1.5rem;
            display: block;
        }

        #help-button {
            top: 1.5rem;
            right: 1.5rem;
        }

        #book-help-button {
            right: 1.5rem;
            bottom: 1.5rem;
        }
        
        /* éš±è—çš„æª”æ¡ˆè¼¸å…¥ */
        #file-input {
            display: none;
        }
        
        /* ==================== ç¯©é¸å™¨å€åŸŸ ==================== */
        .filters {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 5rem;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-section h3 {
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            margin-bottom: 0.75rem;
        }
        
        /* æƒ…ç·’å’Œä¸»é¡Œç¯©é¸è¤‡é¸æ¡† */
        .checkboxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        /* è‡ªå®šç¾©ä¸‹æ‹‰é¸å–® */
        .custom-select {
            position: relative;
            width: 100%;
        }
        
        .select-trigger {
            width: 100%;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            color: #1f2937;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease-in-out;
        }
        
        .select-trigger:hover {
            border-color: #9ca3af;
            background-color: #ffffff;
        }
        
        .select-trigger svg {
            width: 1rem;
            height: 1rem;
            transition: transform 0.2s ease-in-out;
        }
        
        .select-trigger.open svg {
            transform: rotate(180deg);
        }
        
        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-height: 300px;
            overflow-y: auto;
            z-index: 30;
            display: none;
        }
        
        .select-dropdown.show {
            display: block;
        }
        
        .select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.15s ease-in-out;
        }
        
        .select-option:hover {
            background-color: #f3f4f6;
        }
        
        .select-option input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }
        
        .select-option label {
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            flex: 1;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 0.875rem;
            color: #374151; /* gray-700 */
            cursor: pointer;
        }
        
        /* ==================== è©é›²åœ–å€åŸŸ ==================== */
        .wordcloud-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }
        
        #wordcloud-canvas {
            width: 100%;
            max-width: 756px;
            height: 756px;
            margin: 0 auto;
            display: block;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        #wordcloud-canvas.masked {
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }
        
        /* ==================== äº‹ä»¶é¡¯ç¤ºå€ ==================== */
        #event-display {
            background-color: #eff6ff; /* bg-blue-50 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe; /* border-blue-200 */
            margin-bottom: 1.5rem;
            display: none;
        }
        
        #event-display h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .event-keyword {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.375rem;
            text-align: center;
        }
        
        .event-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .event-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .event-meta-label {
            font-weight: 600;
            color: #4b5563;
            font-size: 0.875rem;
        }
        
        .event-meta-value {
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        #event-text {
            font-size: 0.875rem;
            color: #1f2937;
            line-height: 1.5;
            background-color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        
        /* ==================== æç¤ºè¨Šæ¯ ==================== */
        .info-message {
            background-color: #eff6ff; /* bg-blue-50 */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }
        
        .info-message svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #2563eb; /* text-blue-600 */
            flex-shrink: 0;
            margin-top: 0.125rem;
        }
        
        .info-message p {
            font-size: 0.875rem;
            color: #1f2937;
        }
        
        /* ==================== å½ˆçª—æ¨£å¼ ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            backdrop-filter: blur(2px);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            z-index: 41;
            overflow-y: auto;
        }
        
        .modal-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .modal > div:not(.modal-overlay) {
            position: relative;
            z-index: 42;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            position: relative;
            width: 100%;
            max-width: 42rem; /* 672px */
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 85vh;
            overflow-y: auto;
            z-index: 50;
        }
        
        .close-modal-button {
            position: sticky;
            top: -1rem;
            right: -1rem;
            float: right;
            color: #9ca3af; /* text-gray-400 */
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.15s ease-in-out;
            z-index: 51;
        }
        
        .close-modal-button:hover {
            color: #4b5563; /* hover:text-gray-600 */
        }
        
        .close-modal-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        
        .modal-content table td {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .modal-content table td:first-child {
            background-color: #f9fafb;
            font-weight: 600;
            width: 25%;
        }
        
        .modal-content ol {
            padding-left: 1.5rem;
        }
        
        .modal-content ol li {
            margin-bottom: 0.5rem;
        }
        
        /* ==================== è¨­å®šé¢æ¿æ¨£å¼ ==================== */
        .settings-group {
            margin-bottom: 1.5rem;
        }
        
        .settings-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider {
            flex: 1;
            height: 0.5rem;
            border-radius: 0.25rem;
            background: #e5e7eb;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            min-width: 3rem;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }

        .mask-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .mask-option {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #fff;
            padding: 0.35rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .mask-option.selected {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .mask-option img {
            width: 56px;
            height: 56px;
            object-fit: contain;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }

        .mask-option span {
            font-size: 0.75rem;
            color: #374151;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .mask-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .mask-actions button {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            color: #374151;
        }

        #reload-mask-btn {
            border-color: #2563eb;
            background-color: #2563eb;
            color: #fff;
        }

        .mask-list-status {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .mask-loading,
        .mask-error {
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            text-align: center;
        }

        .mask-loading {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .mask-error {
            background-color: #fef2f2;
            color: #b91c1c;
        }
        
        /* ==================== éŒ¯èª¤è¨Šæ¯ ==================== */
        .error-message {
            background-color: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            margin-bottom: 1.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .right-sidebar {
                width: 100%;
            }
            
            .filters {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                padding-top: 5rem;
            }
            
            #wordcloud-canvas {
                max-width: 100%;
                height: auto;
                aspect-ratio: 1 / 1;
            }
            
            .top-right-buttons {
                top: 4.5rem;
                right: 1rem;
                flex-direction: column;
                align-items: flex-end;
            }
            
            .filter-section h3 {
                font-size: 1rem;
            }

            #help-button {
                top: 1rem;
                right: 1rem;
            }

            #book-help-button {
                right: 1rem;
                bottom: 1rem;
            }
        }

        #persona-image-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border: 2px solid #ccc;
            display: none;
            /* é®ç½©æ•ˆæœ */
            -webkit-mask-image: url('å‰ªå½±/å¥³1.png');
            mask-image: url('å‰ªå½±/å¥³1.png');
            -webkit-mask-mode: alpha;
            mask-mode: alpha;
            -webkit-mask-size: 100% 100%;
            mask-size: 100% 100%;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
        }

        .persona-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .persona-card h3 {
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem;
        }
        
        .persona-card p {
            font-size: 0.875rem;
            color: #374151; /* gray-700 */
            margin-bottom: 0.5rem;
        }
        
        .persona-card .label {
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        /* ==================== äº‹ä»¶é¡¯ç¤ºå€ ==================== */
        #event-display {
            background-color: #eff6ff; /* bg-blue-50 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe; /* border-blue-200 */
            margin-bottom: 1.5rem;
            display: none;
        }
        
        #event-display h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .event-keyword {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.375rem;
            text-align: center;
        }
        
        .event-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .event-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .event-meta-label {
            font-weight: 600;
            color: #4b5563;
            font-size: 0.875rem;
        }
        
        .event-meta-value {
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        #event-text {
            font-size: 0.875rem;
            color: #1f2937;
            line-height: 1.5;
            background-color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        
        /* ==================== æç¤ºè¨Šæ¯ ==================== */
        .info-message {
            background-color: #eff6ff; /* bg-blue-50 */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }
        
        .info-message svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #2563eb; /* text-blue-600 */
            flex-shrink: 0;
            margin-top: 0.125rem;
        }
        
        .info-message p {
            font-size: 0.875rem;
            color: #1f2937;
        }
        
        /* ==================== å½ˆçª—æ¨£å¼ ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        
        .modal {
            position: fixed;
            inset: 0;
            z-index: 41;
            overflow-y: auto;
        }
        
        .modal > div:not(.modal-overlay) {
            position: relative;
            z-index: 42;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            position: relative;
            width: 100%;
            max-width: 42rem; /* 672px */
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 80vh;
            overflow-y: auto;
            margin: 2rem auto;
            z-index: 50;
        }
        
        .close-modal-button {
            position: sticky;
            top: -1rem;
            right: -1rem;
            float: right;
            color: #9ca3af; /* text-gray-400 */
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.15s ease-in-out;
            z-index: 51;
        }
        
        .close-modal-button:hover {
            color: #4b5563; /* hover:text-gray-600 */
        }
        
        .close-modal-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        
        .modal-content table td {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .modal-content table td:first-child {
            background-color: #f9fafb;
            font-weight: 600;
            width: 25%;
        }
        
        .modal-content ol {
            padding-left: 1.5rem;
        }
        
        .modal-content ol li {
            margin-bottom: 0.5rem;
        }
        
        /* ==================== è¨­å®šé¢æ¿æ¨£å¼ ==================== */
        .settings-group {
            margin-bottom: 1.5rem;
        }
        
        .settings-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider {
            flex: 1;
            height: 0.5rem;
            border-radius: 0.25rem;
            background: #e5e7eb;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            min-width: 3rem;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }
        
        /* ==================== éŒ¯èª¤è¨Šæ¯ ==================== */
        .error-message {
            background-color: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            margin-bottom: 1.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .right-sidebar {
                width: 100%;
            }
            
            .filters {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                padding-top: 5rem;
            }
            
            #wordcloud-canvas {
                max-width: 100%;
                height: auto;
                aspect-ratio: 1 / 1;
            }
            
            .top-right-buttons {
                top: 1rem;
                right: 1rem;
            }
            
            .filter-section h3 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’æŒ‰éˆ•çµ„ -->
    <div class="top-right-buttons">
        <button id="upload-button" class="icon-button" title="ä¸Šå‚³ CSV æª”æ¡ˆ">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
            </svg>
        </button>
        
        <button id="settings-button" class="icon-button" title="è¨­å®š">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
        </button>
        <!-- mask/shape controls moved to bottom-right panel -->
    </div>

    <button id="help-button" class="floating-action-button" title="æŸ¥çœ‹ä½¿ç”¨èªªæ˜" aria-label="æŸ¥çœ‹ä½¿ç”¨èªªæ˜">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>
    </button>

    <input type="file" id="file-input" accept=".csv" />

    <!-- èªªæ˜å½ˆçª— -->
    <div id="help-modal" class="modal hidden">
        <div id="help-modal-overlay" class="modal-overlay"></div>
        <div class="modal-container">
            <div id="help-modal-content" class="modal-content">
                <button id="help-modal-close-btn" class="close-modal-button" data-modal="help-modal" aria-label="é—œé–‰èªªæ˜è¦–çª—">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2>æ–¹æ³•ä»‹ç´¹ï¼šé¡§å®¢ç•«åƒ (Persona)</h2>
                
                <table>
                    <tbody>
                        <tr>
                            <td>æ–¹æ³•åç¨±</td>
                            <td>é¡§å®¢ç•«åƒ (Persona)</td>
                        </tr>
                        <tr>
                            <td>ä¸€å¥è©±ç¸½çµ</td>
                            <td>ğŸ¯ è·¨è¶Šç”¢å“è¦–è§’ï¼Œç”¨çœŸå¯¦ç”¨æˆ¶çš„çœ¼ç›å’Œæƒ…ç·’ä¾†è¨­è¨ˆã€‚</td>
                        </tr>
                        <tr>
                            <td>æ ¸å¿ƒæ¦‚å¿µ</td>
                            <td>é¡§å®¢ç•«åƒæ˜¯ä¸€ç¨®ç ”ç©¶å‹çš„è™›æ“¬äººç‰©æ¨¡å‹ï¼Œé€éå½™æ•´çœŸå¯¦ç”¨æˆ¶çš„è¡Œç‚ºã€ç—›é»ã€å‹•æ©Ÿã€ç›®æ¨™å’Œäººå£çµ±è¨ˆè³‡æ–™ç­‰æ·±åº¦è³‡è¨Šï¼Œå‰µé€ å‡ºä¸€å€‹å…·é«”ä¸”å…·ä»£è¡¨æ€§çš„ã€Œç†æƒ³ç”¨æˆ¶ã€ã€‚å®ƒè®“è¨­è¨ˆåœ˜éšŠèƒ½å¤ è„«é›¢å€‹äººåè¦‹ï¼Œå°‡è¨­è¨ˆæ±ºç­–èšç„¦æ–¼æ»¿è¶³ç›®æ¨™ç”¨æˆ¶çš„ç‰¹å®šéœ€æ±‚ã€‚</td>
                        </tr>
                        <tr>
                            <td>è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ</td>
                            <td>
                                <ul style="padding-left: 1.5rem; margin: 0;">
                                    <li>æ¨¡ç³Šçš„ç”¨æˆ¶ç›®æ¨™ï¼šå°‡æŠ½è±¡çš„ã€Œç”¨æˆ¶ã€å…·é«”åŒ–ï¼Œå¹«åŠ©åœ˜éšŠæ˜ç¢ºã€Œæˆ‘å€‘åœ¨ç‚ºèª°è¨­è¨ˆï¼Ÿã€</li>
                                    <li>è¨­è¨ˆæ±ºç­–çš„è¡çªï¼šæä¾›ä¸€å€‹å…±åŒçš„åƒè€ƒé»ï¼Œæ¸›å°‘åœ˜éšŠæˆå“¡é–“å› ç”¨æˆ¶èªçŸ¥å·®ç•°è€Œç”¢ç”Ÿçš„çˆ­è­°ã€‚</li>
                                    <li>åŠŸèƒ½è”“å»¶ (Feature Creep)ï¼šå¹«åŠ©åœ˜éšŠèšç„¦ï¼Œç¢ºä¿é–‹ç™¼çš„åŠŸèƒ½èˆ‡ç›®æ¨™ç”¨æˆ¶çš„æ ¸å¿ƒéœ€æ±‚ä¿æŒä¸€è‡´ã€‚</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>æœ€ä½³ä½¿ç”¨æ™‚æ©Ÿ</td>
                            <td>å°ˆæ¡ˆçš„å•é¡Œæ¢ç´¢æœŸã€æ¦‚å¿µç™¼æƒ³æœŸåŠéœ€æ±‚å®šç¾©æœŸã€‚åœ¨é€²è¡Œç”¨æˆ¶ç ”ç©¶ï¼ˆè¨ªè«‡ã€å•å·ã€æ•¸æ“šåˆ†æï¼‰ä¹‹å¾Œï¼Œæ­£å¼é–‹å§‹è¨­è¨ˆæˆ–é–‹ç™¼ä¹‹å‰ã€‚</td>
                        </tr>
                        <tr>
                            <td>ä½¿ç”¨æµç¨‹èªªæ˜</td>
                            <td>
                                <ol style="margin: 0;">
                                    <li><strong>æ•¸æ“šæ”¶é›†èˆ‡åˆ†æï¼š</strong>åŸ·è¡Œç”¨æˆ¶è¨ªè«‡ã€å•å·èª¿æŸ¥ã€ç¶²ç«™æ•¸æ“šåˆ†æç­‰ï¼Œæ”¶é›†çœŸå¯¦ç”¨æˆ¶çš„è¡Œç‚ºæ¨¡å¼å’Œå‹•æ©Ÿã€‚</li>
                                    <li><strong>æ‰¾å‡ºå…±åŒæ¨¡å¼ (Clustering)ï¼š</strong>å°‡æ”¶é›†åˆ°çš„æ•¸æ“šé€²è¡Œåˆ†çµ„ï¼Œè­˜åˆ¥å‡ºå¹¾ç¨®ä¸»è¦çš„ã€å…·æœ‰ä»£è¡¨æ€§çš„ç”¨æˆ¶è¡Œç‚ºã€ç›®æ¨™å’Œç—›é»çš„é›†ç¾¤ã€‚</li>
                                    <li><strong>å»ºç«‹è™›æ“¬äººç‰©ï¼š</strong>ç‚ºæ¯å€‹é—œéµé›†ç¾¤å‰µé€ ä¸€å€‹è™›æ“¬äººç‰©ã€‚ç‚ºå…¶å‘½åã€è¨­å®šèƒŒæ™¯æ•…äº‹ã€å¹´é½¡è·æ¥­ã€æŠ€èƒ½æ°´å¹³ï¼Œä»¥åŠæœ€é‡è¦çš„â€”â€”ç›®æ¨™ (Goals) èˆ‡ç—›é» (Frustrations)ã€‚</li>
                                    <li><strong>æƒ…å¢ƒåŒ– (Scenario Mapping)ï¼š</strong>ç‚º Persona æ’°å¯«ä¸€å€‹æˆ–å¤šå€‹ä½¿ç”¨æƒ…å¢ƒï¼Œæè¿°ä»–/å¥¹åœ¨ç‰¹å®šä»»å‹™ä¸­ï¼Œå¦‚ä½•èˆ‡ç”¢å“æˆ–æœå‹™äº’å‹•ï¼Œä»¥åŠåœ¨æ­¤éç¨‹ä¸­çš„æ„Ÿå—ã€‚</li>
                                    <li><strong>åœ˜éšŠæºé€šèˆ‡é‹ç”¨ï¼š</strong>å°‡ Persona æ–‡ä»¶åŒ–ä¸¦è¦–è¦ºåŒ–ï¼ˆé€šå¸¸æ˜¯æµ·å ±æˆ–å¡ç‰‡ï¼‰ï¼Œåœ¨åœ˜éšŠå…§éƒ¨åˆ†äº«ï¼Œä¸¦åœ¨å¾€å¾Œçš„è¨­è¨ˆå¯©æŸ¥å’ŒåŠŸèƒ½æ’åºæœƒè­°ä¸­ï¼Œå°‡ Persona ä½œç‚ºæ±ºç­–çš„ä¾æ“šã€‚</li>
                                </ol>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">å·¥å…·ä½¿ç”¨èªªæ˜</h3>
                <ol>
                    <li><strong>ä¸Šå‚³ CSV æª”æ¡ˆï¼š</strong>é»æ“Šå³ä¸Šè§’çš„ä¸Šå‚³æŒ‰éˆ•ï¼Œé¸æ“‡æ‚¨çš„ Result1.csv æª”æ¡ˆã€‚</li>
                    <li><strong>ç¯©é¸è³‡æ–™ï¼š</strong>ä½¿ç”¨ã€Œæƒ…ç·’ç¯©é¸ã€å’Œã€Œä¸»é¡Œç¯©é¸ã€è¤‡é¸æ¡†ä¾†éæ¿¾è©é›²å…§å®¹ã€‚</li>
                    <li><strong>æŸ¥çœ‹è©³ç´°è³‡è¨Šï¼š</strong>é»æ“Šè©é›²ä¸­çš„ä»»ä½•é—œéµå­—ï¼Œä¸‹æ–¹æœƒé¡¯ç¤ºè©²é—œéµå­—å°æ‡‰çš„åŸå§‹äº‹ä»¶æè¿°ã€‚</li>
                    <li><strong>èª¿æ•´é¡¯ç¤ºï¼š</strong>é»æ“Šè¨­å®šæŒ‰éˆ•å¯èª¿æ•´è©é›²å­—é«”å¤§å°ã€‚</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½æ“ä½œæŒ‡å—å½ˆçª— -->
    <div id="operation-modal" class="modal hidden">
        <div id="operation-modal-overlay" class="modal-overlay"></div>
        <div class="modal-container">
            <div id="operation-modal-content" class="modal-content">
                <button id="operation-modal-close-btn" class="close-modal-button" data-modal="operation-modal" aria-label="é—œé–‰æ“ä½œæŒ‡å—è¦–çª—">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>

                <h2 style="font-size:1.25rem;margin-bottom:1rem;font-weight:700;">åŠŸèƒ½æ“ä½œæŒ‡å—ï¼ˆPersona / å®¢æˆ¶ç•«åƒï¼‰</h2>
                <table>
                    <tbody>
                        <tr>
                            <td style="width:34%;">æ“ä½œ</td>
                            <td>æ“ä½œèªªæ˜</td>
                        </tr>
                        <tr>
                            <td>ä¸Šå‚³ CSV</td>
                            <td>æŒ‰ <code>#upload-button</code> é¸æ“‡ CSV æª”ï¼ˆä¾‹å¦‚ Result1.csvï¼‰ï¼Œç³»çµ±æœƒç”¨ PapaParse è§£æä¸¦ç”¢ç”Ÿè©é›²ã€‚</td>
                        </tr>
                        <tr>
                            <td>ç¯©é¸ä¸»é¡Œ / æƒ…ç·’</td>
                            <td>ä½¿ç”¨å³å´ <code>#theme-trigger</code> æˆ– <code>#emotion-trigger</code> é¸å–è¦åŒ…å«çš„é …ç›®ã€‚</td>
                        </tr>
                        <tr>
                            <td>æŸ¥çœ‹æ˜ç´°</td>
                            <td>é»æ“Šè©é›²é—œéµå­—æœƒåœ¨ <code>#event-display</code> é¡¯ç¤ºè©²è©çš„åŸå§‹äº‹ä»¶èˆ‡å±¬æ€§ã€‚</td>
                        </tr>
                        <tr>
                            <td>å­—é«”å¤§å°</td>
                            <td>åœ¨ <code>#settings-button</code> çš„è¨­å®šä¸­èª¿æ•´ <code>#font-size-slider</code> ä¾†æ”¹è®Šæœ€å¤§å­—é«”å°ºå¯¸ã€‚</td>
                        </tr>
                        <tr>
                            <td>æœå°‹</td>
                            <td>åœ¨å³å´è¼¸å…¥é—œéµå­—ï¼ŒæŒ‰ <code>#search-keyword-button</code> æˆ– Enter å¯å®šä½ä¸¦é¡¯ç¤ºè©²è©ã€‚</td>
                        </tr>
                        <tr>
                            <td>åŒ¯å‡º / æˆªåœ–</td>
                            <td>å¯ä½¿ç”¨ç€è¦½å™¨åˆ—å°æˆ–æ–°å¢ html2canvas æŒ‰éˆ•æ“·å–è©é›²ç•«é¢ï¼ˆå¦‚éœ€ï¼Œæˆ‘å¯å”åŠ©åŠ å…¥ï¼‰ã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- è¨­å®šå½ˆçª— -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem;">
            <div class="modal-content" style="max-width: 28rem;">
                <button class="close-modal-button" data-modal="settings-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2>è©é›²é¡¯ç¤ºè¨­å®š</h2>
                
                <div class="settings-group">
                    <label for="font-size-slider">å­—é«”å¤§å°</label>
                    <div class="slider-container">
                        <input type="range" id="font-size-slider" class="slider" min="50" max="150" value="100" step="5">
                        <span class="slider-value" id="font-size-value">100%</span>
                    </div>
                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                        èª¿æ•´è©é›²ä¸­é—œéµå­—çš„ç›¸å°å¤§å°ã€‚
                    </p>
                </div>

                <!-- Shape Selection -->
                <div class="settings-group">
                    <label for="shape-select">å½¢ç‹€</label>
                    <select id="shape-select" style="width:100%;padding:0.5rem;border-radius:0.375rem;border:1px solid #d1d5db;background-color: #f9fafb;font-size:0.9rem;">
                        <option value="circle">Circle (åœ“å½¢)</option>
                        <option value="cardioid">Cardioid (å¿ƒå½¢)</option>
                        <option value="diamond">Diamond (è±å½¢)</option>
                        <option value="square">Square (æ–¹å½¢)</option>
                        <option value="triangle">Triangle (ä¸‰è§’å½¢)</option>
                        <option value="star">Star (æ˜Ÿå½¢)</option>
                    </select>
                </div>

                <!-- Mask Upload -->
                <div class="settings-group">
                    <label>é®ç½©å‰ªå½±</label>
                    <p style="font-size:0.75rem;color:#6b7280;margin-bottom:0.5rem;">
                        å¾ã€Œå‰ªå½±ã€è³‡æ–™å¤¾çš„ PNG åœ–ç‰‡ä¸­æŒ‘é¸é®ç½©ã€‚æ–°å¢æª”æ¡ˆå¾Œå¯æŒ‰ã€Œé‡æ–°è¼‰å…¥ã€æ›´æ–°æ¸…å–®ã€‚
                    </p>
                    <div id="mask-gallery" class="mask-gallery"></div>
                    <div class="mask-actions">
                        <button id="reload-mask-btn">é‡æ–°è¼‰å…¥</button>
                        <button id="clear-mask-btn">æ¸…é™¤</button>
                    </div>
                    <div id="mask-list-status" class="mask-list-status"></div>
                    
                    <!-- Preview and Info -->
                    <div id="mask-preview-container" style="display:none;margin-top:0.5rem;padding:0.5rem;background:#f9fafb;border-radius:0.375rem;border:1px solid #e5e7eb;">
                        <div style="display:flex;gap:0.75rem;align-items:center;">
                            <img id="mask-preview" alt="é è¦½" style="width:56px;height:56px;object-fit:contain;border-radius:0.25rem;background:#fff;padding:4px;" />
                            <div id="mask-info" style="font-size:0.75rem;color:#6b7280;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <h1>Persona æ¬Šé‡è©é›²åˆ†æå·¥å…·</h1>
            <p class="subtitle">è¦–è¦ºåŒ–é¡§å®¢ç•«åƒé—œéµç‰¹å¾µèˆ‡æ¬Šé‡åˆ†å¸ƒ</p>
        </div>

        <!-- æç¤ºè¨Šæ¯ -->
        <div id="info-box" class="info-message">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
            </svg>
            <p>è«‹é»æ“Šå³ä¸Šè§’çš„ã€Œä¸Šå‚³ã€æŒ‰éˆ•ä¾†ä¸Šå‚³æ‚¨çš„ Result1.csv æª”æ¡ˆï¼Œé–‹å§‹åˆ†æã€‚</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error-box" class="error-message hidden"></div>

        <!-- å…§å®¹å€ -->
        <div class="content-wrapper">
            <!-- å·¦å´ï¼šè©é›²åœ– -->
            <div class="left-content">
                <!-- è©é›²åœ– -->
                <div id="wordcloud-container" class="wordcloud-container hidden">
                    <canvas id="wordcloud-canvas"></canvas>
                </div>
            </div>

            <!-- å³å´ï¼šé—œéµå­—è³‡è¨Š + ç¯©é¸å™¨ -->
            <div class="right-sidebar">
                <!-- äº‹ä»¶é¡¯ç¤º -->
                <div id="event-display">
                    <h3>ğŸ“Œ é—œéµå­—è©³ç´°è³‡è¨Š</h3>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <input 
                            type="text" 
                            id="event-keyword-input" 
                            placeholder="è¼¸å…¥é—œéµå­—æœå°‹..."
                            style="flex: 1; padding: 0.5rem; font-size: 0.875rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                        />
                        <button 
                            id="search-keyword-button"
                            style="padding: 0.5rem 1rem; background-color: #2563eb; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;"
                        >
                            æœå°‹
                        </button>
                    </div>
                    <div id="event-result" style="display: none;">
                        <div class="event-keyword" id="event-keyword"></div>
                        <div class="event-meta">
                            <div class="event-meta-item">
                                <span class="event-meta-label">ä¸»é¡Œï¼š</span>
                                <span class="event-meta-value" id="event-theme"></span>
                            </div>
                            <div class="event-meta-item">
                                <span class="event-meta-label">æƒ…ç·’ï¼š</span>
                                <span class="event-meta-value" id="event-emotions"></span>
                            </div>
                        </div>
                        <div class="event-meta-item" style="margin-bottom: 0.5rem;">
                            <span class="event-meta-label">åŸå§‹äº‹ä»¶ï¼š</span>
                        </div>
                        <div id="event-text"></div>
                    </div>
                    <div id="event-not-found" style="display: none; padding: 1rem; background-color: #fef2f2; border-radius: 0.375rem; color: #991b1b; font-size: 0.875rem; text-align: center;">
                        æ‰¾ä¸åˆ°è©²é—œéµå­—ï¼Œè«‹ç¢ºèªè¼¸å…¥æ­£ç¢º
                    </div>
                </div>
                
                <div id="filters-container" class="filters hidden">
                    <div class="filter-section">
                        <h3>ä¸»é¡Œç¯©é¸</h3>
                        <div class="custom-select">
                            <div class="select-trigger" id="theme-trigger">
                                <span id="theme-selected-text">å·²é¸æ“‡: å…¨éƒ¨ä¸»é¡Œ</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                            <div class="select-dropdown" id="theme-dropdown">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h3>æƒ…ç·’ç¯©é¸</h3>
                        <div class="custom-select">
                            <div class="select-trigger" id="emotion-trigger">
                                <span id="emotion-selected-text">å·²é¸æ“‡: å…¨éƒ¨æƒ…ç·’</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                            <div class="select-dropdown" id="emotion-dropdown">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cleaned script block: reduces complexity, fixes syntax errors and preserves mask & upload UX
        // è‹¥éƒ¨ç½²è‡³ GitHub Pagesï¼Œå¯åœ¨å¤–éƒ¨ script ä¸­è¦†å¯«ä»¥ä¸‹å…©å€‹è®Šæ•¸ä»¥å°æ‡‰ä¸åŒè·¯å¾‘
        window.MASK_ASSET_BASE = window.MASK_ASSET_BASE || 'å‰ªå½±/';
        window.MASK_LIST_FILENAME = window.MASK_LIST_FILENAME || 'mask-list.json';
        window.addEventListener('load', function () {
            let masterData = [];
            let globalMaxWeight = 0;
            const uniqueThemes = new Set();
            const uniqueEmotions = new Set();

            const BASE_FONT_SIZE = 80;
            let fontSizePercentage = 100;
            let maskScale = 100;

            const fileInput = document.getElementById('file-input');
            const uploadButton = document.getElementById('upload-button');
            const settingsButton = document.getElementById('settings-button');
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const helpModalOverlay = document.getElementById('help-modal-overlay');
            const helpModalCloseBtn = document.getElementById('help-modal-close-btn');
            const settingsModal = document.getElementById('settings-modal');
            const operationButton = document.getElementById('book-help-button');
            const operationModal = document.getElementById('operation-modal');
            const operationModalOverlay = document.getElementById('operation-modal-overlay');
            const operationModalCloseBtn = document.getElementById('operation-modal-close-btn');
            const infoBox = document.getElementById('info-box');
            const errorBox = document.getElementById('error-box');
            const filtersContainer = document.getElementById('filters-container');
            const wordcloudContainer = document.getElementById('wordcloud-container');
            const emotionTrigger = document.getElementById('emotion-trigger');
            const emotionDropdown = document.getElementById('emotion-dropdown');
            const emotionSelectedText = document.getElementById('emotion-selected-text');
            const themeTrigger = document.getElementById('theme-trigger');
            const themeDropdown = document.getElementById('theme-dropdown');
            const themeSelectedText = document.getElementById('theme-selected-text');
            const canvas = document.getElementById('wordcloud-canvas');
            const eventDisplay = document.getElementById('event-display');
            const eventKeywordInput = document.getElementById('event-keyword-input');
            const searchKeywordButton = document.getElementById('search-keyword-button');
            const eventResult = document.getElementById('event-result');
            const eventNotFound = document.getElementById('event-not-found');
            const eventKeyword = document.getElementById('event-keyword');
            const eventText = document.getElementById('event-text');
            const eventTheme = document.getElementById('event-theme');
            const eventEmotions = document.getElementById('event-emotions');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');

            const shapeSelect = document.getElementById('shape-select');
            const maskGallery = document.getElementById('mask-gallery');
            const reloadMaskBtn = document.getElementById('reload-mask-btn');
            const clearMaskBtn = document.getElementById('clear-mask-btn');
            const maskListStatus = document.getElementById('mask-list-status');
            let maskOptions = [];
            let currentMaskSelection = null;
            
            window.wordcloudMaskImage = null;
            window.selectedCloudShape = (shapeSelect && shapeSelect.value) || 'circle';

            function showError(message) { if (errorBox) { errorBox.textContent = 'âŒ ' + message; errorBox.classList.remove('hidden'); } }
            function hideError() { if (errorBox) errorBox.classList.add('hidden'); if (infoBox) infoBox.classList.remove('hidden'); }

            function setupCanvas() {
                if (!canvas) return;
                const targetSize = 756;
                const targetDPI = 144;
                const baseDPI = 96;
                const scale = targetDPI / baseDPI;
                canvas.width = targetSize * scale;
                canvas.height = targetSize * scale;
                canvas.style.width = targetSize + 'px';
                canvas.style.height = targetSize + 'px';
                const ctx = canvas.getContext('2d');
                ctx.setTransform(1,0,0,1,0,0);
                ctx.scale(scale, scale);
            }

            function updateMaskPreview(img) {
                const preview = document.getElementById('mask-preview');
                const container = document.getElementById('mask-preview-container');
                if (!preview || !img) return;
                const size = 56;
                const pc = document.createElement('canvas'); pc.width = size; pc.height = size;
                const pctx = pc.getContext('2d');
                const sc = Math.min(size / (img.naturalWidth || img.width), size / (img.naturalHeight || img.height));
                const sw = (img.naturalWidth || img.width) * sc; const sh = (img.naturalHeight || img.height) * sc;
                const sx = (size - sw) / 2, sy = (size - sh) / 2;
                pctx.clearRect(0,0,size,size); pctx.drawImage(img, sx, sy, sw, sh);
                preview.src = pc.toDataURL(); preview.style.display = 'block'; if (container) container.style.display = 'block';
            }

            function clearMaskPreview() { 
                const preview=document.getElementById('mask-preview'); 
                const container=document.getElementById('mask-preview-container'); 
                const info=document.getElementById('mask-info'); 
                if(preview){preview.src='';preview.style.display='none';} 
                if(container)container.style.display='none'; 
                if(info)info.textContent=''; 
            }

            function showMaskInfo(info) { 
                const el=document.getElementById('mask-info'); 
                if(!el) return; 
                const transText = info.hasTransparency ? 'âœ“ æœ‰é€æ˜' : 'âœ— ç„¡é€æ˜'; 
                const noteText = info.note ? ' Â· '+info.note : ''; 
                el.textContent = (info.width||'') + 'Ã—' + (info.height||'') + ' ' + transText + noteText; 
                el.style.color = info.hasTransparency ? '#059669' : '#dc2626'; 
            }

            function checkImageTransparency(img){ return new Promise((resolve,reject)=>{ try{ const c=document.createElement('canvas'); c.width=img.naturalWidth||img.width; c.height=img.naturalHeight||img.height; const cx=c.getContext('2d'); cx.clearRect(0,0,c.width,c.height); cx.drawImage(img,0,0,c.width,c.height); const d=cx.getImageData(0,0,c.width,c.height).data; let has=false; const step=Math.max(1,Math.floor((c.width*c.height)/1000)); for(let i=3;i<d.length;i+=4*step){ if(d[i]<255){has=true;break;} } resolve({hasTransparency:has,width:c.width,height:c.height}); }catch(e){reject(e);} }); }

            function generateMaskFromImage(sourceImg, threshold=180){ const c=document.createElement('canvas'); const sw=sourceImg.naturalWidth||sourceImg.width; const sh=sourceImg.naturalHeight||sourceImg.height; c.width=sw; c.height=sh; const cx=c.getContext('2d'); cx.clearRect(0,0,sw,sh); cx.drawImage(sourceImg,0,0,sw,sh); const id=cx.getImageData(0,0,sw,sh); const d=id.data; for(let i=0;i<d.length;i+=4){ const r=d[i],g=d[i+1],b=d[i+2]; const l=Math.round((r+g+b)/3); if(l<threshold){ d[i]=0; d[i+1]=0; d[i+2]=0; d[i+3]=255; } else { d[i+3]=0; } } cx.putImageData(id,0,0); const img=new Image(); img.crossOrigin='anonymous'; img.src=c.toDataURL('image/png'); img.naturalWidth=sw; img.naturalHeight=sh; return img; }

            if (shapeSelect) shapeSelect.addEventListener('change', function(){ window.selectedCloudShape=this.value||'circle'; if (masterData.length) renderWordCloud(); });

            async function loadMaskOptions(){
                if(!maskGallery) return;
                maskGallery.innerHTML = '<div class="mask-loading">æ­£åœ¨è¼‰å…¥å‰ªå½±...</div>';
                try {
                    const listUrl = window.MASK_ASSET_BASE + window.MASK_LIST_FILENAME + '?ts=' + Date.now();
                    const response = await fetch(listUrl);
                    if(!response.ok) throw new Error('HTTP ' + response.status);
                    const data = await response.json();
                    const list = Array.isArray(data) ? data : data.masks;
                    if(!Array.isArray(list) || list.length === 0){
                        maskGallery.innerHTML = '<div class="mask-error">æ‰¾ä¸åˆ°ä»»ä½• PNG å‰ªå½±</div>';
                        return;
                    }
                    maskOptions = list.filter(item => item && typeof item.file === 'string' && item.file.toLowerCase().endsWith('.png'));
                    renderMaskOptions();
                    if(maskListStatus) maskListStatus.textContent = 'å·²è¼‰å…¥ ' + maskOptions.length + ' å€‹å‰ªå½±';
                } catch(err) {
                    console.error(err);
                    maskGallery.innerHTML = '<div class="mask-error">ç„¡æ³•è¼‰å…¥å‰ªå½±æ¸…å–®ã€‚è«‹ç¢ºèªå·²ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿé é¢ã€‚</div>';
                    if(maskListStatus) maskListStatus.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
                }
            }

            function renderMaskOptions(){
                if(!maskGallery){ return; }
                maskGallery.innerHTML = '';
                maskOptions.forEach(option => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'mask-option';
                    const label = option.label || option.file;
                    const imgSrc = window.MASK_ASSET_BASE + option.file;
                    btn.innerHTML = '<img src="' + imgSrc + '" alt="' + label + '" loading="lazy" /><span>' + label + '</span>';
                    btn.addEventListener('click', () => selectMaskOption(option, btn));
                    if(currentMaskSelection === option.file){ btn.classList.add('selected'); }
                    maskGallery.appendChild(btn);
                });
                if(maskOptions.length === 0){ maskGallery.innerHTML = '<div class="mask-error">æ²’æœ‰å¯ç”¨å‰ªå½±</div>'; }
            }

            function selectMaskOption(option, buttonEl){
                if(!option) return;
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function(){
                    window.wordcloudMaskImage = img;
                    currentMaskSelection = option.file;
                    maskGallery?.querySelectorAll('.mask-option').forEach(btn => btn.classList.remove('selected'));
                    if(buttonEl) buttonEl.classList.add('selected');
                    updateMaskPreview(img);
                    checkImageTransparency(img)
                        .then(info => showMaskInfo({ hasTransparency: info.hasTransparency, width: info.width, height: info.height, note: option.label || option.file }))
                        .catch(() => showMaskInfo({ hasTransparency: false, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height, note: option.label || option.file }));
                    setupCanvas();
                    if(masterData.length) renderWordCloud();
                };
                img.onerror = function(){
                    if(maskListStatus) maskListStatus.textContent = 'è¼‰å…¥å‰ªå½±å¤±æ•—ï¼š' + (option.label || option.file);
                    buttonEl?.classList.remove('selected');
                };
                img.src = window.MASK_ASSET_BASE + option.file + '?v=' + Date.now();
            }

            if (reloadMaskBtn) reloadMaskBtn.addEventListener('click', loadMaskOptions);

            if (clearMaskBtn) clearMaskBtn.addEventListener('click', function(){
                window.wordcloudMaskImage=null;
                currentMaskSelection = null;
                maskGallery?.querySelectorAll('.mask-option').forEach(btn => btn.classList.remove('selected'));
                clearMaskPreview();
                setupCanvas();
                if(masterData.length) renderWordCloud();
            });
            loadMaskOptions();

            // Theme colors & translations
            const themeColorMap = new Map([['å·¥ä½œèˆ‡è·æ¥­','#2E8B57'],['æ™‚é–“èˆ‡æ•ˆç‡','#FF4500'],['å®¶åº­èˆ‡è¦ªå¯†é—œä¿‚','#8A2BE2'],['æ¶ˆè²»èˆ‡ç¿’æ…£','#F0E68C'],['é‡‘èèˆ‡æŠ•è³‡','#B22222'],['å¥åº·èˆ‡ç®¡ç†','#00FFFF'],['å­¸ç¿’èˆ‡çŸ¥è­˜','#5F9EA0'],['é€šå‹¤èˆ‡å‡ºè¡Œ','#DDA0DD'],['å—œå¥½èˆ‡ä¼‘é–’','#FFD700'],['ç§‘æŠ€èˆ‡é›»å­ç”¢å“','#4682B4'],['å…¶ä»–/èƒŒæ™¯ç‰¹å¾µ','#C0C0C0']]);
            const themeMap = new Map([['Learning & Knowledge','å­¸ç¿’èˆ‡çŸ¥è­˜'],['Consumption & Habits','æ¶ˆè²»èˆ‡ç¿’æ…£'],['Finance & Investment','é‡‘èèˆ‡æŠ•è³‡'],['Work & Career','å·¥ä½œèˆ‡è·æ¥­'],['Family & Intimacy','å®¶åº­èˆ‡è¦ªå¯†é—œä¿‚'],['Time & Efficiency','æ™‚é–“èˆ‡æ•ˆç‡'],['Technology & Gadgets','ç§‘æŠ€èˆ‡é›»å­ç”¢å“'],['Health & Management','å¥åº·èˆ‡ç®¡ç†'],['Hobbies & Leisure','å—œå¥½èˆ‡ä¼‘é–’'],['Other/Background Trait','å…¶ä»–/èƒŒæ™¯ç‰¹å¾µ'],['Commute & Mobility','é€šå‹¤èˆ‡å‡ºè¡Œ']]);
            const emotionMap = new Map([['Desire','æ¸´æœ›'],['Satisfaction','æ»¿è¶³'],['Habitual','ç¿’æ…£'],['Neutral','å¹³å¸¸'],['Tension/Stress','ç·Šå¼µ'],['Achievement','æˆå°±'],['Empathy','å…±æƒ…'],['Joy','å–œæ‚…'],['Forced/Obligated','è¢«è¿«'],['Disappointment','å¤±æœ›'],['Suppression','å£“æŠ‘'],['Helplessness','ç„¡å¥ˆ'],['Other','å…¶ä»–'],['Other/Undefined','å…¶ä»–/ç„¡æ³•å®šç¾©']]);

            function populateFilters(){
                if (!emotionDropdown || !themeDropdown) return;
                emotionDropdown.innerHTML = ''; themeDropdown.innerHTML = '';
                const allEmotionsOpt = document.createElement('div'); allEmotionsOpt.className = 'select-option'; allEmotionsOpt.innerHTML = '<input type="checkbox" id="emotion-all" value="all" checked> <label for="emotion-all">å…¨éƒ¨æƒ…ç·’</label>'; emotionDropdown.appendChild(allEmotionsOpt);
                Array.from(uniqueEmotions).sort().forEach(emotion=>{ const opt = document.createElement('div'); opt.className = 'select-option'; const id = 'emotion-' + emotion.replace(/\s+/g,'-').replace(/\//g,'-'); opt.innerHTML = '<input type="checkbox" id="' + id + '" value="' + emotion + '" checked> <label for="' + id + '">' + emotion + '</label>'; emotionDropdown.appendChild(opt); });
                const allThemesOpt = document.createElement('div'); allThemesOpt.className = 'select-option'; allThemesOpt.innerHTML = '<input type="checkbox" id="theme-all" value="all" checked> <label for="theme-all">å…¨éƒ¨ä¸»é¡Œ</label>'; themeDropdown.appendChild(allThemesOpt);
                Array.from(uniqueThemes).sort().forEach(theme=>{ const opt = document.createElement('div'); opt.className = 'select-option'; const id = 'theme-' + theme.replace(/\s+/g,'-').replace(/\//g,'-'); opt.innerHTML = '<input type="checkbox" id="' + id + '" value="' + theme + '" checked> <label for="' + id + '">' + theme + '</label>'; themeDropdown.appendChild(opt); });
                setupDropdownInteractions(); setupCheckboxEvents();
            }

            function setupDropdownInteractions(){
                if(emotionTrigger) emotionTrigger.addEventListener('click', function(e){ e.stopPropagation(); emotionDropdown.classList.toggle('show'); emotionTrigger.classList.toggle('open'); themeDropdown.classList.remove('show'); themeTrigger.classList.remove('open'); });
                if(themeTrigger) themeTrigger.addEventListener('click', function(e){ e.stopPropagation(); themeDropdown.classList.toggle('show'); themeTrigger.classList.toggle('open'); emotionDropdown.classList.remove('show'); emotionTrigger.classList.remove('open'); });
                document.addEventListener('click', function(){ emotionDropdown.classList.remove('show'); emotionTrigger.classList.remove('open'); themeDropdown.classList.remove('show'); themeTrigger.classList.remove('open'); });
                emotionDropdown.addEventListener('click', function(e){ e.stopPropagation(); }); themeDropdown.addEventListener('click', function(e){ e.stopPropagation(); });
            }

            function setupCheckboxEvents(){
                const emotionAll = document.getElementById('emotion-all');
                if(emotionAll) emotionAll.addEventListener('change', function(){ emotionDropdown.querySelectorAll('input[type="checkbox"]:not(#emotion-all)').forEach(cb=>cb.checked=this.checked); updateEmotionSelectedText(); renderWordCloud(); });
                emotionDropdown.querySelectorAll('input[type="checkbox"]:not(#emotion-all)').forEach(cb=>cb.addEventListener('change', function(){ updateEmotionSelectedText(); renderWordCloud(); }));
                const themeAll = document.getElementById('theme-all');
                if(themeAll) themeAll.addEventListener('change', function(){ themeDropdown.querySelectorAll('input[type="checkbox"]:not(#theme-all)').forEach(cb=>cb.checked=this.checked); updateThemeSelectedText(); renderWordCloud(); });
                themeDropdown.querySelectorAll('input[type="checkbox"]:not(#theme-all)').forEach(cb=>cb.addEventListener('change', function(){ updateThemeSelectedText(); renderWordCloud(); }));
            }

            function updateEmotionSelectedText(){
                const checked = Array.from(emotionDropdown.querySelectorAll('input[type="checkbox"]:checked'));
                const allCb = document.getElementById('emotion-all');
                if(allCb.checked || checked.length === uniqueEmotions.size + 1) emotionSelectedText.textContent = 'å·²é¸æ“‡: å…¨éƒ¨æƒ…ç·’';
                else if(checked.length === 0) emotionSelectedText.textContent = 'è«‹é¸æ“‡æƒ…ç·’';
                else { const names = checked.filter(cb=>cb.id!=='emotion-all').map(cb=>cb.nextElementSibling.textContent); emotionSelectedText.textContent = names.length <= 3 ? 'å·²é¸æ“‡: ' + names.join(', ') : 'å·²é¸æ“‡: ' + names.length + ' å€‹æƒ…ç·’'; }
            }

            function updateThemeSelectedText(){
                const checked = Array.from(themeDropdown.querySelectorAll('input[type="checkbox"]:checked'));
                const allCb = document.getElementById('theme-all');
                if(allCb.checked || checked.length === uniqueThemes.size + 1) themeSelectedText.textContent = 'å·²é¸æ“‡: å…¨éƒ¨ä¸»é¡Œ';
                else if(checked.length === 0) themeSelectedText.textContent = 'è«‹é¸æ“‡ä¸»é¡Œ';
                else { const names = checked.filter(cb=>cb.id!=='theme-all').map(cb=>cb.nextElementSibling.textContent); themeSelectedText.textContent = names.length <= 2 ? 'å·²é¸æ“‡: ' + names.join(', ') : 'å·²é¸æ“‡: ' + names.length + ' å€‹ä¸»é¡Œ'; }
            }

            function renderWordCloud(){
                if(!canvas) return;
                const selectedEmotions = Array.from(emotionDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
                const selectedThemes = Array.from(themeDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
                const filteredData = masterData.filter(item=>{ const themeMatch = selectedThemes.includes('all') || selectedThemes.includes(item.theme); const emotionMatch = selectedEmotions.includes('all') || item.emotions.some(e=>selectedEmotions.includes(e)); return themeMatch && emotionMatch; });
                const keywordDataMap = {}; filteredData.forEach(item=>{ keywordDataMap[item.keyword] = item; });
                const maxFontSize = BASE_FONT_SIZE * (fontSizePercentage / 100);
                const wordCloudList = filteredData.map(item=>{ const ratio = item.weight / globalMaxWeight; const adjustedWeight = Math.pow(ratio,2) * globalMaxWeight; return [item.keyword, adjustedWeight]; });
                const weightFactor = globalMaxWeight > 0 ? maxFontSize / globalMaxWeight : 1;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (wordCloudList.length === 0) { ctx.fillStyle='#9ca3af'; ctx.font='16px Inter, sans-serif'; ctx.textAlign='center'; ctx.fillText('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™',canvas.width/2,canvas.height/2); return; }
                
                let shape = window.selectedCloudShape || 'circle';
                let backgroundColor = '#ffffff';
                
                // å¦‚æœæœ‰é®ç½©åœ–ç‰‡ï¼Œä½¿ç”¨ CSS mask è€Œä¸æ˜¯ shape å‡½æ•¸
                if (window.wordcloudMaskImage) {
                    const maskUrl = window.wordcloudMaskImage.src;
                    canvas.style.webkitMaskImage = 'url(' + maskUrl + ')';
                    canvas.style.maskImage = 'url(' + maskUrl + ')';
                    canvas.classList.add('masked');
                    backgroundColor = '#ffffff';
                    shape = 'circle'; // ç”¨åœ“å½¢å¡«æ»¿æ•´å€‹ canvasï¼ŒCSS mask æœƒè£åˆ‡
                } else {
                    canvas.style.webkitMaskImage = '';
                    canvas.style.maskImage = '';
                    canvas.classList.remove('masked');
                }
                
                WordCloud(canvas, {
                    list: wordCloudList, 
                    weightFactor: weightFactor, 
                    fontFamily: 'Inter, Noto Sans TC, sans-serif',
                    color: function(word){ const data = keywordDataMap[word]; return data ? (themeColorMap.get(data.theme) || '#374151') : '#374151'; },
                    rotateRatio: 0, 
                    backgroundColor: backgroundColor, 
                    minSize: 10, 
                    gridSize: 8, 
                    drawOutOfBound: false, 
                    shrinkToFit: true,
                    origin: [canvas.width/(2*(canvas.width/(parseFloat(canvas.style.width)||canvas.width))), canvas.height/(2*(canvas.height/(parseFloat(canvas.style.height)||canvas.height)))],
                    shape: shape, 
                    ellipticity: 1, 
                    wait: 0,
                    click: function(item){ if(item&&item[0]){ const keyword=item[0]; const data=keywordDataMap[keyword]; if(data){ eventKeywordInput.value=keyword; eventKeyword.textContent=keyword; eventTheme.textContent=data.theme; eventEmotions.textContent=data.emotions.join(', '); eventText.textContent=data.event; eventResult.style.display='block'; eventNotFound.style.display='none'; eventDisplay.style.display='block'; } } },
                    hover: function(item){ canvas.title = item&&item[0] ? (keywordDataMap[item[0]]||{keyword:item[0]}).keyword : ''; }
                });
            }

            if (uploadButton && fileInput) uploadButton.addEventListener('click', ()=> fileInput.click());
            if (fileInput) fileInput.addEventListener('change', handleFileUpload);
            if (settingsButton && settingsModal) settingsButton.addEventListener('click', ()=> settingsModal.classList.remove('hidden'));
            if (helpButton && helpModal) helpButton.addEventListener('click', ()=> helpModal.classList.remove('hidden'));
            if (helpModalOverlay && helpModal) helpModalOverlay.addEventListener('click', ()=> helpModal.classList.add('hidden'));
            if (helpModalCloseBtn && helpModal) helpModalCloseBtn.addEventListener('click', ()=> helpModal.classList.add('hidden'));
            if (operationButton && operationModal) operationButton.addEventListener('click', ()=> operationModal.classList.remove('hidden'));
            if (operationModalOverlay && operationModal) operationModalOverlay.addEventListener('click', ()=> operationModal.classList.add('hidden'));
            if (operationModalCloseBtn && operationModal) operationModalCloseBtn.addEventListener('click', ()=> operationModal.classList.add('hidden'));

            document.querySelectorAll('.close-modal-button').forEach(btn=>btn.addEventListener('click', function(){ const mid=this.getAttribute('data-modal'); const m=document.getElementById(mid); if(m) m.classList.add('hidden'); }));
            document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click', function(){ const m=this.closest('.modal'); if(m) m.classList.add('hidden'); }));

            if (fontSizeSlider) fontSizeSlider.addEventListener('input', function(){ fontSizePercentage = parseInt(this.value,10); if (fontSizeValue) fontSizeValue.textContent = fontSizePercentage + '%'; if (masterData.length) renderWordCloud(); });
            
            function searchKeyword() {
                const kw = eventKeywordInput.value.trim();
                if (!kw) return;
                const data = masterData.find(d => d.keyword === kw);
                if (data) {
                    eventKeyword.textContent = data.keyword;
                    eventTheme.textContent = data.theme;
                    eventEmotions.textContent = data.emotions.join(', ');
                    eventText.textContent = data.event;
                    eventResult.style.display = 'block';
                    eventNotFound.style.display = 'none';
                    eventDisplay.style.display = 'block';
                } else {
                    eventResult.style.display = 'none';
                    eventNotFound.style.display = 'block';
                }
            }

            if (searchKeywordButton) searchKeywordButton.addEventListener('click', searchKeyword);
            if (eventKeywordInput) eventKeywordInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    searchKeyword();
                }
            });

            // CSV parsing & full data processing
            function handleFileUpload(e){ const file = e.target.files[0]; if(!file) return; hideError(); Papa.parse(file,{ header:true, skipEmptyLines:true, complete: function(results){ try{ if(!results.data || results.data.length===0){ showError('CSV æª”æ¡ˆç‚ºç©º'); return; } masterData = []; globalMaxWeight = 0; uniqueThemes.clear(); uniqueEmotions.clear();
                results.data.forEach(row=>{ if(!row['é—œéµå­—1'] && !row['é—œéµå­—2']) return;
                    const themeEn = row['ä¸»é¡Œ/æƒ…å¢ƒ']||''; const themeCn = themeMap.get(themeEn) || themeEn;
                    const emotionsEnRaw = row['æƒ…ç·’/æ…‹åº¦']||''; const emotionsEnList = emotionsEnRaw.split(',').map(e=>e.trim()); const emotionsCnList = emotionsEnList.map(e=>emotionMap.get(e)||e);
                    const event = row['äº‹ä»¶']||''; const weightStr = row['æ¬Šé‡']||'0%'; const weight = Math.max(0.01, parseFloat(weightStr.toString().replace('%',''))/100 || 0.01);
                    uniqueThemes.add(themeCn); emotionsCnList.forEach(e=>uniqueEmotions.add(e));
                    if(weight > globalMaxWeight) globalMaxWeight = weight;
                    if(row['é—œéµå­—1']) masterData.push({keyword: row['é—œéµå­—1'].trim(), weight: weight, theme: themeCn, emotions: emotionsCnList, event: event});
                    if(row['é—œéµå­—2']) masterData.push({keyword: row['é—œéµå­—2'].trim(), weight: weight, theme: themeCn, emotions: emotionsCnList, event: event});
                });
                if(masterData.length === 0){ showError('ç„¡æœ‰æ•ˆçš„é—œéµå­—è³‡æ–™'); return; }
                if(infoBox) infoBox.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.5rem;height:1.5rem;display:inline;margin-right:0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><p style="display:inline;">æˆåŠŸè¼‰å…¥ '+ masterData.length + ' å€‹é—œéµå­—ï¼</p>';
                if(filtersContainer) filtersContainer.classList.remove('hidden');
                if(wordcloudContainer) wordcloudContainer.classList.remove('hidden');
                if(eventDisplay) eventDisplay.style.display='block';
                populateFilters(); setupCanvas(); renderWordCloud();

                // New code to handle persona image as mask
                const personaImageFile = document.getElementById('persona-image-upload')?.files[0];
                if (personaImageFile) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            const generatedMask = generateMaskFromImage(img, 180);
                            generatedMask.onload = function() {
                                window.wordcloudMaskImage = generatedMask;
                                updateMaskPreview(generatedMask);
                                showMaskInfo({ hasTransparency: true, width: generatedMask.naturalWidth, height: generatedMask.naturalHeight, note: 'ä¾†è‡ªå®¢æˆ¶ç•«åƒ' });
                                renderWordCloud();
                            };
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(personaImageFile);
                }

            }catch(err){ console.error(err); showError('è™•ç†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message||err)); } }, error: function(err){ showError('CSV è§£æå¤±æ•—ï¼š'+(err.message||err)); } }); }

            window.addEventListener('resize', function(){ if (masterData.length) { setupCanvas(); renderWordCloud(); } });
        });
    </script>
    <!-- é®ç½© / å½¢ç‹€æ§åˆ¶é¢æ¿ï¼ˆå›ºå®šå³ä¸‹è§’ï¼Œä½æ–¼æ›¸æœ¬æŒ‰éˆ•ä¸Šæ–¹ï¼‰ -->
        <!-- é®ç½© / å½¢ç‹€æ§åˆ¶é¢æ¿ï¼ˆå›ºå®šå³ä¸‹è§’ï¼Œä½æ–¼æ›¸æœ¬æŒ‰éˆ•ä¸Šæ–¹ï¼‰ -->
    
    <!-- æ›¸æœ¬èªªæ˜æŒ‰éˆ•ï¼ˆå›ºå®šå³ä¸‹è§’ï¼‰ -->
    <button id="book-help-button" title="åŠŸèƒ½æ“ä½œæŒ‡å—" class="floating-action-button" aria-label="åŠŸèƒ½æ“ä½œæŒ‡å—">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 20h9" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h12a2 2 0 012 2v14a1 1 0 01-1 1H4a1 1 0 01-1-1V5z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h6" />
        </svg>
    </button>


    <script>
        // ç¯„ä¾‹ SVG ç”¢ç”Ÿèˆ‡é®ç½©è¼‰å…¥ï¼ˆç”·å¥³è€å°‘ï¼‰
        (function(){
            function svgToImage(svgStr, callback) {
                const svg64 = btoa(unescape(encodeURIComponent(svgStr)));
                const dataUrl = 'data:image/svg+xml;base64,' + svg64;
                const img = new Image();
                img.onload = function() { callback(null, img); };
                img.onerror = function(e) { callback(e); };
                img.crossOrigin = 'anonymous';
                img.src = dataUrl;
            }

            function makeSampleSVG(kind) {
                // All SVGs: transparent background, black filled silhouette
                if (kind === 'female') {
                    return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M600 140c80 0 150 60 150 140 0 40-20 76-40 112-14 26-28 50-34 72-6 24 8 60 24 88 16 28 36 52 64 68 44 26 96 40 96 92v60H240v-60c0-52 52-66 96-92 28-16 48-40 64-68 16-28 30-64 24-88-6-22-20-46-34-72-20-36-40-72-40-112 0-80 70-140 150-140z"/>
</svg>`;
                }
                if (kind === 'male') {
                    return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M580 160c90-20 240-20 320 40 70 50 70 150 10 230-36 50-72 80-88 148-14 58 12 120 36 168 24 48 56 90 100 118 60 40 132 58 132 142v64H120v-64c0-84 72-102 132-142 44-28 76-70 100-118 24-48 50-110 36-168-16-68-52-98-88-148-60-80-170-80-260-60z"/>
</svg>`;
                }
                if (kind === 'child') {
                    return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1400" viewBox="0 0 1000 1400">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M500 120c60 0 110 40 110 90 0 28-12 54-28 80-10 16-20 32-24 46-5 18 6 42 18 62 12 20 26 36 46 48 34 22 74 34 74 78v44H280v-44c0-44 40-56 74-78 20-12 34-28 46-48 12-20 23-44 18-62-4-14-14-30-24-46-16-26-28-52-28-80 0-50 50-90 110-90z"/>
</svg>`;
                }
                // elderly
                return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M520 140c100 0 180 80 180 180 0 60-30 110-60 160-22 36-44 70-52 100-10 42 6 96 30 140 24 44 56 82 96 110 68 50 150 72 150 166v72H160v-72c0-94 82-116 150-166 40-28 72-66 96-110 24-44 40-98 30-140-8-30-30-64-52-100-30-50-60-100-60-160 0-100 80-180 180-180z"/>
</svg>`;
            }

            document.addEventListener('DOMContentLoaded', function(){
                const sampleSelect = document.getElementById('sample-mask-select');
                const loadBtn = document.getElementById('load-sample-mask');
                const clearBtn = document.getElementById('clear-mask-btn');
                if (!sampleSelect || !loadBtn) return;

                loadBtn.addEventListener('click', function(){
                    const kind = sampleSelect.value;
                    if (!kind) { alert('è«‹é¸æ“‡ç¯„ä¾‹é®ç½©é¡å‹ (ç”·å¥³å…’é•·è€…)'); return; }
                    const svg = makeSampleSVG(kind);
                    svgToImage(svg, function(err, img){
                        if (err) { alert('å»ºç«‹ç¯„ä¾‹é®ç½©å¤±æ•—'); return; }
                        window.wordcloudMaskImage = img;
                        updateMaskPreview(img);
                        showMaskInfo({ hasTransparency: true, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height, note: 'ç¯„ä¾‹é®ç½©' });
                        try { setupCanvas(); } catch(e) {}
                        if (typeof renderWordCloud === 'function') renderWordCloud();
                    });
                });

                if (clearBtn) {
                    clearBtn.addEventListener('click', function(){
                        window.wordcloudMaskImage = null;
                        clearMaskPreview();
                        try { setupCanvas(); } catch(e) {}
                        if (typeof renderWordCloud === 'function') renderWordCloud();
                    });
                }

                // è‡ªå‹•ç”¢ç”Ÿé®ç½©æŒ‰éˆ•ç¶å®š
                const autoBtn = document.getElementById('auto-mask-btn');
                const thresh = document.getElementById('auto-threshold');
                if (autoBtn && thresh) {
                    autoBtn.addEventListener('click', function(){
                        if (!window.wordcloudMaskImage) { alert('è«‹å…ˆä¸Šå‚³æˆ–è¼‰å…¥ç¯„ä¾‹å½±åƒä½œç‚ºä¾†æºå½±åƒ'); return; }
                        const t = parseInt(thresh.value, 10) || 180;
                        const src = window.wordcloudMaskImage;
                        const generated = generateMaskFromImage(src, t);
                        generated.onload = function() {
                            window.wordcloudMaskImage = generated;
                            updateMaskPreview(generated);
                            showMaskInfo({ hasTransparency: true, width: generated.naturalWidth || generated.width, height: generated.naturalHeight || generated.height, note: 'è‡ªå‹•ç”¢ç”Ÿ' });
                            try { setupCanvas(); } catch(e) {}
                            if (typeof renderWordCloud === 'function') renderWordCloud();
                        };
                    });
                }
            });
        })();
    </script>

</body>
</html>