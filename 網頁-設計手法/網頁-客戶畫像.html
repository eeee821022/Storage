<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona æ¬Šé‡è©é›²åˆ†æå·¥å…·</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <!-- æ–°å¢ï¼šMarked.js ç”¨æ–¼è§£æ AI ç”Ÿæˆçš„ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* ==================== åŸºç¤è¨­å®š ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-800 */
            line-height: 1.6;
        }
        
        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            padding-top: 5rem;
        }
        
        /* ==================== å…§å®¹å€ä½ˆå±€ ==================== */
        .content-wrapper {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .left-content {
            flex: 1;
            min-width: 0;
        }
        
        .right-sidebar {
            width: 360px;
            flex-shrink: 0;
        }
        
        /* ==================== æ¨™é¡Œå€ ==================== */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
            color: #111827; /* gray-900 */
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            font-size: 1rem; /* 16px */
            font-weight: 400;
            color: #4b5563; /* gray-600 */
        }
        
        /* ==================== å³ä¸Šè§’æŒ‰éˆ•çµ„ (ä¿®æ­£ç‰ˆ) ==================== */
        .top-right-buttons {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            display: flex;
            flex-direction: row; /* é è¨­æ©«å‘æ’åˆ— */
            gap: 0.75rem;
            align-items: center;
        }

        /* çµ±ä¸€æ¨£å¼ï¼Œç§»é™¤å€‹åˆ¥å®šä½ */
        .icon-button {
            position: relative; /* è®“çˆ¶å±¤ flex æ§åˆ¶ä½ç½® */
            background-color: #ffffff;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #2563eb;
            transition: all 0.15s ease-in-out;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0; /* æ¸…é™¤é è¨­é‚Šè· */
        }
        
        .icon-button:hover {
            background-color: #eff6ff;
            transform: translateY(-1px);
        }
        
        .icon-button svg {
            width: 1.5rem;
            height: 1.5rem;
            display: block;
        }

        /* AI æŒ‰éˆ•ç‰¹åˆ¥æ¨£å¼ */
        #ai-insight-button {
            background: linear-gradient(135deg, #fff 0%, #f0f9ff 100%);
            border: 1px solid #bfdbfe;
            color: #2563eb;
        }
        #ai-insight-button:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px) scale(1.05);
        }
        
        /* éš±è—çš„æª”æ¡ˆè¼¸å…¥ */
        #file-input {
            display: none;
        }
        
        /* ==================== ç¯©é¸å™¨å€åŸŸ ==================== */
        .filters {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 5rem;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-section h3 {
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            margin-bottom: 0.75rem;
        }
        
        /* æƒ…ç·’å’Œä¸»é¡Œç¯©é¸è¤‡é¸æ¡† */
        .checkboxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        /* è‡ªå®šç¾©ä¸‹æ‹‰é¸å–® */
        .custom-select {
            position: relative;
            width: 100%;
        }
        
        .select-trigger {
            width: 100%;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            color: #1f2937;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease-in-out;
        }
        
        .select-trigger:hover {
            border-color: #9ca3af;
            background-color: #ffffff;
        }
        
        .select-trigger svg {
            width: 1rem;
            height: 1rem;
            transition: transform 0.2s ease-in-out;
        }
        
        .select-trigger.open svg {
            transform: rotate(180deg);
        }
        
        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-height: 300px;
            overflow-y: auto;
            z-index: 30;
            display: none;
        }
        
        .select-dropdown.show {
            display: block;
        }
        
        .select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.15s ease-in-out;
        }
        
        .select-option:hover {
            background-color: #f3f4f6;
        }
        
        .select-option input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }
        
        .select-option label {
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            flex: 1;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 0.875rem;
            color: #374151; /* gray-700 */
            cursor: pointer;
        }
        
        /* ==================== è©é›²åœ–å€åŸŸ ==================== */
        .wordcloud-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }
        
        #wordcloud-canvas {
            width: 100%;
            max-width: 756px;
            height: 756px;
            margin: 0 auto;
            display: block;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        #wordcloud-canvas.masked {
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }
        
        /* ==================== äº‹ä»¶é¡¯ç¤ºå€ ==================== */
        #event-display {
            background-color: #eff6ff; /* bg-blue-50 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe; /* border-blue-200 */
            margin-bottom: 1.5rem;
            display: none;
        }
        
        #event-display h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .event-keyword {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.375rem;
            text-align: center;
        }
        
        .event-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .event-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .event-meta-label {
            font-weight: 600;
            color: #4b5563;
            font-size: 0.875rem;
        }
        
        .event-meta-value {
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        #event-text {
            font-size: 0.875rem;
            color: #1f2937;
            line-height: 1.5;
            background-color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        
        /* ==================== æç¤ºè¨Šæ¯ ==================== */
        .info-message {
            background-color: #eff6ff; /* bg-blue-50 */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #bfdbfe;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }
        
        .info-message svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #2563eb; /* text-blue-600 */
            flex-shrink: 0;
            margin-top: 0.125rem;
        }
        
        .info-message p {
            font-size: 0.875rem;
            color: #1f2937;
        }
        
        /* ==================== å½ˆçª—æ¨£å¼ ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            backdrop-filter: blur(2px);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            z-index: 41;
            overflow-y: auto;
        }
        
        .modal-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            pointer-events: none;
        }

        .modal > div:not(.modal-overlay) {
            position: relative;
            z-index: 42;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            position: relative;
            width: 100%;
            max-width: 42rem; /* 672px */
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 85vh;
            overflow-y: auto;
            margin: 2rem auto;
            z-index: 50;
            pointer-events: auto;
        }

        /* AI Modal å¯¬åº¦èª¿æ•´ */
        #ai-modal-content {
            max-width: 56rem; /* æ›´å¯¬ä¸€é»ä»¥é¡¯ç¤ºå ±å‘Š */
        }

        .side-modal .modal-container {
            display: contents;
        }

        .side-modal .modal-overlay {
            background-color: transparent;
        }

        .side-modal .modal-content {
            position: fixed;
            top: 5rem;
            right: 1.5rem;
            width: 22rem;
            max-width: 22rem;
            height: auto;
            max-height: calc(100vh - 6rem);
            border-radius: 0.75rem;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .side-modal .modal-content {
                position: fixed;
                top: 4rem;
                right: 0;
                left: 0;
                margin: 0 auto;
                width: calc(100% - 2rem);
                max-width: none;
            }
        }
        
        .close-modal-button {
            position: sticky;
            top: -1rem;
            right: -1rem;
            float: right;
            color: #9ca3af; /* text-gray-400 */
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.15s ease-in-out;
            z-index: 51;
        }
        
        .close-modal-button:hover {
            color: #4b5563; /* hover:text-gray-600 */
        }
        
        .close-modal-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        
        .modal-content table td {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .modal-content table td:first-child {
            background-color: #f9fafb;
            font-weight: 600;
            width: 25%;
        }
        
        .modal-content ol {
            padding-left: 1.5rem;
        }
        
        .modal-content ol li {
            margin-bottom: 0.5rem;
        }

        /* AI Content Markdown Styles */
        .markdown-content {
            font-size: 1rem;
            line-height: 1.7;
            color: #374151;
        }
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .markdown-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content p {
            margin-bottom: 1rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        .markdown-content li {
            margin-bottom: 0.25rem;
        }
        .markdown-content strong {
            color: #2563eb; /* Highlight key terms */
            font-weight: 600;
        }
        .markdown-content blockquote {
            border-left: 4px solid #bfdbfe;
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 1rem;
            color: #4b5563;
            font-style: italic;
            background-color: #f9fafb;
            padding: 0.5rem 1rem;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        
        /* ==================== è¨­å®šé¢æ¿æ¨£å¼ ==================== */
        .settings-group {
            margin-bottom: 1.5rem;
        }
        
        .settings-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider {
            flex: 1;
            height: 0.5rem;
            border-radius: 0.25rem;
            background: #e5e7eb;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            min-width: 3rem;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }

        .mask-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .mask-option {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #fff;
            padding: 0.35rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .mask-option.selected {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .mask-option img {
            width: 56px;
            height: 56px;
            object-fit: contain;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }

        .mask-option span {
            font-size: 0.75rem;
            color: #374151;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .mask-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .mask-actions button {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            color: #374151;
        }

        #reload-mask-btn {
            border-color: #2563eb;
            background-color: #2563eb;
            color: #fff;
        }

        .mask-list-status {
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .mask-loading,
        .mask-error {
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            text-align: center;
        }

        .mask-loading {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .mask-error {
            background-color: #fef2f2;
            color: #b91c1c;
        }
        
        /* ==================== éŒ¯èª¤è¨Šæ¯ ==================== */
        .error-message {
            background-color: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            margin-bottom: 1.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .right-sidebar {
                width: 100%;
            }
            
            .filters {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                padding-top: 5rem;
            }
            
            #wordcloud-canvas {
                max-width: 100%;
                height: auto;
                aspect-ratio: 1 / 1;
            }
            
            .top-right-buttons {
                top: 1rem;
                right: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-section h3 {
                font-size: 1rem;
            }
        }
        
        /* AI Context Input Style (Updated for List) */
        .context-input-section {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .context-header label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        #ai-generate-btn {
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #ai-generate-btn:hover {
            background-color: #1d4ed8;
        }

        .context-list-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .context-list-item input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            background-color: #ffffff;
            color: #1f2937;
        }
        
        .context-list-item input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .remove-row-btn {
            padding: 0.5rem;
            background-color: transparent;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.15s;
        }

        .remove-row-btn:hover {
            color: #ef4444;
            border-color: #fca5a5;
            background-color: #fef2f2;
        }
        
        #add-context-btn {
            width: 100%;
            padding: 0.5rem;
            background-color: #ffffff;
            border: 1px dashed #cbd5e1;
            border-radius: 0.375rem;
            color: #64748b;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.25rem;
        }

        #add-context-btn:hover {
            border-color: #94a3b8;
            color: #475569;
            background-color: #f1f5f9;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’æŒ‰éˆ•çµ„ -->
    <!-- ä¿®æ­£ï¼šå°‡æ‰€æœ‰æ“ä½œæŒ‰éˆ•æ”¾å…¥åŒä¸€å€‹å®¹å™¨ï¼Œä»¥ä¾¿çµ±ä¸€ç®¡ç†æ’ç‰ˆ -->
    <div class="top-right-buttons">
        <!-- AI åŠŸèƒ½æŒ‰éˆ• -->
        <button id="screenshot-button" class="icon-button" title="ğŸ“¸ æˆªåœ–è©é›²">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
            </svg>
        </button>

        <button id="ai-insight-button" class="icon-button" title="âœ¨ AI æ´å¯Ÿå ±å‘Š">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
            </svg>
        </button>

        <button id="upload-button" class="icon-button" title="ä¸Šå‚³ CSV æª”æ¡ˆ">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
            </svg>
        </button>
        
        <button id="settings-button" class="icon-button" title="è¨­å®š">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
        </button>

        <button id="help-button" class="icon-button" title="æŸ¥çœ‹ä½¿ç”¨èªªæ˜" aria-label="æŸ¥çœ‹ä½¿ç”¨èªªæ˜">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
            </svg>
        </button>
    </div>

    <input type="file" id="file-input" accept=".csv" />

    <!-- èªªæ˜å½ˆçª— -->
    <div id="help-modal" class="modal hidden">
        <div id="help-modal-overlay" class="modal-overlay"></div>
        <div class="modal-container">
            <div id="help-modal-content" class="modal-content">
                <button id="help-modal-close-btn" class="close-modal-button" data-modal="help-modal" aria-label="é—œé–‰èªªæ˜è¦–çª—">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2>æ–¹æ³•ä»‹ç´¹ï¼šé¡§å®¢ç•«åƒ (Persona)</h2>
                
                <table>
                    <tbody>
                        <tr>
                            <td>æ–¹æ³•åç¨±</td>
                            <td>é¡§å®¢ç•«åƒ (Persona)</td>
                        </tr>
                        <tr>
                            <td>ä¸€å¥è©±ç¸½çµ</td>
                            <td>ğŸ¯ è·¨è¶Šç”¢å“è¦–è§’ï¼Œç”¨çœŸå¯¦ç”¨æˆ¶çš„çœ¼ç›å’Œæƒ…ç·’ä¾†è¨­è¨ˆã€‚</td>
                        </tr>
                        <tr>
                            <td>æ ¸å¿ƒæ¦‚å¿µ</td>
                            <td>é¡§å®¢ç•«åƒæ˜¯ä¸€ç¨®ç ”ç©¶å‹çš„è™›æ“¬äººç‰©æ¨¡å‹ï¼Œé€éå½™æ•´çœŸå¯¦ç”¨æˆ¶çš„è¡Œç‚ºã€ç—›é»ã€å‹•æ©Ÿã€ç›®æ¨™å’Œäººå£çµ±è¨ˆè³‡æ–™ç­‰æ·±åº¦è³‡è¨Šï¼Œå‰µé€ å‡ºä¸€å€‹å…·é«”ä¸”å…·ä»£è¡¨æ€§çš„ã€Œç†æƒ³ç”¨æˆ¶ã€ã€‚å®ƒè®“è¨­è¨ˆåœ˜éšŠèƒ½å¤ è„«é›¢å€‹äººåè¦‹ï¼Œå°‡è¨­è¨ˆæ±ºç­–èšç„¦æ–¼æ»¿è¶³ç›®æ¨™ç”¨æˆ¶çš„ç‰¹å®šéœ€æ±‚ã€‚</td>
                        </tr>
                        <tr>
                            <td>è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ</td>
                            <td>
                                <ul style="padding-left: 1.5rem; margin: 0;">
                                    <li>æ¨¡ç³Šçš„ç”¨æˆ¶ç›®æ¨™ï¼šå°‡æŠ½è±¡çš„ã€Œç”¨æˆ¶ã€å…·é«”åŒ–ï¼Œå¹«åŠ©åœ˜éšŠæ˜ç¢ºã€Œæˆ‘å€‘åœ¨ç‚ºèª°è¨­è¨ˆï¼Ÿã€</li>
                                    <li>è¨­è¨ˆæ±ºç­–çš„è¡çªï¼šæä¾›ä¸€å€‹å…±åŒçš„åƒè€ƒé»ï¼Œæ¸›å°‘åœ˜éšŠæˆå“¡é–“å› ç”¨æˆ¶èªçŸ¥å·®ç•°è€Œç”¢ç”Ÿçš„çˆ­è­°ã€‚</li>
                                    <li>åŠŸèƒ½è”“å»¶ (Feature Creep)ï¼šå¹«åŠ©åœ˜éšŠèšç„¦ï¼Œç¢ºä¿é–‹ç™¼çš„åŠŸèƒ½èˆ‡ç›®æ¨™ç”¨æˆ¶çš„æ ¸å¿ƒéœ€æ±‚ä¿æŒä¸€è‡´ã€‚</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>æœ€ä½³ä½¿ç”¨æ™‚æ©Ÿ</td>
                            <td>å°ˆæ¡ˆçš„å•é¡Œæ¢ç´¢æœŸã€æ¦‚å¿µç™¼æƒ³æœŸåŠéœ€æ±‚å®šç¾©æœŸã€‚åœ¨é€²è¡Œç”¨æˆ¶ç ”ç©¶ï¼ˆè¨ªè«‡ã€å•å·ã€æ•¸æ“šåˆ†æï¼‰ä¹‹å¾Œï¼Œæ­£å¼é–‹å§‹è¨­è¨ˆæˆ–é–‹ç™¼ä¹‹å‰ã€‚</td>
                        </tr>
                        <tr>
                            <td>ä½¿ç”¨æµç¨‹èªªæ˜</td>
                            <td>
                                <ol style="margin: 0;">
                                    <li><strong>æ•¸æ“šæ”¶é›†èˆ‡åˆ†æï¼š</strong>åŸ·è¡Œç”¨æˆ¶è¨ªè«‡ã€å•å·èª¿æŸ¥ã€ç¶²ç«™æ•¸æ“šåˆ†æç­‰ï¼Œæ”¶é›†çœŸå¯¦ç”¨æˆ¶çš„è¡Œç‚ºæ¨¡å¼å’Œå‹•æ©Ÿã€‚</li>
                                    <li><strong>æ‰¾å‡ºå…±åŒæ¨¡å¼ (Clustering)ï¼š</strong>å°‡æ”¶é›†åˆ°çš„æ•¸æ“šé€²è¡Œåˆ†çµ„ï¼Œè­˜åˆ¥å‡ºå¹¾ç¨®ä¸»è¦çš„ã€å…·æœ‰ä»£è¡¨æ€§çš„ç”¨æˆ¶è¡Œç‚ºã€ç›®æ¨™å’Œç—›é»çš„é›†ç¾¤ã€‚</li>
                                    <li><strong>å»ºç«‹è™›æ“¬äººç‰©ï¼š</strong>ç‚ºæ¯å€‹é—œéµé›†ç¾¤å‰µé€ ä¸€å€‹è™›æ“¬äººç‰©ã€‚ç‚ºå…¶å‘½åã€è¨­å®šèƒŒæ™¯æ•…äº‹ã€å¹´é½¡è·æ¥­ã€æŠ€èƒ½æ°´å¹³ï¼Œä»¥åŠæœ€é‡è¦çš„â€”â€”ç›®æ¨™ (Goals) èˆ‡ç—›é» (Frustrations)ã€‚</li>
                                    <li><strong>æƒ…å¢ƒåŒ– (Scenario Mapping)ï¼š</strong>ç‚º Persona æ’°å¯«ä¸€å€‹æˆ–å¤šå€‹ä½¿ç”¨æƒ…å¢ƒï¼Œæè¿°ä»–/å¥¹åœ¨ç‰¹å®šä»»å‹™ä¸­ï¼Œå¦‚ä½•èˆ‡ç”¢å“æˆ–æœå‹™äº’å‹•ï¼Œä»¥åŠåœ¨æ­¤éç¨‹ä¸­çš„æ„Ÿå—ã€‚</li>
                                    <li><strong>åœ˜éšŠæºé€šèˆ‡é‹ç”¨ï¼š</strong>å°‡ Persona æ–‡ä»¶åŒ–ä¸¦è¦–è¦ºåŒ–ï¼ˆé€šå¸¸æ˜¯æµ·å ±æˆ–å¡ç‰‡ï¼‰ï¼Œåœ¨åœ˜éšŠå…§éƒ¨åˆ†äº«ï¼Œä¸¦åœ¨å¾€å¾Œçš„è¨­è¨ˆå¯©æŸ¥å’ŒåŠŸèƒ½æ’åºæœƒè­°ä¸­ï¼Œå°‡ Persona ä½œç‚ºæ±ºç­–çš„ä¾æ“šã€‚</li>
                                </ol>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">åŠŸèƒ½æ“ä½œæŒ‡å—</h3>
                <table>
                    <tbody>
                        <tr>
                            <td style="width:34%;">æ“ä½œ</td>
                            <td>æ“ä½œèªªæ˜</td>
                        </tr>
                        <tr>
                            <td>âœ¨ AI æ´å¯Ÿ</td>
                            <td>é»æ“Šé–ƒçˆæŒ‰éˆ•ï¼ŒAI å°‡æ ¹æ“šç›®å‰çš„é—œéµå­—è‡ªå‹•ç”Ÿæˆä½¿ç”¨è€…ç ”ç©¶å ±å‘Šã€‚</td>
                        </tr>
                        <tr>
                            <td>ä¸Šå‚³ CSV</td>
                            <td>æŒ‰ <code>#upload-button</code> é¸æ“‡ CSV æª”ï¼ˆä¾‹å¦‚ Result1.csvï¼‰ï¼Œç³»çµ±æœƒç”¨ PapaParse è§£æä¸¦ç”¢ç”Ÿè©é›²ã€‚</td>
                        </tr>
                        <tr>
                            <td>ç¯©é¸ä¸»é¡Œ / æƒ…ç·’</td>
                            <td>ä½¿ç”¨å³å´ <code>#theme-trigger</code> æˆ– <code>#emotion-trigger</code> é¸å–è¦åŒ…å«çš„é …ç›®ã€‚</td>
                        </tr>
                        <tr>
                            <td>æŸ¥çœ‹æ˜ç´°</td>
                            <td>é»æ“Šè©é›²é—œéµå­—æœƒåœ¨ <code>#event-display</code> é¡¯ç¤ºè©²è©çš„åŸå§‹äº‹ä»¶èˆ‡å±¬æ€§ã€‚</td>
                        </tr>
                        <tr>
                            <td>å­—é«”å¤§å°</td>
                            <td>åœ¨ <code>#settings-button</code> çš„è¨­å®šä¸­èª¿æ•´ <code>#font-size-slider</code> ä¾†æ”¹è®Šæœ€å¤§å­—é«”å°ºå¯¸ã€‚</td>
                        </tr>
                        <tr>
                            <td>æœå°‹</td>
                            <td>åœ¨å³å´è¼¸å…¥é—œéµå­—ï¼ŒæŒ‰ <code>#search-keyword-button</code> æˆ– Enter å¯å®šä½ä¸¦é¡¯ç¤ºè©²è©ã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI æ´å¯Ÿå ±å‘Šå½ˆçª— -->
    <div id="ai-modal" class="modal hidden">
        <div id="ai-modal-overlay" class="modal-overlay"></div>
        <div class="modal-container">
            <div id="ai-modal-content" class="modal-content">
                <button id="ai-modal-close-btn" class="close-modal-button" data-modal="ai-modal" aria-label="é—œé–‰ AI è¦–çª—">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2>âœ¨ AI æ´å¯Ÿå ±å‘Š</h2>
                <div style="margin-bottom: 1.5rem; font-size: 0.9rem; color: #6b7280;">
                    ä»¥ä¸‹å ±å‘Šç”± Gemini æ¨¡å‹æ ¹æ“šç•¶å‰è©é›²æ•¸æ“šï¼ˆæ¬Šé‡å‰ 50 åé—œéµå­—ï¼‰è‡ªå‹•ç”Ÿæˆã€‚
                </div>
                
                <!-- æ–°å¢ï¼šæ¢åˆ—å¼èƒŒæ™¯è³‡æ–™è¼¸å…¥å€å¡Š -->
                <div class="context-input-section">
                    <div class="context-header">
                        <label>è¨­å®šèƒŒæ™¯æ¢ä»¶ (æ¢åˆ—å¼)ï¼š</label>
                        <button id="ai-generate-btn">é–‹å§‹åˆ†æ</button>
                    </div>
                    
                    <!-- å‹•æ…‹æ¸…å–®å®¹å™¨ -->
                    <div id="ai-context-list">
                        <!-- é è¨­æœƒç”± JS æ’å…¥ä¸€å€‹ç©ºè¡Œ -->
                    </div>
                    <button id="add-context-btn" type="button">+ æ–°å¢æ¢ä»¶</button>
                </div>

                <div id="ai-loading" class="hidden" style="text-align: center; padding: 3rem;">
                    <svg class="animate-spin" style="width: 2.5rem; height: 2.5rem; color: #2563eb; margin: 0 auto 1rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p style="color: #4b5563;">æ­£åœ¨æ·±å…¥åˆ†æä½¿ç”¨è€…è³‡æ–™...</p>
                </div>

                <div id="ai-result" class="markdown-content hidden">
                    <!-- AI å…§å®¹å°‡å¡«å…¥æ­¤è™• -->
                </div>

                <div id="ai-error" class="hidden" style="padding: 1rem; background-color: #fef2f2; border-radius: 0.5rem; color: #b91c1c; border: 1px solid #fecaca; text-align: center;">
                    ç”Ÿæˆå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šå½ˆçª— -->
    <div id="settings-modal" class="modal hidden side-modal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-content">
                <button class="close-modal-button" data-modal="settings-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2>è©é›²é¡¯ç¤ºè¨­å®š</h2>
                
                <div class="settings-group">
                    <label for="api-key-input">Gemini API Key</label>
                    <input type="password" id="api-key-input" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google Gemini API Key" style="width: 100%; padding: 0.5rem; font-size: 0.875rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb;">
                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                        æ‚¨çš„ Key åƒ…å„²å­˜æ–¼ç€è¦½å™¨æœ¬åœ° (localStorage)ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚
                    </p>
                </div>

                <div class="settings-group">
                    <label for="font-size-slider">å­—é«”å¤§å°</label>
                    <div class="slider-container">
                        <input type="range" id="font-size-slider" class="slider" min="50" max="150" value="100" step="5">
                        <span class="slider-value" id="font-size-value">100%</span>
                    </div>
                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                        èª¿æ•´è©é›²ä¸­é—œéµå­—çš„ç›¸å°å¤§å°ã€‚
                    </p>
                </div>

                <!-- æ–°å¢æ¬Šé‡å·®ç•°æ»‘æ¡¿ -->
                <div class="settings-group">
                    <label for="weight-contrast-slider">æ¬Šé‡å·®ç•° (å°æ¯”åº¦)</label>
                    <div class="slider-container">
                        <input type="range" id="weight-contrast-slider" class="slider" min="0.5" max="5.0" value="2.0" step="0.1">
                        <span class="slider-value" id="weight-contrast-value">2.0</span>
                    </div>
                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                        èª¿æ•´é—œéµå­—å¤§å°çš„å·®ç•°ç¨‹åº¦ã€‚æ•¸å€¼è¶Šå¤§ï¼Œæ¬Šé‡é«˜çš„è©è¶Šå¤§ï¼Œæ¬Šé‡ä½çš„è©è¶Šå°ã€‚
                    </p>
                </div>

                <!-- Shape Selection -->
                <div class="settings-group">
                    <label for="shape-select">å½¢ç‹€</label>
                    <select id="shape-select" style="width:100%;padding:0.5rem;border-radius:0.375rem;border:1px solid #d1d5db;background-color: #f9fafb;font-size:0.9rem;">
                        <option value="circle">Circle (åœ“å½¢)</option>
                        <option value="cardioid">Cardioid (å¿ƒå½¢)</option>
                        <option value="diamond">Diamond (è±å½¢)</option>
                        <option value="square">Square (æ–¹å½¢)</option>
                        <option value="triangle">Triangle (ä¸‰è§’å½¢)</option>
                        <option value="star">Star (æ˜Ÿå½¢)</option>
                    </select>
                </div>

                <!-- Mask Upload -->
                <div class="settings-group">
                    <label>é®ç½©å‰ªå½±</label>
                    <p style="font-size:0.75rem;color:#6b7280;margin-bottom:0.5rem;">
                        å¾ã€Œå‰ªå½±ã€è³‡æ–™å¤¾çš„ PNG åœ–ç‰‡ä¸­æŒ‘é¸é®ç½©ã€‚æ–°å¢æª”æ¡ˆå¾Œå¯æŒ‰ã€Œé‡æ–°è¼‰å…¥ã€æ›´æ–°æ¸…å–®ã€‚
                    </p>
                    
                    <!-- Buttons moved above the gallery -->
                    <div class="mask-actions">
                        <button id="open-silhouette-btn">å‰ªå½±é¸å–®</button>
                        <button id="reload-mask-btn">é‡æ–°è¼‰å…¥</button>
                        <button id="clear-mask-btn">æ¸…é™¤</button>
                    </div>
                    <div id="mask-list-status" class="mask-list-status"></div>
                    
                    <div id="mask-gallery" class="mask-gallery"></div>
                    
                    <!-- Preview and Info -->
                    <div id="mask-preview-container" style="display:none;margin-top:0.5rem;padding:0.5rem;background:#f9fafb;border-radius:0.375rem;border:1px solid #e5e7eb;">
                        <div style="display:flex;gap:0.75rem;align-items:center;">
                            <img id="mask-preview" alt="é è¦½" style="width:56px;height:56px;object-fit:contain;border-radius:0.25rem;background:#fff;padding:4px;" />
                            <div id="mask-info" style="font-size:0.75rem;color:#6b7280;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <h1>Persona æ¬Šé‡è©é›²åˆ†æå·¥å…·</h1>
            <p class="subtitle">è¦–è¦ºåŒ–é¡§å®¢ç•«åƒé—œéµç‰¹å¾µèˆ‡æ¬Šé‡åˆ†å¸ƒ</p>
        </div>

        <!-- æç¤ºè¨Šæ¯ -->
        <div id="info-box" class="info-message">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
            </svg>
            <p>è«‹é»æ“Šå³ä¸Šè§’çš„ã€Œä¸Šå‚³ã€æŒ‰éˆ•ä¾†ä¸Šå‚³æ‚¨çš„ Result1.csv æª”æ¡ˆï¼Œé–‹å§‹åˆ†æã€‚</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error-box" class="error-message hidden"></div>

        <!-- å…§å®¹å€ -->
        <div class="content-wrapper">
            <!-- å·¦å´ï¼šè©é›²åœ– -->
            <div class="left-content">
                <!-- è©é›²åœ– -->
                <div id="wordcloud-container" class="wordcloud-container hidden">
                    <canvas id="wordcloud-canvas"></canvas>
                </div>
            </div>

            <!-- å³å´ï¼šé—œéµå­—è³‡è¨Š + ç¯©é¸å™¨ -->
            <div class="right-sidebar">
                <!-- äº‹ä»¶é¡¯ç¤º -->
                <div id="event-display">
                    <h3>ğŸ“Œ é—œéµå­—è©³ç´°è³‡è¨Š</h3>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <input 
                            type="text" 
                            id="event-keyword-input" 
                            placeholder="è¼¸å…¥é—œéµå­—æœå°‹..."
                            style="flex: 1; padding: 0.5rem; font-size: 0.875rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                        />
                        <button 
                            id="search-keyword-button"
                            style="padding: 0.5rem 1rem; background-color: #2563eb; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;"
                        >
                            æœå°‹
                        </button>
                    </div>
                    <div id="event-result" style="display: none;">
                        <div class="event-keyword" id="event-keyword"></div>
                        <div class="event-meta">
                            <div class="event-meta-item">
                                <span class="event-meta-label">ä¸»é¡Œï¼š</span>
                                <span class="event-meta-value" id="event-theme"></span>
                            </div>
                            <div class="event-meta-item">
                                <span class="event-meta-label">æƒ…ç·’ï¼š</span>
                                <span class="event-meta-value" id="event-emotions"></span>
                            </div>
                        </div>
                        <div class="event-meta-item" style="margin-bottom: 0.5rem;">
                            <span class="event-meta-label">åŸå§‹äº‹ä»¶ï¼š</span>
                        </div>
                        <div id="event-text"></div>
                    </div>
                    <div id="event-not-found" style="display: none; padding: 1rem; background-color: #fef2f2; border-radius: 0.375rem; color: #991b1b; font-size: 0.875rem; text-align: center;">
                        æ‰¾ä¸åˆ°è©²é—œéµå­—ï¼Œè«‹ç¢ºèªè¼¸å…¥æ­£ç¢º
                    </div>
                </div>
                
                <div id="filters-container" class="filters hidden">
                    <div class="filter-section">
                        <h3>ä¸»é¡Œç¯©é¸</h3>
                        <div class="custom-select">
                            <div class="select-trigger" id="theme-trigger">
                                <span id="theme-selected-text">å·²é¸æ“‡: å…¨éƒ¨ä¸»é¡Œ</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                            <div class="select-dropdown" id="theme-dropdown">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h3>æƒ…ç·’ç¯©é¸</h3>
                        <div class="custom-select">
                            <div class="select-trigger" id="emotion-trigger">
                                <span id="emotion-selected-text">å·²é¸æ“‡: å…¨éƒ¨æƒ…ç·’</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                            <div class="select-dropdown" id="emotion-dropdown">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‰ªå½±é ç«¯é¸å–®å½ˆçª— -->
    <div id="silhouette-modal" class="modal hidden">
        <div id="silhouette-modal-overlay" class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-content" style="max-width: 42rem;">
                <button class="close-modal-button" data-modal="silhouette-modal" aria-label="é—œé–‰å‰ªå½±é¸å–®">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                <h2 style="margin-bottom: 0.5rem;">GitHub å‰ªå½±é¸å–®</h2>
                <p style="font-size:0.85rem;color:#4b5563;margin-bottom:0.75rem;">
                    å¾ GitHub è³‡æ–™å¤¾ <code>ç¶²é -è¨­è¨ˆæ‰‹æ³•/å‰ªå½±</code> è¼‰å…¥ PNG å‰ªå½±ï¼Œç›´æ¥å¥—ç”¨ç‚ºè©é›²é®ç½©ã€‚
                </p>
                <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;">
                    <button id="reload-silhouette-btn" style="padding:0.5rem 0.75rem;border-radius:0.375rem;border:1px solid #2563eb;background:#2563eb;color:#fff;font-size:0.85rem;cursor:pointer;flex:0 0 auto;">é‡æ–°è¼‰å…¥å‰ªå½±</button>
                    <span id="silhouette-list-status" class="mask-list-status" style="flex:1 1 auto;margin:0;"></span>
                </div>
                <div id="silhouette-grid" class="mask-gallery" style="max-height:440px;overflow:auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // Cleaned script block: reduces complexity, fixes syntax errors and preserves mask & upload UX
            // [ä¿®æ”¹] å¼·åˆ¶æŒ‡å®š GitHub Raw æª”æ¡ˆçš„çµ•å°è·¯å¾‘
            (function(){
                const GITHUB_RAW_PATH = 'https://raw.githubusercontent.com/eeee821022/Storage/main/ç¶²é -è¨­è¨ˆæ‰‹æ³•/å‰ªå½±/';
                window.MASK_ASSET_BASE = GITHUB_RAW_PATH;
                window.MASK_LIST_FILENAME = window.MASK_LIST_FILENAME || 'mask-list.json';
                // æ–°å¢ CSV ç¯„æœ¬è·¯å¾‘
                window.DEFAULT_CSV_URL = GITHUB_RAW_PATH + 'ç¯„æœ¬.csv';
            })();
            window.addEventListener('load', function () {
            let masterData = [];
            let globalMaxWeight = 0;
            const uniqueThemes = new Set();
            const uniqueEmotions = new Set();

            const BASE_FONT_SIZE = 80;
            let fontSizePercentage = 100;
            let weightContrast = 2.0; // æ–°å¢æ¬Šé‡å·®ç•°è®Šæ•¸ï¼Œé è¨­å€¼ 2.0
            let maskScale = 100;

            const fileInput = document.getElementById('file-input');
            const screenshotButton = document.getElementById('screenshot-button');
            const uploadButton = document.getElementById('upload-button');
            const settingsButton = document.getElementById('settings-button');
            const helpButton = document.getElementById('help-button');
            const aiButton = document.getElementById('ai-insight-button'); // æ–°å¢ AI æŒ‰éˆ•
            const helpModal = document.getElementById('help-modal');
            const helpModalOverlay = document.getElementById('help-modal-overlay');
            const helpModalCloseBtn = document.getElementById('help-modal-close-btn');
            const settingsModal = document.getElementById('settings-modal');
            const aiModal = document.getElementById('ai-modal'); // æ–°å¢ AI Modal
            const aiModalOverlay = document.getElementById('ai-modal-overlay');
            const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
            const aiLoading = document.getElementById('ai-loading');
            const aiResult = document.getElementById('ai-result');
            const aiError = document.getElementById('ai-error');
            const aiGenerateBtn = document.getElementById('ai-generate-btn'); // æ–°å¢ç”ŸæˆæŒ‰éˆ•
            const aiContextList = document.getElementById('ai-context-list'); // æ¢åˆ—å¼æ¸…å–®å®¹å™¨
            const addContextBtn = document.getElementById('add-context-btn'); // æ–°å¢æ¢ä»¶æŒ‰éˆ•
            
            const infoBox = document.getElementById('info-box');
            const errorBox = document.getElementById('error-box');
            const filtersContainer = document.getElementById('filters-container');
            const wordcloudContainer = document.getElementById('wordcloud-container');
            const emotionTrigger = document.getElementById('emotion-trigger');
            const emotionDropdown = document.getElementById('emotion-dropdown');
            const emotionSelectedText = document.getElementById('emotion-selected-text');
            const themeTrigger = document.getElementById('theme-trigger');
            const themeDropdown = document.getElementById('theme-dropdown');
            const themeSelectedText = document.getElementById('theme-selected-text');
            const canvas = document.getElementById('wordcloud-canvas');
            const eventDisplay = document.getElementById('event-display');
            const eventKeywordInput = document.getElementById('event-keyword-input');
            const searchKeywordButton = document.getElementById('search-keyword-button');
            const eventResult = document.getElementById('event-result');
            const eventNotFound = document.getElementById('event-not-found');
            const eventKeyword = document.getElementById('event-keyword');
            const eventText = document.getElementById('event-text');
            const eventTheme = document.getElementById('event-theme');
            const eventEmotions = document.getElementById('event-emotions');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');
            const weightContrastSlider = document.getElementById('weight-contrast-slider'); // æ–°å¢æ»‘æ¡¿
            const weightContrastValue = document.getElementById('weight-contrast-value'); // æ–°å¢æ•¸å€¼é¡¯ç¤º
            const apiKeyInput = document.getElementById('api-key-input'); // æ–°å¢ API Key è¼¸å…¥æ¡†

            const shapeSelect = document.getElementById('shape-select');
            const maskGallery = document.getElementById('mask-gallery');
            const reloadMaskBtn = document.getElementById('reload-mask-btn');
            const clearMaskBtn = document.getElementById('clear-mask-btn');
            const maskListStatus = document.getElementById('mask-list-status');
            const openSilhouetteBtn = document.getElementById('open-silhouette-btn');
            const silhouetteModal = document.getElementById('silhouette-modal');
            const silhouetteOverlay = document.getElementById('silhouette-modal-overlay');
            const reloadSilhouetteBtn = document.getElementById('reload-silhouette-btn');
            const silhouetteGrid = document.getElementById('silhouette-grid');
            const silhouetteStatus = document.getElementById('silhouette-list-status');
            let maskOptions = [];
            let currentMaskSelection = null;
            let silhouetteLoaded = false;

            const GITHUB_OWNER = 'eeee821022';
            const GITHUB_REPO = 'Storage';
            const GITHUB_SILHOUETTE_PATH = 'ç¶²é -è¨­è¨ˆæ‰‹æ³•/å‰ªå½±';

            async function fetchGitHubSilhouettes(){
                const encodedPath = GITHUB_SILHOUETTE_PATH.split('/').map(encodeURIComponent).join('/');
                const apiUrl = 'https://api.github.com/repos/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/contents/' + encodedPath + '?ts=' + Date.now();
                const response = await fetch(apiUrl);
                if(!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                const files = Array.isArray(data) ? data : [];
                return files
                    .filter(item => item.type === 'file' && /\.png$/i.test(item.name))
                    .map(file => ({ name: file.name, url: file.download_url || (window.MASK_ASSET_BASE + file.name) }));
            }
            
            window.wordcloudMaskImage = null;
            window.selectedCloudShape = (shapeSelect && shapeSelect.value) || 'circle';

            function showError(message) { if (errorBox) { errorBox.textContent = 'âŒ ' + message; errorBox.classList.remove('hidden'); } }
            function hideError() { if (errorBox) errorBox.classList.add('hidden'); if (infoBox) infoBox.classList.remove('hidden'); }

            // [ä¿®æ­£] ç°¡åŒ– Canvas è¨­å®šï¼Œç¢ºä¿èˆ‡ wordcloud2.js åº§æ¨™ç³»çµ±ä¸€è‡´ï¼Œè§£æ±ºé»æ“ŠéŒ¯ä½å•é¡Œ
            function setupCanvas() {
                if (!canvas) return;
                const container = document.getElementById('wordcloud-container');
                // ç›´æ¥ç²å–å®¹å™¨å¯¬åº¦ï¼Œä¸¦é™åˆ¶æœ€å¤§å¯¬åº¦
                const targetSize = Math.min(container.clientWidth - 64, 756); // -64 padding
                
                // é—œéµä¿®æ­£ï¼šå¼·åˆ¶ Canvas çš„å…§éƒ¨è§£æåº¦ (width/height) èˆ‡ CSS é¡¯ç¤ºå¤§å° (style.width/height) ä¸€è‡´
                // é€™æ¨£ wordcloud2.js çš„ hit detection å°±ä¸æœƒå› ç‚ºç¸®æ”¾è€ŒéŒ¯ä½
                canvas.width = targetSize;
                canvas.height = targetSize;
                canvas.style.width = targetSize + 'px';
                canvas.style.height = targetSize + 'px';
                
                // é‡ç½® transformï¼Œé¿å…ä¹‹å‰çš„ scale æ®˜ç•™
                const ctx = canvas.getContext('2d');
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            }

            function applyMaskImage(img, note){
                window.wordcloudMaskImage = img;
                currentMaskSelection = note || null;
                updateMaskPreview(img);
                checkImageTransparency(img)
                    .then(info => showMaskInfo({ hasTransparency: info.hasTransparency, width: info.width, height: info.height, note: note }))
                    .catch(() => showMaskInfo({ hasTransparency: false, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height, note: note }));
                setupCanvas();
                if(masterData.length) renderWordCloud();
            }

            function loadMaskImage(imageUrl, label){
                return new Promise((resolve, reject) => {
                    const finalUrl = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 'ts=' + Date.now();
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = function(){
                        applyMaskImage(img, label);
                        resolve(img);
                    };
                    img.onerror = function(){ reject(new Error('ç„¡æ³•è¼‰å…¥åœ–ç‰‡')); };
                    img.src = finalUrl;
                });
            }

            function updateMaskPreview(img) {
                const preview = document.getElementById('mask-preview');
                const container = document.getElementById('mask-preview-container');
                if (!preview || !img) return;
                const size = 56;
                const pc = document.createElement('canvas'); pc.width = size; pc.height = size;
                const pctx = pc.getContext('2d');
                const sc = Math.min(size / (img.naturalWidth || img.width), size / (img.naturalHeight || img.height));
                const sw = (img.naturalWidth || img.width) * sc; const sh = (img.naturalHeight || img.height) * sc;
                const sx = (size - sw) / 2, sy = (size - sh) / 2;
                pctx.clearRect(0,0,size,size); pctx.drawImage(img, sx, sy, sw, sh);
                preview.src = pc.toDataURL(); preview.style.display = 'block'; if (container) container.style.display = 'block';
            }

            function clearMaskPreview() { 
                const preview=document.getElementById('mask-preview'); 
                const container=document.getElementById('mask-preview-container'); 
                const info=document.getElementById('mask-info'); 
                if(preview){preview.src='';preview.style.display='none';} 
                if(container)container.style.display='none'; 
                if(info)info.textContent=''; 
            }

            function showMaskInfo(info) { 
                const el=document.getElementById('mask-info'); 
                if(!el) return; 
                const transText = info.hasTransparency ? 'âœ“ æœ‰é€æ˜' : 'âœ— ç„¡é€æ˜'; 
                const noteText = info.note ? ' Â· '+info.note : ''; 
                el.textContent = (info.width||'') + 'Ã—' + (info.height||'') + ' ' + transText + noteText; 
                el.style.color = info.hasTransparency ? '#059669' : '#dc2626'; 
            }

            function checkImageTransparency(img){ return new Promise((resolve,reject)=>{ try{ const c=document.createElement('canvas'); c.width=img.naturalWidth||img.width; c.height=img.naturalHeight||img.height; const cx=c.getContext('2d'); cx.clearRect(0,0,c.width,c.height); cx.drawImage(img,0,0,c.width,c.height); const d=cx.getImageData(0,0,c.width,c.height).data; let has=false; const step=Math.max(1,Math.floor((c.width*c.height)/1000)); for(let i=3;i<d.length;i+=4*step){ if(d[i]<255){has=true;break;} } resolve({hasTransparency:has,width:c.width,height:c.height}); }catch(e){reject(e);} }); }

            function generateMaskFromImage(sourceImg, threshold=180){ const c=document.createElement('canvas'); const sw=sourceImg.naturalWidth||sourceImg.width; const sh=sourceImg.naturalHeight||sourceImg.height; c.width=sw; c.height=sh; const cx=c.getContext('2d'); cx.clearRect(0,0,sw,sh); cx.drawImage(sourceImg,0,0,sw,sh); const id=cx.getImageData(0,0,sw,sh); const d=id.data; for(let i=0;i<d.length;i+=4){ const r=d[i],g=d[i+1],b=d[i+2]; const l=Math.round((r+g+b)/3); if(l<threshold){ d[i]=0; d[i+1]=0; d[i+2]=0; d[i+3]=255; } else { d[i+3]=0; } } cx.putImageData(id,0,0); const img=new Image(); img.crossOrigin='anonymous'; img.src=c.toDataURL('image/png'); img.naturalWidth=sw; img.naturalHeight=sh; return img; }

            if (shapeSelect) shapeSelect.addEventListener('change', function(){ window.selectedCloudShape=this.value||'circle'; if (masterData.length) renderWordCloud(); });

            async function loadMaskOptions(){
                if(!maskGallery) return;
                maskGallery.innerHTML = '<div class="mask-loading">æ­£åœ¨è¼‰å…¥å‰ªå½±...</div>';
                if(maskListStatus) maskListStatus.textContent = 'è¼‰å…¥ä¸­...';
                try {
                    const silhouettes = await fetchGitHubSilhouettes();
                    if(!Array.isArray(silhouettes) || silhouettes.length === 0){
                        maskGallery.innerHTML = '<div class="mask-error">æ‰¾ä¸åˆ°ä»»ä½• PNG å‰ªå½±</div>';
                        if(maskListStatus) maskListStatus.textContent = 'ç„¡å¯ç”¨å‰ªå½±';
                        return;
                    }
                    maskOptions = silhouettes.map(item => ({
                        file: item.name,
                        label: item.name,
                        url: item.url
                    }));
                    renderMaskOptions();
                    if(maskListStatus) maskListStatus.textContent = 'å·²è¼‰å…¥ ' + maskOptions.length + ' å€‹å‰ªå½±';
                } catch(err) {
                    console.error(err);
                    maskGallery.innerHTML = '<div class="mask-error">ç„¡æ³•è¼‰å…¥å‰ªå½±æ¸…å–®ã€‚è«‹ç¢ºèªå·²ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿé é¢ã€‚</div>';
                    if(maskListStatus) maskListStatus.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
                }
            }

            function renderMaskOptions(){
                if(!maskGallery){ return; }
                maskGallery.innerHTML = '';
                maskOptions.forEach(option => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'mask-option';
                    const label = option.label || option.file;
                    const imgSrc = option.url || (window.MASK_ASSET_BASE + option.file);
                    btn.innerHTML = '<img src="' + imgSrc + '?preview=1" alt="' + label + '" loading="lazy" /><span>' + label + '</span>';
                    btn.addEventListener('click', () => selectMaskOption(option, btn));
                    if(currentMaskSelection === option.file){ btn.classList.add('selected'); }
                    maskGallery.appendChild(btn);
                });
                if(maskOptions.length === 0){ maskGallery.innerHTML = '<div class="mask-error">æ²’æœ‰å¯ç”¨å‰ªå½±</div>'; }
            }

            function selectMaskOption(option, buttonEl){
                if(!option) return;
                maskGallery?.querySelectorAll('.mask-option').forEach(btn => btn.classList.remove('selected'));
                if(buttonEl) buttonEl.classList.add('selected');
                silhouetteGrid?.querySelectorAll('.mask-option').forEach(btn => btn.classList.remove('selected'));
                const label = option.label || option.file;
                const url = option.url || (window.MASK_ASSET_BASE + option.file);
                loadMaskImage(url, label)
                    .then(() => { if(maskListStatus) maskListStatus.textContent = 'å·²å¥—ç”¨ï¼š' + label; })
                    .catch(err => {
                        if(maskListStatus) maskListStatus.textContent = 'è¼‰å…¥å‰ªå½±å¤±æ•—ï¼š' + label;
                        buttonEl?.classList.remove('selected');
                        console.error(err);
                    });
            }

            if (reloadMaskBtn) reloadMaskBtn.addEventListener('click', loadMaskOptions);

            if (clearMaskBtn) clearMaskBtn.addEventListener('click', function(){
                window.wordcloudMaskImage=null;
                currentMaskSelection = null;
                maskGallery?.querySelectorAll('.mask-option').forEach(btn => btn.classList.remove('selected'));
                silhouetteGrid?.querySelectorAll('.mask-option').forEach(btn => btn.classList.remove('selected'));
                clearMaskPreview();
                setupCanvas();
                if(masterData.length) renderWordCloud();
            });
            loadMaskOptions();


            async function loadSilhouetteOptions(forceReload){
                if(!silhouetteGrid) return;
                if(silhouetteLoaded && !forceReload) return;
                silhouetteGrid.innerHTML = '<div class="mask-loading">æ­£åœ¨è¼‰å…¥ GitHub å‰ªå½±...</div>';
                if(silhouetteStatus) silhouetteStatus.textContent = 'è¼‰å…¥ä¸­...';
                try {
                    const silhouettes = await fetchGitHubSilhouettes();
                    if(silhouettes.length === 0){
                        silhouetteGrid.innerHTML = '<div class="mask-error">æ­¤è³‡æ–™å¤¾ä¸­æ‰¾ä¸åˆ° PNG æª”æ¡ˆ</div>';
                        if(silhouetteStatus) silhouetteStatus.textContent = 'ç„¡å¯ç”¨å‰ªå½±';
                        silhouetteLoaded = true;
                        return;
                    }
                    silhouetteGrid.innerHTML = '';
                    silhouettes.forEach(file => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'mask-option';
                        const rawUrl = file.url;
                        btn.innerHTML = '<img src="' + rawUrl + '?preview=1" alt="' + file.name + '" loading="lazy" /><span>' + file.name + '</span>';
                        btn.addEventListener('click', () => {
                            silhouetteGrid.querySelectorAll('.mask-option').forEach(el => el.classList.remove('selected'));
                            maskGallery?.querySelectorAll('.mask-option').forEach(el => el.classList.remove('selected'));
                            btn.classList.add('selected');
                            loadMaskImage(rawUrl, file.name)
                                .then(() => { if(silhouetteStatus) silhouetteStatus.textContent = 'å·²å¥—ç”¨ï¼š' + file.name; })
                                .catch(err => {
                                    btn.classList.remove('selected');
                                    if(silhouetteStatus) silhouetteStatus.textContent = 'è¼‰å…¥é®ç½©å¤±æ•—ï¼š' + err.message;
                                    console.error(err);
                                });
                        });
                        silhouetteGrid.appendChild(btn);
                    });
                    if(silhouetteStatus) silhouetteStatus.textContent = 'å·²è¼‰å…¥ ' + silhouettes.length + ' å€‹å‰ªå½±';
                    silhouetteLoaded = true;
                } catch(err) {
                    console.error(err);
                    silhouetteGrid.innerHTML = '<div class="mask-error">ç„¡æ³•è®€å– GitHub å‰ªå½±ï¼š' + err.message + '</div>';
                    if(silhouetteStatus) silhouetteStatus.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
                    silhouetteLoaded = false;
                }
            }

            if(openSilhouetteBtn && silhouetteModal){
                openSilhouetteBtn.addEventListener('click', () => {
                    silhouetteModal.classList.remove('hidden');
                    loadSilhouetteOptions();
                });
            }

            if(reloadSilhouetteBtn){
                reloadSilhouetteBtn.addEventListener('click', () => {
                    silhouetteLoaded = false;
                    loadSilhouetteOptions(true);
                });
            }

            if(silhouetteOverlay && silhouetteModal){
                silhouetteOverlay.addEventListener('click', () => silhouetteModal.classList.add('hidden'));
            }

            // Theme colors & translations
            // [ä¿®æ”¹] æ”¹ç‚ºå‹•æ…‹é…è‰²ï¼Œä¸å†ç¶å®šç‰¹å®šæ–‡å­—
            const themeColorMap = new Map(); 
            // é€™è£¡å®šç¾©ä¸€çµ„é€šç”¨çš„è‰²ç›¤ (ä½ å¯ä»¥éš¨æ„å¢åŠ å–œæ­¡çš„è‰²ç¢¼)
            const colorPalette = [
                '#2E8B57', '#FF4500', '#8A2BE2', '#F9C74F', '#B22222', 
                '#43AA8B', '#577590', '#F94144', '#90BE6D', '#F3722C', 
                '#277DA1', '#5F9EA0', '#DDA0DD', '#FFD700', '#4682B4',
                '#FF1493', '#1E90FF', '#32CD32', '#FF8C00', '#4B0082'
            ];

            const themeMap = new Map([['Learning & Knowledge','å­¸ç¿’èˆ‡çŸ¥è­˜'],['Consumption & Habits','æ¶ˆè²»èˆ‡ç¿’æ…£'],['Finance & Investment','é‡‘èèˆ‡æŠ•è³‡'],['Work & Career','å·¥ä½œèˆ‡è·æ¥­'],['Family & Intimacy','å®¶åº­èˆ‡è¦ªå¯†é—œä¿‚'],['Time & Efficiency','æ™‚é–“èˆ‡æ•ˆç‡'],['Technology & Gadgets','ç§‘æŠ€èˆ‡é›»å­ç”¢å“'],['Health & Management','å¥åº·èˆ‡ç®¡ç†'],['Hobbies & Leisure','å—œå¥½èˆ‡ä¼‘é–’'],['Other/Background Trait','å…¶ä»–/èƒŒæ™¯ç‰¹å¾µ'],['Commute & Mobility','é€šå‹¤èˆ‡å‡ºè¡Œ']]);
            const emotionMap = new Map([['Desire','æ¸´æœ›'],['Satisfaction','æ»¿è¶³'],['Habitual','ç¿’æ…£'],['Neutral','å¹³å¸¸'],['Tension/Stress','ç·Šå¼µ'],['Achievement','æˆå°±'],['Empathy','å…±æƒ…'],['Joy','å–œæ‚…'],['Forced/Obligated','è¢«è¿«'],['Disappointment','å¤±æœ›'],['Suppression','å£“æŠ‘'],['Helplessness','ç„¡å¥ˆ'],['Other','å…¶ä»–'],['Other/Undefined','å…¶ä»–/ç„¡æ³•å®šç¾©']]);

            function populateFilters(){
                if (!emotionDropdown || !themeDropdown) return;
                emotionDropdown.innerHTML = ''; themeDropdown.innerHTML = '';
                const allEmotionsOpt = document.createElement('div'); allEmotionsOpt.className = 'select-option'; allEmotionsOpt.innerHTML = '<input type="checkbox" id="emotion-all" value="all" checked> <label for="emotion-all">å…¨éƒ¨æƒ…ç·’</label>'; emotionDropdown.appendChild(allEmotionsOpt);
                Array.from(uniqueEmotions).sort().forEach(emotion=>{ const opt = document.createElement('div'); opt.className = 'select-option'; const id = 'emotion-' + emotion.replace(/\s+/g,'-').replace(/\//g,'-'); opt.innerHTML = '<input type="checkbox" id="' + id + '" value="' + emotion + '" checked> <label for="' + id + '">' + emotion + '</label>'; emotionDropdown.appendChild(opt); });
                const allThemesOpt = document.createElement('div'); allThemesOpt.className = 'select-option'; allThemesOpt.innerHTML = '<input type="checkbox" id="theme-all" value="all" checked> <label for="theme-all">å…¨éƒ¨ä¸»é¡Œ</label>'; themeDropdown.appendChild(allThemesOpt);
                Array.from(uniqueThemes).sort().forEach(theme=>{ const opt = document.createElement('div'); opt.className = 'select-option'; const id = 'theme-' + theme.replace(/\s+/g,'-').replace(/\//g,'-'); opt.innerHTML = '<input type="checkbox" id="' + id + '" value="' + theme + '" checked> <label for="' + id + '">' + theme + '</label>'; themeDropdown.appendChild(opt); });
                setupDropdownInteractions(); setupCheckboxEvents();
            }

            function setupDropdownInteractions(){
                if(emotionTrigger) emotionTrigger.addEventListener('click', function(e){ e.stopPropagation(); emotionDropdown.classList.toggle('show'); emotionTrigger.classList.toggle('open'); themeDropdown.classList.remove('show'); themeTrigger.classList.remove('open'); });
                if(themeTrigger) themeTrigger.addEventListener('click', function(e){ e.stopPropagation(); themeDropdown.classList.toggle('show'); themeTrigger.classList.toggle('open'); emotionDropdown.classList.remove('show'); emotionTrigger.classList.remove('open'); });
                document.addEventListener('click', function(){ emotionDropdown.classList.remove('show'); emotionTrigger.classList.remove('open'); themeDropdown.classList.remove('show'); themeTrigger.classList.remove('open'); });
                emotionDropdown.addEventListener('click', function(e){ e.stopPropagation(); }); themeDropdown.addEventListener('click', function(e){ e.stopPropagation(); });
            }

            function setupCheckboxEvents(){
                const emotionAll = document.getElementById('emotion-all');
                if(emotionAll) emotionAll.addEventListener('change', function(){ emotionDropdown.querySelectorAll('input[type="checkbox"]:not(#emotion-all)').forEach(cb=>cb.checked=this.checked); updateEmotionSelectedText(); renderWordCloud(); });
                emotionDropdown.querySelectorAll('input[type="checkbox"]:not(#emotion-all)').forEach(cb=>cb.addEventListener('change', function(){ updateEmotionSelectedText(); renderWordCloud(); }));
                const themeAll = document.getElementById('theme-all');
                if(themeAll) themeAll.addEventListener('change', function(){ themeDropdown.querySelectorAll('input[type="checkbox"]:not(#theme-all)').forEach(cb=>cb.checked=this.checked); updateThemeSelectedText(); renderWordCloud(); });
                themeDropdown.querySelectorAll('input[type="checkbox"]:not(#theme-all)').forEach(cb=>cb.addEventListener('change', function(){ updateThemeSelectedText(); renderWordCloud(); }));
            }

            function updateEmotionSelectedText(){
                const checked = Array.from(emotionDropdown.querySelectorAll('input[type="checkbox"]:checked'));
                const allCb = document.getElementById('emotion-all');
                if(allCb.checked || checked.length === uniqueEmotions.size + 1) emotionSelectedText.textContent = 'å·²é¸æ“‡: å…¨éƒ¨æƒ…ç·’';
                else if(checked.length === 0) emotionSelectedText.textContent = 'è«‹é¸æ“‡æƒ…ç·’';
                else { const names = checked.filter(cb=>cb.id!=='emotion-all').map(cb=>cb.nextElementSibling.textContent); emotionSelectedText.textContent = names.length <= 3 ? 'å·²é¸æ“‡: ' + names.join(', ') : 'å·²é¸æ“‡: ' + names.length + ' å€‹æƒ…ç·’'; }
            }

            function updateThemeSelectedText(){
                const checked = Array.from(themeDropdown.querySelectorAll('input[type="checkbox"]:checked'));
                const allCb = document.getElementById('theme-all');
                if(allCb.checked || checked.length === uniqueThemes.size + 1) themeSelectedText.textContent = 'å·²é¸æ“‡: å…¨éƒ¨ä¸»é¡Œ';
                else if(checked.length === 0) themeSelectedText.textContent = 'è«‹é¸æ“‡ä¸»é¡Œ';
                else { const names = checked.filter(cb=>cb.id!=='theme-all').map(cb=>cb.nextElementSibling.textContent); themeSelectedText.textContent = names.length <= 2 ? 'å·²é¸æ“‡: ' + names.join(', ') : 'å·²é¸æ“‡: ' + names.length + ' å€‹ä¸»é¡Œ'; }
            }

            function renderWordCloud(){
                if(!canvas) return;
                const selectedEmotions = Array.from(emotionDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
                const selectedThemes = Array.from(themeDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
                const filteredData = masterData.filter(item=>{ const themeMatch = selectedThemes.includes('all') || selectedThemes.includes(item.theme); const emotionMatch = selectedEmotions.includes('all') || item.emotions.some(e=>selectedEmotions.includes(e)); return themeMatch && emotionMatch; });
                const keywordDataMap = {}; filteredData.forEach(item=>{ keywordDataMap[item.keyword] = item; });
                const maxFontSize = BASE_FONT_SIZE * (fontSizePercentage / 100);
                
                // [ä¿®æ­£] å¼•å…¥ weightContrast è®Šæ•¸å–ä»£å›ºå®šçš„å¹³æ–¹ (2)
                const wordCloudList = filteredData.map(item=>{ 
                    const ratio = item.weight / globalMaxWeight; 
                    const adjustedWeight = Math.pow(ratio, weightContrast) * globalMaxWeight; // ä½¿ç”¨è®Šæ•¸
                    return [item.keyword, adjustedWeight]; 
                });
                
                const weightFactor = globalMaxWeight > 0 ? maxFontSize / globalMaxWeight : 1;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (wordCloudList.length === 0) { ctx.fillStyle='#9ca3af'; ctx.font='16px Inter, sans-serif'; ctx.textAlign='center'; ctx.fillText('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™',canvas.width/2,canvas.height/2); return; }
                
                let shape = window.selectedCloudShape || 'circle';
                let backgroundColor = '#ffffff';
                
                // å¦‚æœæœ‰é®ç½©åœ–ç‰‡ï¼Œä½¿ç”¨ CSS mask è€Œä¸æ˜¯ shape å‡½æ•¸
                if (window.wordcloudMaskImage) {
                    const maskUrl = window.wordcloudMaskImage.src;
                    canvas.style.webkitMaskImage = 'url(' + maskUrl + ')';
                    canvas.style.maskImage = 'url(' + maskUrl + ')';
                    canvas.classList.add('masked');
                    backgroundColor = '#ffffff';
                    shape = 'circle'; // ç”¨åœ“å½¢å¡«æ»¿æ•´å€‹ canvasï¼ŒCSS mask æœƒè£åˆ‡
                } else {
                    canvas.style.webkitMaskImage = '';
                    canvas.style.maskImage = '';
                    canvas.classList.remove('masked');
                }
                
                WordCloud(canvas, {
                    list: wordCloudList, 
                    weightFactor: weightFactor, 
                    fontFamily: 'Inter, Noto Sans TC, sans-serif',
                    color: function(word){ const data = keywordDataMap[word]; return data ? (themeColorMap.get(data.theme) || '#374151') : '#374151'; },
                    rotateRatio: 0, 
                    backgroundColor: backgroundColor, 
                    minSize: 10, 
                    gridSize: 8, 
                    drawOutOfBound: false, 
                    shrinkToFit: true,
                    // [ä¿®æ­£] ç§»é™¤è¤‡é›œçš„ origin è¨ˆç®—ï¼Œä½¿ç”¨é è¨­ä¸­å¿ƒï¼Œä»¥é¿å…é»æ“ŠéŒ¯ä½
                    origin: null,
                    shape: shape, 
                    ellipticity: 1, 
                    wait: 0,
                    click: function(item){ if(item&&item[0]){ const keyword=item[0]; const data=keywordDataMap[keyword]; if(data){ eventKeywordInput.value=keyword; eventKeyword.textContent=keyword; eventTheme.textContent=data.theme; eventEmotions.textContent=data.emotions.join(', '); eventText.textContent=data.event; eventResult.style.display='block'; eventNotFound.style.display='none'; eventDisplay.style.display='block'; } } },
                    hover: function(item){ canvas.title = item&&item[0] ? (keywordDataMap[item[0]]||{keyword:item[0]}).keyword : ''; }
                });
            }

            // æˆªåœ–åŠŸèƒ½
            function screenshotWordCloud() {
                if (!canvas) {
                    alert('è«‹å…ˆè¼‰å…¥è³‡æ–™ä¸¦ç”Ÿæˆè©é›²ï¼');
                    return;
                }
                
                try {
                    // å‰µå»ºä¸€å€‹è‡¨æ™‚ canvas ä¾†è™•ç†é®è‰²ç‰‡
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // å¦‚æœæœ‰é®è‰²ç‰‡ï¼Œéœ€è¦ç‰¹æ®Šè™•ç†
                    if (window.wordcloudMaskImage) {
                        // å…ˆç¹ªè£½ç™½è‰²èƒŒæ™¯
                        tempCtx.fillStyle = '#ffffff';
                        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                        
                        // ç¹ªè£½åŸå§‹è©é›²
                        tempCtx.drawImage(canvas, 0, 0);
                        
                        // æ‡‰ç”¨é®è‰²ç‰‡
                        tempCtx.globalCompositeOperation = 'destination-in';
                        tempCtx.drawImage(window.wordcloudMaskImage, 0, 0, tempCanvas.width, tempCanvas.height);
                    } else {
                        // æ²’æœ‰é®è‰²ç‰‡ï¼Œç›´æ¥è¤‡è£½
                        tempCtx.drawImage(canvas, 0, 0);
                    }
                    
                    // è½‰æ›ç‚ºåœ–ç‰‡ä¸¦ä¸‹è¼‰
                    tempCanvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        link.download = `è©é›²_${timestamp}.png`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                } catch (err) {
                    console.error('æˆªåœ–å¤±æ•—:', err);
                    alert('æˆªåœ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
            
            if (screenshotButton) screenshotButton.addEventListener('click', screenshotWordCloud);
            if (uploadButton && fileInput) uploadButton.addEventListener('click', ()=> fileInput.click());
            if (fileInput) fileInput.addEventListener('change', handleFileUpload);
            if (settingsButton && settingsModal) settingsButton.addEventListener('click', ()=> settingsModal.classList.remove('hidden'));
            if (helpButton && helpModal) helpButton.addEventListener('click', ()=> helpModal.classList.remove('hidden'));
            if (helpModalOverlay && helpModal) helpModalOverlay.addEventListener('click', ()=> helpModal.classList.add('hidden'));
            if (helpModalCloseBtn && helpModal) helpModalCloseBtn.addEventListener('click', ()=> helpModal.classList.add('hidden'));
            
            // AI Modal Controls
            if (aiButton && aiModal) aiButton.addEventListener('click', ()=> {
                aiModal.classList.remove('hidden');
                // ä¸å†è‡ªå‹•è§¸ç™¼ï¼Œæ”¹ç”±æŒ‰éˆ•è§¸ç™¼
                // generatePersonaInsights(); 
            });
            if (aiModalOverlay && aiModal) aiModalOverlay.addEventListener('click', ()=> aiModal.classList.add('hidden'));
            if (aiModalCloseBtn && aiModal) aiModalCloseBtn.addEventListener('click', ()=> aiModal.classList.add('hidden'));

            // ç¶å®šæ‰‹å‹•ç”ŸæˆæŒ‰éˆ•äº‹ä»¶
            if (aiGenerateBtn) {
                aiGenerateBtn.addEventListener('click', generatePersonaInsights);
            }

            document.querySelectorAll('.close-modal-button').forEach(btn=>btn.addEventListener('click', function(){ const mid=this.getAttribute('data-modal'); const m=document.getElementById(mid); if(m) m.classList.add('hidden'); }));
            document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click', function(){ const m=this.closest('.modal'); if(m) m.classList.add('hidden'); }));

            if (fontSizeSlider) fontSizeSlider.addEventListener('input', function(){ fontSizePercentage = parseInt(this.value,10); if (fontSizeValue) fontSizeValue.textContent = fontSizePercentage + '%'; if (masterData.length) renderWordCloud(); });
            
            // [æ–°å¢] æ¬Šé‡å·®ç•°æ»‘æ¡¿äº‹ä»¶ç›£è½
            if (weightContrastSlider) {
                weightContrastSlider.addEventListener('input', function() {
                    weightContrast = parseFloat(this.value);
                    if (weightContrastValue) weightContrastValue.textContent = weightContrast.toFixed(1);
                    if (masterData.length) renderWordCloud();
                });
            }

            // [æ–°å¢] API Key è¼¸å…¥æ¡†åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½
            if (apiKeyInput) {
                // å˜—è©¦å¾ localStorage è¼‰å…¥
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) {
                    apiKeyInput.value = savedKey;
                }

                // ç›£è½è¼¸å…¥ä¸¦å³æ™‚å„²å­˜
                apiKeyInput.addEventListener('input', function() {
                    localStorage.setItem('gemini_api_key', this.value.trim());
                });
            }
            
            // [æ–°å¢] å‹•æ…‹æ¢åˆ—å¼è¼¸å…¥æ¡†é‚è¼¯
            function addContextRow(value = '') {
                const div = document.createElement('div');
                div.className = 'context-list-item';
                div.innerHTML = `
                    <input type="text" value="${value}" placeholder="è¼¸å…¥èƒŒæ™¯æ¢ä»¶ (å¦‚ï¼šå±…ä½åœ¨å°åŒ—)">
                    <button class="remove-row-btn" title="åˆªé™¤" onclick="this.parentElement.remove()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1rem;height:1rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                aiContextList.appendChild(div);
            }

            if (addContextBtn) {
                addContextBtn.addEventListener('click', () => addContextRow());
                // é è¨­æ–°å¢ä¸€åˆ—
                addContextRow(); 
            }
            
            function searchKeyword() {
                const kw = eventKeywordInput.value.trim();
                if (!kw) return;
                const data = masterData.find(d => d.keyword === kw);
                if (data) {
                    eventKeyword.textContent = data.keyword;
                    eventTheme.textContent = data.theme;
                    eventEmotions.textContent = data.emotions.join(', ');
                    eventText.textContent = data.event;
                    eventResult.style.display = 'block';
                    eventNotFound.style.display = 'none';
                    eventDisplay.style.display = 'block';
                } else {
                    eventResult.style.display = 'none';
                    eventNotFound.style.display = 'block';
                }
            }

            if (searchKeywordButton) searchKeywordButton.addEventListener('click', searchKeyword);
            if (eventKeywordInput) eventKeywordInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    searchKeyword();
                }
            });

            // [é‡æ§‹] æŠ½å–å‡ºå…±ç”¨çš„ CSV è³‡æ–™è™•ç†é‚è¼¯
            function processCSVData(results) {
                try {
                    if (!results.data || results.data.length === 0) {
                        showError('CSV æª”æ¡ˆç‚ºç©º');
                        return;
                    }
                    masterData = [];
                    globalMaxWeight = 0;
                    uniqueThemes.clear();
                    uniqueEmotions.clear();
                    
                    results.data.forEach(row => {
                        if (!row['é—œéµå­—1'] && !row['é—œéµå­—2']) return;
                        const themeEn = row['ä¸»é¡Œ/æƒ…å¢ƒ'] || '';
                        const themeCn = themeMap.get(themeEn) || themeEn;
                        const emotionsEnRaw = row['æƒ…ç·’/æ…‹åº¦'] || '';
                        const emotionsEnList = emotionsEnRaw.split(',').map(e => e.trim());
                        const emotionsCnList = emotionsEnList.map(e => emotionMap.get(e) || e);
                        const event = row['äº‹ä»¶'] || '';
                        const weightStr = row['æ¬Šé‡'] || '0%';
                        const weight = Math.max(0.01, parseFloat(weightStr.toString().replace('%', '')) / 100 || 0.01);
                        
                        uniqueThemes.add(themeCn);
                        emotionsCnList.forEach(e => uniqueEmotions.add(e));
                        
                        if (weight > globalMaxWeight) globalMaxWeight = weight;
                        
                        if (row['é—œéµå­—1']) masterData.push({keyword: row['é—œéµå­—1'].trim(), weight: weight, theme: themeCn, emotions: emotionsCnList, event: event});
                        if (row['é—œéµå­—2']) masterData.push({keyword: row['é—œéµå­—2'].trim(), weight: weight, theme: themeCn, emotions: emotionsCnList, event: event});
                    });
                    
                    // [æ–°å¢] è‡ªå‹•ä¾åºåˆ†é…é¡è‰²çµ¦æ¯ä¸€å€‹ç¨ç‰¹çš„ä¸»é¡Œ
                    themeColorMap.clear(); // æ¸…ç©ºèˆŠçš„å°æ‡‰
                    const sortedThemes = Array.from(uniqueThemes).sort(); // æ’åºä¸»é¡Œç¢ºä¿æ¯æ¬¡é †åºä¸€è‡´
                    console.log('ğŸ¨ åµæ¸¬åˆ°çš„ä¸»é¡Œæ•¸é‡:', sortedThemes.length);
                    console.log('ğŸ¨ ä¸»é¡Œåˆ—è¡¨:', sortedThemes);
                    sortedThemes.forEach((theme, index) => {
                        // ä½¿ç”¨å–é¤˜æ•¸ (%) é‹ç®—ï¼Œå¦‚æœä¸»é¡Œæ•¸é‡è¶…éè‰²ç›¤æ•¸é‡ï¼Œæœƒå¾ªç’°ä½¿ç”¨é¡è‰²
                        const color = colorPalette[index % colorPalette.length];
                        themeColorMap.set(theme, color);
                        console.log(`ğŸ¨ ä¸»é¡Œ "${theme}" â†’ é¡è‰² ${color}`);
                    });

                    if (masterData.length === 0) {
                        showError('ç„¡æœ‰æ•ˆçš„é—œéµå­—è³‡æ–™');
                        return;
                    }
                    
                    if (infoBox) infoBox.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.5rem;height:1.5rem;display:inline;margin-right:0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><p style="display:inline;">æˆåŠŸè¼‰å…¥ ' + masterData.length + ' å€‹é—œéµå­—ï¼</p>';
                    if (filtersContainer) filtersContainer.classList.remove('hidden');
                    if (wordcloudContainer) wordcloudContainer.classList.remove('hidden');
                    if (eventDisplay) eventDisplay.style.display = 'block';
                    populateFilters();
                    setupCanvas();
                    renderWordCloud();
                } catch (err) {
                    console.error(err);
                    showError('è™•ç†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message || err));
                }
            }

            // åŸå§‹çš„ä¸Šå‚³è™•ç†å‡½æ•¸ï¼Œæ”¹ç‚ºå‘¼å« processCSVData
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                hideError();
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: processCSVData,
                    error: function (err) {
                        showError('CSV è§£æå¤±æ•—ï¼š' + (err.message || err));
                    }
                });
            }
            
            // [æ–°å¢] è‡ªå‹•è¼‰å…¥é è¨­ CSV åŠŸèƒ½
            async function loadDefaultCSV() {
                if(infoBox) infoBox.innerHTML = '<p>æ­£åœ¨è¼‰å…¥ç¯„æœ¬è³‡æ–™...</p>';
                try {
                    const response = await fetch(window.DEFAULT_CSV_URL);
                    if (!response.ok) throw new Error('ç„¡æ³•ä¸‹è¼‰ç¯„æœ¬æª”æ¡ˆ');
                    const csvText = await response.text();
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: processCSVData,
                        error: function (err) {
                            showError('ç¯„æœ¬ CSV è§£æå¤±æ•—ï¼š' + (err.message || err));
                        }
                    });
                } catch (err) {
                    console.error(err);
                    // å¦‚æœè‡ªå‹•è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­æç¤º
                    if(infoBox) infoBox.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.5rem;height:1.5rem;display:inline;margin-right:0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg><p>è‡ªå‹•è¼‰å…¥ç¯„æœ¬å¤±æ•—ï¼Œè«‹é»æ“Šå³ä¸Šè§’çš„ã€Œä¸Šå‚³ã€æŒ‰éˆ•ä¾†ä¸Šå‚³æ‚¨çš„ CSV æª”æ¡ˆã€‚</p>';
                }
            }

            // [æ–°å¢] Gemini AI æ´å¯Ÿå ±å‘Šç”Ÿæˆé‚è¼¯
            async function generatePersonaInsights() {
                // å„ªå…ˆå¾ localStorage è®€å–ä½¿ç”¨è€…è¨­å®šçš„ API Key
                const userApiKey = localStorage.getItem('gemini_api_key');
                
                if (!userApiKey) {
                    aiResult.innerHTML = '<p style="color: #b91c1c; text-align: center; font-weight: bold;">è«‹å…ˆè¨­å®š API Key</p><p style="text-align: center; color: #6b7280;">è«‹é»æ“Šå³ä¸Šè§’çš„ã€Œè¨­å®šã€æŒ‰éˆ•ï¼Œåœ¨ã€ŒGemini API Keyã€æ¬„ä½ä¸­è²¼ä¸Šæ‚¨çš„é‡‘é‘°ã€‚<br><br><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #2563eb; text-decoration: underline;">å‰å¾€ Google AI Studio å–å¾— API Key</a></p>';
                    aiResult.classList.remove('hidden');
                    return;
                }

                if (!masterData || masterData.length === 0) {
                    aiResult.innerHTML = '<p style="color: #6b7280; text-align: center;">è«‹å…ˆè¼‰å…¥ CSV è³‡æ–™ä»¥é€²è¡Œåˆ†æã€‚</p>';
                    aiResult.classList.remove('hidden');
                    return;
                }

                aiLoading.classList.remove('hidden');
                aiResult.classList.add('hidden');
                aiError.classList.add('hidden');

                try {
                    // 1. æº–å‚™æ•¸æ“šï¼šå–æ¬Šé‡æœ€é«˜çš„å‰ 50 å€‹é—œéµå­—
                    const topKeywords = [...masterData]
                        .sort((a, b) => b.weight - a.weight)
                        .slice(0, 50)
                        .map(item => `[${item.theme}] ${item.keyword} (æ¬Šé‡: ${(item.weight*100).toFixed(0)}%, æƒ…ç·’: ${item.emotions.join(',')})`)
                        .join('\n');

                    // 2. [ä¿®æ­£] ç²å–æ¢åˆ—å¼èƒŒæ™¯è³‡æ–™
                    const contextInputs = document.querySelectorAll('#ai-context-list input');
                    const contextLines = Array.from(contextInputs)
                        .map(input => input.value.trim())
                        .filter(val => val !== '');

                    let contextInstruction = "";
                    if (contextLines.length > 0) {
                        const formattedContext = contextLines.map(line => `- ${line}`).join('\n');
                        contextInstruction = `\n\nã€æŒ‡å®šèƒŒæ™¯æ¢ä»¶ã€‘ï¼š\nè«‹å‹™å¿…åš´æ ¼åŸºæ–¼ä»¥ä¸‹è¨­å®šé€²è¡Œåˆ†æï¼Œä¸å¯èˆ‡æ­¤è¡çªï¼š\n${formattedContext}\n`;
                    } else {
                        contextInstruction = `\n\nã€èƒŒæ™¯æ¢ä»¶ã€‘ï¼š\nè«‹è‡ªè¡Œæ ¹æ“šé—œéµå­—æ¨è«–æœ€åˆé©çš„ä½¿ç”¨è€…ç•«åƒèƒŒæ™¯ã€‚\n`;
                    }

                    const promptText = `
è«‹æ ¹æ“šä»¥ä¸‹ Persona çš„é—œéµå­—æ•¸æ“šï¼Œæ‰®æ¼”ä¸€ä½è³‡æ·±çš„ä½¿ç”¨è€…ç ”ç©¶å“¡ï¼Œç”Ÿæˆä¸€ä»½ã€Œä½¿ç”¨è€…ç•«åƒæ´å¯Ÿå ±å‘Šã€ã€‚
${contextInstruction}

è«‹ä½¿ç”¨ Markdown æ ¼å¼ï¼Œä¸¦**åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ç« ç¯€çµæ§‹è¼¸å‡º**ï¼š

1. **äººç‰©å´å¯« (Bio)**ï¼š
    * åŸºæ–¼æŒ‡å®šæ¢ä»¶æˆ–æ¨è«–ï¼Œç”Ÿå‹•æè¿°é€™ä½ç”¨æˆ¶ï¼ˆåŒ…å«å¹´é½¡ã€è·æ¥­ã€å±…ä½åœ°ã€ç”Ÿæ´»å‹æ…‹ï¼‰ã€‚
2. **æ ¸å¿ƒå‹•æ©Ÿ (Core Motivations)**ï¼š
    * ä»–ç‚ºä»€éº¼åšé€™äº›äº‹ï¼Ÿæ·±å±¤çš„éœ€æ±‚æ˜¯ä»€éº¼ï¼Ÿ
3. **ç—›é»èˆ‡æŒ«æŠ˜ (Pain Points)**ï¼š
    * ä»–åœ¨æ“”å¿ƒä»€éº¼ï¼Ÿé‡åˆ°ä»€éº¼å›°é›£ï¼Ÿ
4. **è¨­è¨ˆæ©Ÿæœƒé» (Design Opportunities)**ï¼š
    * ç”¢å“å¯ä»¥å¦‚ä½•å¹«åŠ©ä»–ï¼Ÿæå‡ºå…·é«”å»ºè­°ã€‚

è³‡æ–™å¦‚ä¸‹ (å–æ¬Šé‡å‰ 50 ç­†)ï¼š
${topKeywords}
                    `;
                    
                    const apiKey = userApiKey; // ä½¿ç”¨è€…è¼¸å…¥çš„ Key

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptText }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API è«‹æ±‚å¤±æ•— (${response.status}): ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        // ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown
                        aiResult.innerHTML = marked.parse(text);
                        aiResult.classList.remove('hidden');
                    } else {
                        throw new Error('ç„¡æ•ˆçš„ AI å›æ‡‰');
                    }

                } catch (err) {
                    console.error(err);
                    aiError.classList.remove('hidden');
                    aiError.textContent = 'ç”Ÿæˆå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message;
                } finally {
                    aiLoading.classList.add('hidden');
                }
            }

            window.addEventListener('resize', function(){ if (masterData.length) { setupCanvas(); renderWordCloud(); } });

            // å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥
            loadDefaultCSV();
        });
    </script>
    <!-- é®ç½© / å½¢ç‹€æ§åˆ¶é¢æ¿ï¼ˆå›ºå®šå³ä¸‹è§’ï¼Œä½æ–¼æ›¸æœ¬æŒ‰éˆ•ä¸Šæ–¹ï¼‰ -->
        <!-- é®ç½© / å½¢ç‹€æ§åˆ¶é¢æ¿ï¼ˆå›ºå®šå³ä¸‹è§’ï¼Œä½æ–¼æ›¸æœ¬æŒ‰éˆ•ä¸Šæ–¹ï¼‰ -->
    
    <script>
        // ç¯„ä¾‹ SVG ç”¢ç”Ÿèˆ‡é®ç½©è¼‰å…¥ï¼ˆç”·å¥³è€å°‘ï¼‰
        (function(){
            function svgToImage(svgStr, callback) {
                const svg64 = btoa(unescape(encodeURIComponent(svgStr)));
                const dataUrl = 'data:image/svg+xml;base64,' + svg64;
                const img = new Image();
                img.onload = function() { callback(null, img); };
                img.onerror = function(e) { callback(e); };
                img.crossOrigin = 'anonymous';
                img.src = dataUrl;
            }

            function makeSampleSVG(kind) {
                // All SVGs: transparent background, black filled silhouette
                if (kind === 'female') {
                    return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M600 140c80 0 150 60 150 140 0 40-20 76-40 112-14 26-28 50-34 72-6 24 8 60 24 88 16 28 36 52 64 68 44 26 96 40 96 92v60H240v-60c0-52 52-66 96-92 28-16 48-40 64-68 16-28 30-64 24-88-6-22-20-46-34-72-20-36-40-72-40-112 0-80 70-140 150-140z"/>
</svg>`;
                }
                if (kind === 'male') {
                    return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M580 160c90-20 240-20 320 40 70 50 70 150 10 230-36 50-72 80-88 148-14 58 12 120 36 168 24 48 56 90 100 118 60 40 132 58 132 142v64H120v-64c0-84 72-102 132-142 44-28 76-70 100-118 24-44 40-98 30-140-16-68-52-98-88-148-60-80-170-80-260-60z"/>
</svg>`;
                }
                if (kind === 'child') {
                    return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1400" viewBox="0 0 1000 1400">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M500 120c60 0 110 40 110 90 0 28-12 54-28 80-10 16-20 32-24 46-5 18 6 42 18 62 12 20 26 36 46 48 34 22 74 34 74 78v44H280v-44c0-44 40-56 74-78 20-12 34-28 46-48 12-20 23-44 18-62-4-14-14-30-24-46-16-28-28-52-28-80 0-50 50-90 110-90z"/>
</svg>`;
                }
                // elderly
                return `<?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600">
  <rect width="100%" height="100%" fill="transparent"/>
  <path fill="#000" d="M520 140c100 0 180 80 180 180 0 60-30 110-60 160-22 36-44 70-52 100-10 42 6 96 30 140 24 44 56 82 96 110 68 50 150 72 150 166v72H160v-72c0-94 82-116 150-166 40-28 72-66 96-110 24-44 40-98 30-140-8-30-30-64-52-100-30-50-60-100-60-160 0-100 80-180 180-180z"/>
</svg>`;
            }

            document.addEventListener('DOMContentLoaded', function(){
                const sampleSelect = document.getElementById('sample-mask-select');
                const loadBtn = document.getElementById('load-sample-mask');
                const clearBtn = document.getElementById('clear-mask-btn');
                if (!sampleSelect || !loadBtn) return;

                loadBtn.addEventListener('click', function(){
                    const kind = sampleSelect.value;
                    if (!kind) { alert('è«‹é¸æ“‡ç¯„ä¾‹é®ç½©é¡å‹ (ç”·å¥³å…’é•·è€…)'); return; }
                    const svg = makeSampleSVG(kind);
                    svgToImage(svg, function(err, img){
                        if (err) { alert('å»ºç«‹ç¯„ä¾‹é®ç½©å¤±æ•—'); return; }
                        window.wordcloudMaskImage = img;
                        updateMaskPreview(img);
                        showMaskInfo({ hasTransparency: true, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height, note: 'ç¯„ä¾‹é®ç½©' });
                        try { setupCanvas(); } catch(e) {}
                        if (typeof renderWordCloud === 'function') renderWordCloud();
                    });
                });

                if (clearBtn) {
                    clearBtn.addEventListener('click', function(){
                        window.wordcloudMaskImage = null;
                        clearMaskPreview();
                        try { setupCanvas(); } catch(e) {}
                        if (typeof renderWordCloud === 'function') renderWordCloud();
                    });
                }

                // è‡ªå‹•ç”¢ç”Ÿé®ç½©æŒ‰éˆ•ç¶å®š
                const autoBtn = document.getElementById('auto-mask-btn');
                const thresh = document.getElementById('auto-threshold');
                if (autoBtn && thresh) {
                    autoBtn.addEventListener('click', function(){
                        if (!window.wordcloudMaskImage) { alert('è«‹å…ˆä¸Šå‚³æˆ–è¼‰å…¥ç¯„ä¾‹å½±åƒä½œç‚ºä¾†æºå½±åƒ'); return; }
                        const t = parseInt(thresh.value, 10) || 180;
                        const src = window.wordcloudMaskImage;
                        const generated = generateMaskFromImage(src, t);
                        generated.onload = function() {
                            window.wordcloudMaskImage = generated;
                            updateMaskPreview(generated);
                            showMaskInfo({ hasTransparency: true, width: generated.naturalWidth || generated.width, height: generated.naturalHeight || generated.height, note: 'è‡ªå‹•ç”¢ç”Ÿ' });
                            try { setupCanvas(); } catch(e) {}
                            if (typeof renderWordCloud === 'function') renderWordCloud();
                        };
                    });
                }
            });
        })();
    </script>

</body>
</html>
