<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Business Model Canvas) å”ä½œå·¥å…·</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <!-- å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        /* BMC Grid Layout */
        .bmc-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(3, minmax(180px, auto));
            gap: 0.5rem;
            background-color: #cbd5e1;
            border: 0.5rem solid #cbd5e1;
            border-radius: 0.5rem;
            align-items: stretch;
        }

        @media (max-width: 1024px) {
            .bmc-grid {
                display: flex;
                flex-direction: column;
            }
            .bmc-cell {
                min-height: 200px;
            }
        }

        .bmc-cell {
            background-color: white;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.2s;
            min-height: 100%; 
            height: auto;
        }

        .bmc-cell h3 {
            font-size: 0.875rem;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .bmc-icon {
            width: 1.25rem;
            height: 1.25rem;
            opacity: 0.7;
        }

        .bmc-textarea {
            width: 100%;
            flex-grow: 1;
            resize: none;
            border: none;
            outline: none;
            overflow: hidden;
            background: transparent;
            min-height: 100px;
            display: block;
            line-height: 1.6;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        /* Grid Positioning */
        .area-kp { grid-column: 1 / 3; grid-row: 1 / 3; }
        .area-ka { grid-column: 3 / 5; grid-row: 1 / 2; }
        .area-kr { grid-column: 3 / 5; grid-row: 2 / 3; }
        .area-vp { grid-column: 5 / 7; grid-row: 1 / 3; }
        .area-cr { grid-column: 7 / 9; grid-row: 1 / 2; }
        .area-ch { grid-column: 7 / 9; grid-row: 2 / 3; }
        .area-cs { grid-column: 9 / 11; grid-row: 1 / 3; }
        .area-cost { grid-column: 1 / 6; grid-row: 3 / 4; }
        .area-revenue { grid-column: 6 / 11; grid-row: 3 / 4; }

        /* Color Tags */
        .tag-yellow { background-color: #fef9c3; }
        .tag-green { background-color: #dcfce7; }
        .tag-red { background-color: #fee2e2; }
        .tag-blue { background-color: #dbeafe; }

        /* Action Buttons */
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: #334152;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .action-button:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .action-button svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            color: #64748b;
        }
        
        .primary-btn {
            background-color: #2563eb;
            color: white;
            border: 1px solid #2563eb;
        }
        .primary-btn:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .primary-btn svg { color: white; }

        /* Modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Status Indicator */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-connecting { background-color: #fbbf24; }
        .status-connected { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }

        /* Right Sidebar Styles */
        #source-panel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
        }
        #source-panel.open {
            transform: translateX(0);
        }
        #source-panel.closed {
            transform: translateX(100%);
        }

        /* Main Container Shift */
        #main-container {
            transition: padding-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-sizing: border-box;
        }
        #main-container.shifted {
            padding-right: 26rem;
        }
    </style>
</head>
<body class="relative min-h-screen">

    <!-- Help Button (Top Right) -->
    <button onclick="toggleModal('help-modal')" class="fixed top-6 right-6 z-50 p-3 bg-white rounded-full shadow-lg text-blue-600 hover:bg-blue-50 transition-colors border border-blue-100" title="ä½¿ç”¨èªªæ˜">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>
    </button>

    <!-- Right Sidebar (Source Text Panel) -->
    <div id="source-panel" class="fixed top-24 right-0 bottom-0 w-96 bg-white border-l border-slate-200 z-40 closed flex flex-col">
        <!-- Toggle Tab -->
        <button id="source-toggle-btn" onclick="toggleSourcePanel()" class="absolute top-0 -left-10 w-10 h-12 bg-white border border-r-0 border-slate-200 rounded-l-lg shadow-[-2px_2px_5px_rgba(0,0,0,0.05)] flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-slate-50 transition-colors group" title="å±•é–‹/éš±è—æ¡ˆä»¶è³‡æ–™">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 group-hover:scale-110 transition-transform">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
            </svg>
        </button>
        
        <!-- Content -->
        <div class="p-4 flex flex-col h-full bg-slate-50/50">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    ğŸ“„ åŸå§‹æ¡ˆä»¶è³‡æ–™
                    <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded">å¯ç·¨è¼¯</span>
                </h3>
                <button onclick="clearSourceText()" class="text-xs text-slate-400 hover:text-red-500 hover:underline">æ¸…ç©º</button>
            </div>
            <p class="text-xs text-slate-500 mb-2">æ­¤è™•å…§å®¹æœƒèˆ‡åœ˜éšŠåŒæ­¥ã€‚ä½¿ç”¨ã€ŒAI æ™ºèƒ½åˆ†æã€æ™‚ï¼Œè¼¸å…¥çš„æ–‡æœ¬æœƒè‡ªå‹•å‚™ä»½æ–¼æ­¤ã€‚</p>
            <textarea id="source-textarea" class="flex-1 w-full p-3 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white leading-relaxed text-slate-600" placeholder="åœ¨æ­¤è²¼ä¸Šè¨ªè«‡è¨˜éŒ„ã€å•†æ¥­è¨ˆç•«è‰ç¨¿æˆ–ä»»ä½•åƒè€ƒè³‡æ–™..."></textarea>
        </div>
    </div>

    <div class="container mx-auto max-w-[1400px] p-4 md:p-8 pt-16" id="main-container">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">å•†æ¥­æ¨¡å¼ç•«å¸ƒ <span class="text-blue-600">BMC</span></h1>
            <p class="text-slate-500">Business Model Canvas</p>
            
            <!-- System Status -->
            <div class="mt-4 flex justify-center gap-4 flex-wrap">
                <div id="connection-status" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 text-slate-600 text-sm">
                    <span class="status-indicator status-connecting"></span>
                    <span id="connection-text">é€£ç·šä¸­...</span>
                </div>
                <div id="collab-status" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-50 text-blue-700 border border-blue-100 text-sm hidden">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span id="collab-text"></span>
                </div>
            </div>
        </header>

        <!-- Toolbar -->
        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <!-- AI Analysis -->
            <button onclick="toggleModal('ai-modal')" class="action-button primary-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09 3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
                </svg>
                AI æ™ºèƒ½åˆ†æ
            </button>
            
            <!-- Collaboration -->
            <button id="collab-setup-btn" onclick="checkAndToggleCollab()" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
                </svg>
                å¤šäººå”ä½œè¨­å®š
            </button>

            <button id="import-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                åŒ¯å…¥
            </button>
            <button id="export-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                åŒ¯å‡º
            </button>
            <button id="screenshot-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.174a2.31 2.31 0 0 0-1.64 2.288v7.517A2.31 2.31 0 0 0 4.615 21h14.77a2.31 2.31 0 0 0 2.31-2.31v-7.517a2.31 2.31 0 0 0-1.64-2.288c-.377-.062-.754-.12-1.134-.174a2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.776 48.776 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.04l-.821 1.316Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" /></svg>
                æˆªåœ–
            </button>
            <button id="clear-btn" class="action-button text-red-600 hover:bg-red-50 border-red-200 hover:border-red-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.578 0c-.267.03-.53.062-.79.098m14.055 0a47.905 47.905 0 0 1-4.472 0m-8.58 0a47.905 47.905 0 0 0-4.472 0" /></svg>
                æ¸…ç©º
            </button>
        </div>

        <!-- Canvas -->
        <div id="canvas-area" class="bmc-grid shadow-xl">
            <!-- 9 Blocks (kp, ka, kr, vp, cr, ch, cs, cost, revenue) -->
            <div class="bmc-cell area-kp" id="cell-kp">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>é—œéµåˆä½œå¤¥ä¼´ (KP)</h3>
                <textarea class="bmc-textarea" placeholder="ä¾›æ‡‰å•†ã€åˆä½œå¤¥ä¼´..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-ka" id="cell-ka">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>é—œéµæ´»å‹• (KA)</h3>
                <textarea class="bmc-textarea" placeholder="ç”Ÿç”¢ã€è§£æ±ºå•é¡Œ..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-kr" id="cell-kr">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>é—œéµè³‡æº (KR)</h3>
                <textarea class="bmc-textarea" placeholder="è³‡ç”¢ã€äººåŠ›ã€é‡‘è..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-vp" id="cell-vp">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>åƒ¹å€¼ä¸»å¼µ (VP)</h3>
                <textarea class="bmc-textarea" placeholder="è§£æ±ºä»€éº¼å•é¡Œï¼Ÿæä¾›ä»€éº¼åƒ¹å€¼ï¼Ÿ" oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-cr" id="cell-cr">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>é¡§å®¢é—œä¿‚ (CR)</h3>
                <textarea class="bmc-textarea" placeholder="å€‹äººåŠ©ç†ã€ç¤¾ç¾¤..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-ch" id="cell-ch">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>é€šè·¯ (CH)</h3>
                <textarea class="bmc-textarea" placeholder="ç¶²ç«™ã€å¯¦é«”åº—..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-cs" id="cell-cs">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>ç›®æ¨™å®¢ç¾¤ (CS)</h3>
                <textarea class="bmc-textarea" placeholder="å¤§çœ¾ã€åˆ©åŸºå¸‚å ´..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-cost" id="cell-cost">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>æˆæœ¬çµæ§‹ (C$)</h3>
                <textarea class="bmc-textarea" placeholder="å›ºå®šæˆæœ¬ã€è®Šå‹•æˆæœ¬..." oninput="autoResize(this)"></textarea>
            </div>
            <div class="bmc-cell area-revenue" id="cell-revenue">
                <h3><svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>æ”¶ç›Šæµ (R$)</h3>
                <textarea class="bmc-textarea" placeholder="éŠ·å”®ã€è¨‚é–±è²»..." oninput="autoResize(this)"></textarea>
            </div>
        </div>
    </div>

    <!-- Hidden Input -->
    <input type="file" id="file-input" accept=".json" class="hidden" />

    <!-- Right Click Menu -->
    <div id="context-menu" class="hidden fixed bg-white shadow-xl rounded-lg border border-slate-200 z-50 text-sm py-1 min-w-[120px]">
        <div class="px-3 py-2 hover:bg-yellow-50 cursor-pointer flex items-center gap-2" onclick="setColor('yellow')"><span class="w-3 h-3 rounded-full bg-yellow-200 border border-yellow-300"></span> æ¨™è¨˜é»ƒè‰² (å‡è¨­)</div>
        <div class="px-3 py-2 hover:bg-green-50 cursor-pointer flex items-center gap-2" onclick="setColor('green')"><span class="w-3 h-3 rounded-full bg-green-200 border border-green-300"></span> æ¨™è¨˜ç¶ è‰² (é©—è­‰)</div>
        <div class="px-3 py-2 hover:bg-red-50 cursor-pointer flex items-center gap-2" onclick="setColor('red')"><span class="w-3 h-3 rounded-full bg-red-200 border border-red-300"></span> æ¨™è¨˜ç´…è‰² (é¢¨éšª)</div>
        <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer flex items-center gap-2" onclick="setColor('blue')"><span class="w-3 h-3 rounded-full bg-blue-200 border border-blue-300"></span> æ¨™è¨˜è—è‰² (ä¸€èˆ¬)</div>
        <div class="border-t border-slate-100 my-1"></div>
        <div class="px-3 py-2 hover:bg-slate-50 cursor-pointer text-slate-500" onclick="setColor('none')">æ¸…é™¤æ¨™è¨˜</div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl m-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09 3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>
                    Gemini æ™ºèƒ½åˆ†æ
                </h3>
                <button onclick="toggleModal('ai-modal')" class="text-slate-400 hover:text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Gemini API Key</label>
                    <input type="password" id="ai-key" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">å•†æ¥­è¨ˆç•«/ç­†è¨˜å…§å®¹</label>
                    <textarea id="ai-input" class="w-full h-40 p-3 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹è²¼ä¸Šæ‚¨çš„å•†æ¥­æ§‹æƒ³ã€æœƒè­°è¨˜éŒ„æˆ–æ–‡ç« å…§å®¹..."></textarea>
                </div>
                <div id="ai-loading" class="hidden text-center py-4">
                    <div class="spinner"></div>
                    <p class="text-sm text-slate-500 mt-2">AI æ­£åœ¨åˆ†ææ‚¨çš„å•†æ¥­æ¨¡å¼...</p>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="toggleModal('ai-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-md text-sm">å–æ¶ˆ</button>
                <button onclick="runAIAnalysis()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md text-sm font-medium flex items-center gap-2">é–‹å§‹åˆ†æ</button>
            </div>
        </div>
    </div>

    <!-- Collaboration Modal -->
    <div id="collab-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    å¤šäººå”ä½œè¨­å®š
                </h3>
                <button onclick="toggleModal('collab-modal')" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Setup View -->
                <div id="collab-setup-view">
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-blue-800 mb-1 text-sm">âœ¨ å³æ™‚åŒæ­¥æ¨¡å¼</h4>
                        <p class="text-xs text-blue-600">å»ºç«‹ä¸€å€‹å°ˆå±¬é€£çµï¼Œé‚€è«‹åœ˜éšŠæˆå“¡åŠ å…¥ã€‚æ‰€æœ‰è®Šæ›´å°‡å³æ™‚åŒæ­¥ã€‚</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">æ¬Šé™è¨­å®š</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                </div>
                                <input type="text" id="collab-password-input" class="pl-9 w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="è¨­å®šç·¨è¼¯å¯†ç¢¼ (é¸å¡«)">
                            </div>
                            <p class="text-xs text-slate-500 mt-1.5 ml-1">
                                <span class="inline-block w-1.5 h-1.5 rounded-full bg-slate-400 mr-1"></span>ç•™ç©ºï¼šæ‰€æœ‰äººçš†å¯ç·¨è¼¯
                                <br>
                                <span class="inline-block w-1.5 h-1.5 rounded-full bg-blue-400 mr-1"></span>è¨­å®šå¯†ç¢¼ï¼šè¨ªå®¢éœ€è¼¸å…¥å¯†ç¢¼æ‰å¯ç·¨è¼¯ (å¦å‰‡å”¯è®€)
                            </p>
                        </div>

                        <button onclick="startCollaboration()" id="start-collab-btn" class="w-full py-2.5 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-medium shadow-sm transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                            <span>é–‹å§‹å”ä½œ</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                        </button>
                    </div>
                </div>

                <!-- Active View (Waiting State) -->
                <div id="collab-active-view" class="hidden text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-1">å”ä½œå·²å•Ÿç”¨ï¼</h4>
                    <p class="text-sm text-slate-500 mb-6">æ‚¨çš„ç•«å¸ƒç¾åœ¨å·²ä¸Šç·šï¼Œè«‹å°‡é€£çµå‚³é€çµ¦å¤¥ä¼´ã€‚</p>
                    
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-left mb-6">
                        <label class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">åˆ†äº«é€£çµ</label>
                        <div class="flex gap-2">
                            <input type="text" id="share-link" readonly class="flex-1 p-2 bg-white border border-slate-300 rounded text-xs text-slate-600 select-all">
                            <button onclick="copyLink()" class="px-3 py-2 bg-white border border-slate-300 rounded text-slate-700 hover:bg-slate-50 text-xs font-medium transition-colors">è¤‡è£½</button>
                        </div>
                    </div>

                    <div id="password-display-area" class="hidden bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-left flex justify-between items-center">
                         <div>
                             <span class="block text-xs text-yellow-800 font-medium">ç·¨è¼¯å¯†ç¢¼</span>
                             <code id="display-password" class="text-sm font-bold text-yellow-900 font-mono"></code>
                         </div>
                         <span class="text-xs text-yellow-600 px-2 py-1 bg-yellow-100 rounded">Admin</span>
                    </div>
                    
                    <button onclick="toggleModal('collab-modal')" class="mt-6 text-sm text-slate-500 hover:text-slate-700 underline">é—œé–‰è¦–çª—</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="password-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 p-6 text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-2">éœ€è¦ç·¨è¼¯æ¬Šé™</h3>
            <p class="text-sm text-slate-600 mb-4">æ­¤ç•«å¸ƒå—å¯†ç¢¼ä¿è­·ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²è¡Œç·¨è¼¯ï¼Œæˆ–é»æ“Šã€Œåƒ…æª¢è¦–ã€ä»¥å”¯è®€æ¨¡å¼ç€è¦½ã€‚</p>
            <input type="password" id="guest-password-input" class="w-full p-2 border border-slate-300 rounded-md mb-4" placeholder="è¼¸å…¥ç·¨è¼¯å¯†ç¢¼">
            <div class="flex gap-2 justify-center">
                <button onclick="enableReadOnly()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-md text-sm">åƒ…æª¢è¦–</button>
                <button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md text-sm">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">è¨­è¨ˆæ‰‹æ³•ï¼šå•†æ¥­æ¨¡å¼ç•«å¸ƒ</h3>
                <button onclick="toggleModal('help-modal')" class="text-slate-400 hover:text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 overflow-y-auto prose prose-slate max-w-none">
                <table class="w-full text-sm border-collapse border border-slate-200">
                    <tbody>
                        <tr class="border-b"><td class="p-3 bg-slate-50 font-bold w-1/4">æ–¹æ³•åç¨±</td><td class="p-3">å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Business Model Canvas)</td></tr>
                        <tr class="border-b"><td class="p-3 bg-slate-50 font-bold">ä¸€å¥è©±ç¸½çµ</td><td class="p-3">é€éä¹å¤§æ§‹é¢çš„ç³»çµ±æ€§ä½ˆå±€ï¼Œæ¸…æ™°æç¹ªã€åˆ†æä¸¦å‰µæ–°æ‚¨çš„ä¼æ¥­åƒ¹å€¼å‰µé€ é‚è¼¯ã€‚</td></tr>
                        <tr class="border-b"><td class="p-3 bg-slate-50 font-bold">æ ¸å¿ƒæ¦‚å¿µ</td><td class="p-3">å°‡ä¼æ¥­é‹ä½œç°¡åŒ–ç‚ºä¹å€‹é—œéµè¦ç´ ï¼ˆåƒ¹å€¼ä¸»å¼µã€å®¢ç¾¤ã€é€šè·¯ç­‰ï¼‰ï¼Œæä¾›ä¸€å€‹è¦–è¦ºåŒ–ã€å–®é å¼çš„åˆ†æå·¥å…·ã€‚</td></tr>
                        <tr class="border-b"><td class="p-3 bg-slate-50 font-bold">ä½¿ç”¨æµç¨‹</td><td class="p-3"><ol class="list-decimal pl-4 space-y-1"><li><strong>åƒ¹å€¼ä¸»å¼µ (VP)ï¼š</strong>æ ¸å¿ƒåƒ¹å€¼æ˜¯ä»€éº¼ï¼Ÿ</li><li><strong>ç›®æ¨™å®¢ç¾¤ (CS)ï¼š</strong>èª°æ˜¯ä½ çš„å®¢æˆ¶ï¼Ÿ</li><li><strong>é€šè·¯ (CH)ï¼š</strong>å¦‚ä½•æ¥è§¸å®¢æˆ¶ï¼Ÿ</li><li><strong>é¡§å®¢é—œä¿‚ (CR)ï¼š</strong>å¦‚ä½•ç¶­ç¹«å®¢æˆ¶ï¼Ÿ</li><li><strong>æ”¶ç›Šæµ (R$)ï¼š</strong>æ€éº¼è³ºéŒ¢ï¼Ÿ</li><li><strong>é—œéµè³‡æº (KR)ï¼š</strong>éœ€è¦ä»€éº¼è³‡ç”¢ï¼Ÿ</li><li><strong>é—œéµæ´»å‹• (KA)ï¼š</strong>éœ€è¦åšä»€éº¼äº‹ï¼Ÿ</li><li><strong>é—œéµå¤¥ä¼´ (KP)ï¼š</strong>èª°å¯ä»¥å¹«å¿™ï¼Ÿ</li><li><strong>æˆæœ¬çµæ§‹ (C$)ï¼š</strong>éŒ¢èŠ±åœ¨å“ªè£¡ï¼Ÿ</li></ol></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        const appId = 'bmc-tool-v1';
        let db;
        let currentSessionId = null;
        let unsubscribe = null;
        let isReadOnly = false;
        let localEditPassword = null;
        let isOwner = false;
        let isFirebaseReady = false;

        const BLOCKS = ['kp', 'ka', 'kr', 'vp', 'cr', 'ch', 'cs', 'cost', 'revenue'];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateConnectionStatus('connecting', 'é€£ç·šä¸­...');
            
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDyB_rJ37rHW1uwpQNASlWc53AjsPwh2EE",
                    authDomain: "business-model-canvas-3da74.firebaseapp.com",
                    projectId: "business-model-canvas-3da74",
                    storageBucket: "business-model-canvas-3da74.firebasestorage.app",
                    messagingSenderId: "922978479250",
                    appId: "1:922978479250:web:21f376739dd4a312a68a4b",
                    measurementId: "G-VDQYMC8DLG"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                } else {
                    firebase.app();
                }

                db = firebase.firestore();
                const auth = firebase.auth();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        isFirebaseReady = true;
                        updateConnectionStatus('connected', 'å·²é€£ç·š');
                        
                        const urlParams = new URLSearchParams(window.location.search);
                        const session = urlParams.get('session');
                        if (session && !currentSessionId) {
                            await joinSession(session);
                        }
                    } else {
                        await performLogin(auth);
                    }
                });
                
                if(!auth.currentUser) {
                     await performLogin(auth);
                }

            } catch (e) {
                console.error("Firebase Init Error:", e);
                updateConnectionStatus('error', 'é€£ç·šå¤±æ•— (å–®æ©Ÿæ¨¡å¼å¯ç”¨)');
            }

            setupInteractions();
            // æ ¸å¿ƒä¿®æ”¹ï¼šåˆå§‹åŒ–æ™‚ä¹Ÿè§¸ç™¼ä¸€æ¬¡é«˜åº¦èª¿æ•´ï¼Œé¿å…è¼‰å…¥å…§å®¹å¾Œé«˜åº¦éŒ¯èª¤
            document.querySelectorAll('.bmc-textarea').forEach(el => autoResize(el));
        });

        // æ ¸å¿ƒä¿®æ”¹ï¼šå´é‚Šæ¬„åˆ‡æ›é‚è¼¯
        function toggleSourcePanel() {
            const panel = document.getElementById('source-panel');
            const container = document.getElementById('main-container');
            
            panel.classList.toggle('open');
            panel.classList.toggle('closed');
            
            // åŒæ­¥åˆ‡æ›ä¸»å®¹å™¨çš„æ¨£å¼ï¼Œç”¢ç”Ÿæ¨ç§»æ•ˆæœ
            if (panel.classList.contains('open')) {
                container.classList.add('shifted');
            } else {
                container.classList.remove('shifted');
            }
        }

        // æ ¸å¿ƒä¿®æ”¹ï¼šTextarea è‡ªå‹•èª¿æ•´é«˜åº¦å‡½å¼
        function autoResize(el) {
            // å…ˆé‡ç½®é«˜åº¦ä»¥è¨ˆç®—æ–°çš„ scrollHeight (è™•ç†åˆªé™¤æ–‡å­—çš„æƒ…æ³)
            el.style.height = 'auto';
            // è¨­å®šç‚º scrollHeightï¼Œç¢ºä¿ä¸å‡ºç¾æ²è»¸
            el.style.height = (el.scrollHeight) + 'px';
        }

        function clearSourceText() {
            if(!confirm('ç¢ºå®šè¦æ¸…ç©ºåŸå§‹è³‡æ–™å—ï¼Ÿ')) return;
            document.getElementById('source-textarea').value = '';
            if (currentSessionId && !isReadOnly && isFirebaseReady) {
                updateFirestoreSourceText('');
            }
        }

        let sourceUpdateTimeout;
        function updateFirestoreSourceText(text) {
            if (!db || !isFirebaseReady || !currentSessionId) return;
            if (sourceUpdateTimeout) clearTimeout(sourceUpdateTimeout);
            sourceUpdateTimeout = setTimeout(() => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).update({
                    sourceText: text
                }).catch(console.error);
            }, 1000);
        }

        // --- Other existing functions remain the same ... ---

        function checkAndToggleCollab() {
            if (!isFirebaseReady) {
                alert('ç³»çµ±å°šæœªå®Œæˆé€£ç·šï¼Œæš«æ™‚ç„¡æ³•ä½¿ç”¨å¤šäººå”ä½œåŠŸèƒ½ã€‚\n(è«‹æª¢æŸ¥ Firebase Console æ˜¯å¦å·²é–‹å•Ÿ "Anonymous" ç™»å…¥)');
                return;
            }
            toggleModal('collab-modal');
        }

        async function performLogin(auth) {
            try {
                 await auth.signInAnonymously();
            } catch(err) {
                console.error("Login failed:", err);
                if (err.code === 'auth/operation-not-allowed') {
                     updateConnectionStatus('error', 'éœ€é–‹å•ŸåŒ¿åç™»å…¥ (Authentication > Sign-in method)');
                } else if (err.code === 'auth/configuration-not-found') {
                     updateConnectionStatus('error', 'ç¶²åŸŸé™åˆ¶ (åŠŸèƒ½å—é™)');
                } else {
                     updateConnectionStatus('error', 'ç™»å…¥å¤±æ•—');
                }
            }
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.querySelector('#connection-status .status-indicator');
            const textEl = document.getElementById('connection-text');
            
            indicator.className = 'status-indicator'; 
            textEl.textContent = text;

            if (status === 'connected') indicator.classList.add('status-connected');
            else if (status === 'error') indicator.classList.add('status-error');
            else indicator.classList.add('status-connecting');
        }

        let currentContextCell = null;

        function setupInteractions() {
            document.addEventListener('click', () => document.getElementById('context-menu').classList.add('hidden'));
            
            document.querySelectorAll('.bmc-cell').forEach(cell => {
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (isReadOnly) return;
                    currentContextCell = cell;
                    const menu = document.getElementById('context-menu');
                    menu.style.left = `${e.clientX}px`;
                    menu.style.top = `${e.clientY}px`;
                    menu.classList.remove('hidden');
                });

                const textarea = cell.querySelector('textarea');
                textarea.addEventListener('input', (e) => {
                    if (currentSessionId && !isReadOnly && isFirebaseReady) {
                        updateFirestoreDebounced(cell.id.split('-')[1], e.target.value);
                    }
                });
            });

            const sourceTextarea = document.getElementById('source-textarea');
            sourceTextarea.addEventListener('input', (e) => {
                if (currentSessionId && !isReadOnly && isFirebaseReady) {
                    updateFirestoreSourceText(e.target.value);
                }
            });

            document.getElementById('screenshot-btn').addEventListener('click', takeScreenshot);
            document.getElementById('export-btn').addEventListener('click', exportJSON);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', importJSON);
            document.getElementById('clear-btn').addEventListener('click', clearCanvas);
            
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) document.getElementById('ai-key').value = savedKey;
        }

        function setColor(color) {
            if (!currentContextCell) return;
            currentContextCell.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
            if (color !== 'none') {
                currentContextCell.classList.add(`tag-${color}`);
            }
            if (currentSessionId && !isReadOnly && isFirebaseReady) {
                const blockId = currentContextCell.id.split('-')[1];
                updateFirestoreColor(blockId, color);
            }
        }

        async function startCollaboration() {
            if (!isFirebaseReady) return;
            
            const btn = document.getElementById('start-collab-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner border-white/30 border-l-white w-4 h-4 mr-2"></div> å»ºç«‹ä¸­...';
            btn.disabled = true;

            const password = document.getElementById('collab-password-input').value.trim();
            const newSessionId = Math.random().toString(36).substring(2, 10);
            
            const initialData = {
                created: firebase.firestore.FieldValue.serverTimestamp(),
                editPassword: password || null,
                sourceText: document.getElementById('source-textarea').value
            };

            BLOCKS.forEach(id => {
                const cell = document.getElementById(`cell-${id}`);
                initialData[id] = {
                    text: cell.querySelector('textarea').value,
                    color: getCellColor(cell)
                };
            });

            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(newSessionId).set(initialData);
                isOwner = true;
                localEditPassword = password;
                await joinSession(newSessionId, true);
            } catch (err) {
                alert("å»ºç«‹å”ä½œå¤±æ•—: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function joinSession(sessionId, justCreated = false) {
            if (!db) return;
            currentSessionId = sessionId;
            
            document.getElementById('collab-status').classList.remove('hidden');
            document.getElementById('collab-text').textContent = `${sessionId}`;
            document.getElementById('collab-setup-view').classList.add('hidden');
            document.getElementById('collab-active-view').classList.remove('hidden');
            
            const newUrl = `${window.location.pathname}?session=${sessionId}`;
            window.history.pushState({path: newUrl}, '', newUrl);
            document.getElementById('share-link').value = window.location.href;

            if (justCreated && localEditPassword) {
                document.getElementById('password-display-area').classList.remove('hidden');
                document.getElementById('display-password').textContent = localEditPassword;
            }

            if (unsubscribe) unsubscribe();

            unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(sessionId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (!justCreated && !localEditPassword && data.editPassword && !isReadOnly) {
                            document.getElementById('password-modal').classList.add('active');
                        }
                        
                        if (data.sourceText !== undefined) {
                            const sourceArea = document.getElementById('source-textarea');
                            if (document.activeElement !== sourceArea) {
                                sourceArea.value = data.sourceText;
                            }
                        }

                        BLOCKS.forEach(id => {
                            if (data[id]) {
                                const cell = document.getElementById(`cell-${id}`);
                                const textarea = cell.querySelector('textarea');
                                if (document.activeElement !== textarea) {
                                    textarea.value = data[id].text || '';
                                    // åŒæ­¥è³‡æ–™æ™‚ä¹Ÿè¦è‡ªå‹•èª¿æ•´é«˜åº¦
                                    autoResize(textarea);
                                }
                                cell.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
                                if (data[id].color && data[id].color !== 'none') {
                                    cell.classList.add(`tag-${data[id].color}`);
                                }
                            }
                        });
                    } else {
                        alert('å”ä½œç•«å¸ƒä¸å­˜åœ¨');
                        currentSessionId = null;
                        document.getElementById('collab-status').classList.add('hidden');
                    }
                }, (error) => {
                    console.error(error);
                    alert("ç„¡æ³•è®€å–å”ä½œè³‡æ–™ (æ¬Šé™ä¸è¶³æˆ–é€£ç·šéŒ¯èª¤)");
                });
        }

        function enableReadOnly() {
            isReadOnly = true;
            document.getElementById('password-modal').classList.remove('active');
            document.querySelectorAll('textarea').forEach(el => el.readOnly = true);
            document.getElementById('source-textarea').readOnly = true;
            document.getElementById('collab-text').textContent += " (å”¯è®€)";
        }

        function verifyPassword() {
            if (!db || !currentSessionId) return;
            const input = document.getElementById('guest-password-input').value;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).get()
                .then(doc => {
                    if (doc.data().editPassword === input) {
                        localEditPassword = input;
                        document.getElementById('password-modal').classList.remove('active');
                        isReadOnly = false;
                        document.querySelectorAll('textarea').forEach(el => el.readOnly = false);
                        document.getElementById('source-textarea').readOnly = false;
                    } else {
                        alert('å¯†ç¢¼éŒ¯èª¤');
                    }
                });
        }

        let updateTimeouts = {};
        function updateFirestoreDebounced(blockId, text) {
            if (!db || !isFirebaseReady || !currentSessionId) return;
            if (updateTimeouts[blockId]) clearTimeout(updateTimeouts[blockId]);
            updateTimeouts[blockId] = setTimeout(() => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).update({
                    [`${blockId}.text`]: text
                }).catch(console.error);
            }, 500);
        }

        function updateFirestoreColor(blockId, color) {
            if (!db || !isFirebaseReady || !currentSessionId) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).update({
                [`${blockId}.color`]: color
            }).catch(console.error);
        }

        function getCellColor(cell) {
            if (cell.classList.contains('tag-yellow')) return 'yellow';
            if (cell.classList.contains('tag-green')) return 'green';
            if (cell.classList.contains('tag-red')) return 'red';
            if (cell.classList.contains('tag-blue')) return 'blue';
            return 'none';
        }

        // --- AI Analysis Logic ---
        async function runAIAnalysis() {
            const apiKey = document.getElementById('ai-key').value.trim();
            const text = document.getElementById('ai-input').value.trim();
            
            if (!apiKey) return alert('è«‹è¼¸å…¥ API Key');
            if (!text) return alert('è«‹è¼¸å…¥å…§å®¹');
            
            localStorage.setItem('gemini_api_key', apiKey);
            document.getElementById('ai-loading').classList.remove('hidden');

            const sourcePanel = document.getElementById('source-panel');
            const sourceTextarea = document.getElementById('source-textarea');
            sourceTextarea.value = text;
            sourcePanel.classList.remove('closed');
            sourcePanel.classList.add('open');
            // æ‰‹å‹•è§¸ç™¼å´é‚Šæ¬„æ‰“é–‹æ™‚çš„æ¨£å¼æ›´æ–°
            document.getElementById('main-container').classList.add('shifted');

            if (currentSessionId && !isReadOnly && isFirebaseReady) {
                updateFirestoreSourceText(text);
            }
            
            const prompt = `
                ä½ æ˜¯ä¸€ä½å•†æ¥­ç­–ç•¥é¡§å•ã€‚è«‹åˆ†æä»¥ä¸‹éçµæ§‹åŒ–çš„æ–‡æœ¬ï¼Œå°‡å…¶å…§å®¹æ­¸ç´åˆ°å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Business Model Canvas) çš„ä¹å¤§æ§‹é¢ä¸­ã€‚
                è«‹åš´æ ¼è¼¸å‡ºç‚º JSON æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚JSON éµå€¼å°æ‡‰å¦‚ä¸‹ï¼š
                kp: é—œéµåˆä½œå¤¥ä¼´, ka: é—œéµæ´»å‹•, kr: é—œéµè³‡æº, vp: åƒ¹å€¼ä¸»å¼µ, 
                cr: é¡§å®¢é—œä¿‚, ch: é€šè·¯, cs: ç›®æ¨™å®¢ç¾¤, cost: æˆæœ¬çµæ§‹, revenue: æ”¶ç›Šæµã€‚
                æ¯å€‹å€¼è«‹ä½¿ç”¨æ¢åˆ—å¼æ–‡å­— (ç”¨æ›è¡Œç¬¦è™Ÿæˆ–åˆ†è™Ÿåˆ†éš”)ã€‚

                æ–‡æœ¬å…§å®¹ï¼š
                ${text}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (!data.candidates) throw new Error("AI å›æ‡‰ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ API Key");
                const rawResult = data.candidates[0].content.parts[0].text;
                const jsonString = rawResult.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonString);

                BLOCKS.forEach(key => {
                    if (result[key]) {
                        const cell = document.getElementById(`cell-${key}`);
                        const textarea = cell.querySelector('textarea');
                        textarea.value = result[key];
                        autoResize(textarea); // AI å¡«å…¥å¾Œè‡ªå‹•èª¿æ•´é«˜åº¦
                        if (currentSessionId && !isReadOnly && isFirebaseReady) {
                            updateFirestoreDebounced(key, result[key]);
                        }
                    }
                });
                toggleModal('ai-modal');
                alert('AI åˆ†æå®Œæˆï¼');
            } catch (err) {
                console.error(err);
                alert('åˆ†æå¤±æ•—ï¼š' + err.message);
            } finally {
                document.getElementById('ai-loading').classList.add('hidden');
            }
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.classList.toggle('active');
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            document.execCommand("copy");
            alert("é€£çµå·²è¤‡è£½");
        }

        function clearCanvas() {
            if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ')) return;
            document.querySelectorAll('.bmc-textarea').forEach(t => {
                t.value = '';
                autoResize(t); // æ¸…ç©ºå¾Œé‡ç½®é«˜åº¦
                if (currentSessionId && !isReadOnly && isFirebaseReady) updateFirestoreDebounced(t.parentElement.id.split('-')[1], '');
            });
            document.querySelectorAll('.bmc-cell').forEach(c => {
                c.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
                if (currentSessionId && !isReadOnly && isFirebaseReady) updateFirestoreColor(c.id.split('-')[1], 'none');
            });
        }

        function exportJSON() {
            const data = {};
            BLOCKS.forEach(id => {
                const cell = document.getElementById(`cell-${id}`);
                data[id] = { text: cell.querySelector('textarea').value, color: getCellColor(cell) };
            });
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bmc-data.json';
            a.click();
        }

        function importJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    BLOCKS.forEach(id => {
                        if (data[id]) {
                            const cell = document.getElementById(`cell-${id}`);
                            cell.querySelector('textarea').value = data[id].text || '';
                            autoResize(cell.querySelector('textarea')); // åŒ¯å…¥å¾Œè‡ªå‹•èª¿æ•´é«˜åº¦
                            cell.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
                            if (data[id].color && data[id].color !== 'none') cell.classList.add(`tag-${data[id].color}`);
                            if (currentSessionId && !isReadOnly && isFirebaseReady) {
                                updateFirestoreDebounced(id, data[id].text);
                                updateFirestoreColor(id, data[id].color);
                            }
                        }
                    });
                } catch (err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(file);
        }

        function takeScreenshot() {
            const btn = document.getElementById('screenshot-btn');
            const originalText = btn.innerHTML;
            btn.textContent = 'æˆªåœ–ä¸­...';
            html2canvas(document.getElementById('canvas-area'), { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'bmc-canvas.png';
                a.click();
                btn.innerHTML = originalText;
            });
        }
    </script>
</body>
</html>
