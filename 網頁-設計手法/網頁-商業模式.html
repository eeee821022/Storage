<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Business Model Canvas) å”ä½œå·¥å…·</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs (ä½¿ç”¨æ¨¡çµ„åŒ–å°å…¥çš„ç›¸å®¹æ€§å¯«æ³•) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <!-- Showdown ç”¨æ–¼ Markdown è§£æ (Gemini è¼¸å‡ºè™•ç†) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <!-- å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #334155; /* slate-700 */
        }

        /* BMC Grid Layout */
        .bmc-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(3, minmax(180px, auto));
            gap: 0.5rem;
            background-color: #cbd5e1; /* border color */
            border: 0.5rem solid #cbd5e1;
            border-radius: 0.5rem;
        }

        /* RWD for Mobile */
        @media (max-width: 1024px) {
            .bmc-grid {
                display: flex;
                flex-direction: column;
            }
            .bmc-cell {
                min-height: 200px;
            }
        }

        .bmc-cell {
            background-color: white;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.2s;
        }

        .bmc-cell h3 {
            font-size: 0.875rem;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            pointer-events: none; /* Prevent clicking title */
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .bmc-icon {
            width: 1.25rem;
            height: 1.25rem;
            opacity: 0.7;
        }

        .bmc-textarea {
            flex: 1;
            width: 100%;
            resize: none;
            border: none;
            outline: none;
            font-size: 0.95rem;
            line-height: 1.6;
            background: transparent;
            min-height: 100px;
        }

        /* Grid Positioning */
        .area-kp { grid-column: 1 / 3; grid-row: 1 / 3; }
        .area-ka { grid-column: 3 / 5; grid-row: 1 / 2; }
        .area-kr { grid-column: 3 / 5; grid-row: 2 / 3; }
        .area-vp { grid-column: 5 / 7; grid-row: 1 / 3; }
        .area-cr { grid-column: 7 / 9; grid-row: 1 / 2; }
        .area-ch { grid-column: 7 / 9; grid-row: 2 / 3; }
        .area-cs { grid-column: 9 / 11; grid-row: 1 / 3; }
        /* ä¿®æ­£ Class åç¨±ï¼Œç§»é™¤ $ ç¬¦è™Ÿä»¥ä¿®å¾© CSS é¸æ“‡å™¨å•é¡Œ */
        .area-cost { grid-column: 1 / 6; grid-row: 3 / 4; height: auto; min-height: 120px;}
        .area-revenue { grid-column: 6 / 11; grid-row: 3 / 4; height: auto; min-height: 120px;}

        /* Color Tags */
        .tag-yellow { background-color: #fef9c3; }
        .tag-green { background-color: #dcfce7; }
        .tag-red { background-color: #fee2e2; }
        .tag-blue { background-color: #dbeafe; }

        /* Action Button Style */
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: #334152;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .action-button:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            color: #64748b;
        }
        
        .primary-btn {
            background-color: #2563eb;
            color: white;
            border: 1px solid #2563eb;
        }
        .primary-btn:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .primary-btn svg { color: white; }

        /* Modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Connection Status Indicator */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-connecting { background-color: #fbbf24; } /* Yellow */
        .status-connected { background-color: #22c55e; } /* Green */
        .status-error { background-color: #ef4444; } /* Red */
    </style>
</head>
<body>

    <!-- å³ä¸Šè§’èªªæ˜æŒ‰éˆ• -->
    <button onclick="toggleModal('help-modal')" class="fixed top-6 right-6 z-50 p-3 bg-white rounded-full shadow-lg text-blue-600 hover:bg-blue-50 transition-colors border border-blue-100" title="ä½¿ç”¨èªªæ˜">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>
    </button>

    <div class="container mx-auto max-w-[1400px] p-4 md:p-8 pt-16">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">å•†æ¥­æ¨¡å¼ç•«å¸ƒ <span class="text-blue-600">BMC</span></h1>
            <p class="text-slate-500">Business Model Canvas</p>
            
            <!-- ç³»çµ±ç‹€æ…‹é¡¯ç¤º -->
            <div class="mt-4 flex justify-center gap-4">
                 <!-- é€£ç·šç‹€æ…‹ -->
                <div id="connection-status" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 text-slate-600 text-sm">
                    <span class="status-indicator status-connecting"></span>
                    <span id="connection-text">é€£ç·šä¸­...</span>
                </div>
                
                <!-- å”ä½œç‹€æ…‹ (éš±è—ç›´åˆ°åŠ å…¥ Session) -->
                <div id="collab-status" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-50 text-blue-700 border border-blue-100 text-sm hidden">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span id="collab-text"></span>
                </div>
            </div>
        </header>

        <!-- å·¥å…·åˆ— -->
        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button onclick="toggleModal('ai-modal')" class="action-button primary-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09 3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
                </svg>
                AI æ™ºèƒ½åˆ†æ
            </button>
            <!-- ç§»é™¤ disabled å±¬æ€§ï¼Œæ”¹ç‚ºé»æ“Šæ™‚æª¢æŸ¥ -->
            <button id="collab-setup-btn" onclick="checkAndToggleCollab()" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
                </svg>
                å¤šäººå”ä½œè¨­å®š
            </button>
            <button id="import-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                åŒ¯å…¥
            </button>
            <button id="export-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                åŒ¯å‡º
            </button>
            <button id="screenshot-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.174a2.31 2.31 0 0 0-1.64 2.288v7.517A2.31 2.31 0 0 0 4.615 21h14.77a2.31 2.31 0 0 0 2.31-2.31v-7.517a2.31 2.31 0 0 0-1.64-2.288c-.377-.062-.754-.12-1.134-.174a2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.776 48.776 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.04l-.821 1.316Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" /></svg>
                æˆªåœ–
            </button>
            <button id="clear-btn" class="action-button text-red-600 hover:bg-red-50 border-red-200 hover:border-red-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.578 0c-.267.03-.53.062-.79.098m14.055 0a47.905 47.905 0 0 1-4.472 0m-8.58 0a47.905 47.905 0 0 0-4.472 0" /></svg>
                æ¸…ç©º
            </button>
        </div>

        <!-- ç•«å¸ƒä¸»é«” -->
        <div id="canvas-area" class="bmc-grid shadow-xl">
            
            <!-- 1. é—œéµåˆä½œå¤¥ä¼´ Key Partners -->
            <div class="bmc-cell area-kp" id="cell-kp">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    é—œéµåˆä½œå¤¥ä¼´ (KP)
                </h3>
                <textarea class="bmc-textarea" placeholder="ä¾›æ‡‰å•†ã€åˆä½œå¤¥ä¼´ã€å¤–åŒ…è³‡æº..."></textarea>
            </div>

            <!-- 2. é—œéµæ´»å‹• Key Activities -->
            <div class="bmc-cell area-ka" id="cell-ka">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    é—œéµæ´»å‹• (KA)
                </h3>
                <textarea class="bmc-textarea" placeholder="ç”Ÿç”¢ã€è§£æ±ºå•é¡Œã€å¹³å°/ç¶²çµ¡..."></textarea>
            </div>

            <!-- 3. é—œéµè³‡æº Key Resources -->
            <div class="bmc-cell area-kr" id="cell-kr">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    é—œéµè³‡æº (KR)
                </h3>
                <textarea class="bmc-textarea" placeholder="å¯¦é«”è³‡ç”¢ã€æ™ºæ…§è²¡ç”¢ã€äººåŠ›ã€é‡‘è..."></textarea>
            </div>

            <!-- 4. åƒ¹å€¼ä¸»å¼µ Value Propositions -->
            <div class="bmc-cell area-vp" id="cell-vp">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>
                    åƒ¹å€¼ä¸»å¼µ (VP)
                </h3>
                <textarea class="bmc-textarea" placeholder="ç‚ºå®¢æˆ¶è§£æ±ºä»€éº¼å•é¡Œï¼Ÿæä¾›ä»€éº¼åƒ¹å€¼ï¼Ÿç”¢å“ç‰¹è‰²..."></textarea>
            </div>

            <!-- 5. é¡§å®¢é—œä¿‚ Customer Relationships -->
            <div class="bmc-cell area-cr" id="cell-cr">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                    é¡§å®¢é—œä¿‚ (CR)
                </h3>
                <textarea class="bmc-textarea" placeholder="å€‹äººåŠ©ç†ã€è‡ªåŠ©æœå‹™ã€ç¤¾ç¾¤ã€å…±å‰µ..."></textarea>
            </div>

            <!-- 6. é€šè·¯ Channels -->
            <div class="bmc-cell area-ch" id="cell-ch">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    é€šè·¯ (CH)
                </h3>
                <textarea class="bmc-textarea" placeholder="ç¶²ç«™ã€å¯¦é«”åº—ã€æ¥­å‹™åœ˜éšŠã€åˆä½œå¤¥ä¼´..."></textarea>
            </div>

            <!-- 7. ç›®æ¨™å®¢ç¾¤ Customer Segments -->
            <div class="bmc-cell area-cs" id="cell-cs">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    ç›®æ¨™å®¢ç¾¤ (CS)
                </h3>
                <textarea class="bmc-textarea" placeholder="å¤§çœ¾å¸‚å ´ã€åˆ©åŸºå¸‚å ´ã€å¤šé‚Šå¹³å°..."></textarea>
            </div>

            <!-- 8. æˆæœ¬çµæ§‹ Cost Structure -->
            <!-- æ›´æ–° ID å’Œ Class ç§»é™¤ $ ç¬¦è™Ÿ -->
            <div class="bmc-cell area-cost" id="cell-cost">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>
                    æˆæœ¬çµæ§‹ (C$)
                </h3>
                <textarea class="bmc-textarea" placeholder="å›ºå®šæˆæœ¬ã€è®Šå‹•æˆæœ¬ã€è¦æ¨¡ç¶“æ¿Ÿ..."></textarea>
            </div>

            <!-- 9. æ”¶ç›Šæµ Revenue Streams -->
            <!-- æ›´æ–° ID å’Œ Class ç§»é™¤ $ ç¬¦è™Ÿ -->
            <div class="bmc-cell area-revenue" id="cell-revenue">
                <h3>
                    <svg class="bmc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    æ”¶ç›Šæµ (R$)
                </h3>
                <textarea class="bmc-textarea" placeholder="è³‡ç”¢éŠ·å”®ã€ä½¿ç”¨è²»ã€è¨‚é–±è²»ã€æˆæ¬Šè²»..."></textarea>
            </div>

        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-input" accept=".json" class="hidden" />

    <!-- Right Click Menu -->
    <div id="context-menu" class="hidden fixed bg-white shadow-xl rounded-lg border border-slate-200 z-50 text-sm py-1 min-w-[120px]">
        <div class="px-3 py-2 hover:bg-yellow-50 cursor-pointer flex items-center gap-2" onclick="setColor('yellow')">
            <span class="w-3 h-3 rounded-full bg-yellow-200 border border-yellow-300"></span> æ¨™è¨˜é»ƒè‰² (å‡è¨­)
        </div>
        <div class="px-3 py-2 hover:bg-green-50 cursor-pointer flex items-center gap-2" onclick="setColor('green')">
            <span class="w-3 h-3 rounded-full bg-green-200 border border-green-300"></span> æ¨™è¨˜ç¶ è‰² (é©—è­‰)
        </div>
        <div class="px-3 py-2 hover:bg-red-50 cursor-pointer flex items-center gap-2" onclick="setColor('red')">
            <span class="w-3 h-3 rounded-full bg-red-200 border border-red-300"></span> æ¨™è¨˜ç´…è‰² (é¢¨éšª)
        </div>
        <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer flex items-center gap-2" onclick="setColor('blue')">
            <span class="w-3 h-3 rounded-full bg-blue-200 border border-blue-300"></span> æ¨™è¨˜è—è‰² (ä¸€èˆ¬)
        </div>
        <div class="border-t border-slate-100 my-1"></div>
        <div class="px-3 py-2 hover:bg-slate-50 cursor-pointer text-slate-500" onclick="setColor('none')">æ¸…é™¤æ¨™è¨˜</div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl m-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>
                    Gemini æ™ºèƒ½åˆ†æ
                </h3>
                <button onclick="toggleModal('ai-modal')" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Gemini API Key</label>
                    <input type="password" id="ai-key" class="w-full p-2 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">å•†æ¥­è¨ˆç•«/ç­†è¨˜å…§å®¹</label>
                    <textarea id="ai-input" class="w-full h-40 p-3 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹è²¼ä¸Šæ‚¨çš„å•†æ¥­æ§‹æƒ³ã€æœƒè­°è¨˜éŒ„æˆ–æ–‡ç« å…§å®¹..."></textarea>
                </div>
                <div id="ai-loading" class="hidden text-center py-4">
                    <div class="spinner"></div>
                    <p class="text-sm text-slate-500 mt-2">AI æ­£åœ¨åˆ†ææ‚¨çš„å•†æ¥­æ¨¡å¼...</p>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="toggleModal('ai-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-md text-sm">å–æ¶ˆ</button>
                <button onclick="runAIAnalysis()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md text-sm font-medium flex items-center gap-2">
                    é–‹å§‹åˆ†æ
                </button>
            </div>
        </div>
    </div>

    <!-- Collaboration Modal -->
    <div id="collab-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">å¤šäººå”ä½œè¨­å®š</h3>
                <button onclick="toggleModal('collab-modal')" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6">
                <div id="collab-setup-view">
                    <p class="text-sm text-slate-600 mb-4">é–‹å•Ÿå”ä½œæ¨¡å¼å¾Œï¼Œæ‚¨å¯ä»¥é‚€è«‹ä»–äººå³æ™‚å…±åŒç·¨è¼¯é€™ä»½ç•«å¸ƒã€‚</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">è¨­å®šç·¨è¼¯å¯†ç¢¼ (é¸å¡«)</label>
                        <input type="text" id="collab-password-input" class="w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="ç•™ç©ºå‰‡æ‰€æœ‰äººçš†å¯ç·¨è¼¯">
                        <p class="text-xs text-slate-500 mt-1">è‹¥è¨­å®šå¯†ç¢¼ï¼Œè¨ªå®¢éœ€è¼¸å…¥å¯†ç¢¼æ‰èƒ½å–å¾—ç·¨è¼¯æ¬Šé™ï¼Œå¦å‰‡åƒ…èƒ½æª¢è¦–ã€‚</p>
                    </div>
                    <button onclick="startCollaboration()" class="w-full py-2 bg-green-600 text-white hover:bg-green-700 rounded-md font-medium">å»ºç«‹æ–°å”ä½œç•«å¸ƒ</button>
                </div>

                <div id="collab-active-view" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-md p-3 mb-4 flex items-start gap-3">
                        <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div>
                            <p class="text-sm font-bold text-green-800">å”ä½œå·²å•Ÿç”¨</p>
                            <p class="text-xs text-green-700">æ‚¨çš„ç•«å¸ƒå·²ä¸Šç·šã€‚</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">åˆ†äº«é€£çµ (Session Link)</label>
                        <div class="flex gap-2">
                            <input type="text" id="share-link" readonly class="flex-1 p-2 bg-slate-100 border border-slate-300 rounded-md text-xs text-slate-600">
                            <button onclick="copyLink()" class="px-3 py-2 bg-white border border-slate-300 rounded-md text-slate-600 hover:bg-slate-50 text-sm">è¤‡è£½</button>
                        </div>
                    </div>

                    <div id="password-display-area" class="mb-4 hidden">
                         <label class="block text-sm font-medium text-slate-700 mb-1">ç·¨è¼¯å¯†ç¢¼</label>
                         <code id="display-password" class="block p-2 bg-slate-100 rounded text-sm font-mono"></code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal (For Guests) -->
    <div id="password-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 p-6 text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-2">éœ€è¦ç·¨è¼¯æ¬Šé™</h3>
            <p class="text-sm text-slate-600 mb-4">æ­¤ç•«å¸ƒå—å¯†ç¢¼ä¿è­·ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²è¡Œç·¨è¼¯ï¼Œæˆ–é»æ“Šã€Œåƒ…æª¢è¦–ã€ä»¥å”¯è®€æ¨¡å¼ç€è¦½ã€‚</p>
            <input type="password" id="guest-password-input" class="w-full p-2 border border-slate-300 rounded-md mb-4" placeholder="è¼¸å…¥ç·¨è¼¯å¯†ç¢¼">
            <div class="flex gap-2 justify-center">
                <button onclick="enableReadOnly()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-md text-sm">åƒ…æª¢è¦–</button>
                <button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md text-sm">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">è¨­è¨ˆæ‰‹æ³•ï¼šå•†æ¥­æ¨¡å¼ç•«å¸ƒ</h3>
                <button onclick="toggleModal('help-modal')" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto prose prose-slate max-w-none">
                <table class="w-full text-sm border-collapse border border-slate-200">
                    <tbody>
                        <tr class="border-b">
                            <td class="p-3 bg-slate-50 font-bold w-1/4">æ–¹æ³•åç¨±</td>
                            <td class="p-3">å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Business Model Canvas)</td>
                        </tr>
                        <tr class="border-b">
                            <td class="p-3 bg-slate-50 font-bold">ä¸€å¥è©±ç¸½çµ</td>
                            <td class="p-3">é€éä¹å¤§æ§‹é¢çš„ç³»çµ±æ€§ä½ˆå±€ï¼Œæ¸…æ™°æç¹ªã€åˆ†æä¸¦å‰µæ–°æ‚¨çš„ä¼æ¥­åƒ¹å€¼å‰µé€ é‚è¼¯ã€‚</td>
                        </tr>
                        <tr class="border-b">
                            <td class="p-3 bg-slate-50 font-bold">æ ¸å¿ƒæ¦‚å¿µ</td>
                            <td class="p-3">å°‡ä¼æ¥­é‹ä½œç°¡åŒ–ç‚ºä¹å€‹é—œéµè¦ç´ ï¼ˆåƒ¹å€¼ä¸»å¼µã€å®¢ç¾¤ã€é€šè·¯ç­‰ï¼‰ï¼Œæä¾›ä¸€å€‹è¦–è¦ºåŒ–ã€å–®é å¼çš„åˆ†æå·¥å…·ã€‚</td>
                        </tr>
                        <tr class="border-b">
                            <td class="p-3 bg-slate-50 font-bold">ä½¿ç”¨æµç¨‹</td>
                            <td class="p-3">
                                <ol class="list-decimal pl-4 space-y-1">
                                    <li><strong>åƒ¹å€¼ä¸»å¼µ (VP)ï¼š</strong>æ ¸å¿ƒåƒ¹å€¼æ˜¯ä»€éº¼ï¼Ÿè§£æ±ºä»€éº¼å•é¡Œï¼Ÿ</li>
                                    <li><strong>ç›®æ¨™å®¢ç¾¤ (CS)ï¼š</strong>èª°æ˜¯ä½ çš„å®¢æˆ¶ï¼Ÿ</li>
                                    <li><strong>é€šè·¯ (CH)ï¼š</strong>å¦‚ä½•æ¥è§¸å®¢æˆ¶ï¼Ÿ</li>
                                    <li><strong>é¡§å®¢é—œä¿‚ (CR)ï¼š</strong>å¦‚ä½•ç¶­ç¹«å®¢æˆ¶ï¼Ÿ</li>
                                    <li><strong>æ”¶ç›Šæµ (R$)ï¼š</strong>æ€éº¼è³ºéŒ¢ï¼Ÿ</li>
                                    <li><strong>é—œéµè³‡æº (KR)ï¼š</strong>éœ€è¦ä»€éº¼è³‡ç”¢ï¼Ÿ</li>
                                    <li><strong>é—œéµæ´»å‹• (KA)ï¼š</strong>éœ€è¦åšä»€éº¼äº‹ï¼Ÿ</li>
                                    <li><strong>é—œéµå¤¥ä¼´ (KP)ï¼š</strong>èª°å¯ä»¥å¹«å¿™ï¼Ÿ</li>
                                    <li><strong>æˆæœ¬çµæ§‹ (C$)ï¼š</strong>éŒ¢èŠ±åœ¨å“ªè£¡ï¼Ÿ</li>
                                </ol>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="mt-6 p-4 bg-blue-50 rounded-lg text-sm text-blue-800">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong> æ‚¨å¯ä»¥ä½¿ç”¨æœ¬å·¥å…·çš„ <strong>AI æ™ºèƒ½åˆ†æ</strong> åŠŸèƒ½ï¼Œç›´æ¥è²¼ä¸Šæ‚¨çš„ç­†è¨˜ï¼Œè®“ AI å¹«æ‚¨è‡ªå‹•å¡«å¯«é€™ä¹å¤§æ ¼å­ï¼
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bmc-tool-v1';
        let db;
        let currentSessionId = null;
        let unsubscribe = null;
        let isReadOnly = false;
        let localEditPassword = null; // The password required to edit this session
        let isOwner = false;
        let isFirebaseReady = false;

        // Nine Blocks Keys (Updated to match new IDs without special characters)
        const BLOCKS = ['kp', 'ka', 'kr', 'vp', 'cr', 'ch', 'cs', 'cost', 'revenue'];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateConnectionStatus('connecting', 'é€£ç·šä¸­...');
            
            try {
                // Initialize Firebase
                // ğŸ‘‡ğŸ‘‡ğŸ‘‡ åœ¨é€™è£¡è²¼ä¸Šæ‚¨å¾ Firebase å¾Œå°è¤‡è£½çš„è¨­å®š ğŸ‘‡ğŸ‘‡ğŸ‘‡
                const firebaseConfig = {
                    apiKey: "AIzaSyDyB_rJ37rHW1uwpQNASlWc53AjsPwh2EE",
                    authDomain: "business-model-canvas-3da74.firebaseapp.com",
                    projectId: "business-model-canvas-3da74",
                    storageBucket: "business-model-canvas-3da74.firebasestorage.app",
                    messagingSenderId: "922978479250",
                    appId: "1:922978479250:web:21f376739dd4a312a68a4b",
                    measurementId: "G-VDQYMC8DLG"
                };
                // ğŸ‘†ğŸ‘†ğŸ‘†------------------------------------------ğŸ‘†ğŸ‘†ğŸ‘†

                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ App è¢«åˆå§‹åŒ–ï¼Œé¿å…é‡è¤‡éŒ¯èª¤
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                } else {
                    firebase.app(); // ä½¿ç”¨å·²å­˜åœ¨çš„ app
                }

                db = firebase.firestore();
                const auth = firebase.auth();
                
                // Auth State Listener
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Login Success
                        isFirebaseReady = true;
                        updateConnectionStatus('connected', 'å·²é€£ç·š');
                        
                        // Enable Collaboration Button
                        const collabBtn = document.getElementById('collab-setup-btn');
                        collabBtn.disabled = false;
                        collabBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        collabBtn.title = "è¨­å®šå¤šäººå”ä½œ";

                        // Check URL for session AFTER auth is ready
                        const urlParams = new URLSearchParams(window.location.search);
                        const session = urlParams.get('session');
                        if (session && !currentSessionId) {
                            await joinSession(session);
                        }
                    } else {
                        // Re-trigger login if somehow logged out
                            await performLogin(auth);
                    }
                });
                
                    // Trigger initial login
                    await performLogin(auth);

            } catch (e) {
                console.error("Firebase Init Error:", e);
                // é¡¯ç¤ºæ›´å…·é«”çš„éŒ¯èª¤è¨Šæ¯çµ¦ä½¿ç”¨è€…
                updateConnectionStatus('error', 'é€£ç·šå¤±æ•—: ' + e.message);
            }

            // Setup Local Interactions
            setupInteractions();
        });

        // Helper for button click
        function checkAndToggleCollab() {
            if (!isFirebaseReady) {
                alert('ç³»çµ±å°šæœªå®Œæˆé€£ç·šæˆ– Firebase è¨­å®šæœ‰èª¤ï¼Œæš«æ™‚ç„¡æ³•ä½¿ç”¨å¤šäººå”ä½œåŠŸèƒ½ã€‚');
                return;
            }
            toggleModal('collab-modal');
        }

        async function performLogin(auth) {
            try {
                 // å˜—è©¦åŒ¿åç™»å…¥
                 await auth.signInAnonymously();
            } catch(err) {
                console.error("Login failed:", err);
                // Display more informative error in status
                let errorMsg = 'ç™»å…¥å¤±æ•—';
                if (err.code === 'auth/configuration-not-found') {
                    errorMsg = 'Firebase Auth è¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ˜¯å¦å·²å•Ÿç”¨åŒ¿åç™»å…¥';
                } else if (err.code === 'auth/operation-not-allowed') {
                    errorMsg = 'Firebase æœªå•Ÿç”¨åŒ¿åç™»å…¥åŠŸèƒ½';
                } else {
                    errorMsg += ': ' + err.code;
                }
                updateConnectionStatus('error', errorMsg);
            }
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.querySelector('#connection-status .status-indicator');
            const textEl = document.getElementById('connection-text');
            
            indicator.className = 'status-indicator'; // Reset
            textEl.textContent = text;

            if (status === 'connected') {
                indicator.classList.add('status-connected');
            } else if (status === 'error') {
                indicator.classList.add('status-error');
            } else {
                indicator.classList.add('status-connecting');
            }
        }

        // --- Interaction Logic ---
        let currentContextCell = null;

        function setupInteractions() {
            // Right click menu
            document.addEventListener('click', () => document.getElementById('context-menu').classList.add('hidden'));
            
            document.querySelectorAll('.bmc-cell').forEach(cell => {
                // Context Menu
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (isReadOnly) return;
                    currentContextCell = cell;
                    const menu = document.getElementById('context-menu');
                    menu.style.left = `${e.clientX}px`;
                    menu.style.top = `${e.clientY}px`;
                    menu.classList.remove('hidden');
                });

                // Input Sync (Local or Remote)
                const textarea = cell.querySelector('textarea');
                textarea.addEventListener('input', (e) => {
                    if (currentSessionId && !isReadOnly && isFirebaseReady) {
                        updateFirestoreDebounced(cell.id.split('-')[1], e.target.value);
                    }
                });
            });

            // Import/Export/Screenshot
            document.getElementById('screenshot-btn').addEventListener('click', takeScreenshot);
            document.getElementById('export-btn').addEventListener('click', exportJSON);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', importJSON);
            document.getElementById('clear-btn').addEventListener('click', clearCanvas);
            
            // API Key Persistence
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) document.getElementById('ai-key').value = savedKey;
        }

        function setColor(color) {
            if (!currentContextCell) return;
            currentContextCell.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
            if (color !== 'none') {
                currentContextCell.classList.add(`tag-${color}`);
            }
            
            // Sync color change if needed
            if (currentSessionId && !isReadOnly && isFirebaseReady) {
                const blockId = currentContextCell.id.split('-')[1];
                updateFirestoreColor(blockId, color);
            }
        }

        // --- Collaboration Logic ---

        async function startCollaboration() {
            if (!isFirebaseReady) return alert('å°šæœªé€£ç·šè‡³ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            
            const password = document.getElementById('collab-password-input').value.trim();
            const newSessionId = Math.random().toString(36).substring(2, 10);
            
            // Prepare Initial Data from current local state
            const initialData = {
                created: firebase.firestore.FieldValue.serverTimestamp(),
                editPassword: password || null // Store password in doc (Simple protection)
            };

            BLOCKS.forEach(id => {
                const cell = document.getElementById(`cell-${id}`);
                initialData[id] = {
                    text: cell.querySelector('textarea').value,
                    color: getCellColor(cell)
                };
            });

            try {
                // Write to Firestore
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(newSessionId).set(initialData);
                
                isOwner = true;
                localEditPassword = password; // Owner knows the password automatically
                await joinSession(newSessionId, true);
            } catch (err) {
                console.error("Error creating session", err);
                alert("å»ºç«‹å”ä½œå¤±æ•—: " + err.message);
            }
        }

        async function joinSession(sessionId, justCreated = false) {
            if (!db) return; // Safety check

            currentSessionId = sessionId;
            
            // UI Updates
            document.getElementById('collab-status').classList.remove('hidden');
            document.getElementById('collab-text').textContent = `${sessionId}`;
            document.getElementById('collab-setup-view').classList.add('hidden');
            document.getElementById('collab-active-view').classList.remove('hidden');
            
            // Update URL
            const newUrl = `${window.location.pathname}?session=${sessionId}`;
            window.history.pushState({path: newUrl}, '', newUrl);
            document.getElementById('share-link').value = window.location.href;

            if (justCreated) {
                if (localEditPassword) {
                    document.getElementById('password-display-area').classList.remove('hidden');
                    document.getElementById('display-password').textContent = localEditPassword;
                }
            }

            // Listen to Firestore
            if (unsubscribe) unsubscribe(); // Unsubscribe previous listener if exists

            unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(sessionId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Permission Check for NEW joiners
                        if (!justCreated && !localEditPassword && data.editPassword && !isReadOnly) {
                            // If document has password, and we don't have it locally, prompt user
                            document.getElementById('password-modal').classList.add('active');
                        }

                        // Sync Data to UI
                        BLOCKS.forEach(id => {
                            if (data[id]) {
                                const cell = document.getElementById(`cell-${id}`);
                                const textarea = cell.querySelector('textarea');
                                
                                // Only update if different to avoid cursor jump issues (simple check)
                                if (document.activeElement !== textarea) {
                                    textarea.value = data[id].text || '';
                                }
                                
                                // Sync Color
                                cell.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
                                if (data[id].color && data[id].color !== 'none') {
                                    cell.classList.add(`tag-${data[id].color}`);
                                }
                            }
                        });
                    } else {
                        alert('æ­¤å”ä½œç•«å¸ƒä¸å­˜åœ¨æˆ–æ˜¯å·²è¢«åˆªé™¤');
                        // Reset to local mode
                        currentSessionId = null;
                        document.getElementById('collab-status').classList.add('hidden');
                    }
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    if (error.code === 'permission-denied') {
                         alert("æ¬Šé™ä¸è¶³ï¼šç„¡æ³•è®€å–å”ä½œè³‡æ–™ã€‚è«‹ç¢ºèªæ‚¨å·²é€£ç·šã€‚");
                    }
                });
        }

        function enableReadOnly() {
            isReadOnly = true;
            document.getElementById('password-modal').classList.remove('active');
            document.querySelectorAll('textarea').forEach(el => el.readOnly = true);
            document.getElementById('collab-text').textContent += " (å”¯è®€)";
        }

        function verifyPassword() {
            if (!db || !currentSessionId) return;
            const input = document.getElementById('guest-password-input').value;
            
            // Check against Firestore data (fetched previously in snapshot, but let's fetch once to check)
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).get()
                .then(doc => {
                    if (doc.data().editPassword === input) {
                        localEditPassword = input;
                        document.getElementById('password-modal').classList.remove('active');
                        isReadOnly = false;
                        document.querySelectorAll('textarea').forEach(el => el.readOnly = false);
                    } else {
                        alert('å¯†ç¢¼éŒ¯èª¤');
                    }
                });
        }

        // --- Firestore Updates (Debounced) ---
        let updateTimeouts = {};

        function updateFirestoreDebounced(blockId, text) {
            if (!db || !isFirebaseReady || !currentSessionId) return;
            if (updateTimeouts[blockId]) clearTimeout(updateTimeouts[blockId]);
            
            updateTimeouts[blockId] = setTimeout(() => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).update({
                    [`${blockId}.text`]: text
                }).catch(err => console.error("Update failed:", err));
            }, 500);
        }

        function updateFirestoreColor(blockId, color) {
            if (!db || !isFirebaseReady || !currentSessionId) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sessions').doc(currentSessionId).update({
                [`${blockId}.color`]: color
            }).catch(err => console.error("Color update failed:", err));
        }

        function getCellColor(cell) {
            if (cell.classList.contains('tag-yellow')) return 'yellow';
            if (cell.classList.contains('tag-green')) return 'green';
            if (cell.classList.contains('tag-red')) return 'red';
            if (cell.classList.contains('tag-blue')) return 'blue';
            return 'none';
        }

        // --- AI Analysis Logic ---
        async function runAIAnalysis() {
            const apiKey = document.getElementById('ai-key').value.trim();
            const text = document.getElementById('ai-input').value.trim();
            
            if (!apiKey) return alert('è«‹è¼¸å…¥ API Key');
            if (!text) return alert('è«‹è¼¸å…¥å…§å®¹');
            
            localStorage.setItem('gemini_api_key', apiKey);
            
            document.getElementById('ai-loading').classList.remove('hidden');
            
            // æ›´æ–° Prompt è®“ Gemini è¼¸å‡ºå°æ‡‰æ–°éµå€¼çš„ JSON
            const prompt = `
                ä½ æ˜¯ä¸€ä½å•†æ¥­ç­–ç•¥é¡§å•ã€‚è«‹åˆ†æä»¥ä¸‹æ–‡æœ¬ï¼Œå°‡å…¶å…§å®¹æ­¸ç´åˆ°å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Business Model Canvas) çš„ä¹å¤§æ§‹é¢ä¸­ã€‚
                è«‹åš´æ ¼è¼¸å‡ºç‚º JSON æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚JSON éµå€¼å°æ‡‰å¦‚ä¸‹ï¼š
                kp: é—œéµåˆä½œå¤¥ä¼´, ka: é—œéµæ´»å‹•, kr: é—œéµè³‡æº, vp: åƒ¹å€¼ä¸»å¼µ, 
                cr: é¡§å®¢é—œä¿‚, ch: é€šè·¯, cs: ç›®æ¨™å®¢ç¾¤, cost: æˆæœ¬çµæ§‹, revenue: æ”¶ç›Šæµã€‚
                æ¯å€‹å€¼è«‹ä½¿ç”¨æ¢åˆ—å¼æ–‡å­— (ç”¨æ›è¡Œç¬¦è™Ÿæˆ–åˆ†è™Ÿåˆ†éš”)ã€‚

                æ–‡æœ¬å…§å®¹ï¼š
                ${text}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                const rawResult = data.candidates[0].content.parts[0].text;
                
                // Clean JSON string (remove markdown code blocks if present)
                const jsonString = rawResult.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonString);

                // Populate Canvas
                BLOCKS.forEach(key => {
                    if (result[key]) {
                        const cell = document.getElementById(`cell-${key}`);
                        const textarea = cell.querySelector('textarea');
                        textarea.value = result[key];
                        // Trigger sync if needed
                        if (currentSessionId && !isReadOnly && isFirebaseReady) {
                            updateFirestoreDebounced(key, result[key]);
                        }
                    }
                });
                
                toggleModal('ai-modal');
                alert('AI åˆ†æå®Œæˆï¼');

            } catch (err) {
                console.error(err);
                alert('åˆ†æå¤±æ•—ï¼š' + err.message);
            } finally {
                document.getElementById('ai-loading').classList.add('hidden');
            }
        }

        // --- Helper Functions ---
        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
            } else {
                modal.classList.add('active');
            }
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            document.execCommand("copy");
            alert("é€£çµå·²è¤‡è£½");
        }

        function clearCanvas() {
            if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ')) return;
            document.querySelectorAll('.bmc-textarea').forEach(t => {
                t.value = '';
                if (currentSessionId && !isReadOnly && isFirebaseReady) {
                    const id = t.parentElement.id.split('-')[1];
                    updateFirestoreDebounced(id, '');
                }
            });
            document.querySelectorAll('.bmc-cell').forEach(c => {
                c.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
                if (currentSessionId && !isReadOnly && isFirebaseReady) {
                    const id = c.id.split('-')[1];
                    updateFirestoreColor(id, 'none');
                }
            });
        }

        function exportJSON() {
            const data = {};
            BLOCKS.forEach(id => {
                const cell = document.getElementById(`cell-${id}`);
                data[id] = {
                    text: cell.querySelector('textarea').value,
                    color: getCellColor(cell)
                };
            });
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bmc-data.json';
            a.click();
        }

        function importJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    BLOCKS.forEach(id => {
                        if (data[id]) {
                            const cell = document.getElementById(`cell-${id}`);
                            cell.querySelector('textarea').value = data[id].text || '';
                            cell.classList.remove('tag-yellow', 'tag-green', 'tag-red', 'tag-blue');
                            if (data[id].color && data[id].color !== 'none') {
                                cell.classList.add(`tag-${data[id].color}`);
                            }
                            // Sync
                            if (currentSessionId && !isReadOnly && isFirebaseReady) {
                                updateFirestoreDebounced(id, data[id].text);
                                updateFirestoreColor(id, data[id].color);
                            }
                        }
                    });
                } catch (err) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                }
            };
            reader.readAsText(file);
        }

        function takeScreenshot() {
            const btn = document.getElementById('screenshot-btn');
            const originalText = btn.innerHTML;
            btn.textContent = 'æˆªåœ–ä¸­...';
            
            html2canvas(document.getElementById('canvas-area'), {
                scale: 2,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'bmc-canvas.png';
                a.click();
                btn.innerHTML = originalText;
            });
        }

    </script>
</body>
</html>