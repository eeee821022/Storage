<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½¿ç”¨è€…åœ°åœ– (CJM) è£½ä½œå·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: è¼‰å…¥ html2canvas (æˆªåœ–ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overscroll-behavior: none; /* é˜²æ­¢ç€è¦½å™¨ "æ‹‰å‹•" ç‰¹æ•ˆ */
        }
        
        /* -- ä¸»è¦åœ°åœ–ç¶²æ ¼ -- */
        #map-grid {
            display: grid;
            /* * é—œéµçš„ CSS Grid è¨­å®š: 
             * ç¬¬ 1 æ¬„: 200px (æ³³é“æ¨™é¡Œ)
             * ä¹‹å¾Œçš„æ¬„: æ ¹æ“š --stage-count è®Šæ•¸é‡è¤‡ (æœ€å° 300px, å‡åˆ†å‰©é¤˜ç©ºé–“)
             */
            grid-template-columns: 200px repeat(var(--stage-count, 3), minmax(300px, 1fr));
        }

        /* -- é»è²¼æ¨™é¡Œ -- */
        /* å·¦ä¸Šè§’ (å›ºå®š) */
        .grid-corner {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 20;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        /* éšæ®µæ¨™é¡Œ (æ°´å¹³é»è²¼) */
        .stage-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* æ³³é“æ¨™é¡Œ (å‚ç›´é»è²¼) */
        .lane-header {
            position: sticky;
            left: 0;
            z-index: 10;
        }

        /* -- å…§å®¹å„²å­˜æ ¼ -- */
        .grid-cell {
            min-height: 100px; /* FIX: é™ä½æœ€å°é«˜åº¦ */
            /* è®“å¡ç‰‡å¯ä»¥å‚ç›´æ’åˆ— */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* space-y-2 */
            padding: 0.75rem; /* p-3 */
            border-bottom: 1px solid #e2e8f0; /* border-slate-200 */
            border-right: 1px solid #e2e8f0; /* border-slate-200 */
        }
        
        /* -- å¡ç‰‡æ¨£å¼ -- */
        .card {
            /* cursor: grab; */ /* ç§»é™¤ï¼Œæ”¹ç‚ºé»æ“Šå±•é–‹ */
            transition: all 0.2s ease;
            background-color: #FFFFFF; /* é è¨­èƒŒæ™¯è‰² */
        }
        /* NEW: å¡ç‰‡æ¨™é¡Œ */
        .card-title {
            cursor: pointer; /* æç¤ºå¯é»æ“Š */
            font-weight: 600; /* semibold */
            font-size: 0.875rem; /* text-sm */
            padding: 0.625rem 0.75rem; /* p-2.5 p-3 */
        }
        /* NEW: å¡ç‰‡å…§å®¹ */
        .card-content {
            font-size: 0.875rem; /* text-sm */
            padding: 0 0.75rem 0.625rem 0.75rem;
            cursor: pointer; /* æç¤ºå¯é»æ“Šç·¨è¼¯ */
            border-top: 1px solid #f1f5f9; /* border-slate-100 */
        }
        .card-content:hover {
            background-color: #f8fafc; /* bg-slate-50 */
        }
        
        .card:active {
            /* cursor: grabbing; */ /* ç§»é™¤ */
            transform: none; /* ç§»é™¤ */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); /* shadow-sm */
        }
        .card:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .card.dragging {
            opacity: 0.5;
        }
        
        /* -- æ‹–æ›³ç¶“éçš„å„²å­˜æ ¼ -- */
        .grid-cell.drag-over {
            background-color: #f0f9ff; /* bg-blue-50 */
            outline: 2px dashed #3b82f6; /* outline-blue-500 */
        }

        /* NEW: æ‹–æ›³æ¨™é¡Œæ™‚çš„æ¨£å¼ */
        .stage-header, .lane-header {
            cursor: grab;
        }
        .stage-header.dragging, .lane-header.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .stage-header.drag-over-before {
            border-left: 4px solid #3b82f6; /* blue-500 */
        }
        .lane-header.drag-over-before {
            border-top: 4px solid #3b82f6; /* blue-500 */
        }


        /* -- æƒ…ç·’æ›²ç·šå„²å­˜æ ¼ -- */
        .emotion-lane-cell {
            grid-column: 2 / -1; /* é—œéµ: è®“æ­¤å„²å­˜æ ¼æ©«è·¨æ‰€æœ‰ "éšæ®µ" æ¬„ */
            padding: 0;
            position: relative;
        }
        .emotion-lane-cell svg {
            width: 100%;
            height: 100%;
            overflow: visible; /* è®“é»é»å¯ä»¥è¶…å‡ºé‚Šç•Œ */
        }
        .emotion-lane-cell .emotion-line {
            fill: none;
            stroke: #3b82f6; /* stroke-blue-500 */
            stroke-width: 3;
            vector-effect: non-scaling-stroke;
        }
        .emotion-lane-cell .emotion-point {
            fill: #3b82f6; /* fill-blue-500 */
            stroke: white;
            stroke-width: 2;
            cursor: ns-resize; /* ä¸Šä¸‹æ‹–æ›³ */
            transition: all 0.1s ease;
        }
        .emotion-lane-cell .emotion-point:hover {
            r: 10;
            fill: #2563eb; /* fill-blue-600 */
        }
        .emotion-lane-cell .grid-line {
            stroke: #e2e8f0; /* stroke-slate-200 */
            stroke-width: 1;
            stroke-dasharray: 4 4;
        }
        .emotion-lane-cell .emotion-label {
            font-size: 0.75rem;
            fill: #64748b; /* fill-slate-500 */
            user-select: none;
        }

        /* -- å½ˆå‡ºå¼è¦–çª— (Modal) -- */
        #modal-backdrop {
            transition: opacity 0.2s ease-in-out;
        }
        #modal-panel {
            transition: all 0.2s ease-in-out;
        }
        #modal.hidden #modal-backdrop {
            opacity: 0;
        }
        #modal.hidden #modal-panel {
            opacity: 0;
            transform: translateY(1rem) scale(0.95);
        }
        
        /* -- éš±è—åœ–ç¤ºçš„æŒ‰éˆ• -- */
        .icon-button {
            opacity: 0.4; /* FIX: æé«˜é è¨­é€æ˜åº¦ */
            transition: opacity 0.2s ease;
        }
        .group:hover .icon-button,
        .icon-button:hover {
            opacity: 1;
        }
        
        /* -- çµ±ä¸€æŒ‰éˆ•æ¨£å¼ -- */
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            background-color: #ffffff;
            color: #334155; /* text-slate-700 */
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1; /* border-slate-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .action-button:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #94a3b8; /* border-slate-400 */
        }
        .action-button svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            color: #64748b; /* text-slate-500 */
        }
        
        .primary-button {
            background-color: #3b82f6; /* bg-blue-600 */
            color: #ffffff;
            border-color: #3b82f6;
        }
        .primary-button:hover {
            background-color: #2563eb; /* bg-blue-700 */
            border-color: #2563eb;
        }
        .primary-button svg {
            color: #ffffff;
        }
        
        .success-button {
            background-color: #10b981; /* bg-green-600 */
            color: #ffffff;
            border-color: #10b981;
        }
        .success-button:hover {
            background-color: #059669; /* bg-green-700 */
            border-color: #059669;
        }
        .success-button svg {
            color: #ffffff;
        }
        
        .gradient-button {
            background: linear-gradient(to right, #3b82f6, #9333ea); /* blue-600 to purple-600 */
            color: #ffffff;
            border: none;
        }
        .gradient-button:hover {
            background: linear-gradient(to right, #2563eb, #7e22ce); /* blue-700 to purple-700 */
        }
        .gradient-button svg {
            color: #ffffff;
        }

        /* NEW: æˆªåœ–æ™‚éš±è—çš„å…ƒç´  */
        .screenshot-hidden {
            display: none !important;
        }

        /* NEW: èªªæ˜å½ˆçª—çš„æ¨£å¼ */
        /* é®ç½© */
        #help-modal-overlay {
            transition: opacity 0.3s ease;
        }
        /* å…§å®¹ */
        #help-modal-content {
            transition: all 0.3s ease;
        }
        #help-modal.hidden #help-modal-overlay {
            opacity: 0;
        }
        #help-modal.hidden #help-modal-content {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        
        /* -- çµ±ä¸€æŒ‰éˆ•æ¨£å¼ -- */
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            background-color: #ffffff;
            color: #334155; /* text-slate-700 */
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1; /* border-slate-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .action-button:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #94a3b8; /* border-slate-400 */
        }
        .action-button svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            color: #64748b; /* text-slate-500 */
        }
        
        .primary-button {
            background-color: #3b82f6; /* bg-blue-600 */
            color: #ffffff;
            border-color: #3b82f6;
        }
        .primary-button:hover {
            background-color: #2563eb; /* bg-blue-700 */
            border-color: #2563eb;
        }
        .primary-button svg {
            color: #ffffff;
        }
        
        .success-button {
            background-color: #10b981; /* bg-green-600 */
            color: #ffffff;
            border-color: #10b981;
        }
        .success-button:hover {
            background-color: #059669; /* bg-green-700 */
            border-color: #059669;
        }
        .success-button svg {
            color: #ffffff;
        }
        
        .gradient-button {
            background: linear-gradient(to right, #3b82f6, #9333ea); /* blue-600 to purple-600 */
            color: #ffffff;
            border: none;
        }
        .gradient-button:hover {
            background: linear-gradient(to right, #2563eb, #7e22ce); /* blue-700 to purple-700 */
        }
        .gradient-button svg {
            color: #ffffff;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800">
    
    <!-- NEW: èªªæ˜æŒ‰éˆ• (ä¾†è‡ªè¦æ ¼æ›¸ 3.1) -->
    <button id="help-button" class="fixed top-6 right-6 z-50 p-3 bg-white rounded-full shadow-lg text-blue-600 hover:bg-blue-50 transition-colors">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
           <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
       </svg>
    </button>
    
    <!-- è¨­å®šæŒ‰éˆ• -->
    <button id="settings-btn" class="fixed top-6 right-20 z-50 p-3 bg-white rounded-full shadow-lg text-slate-600 hover:bg-slate-50 transition-colors">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
           <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
           <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
       </svg>
    </button>
    
    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div class="p-4 md:p-8"> <!-- ç§»é™¤äº† max-w-screen-2xl å’Œ mx-auto -->

        <!-- é ‚éƒ¨ï¼šæ¨™é¡Œèˆ‡ Persona ç·¨è¼¯å€ -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-slate-900">ä½¿ç”¨è€…åœ°åœ– (CJM) è£½ä½œå·¥å…·</h1>
            <p class="text-slate-600 mt-1">é»æ“Šæ–‡å­—å³å¯é–‹å§‹ç·¨è¼¯æ‚¨çš„ä½¿ç”¨è€…åœ°åœ–ã€‚</p>

            <!-- Persona ç·¨è¼¯å€ -->
            <div class="mt-6 bg-white rounded-lg shadow-sm p-5 border border-slate-200">
                <div class="flex items-center space-x-4">
                    <img id="persona-img" src="https://placehold.co/80x80/e2e8f0/64748b?text=Persona" 
                         alt="Persona Avatar" class="w-20 h-20 rounded-full bg-slate-200 object-cover flex-shrink-0">
                    <div class="flex-grow">
                        <input type="text" id="persona-name" 
                               class="text-xl font-semibold w-full p-1 rounded hover:bg-slate-100 focus:bg-slate-100 focus:ring-2 focus:ring-blue-500 outline-none" 
                               value="ç‹å¤§æ˜ (é è¨­ Persona)">
                        <textarea id="persona-desc" 
                                  class="text-sm text-slate-600 w-full p-1 rounded hover:bg-slate-100 focus:bg-slate-100 focus:ring-2 focus:ring-blue-500 outline-none" 
                                  rows="2">é€™æ˜¯ä¸€ä½ 30 æ­²çš„ä¸Šç­æ—ï¼Œä»–å¸Œæœ›åœ¨ä¸‹ç­å¾Œèƒ½å¿«é€Ÿæ‰¾åˆ°å¥åº·çš„æ™šé¤é¸æ“‡ã€‚ä»–å°ç§‘æŠ€ç”¢å“ç†Ÿæ‚‰ï¼Œä½†ç¼ºä¹è€å¿ƒã€‚</textarea>
                    </div>
                </div>
                 <div class="text-xs text-slate-400 mt-2">æç¤ºï¼šæ‚¨å¯ä»¥è²¼ä¸Šåœ–ç‰‡ç¶²å€ä¾†æ›´æ›å·¦å´é ­åƒã€‚</div>
            </div>
        </header>

        <!-- æ§åˆ¶æŒ‰éˆ•å€ -->
        <div class="flex flex-wrap gap-3 my-4">
            <button id="add-stage-btn" class="action-button primary-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                æ–°å¢éšæ®µ (æ¬„)
            </button>
            <button id="add-lane-btn" class="action-button success-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                æ–°å¢æ³³é“ (åˆ—)
            </button>
            <div class="flex-grow"></div>
            
            <button id="import-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
               </svg>
               åŒ¯å…¥
            </button>
            
            <button id="export-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
               </svg>
               åŒ¯å‡º
            </button>
            
            <button id="screenshot-btn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.174a2.31 2.31 0 0 0-1.64 2.288v7.517A2.31 2.31 0 0 0 4.615 21h14.77a2.31 2.31 0 0 0 2.31-2.31v-7.517a2.31 2.31 0 0 0-1.64-2.288c-.377-.062-.754-.12-1.134-.174a2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.776 48.776 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.04l-.821 1.316Z" />
                   <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
               </svg>
               æˆªåœ–
            </button>
            
            <button id="ai-btn" class="action-button gradient-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
               </svg>
               âœ¨ AI ç”Ÿæˆæ—…ç¨‹
            </button>
            
            
            <input type="file" id="import-file" class="hidden" accept=".json">
        </div>

        <!-- åœ°åœ–ä¸»è¦å®¹å™¨ (å¯æ°´å¹³æ²å‹•) -->
        <div id="map-wrapper" class="w-full overflow-auto bg-white rounded-lg shadow-lg border border-slate-200">
            <!-- JavaScript å°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆåœ°åœ–ç¶²æ ¼ -->
            <div id="map-grid">
                <!-- ç¯„ä¾‹ï¼šå·¦ä¸Šè§’ -->
                <!-- <div class="grid-corner p-3 border-b border-r border-slate-200"></div> -->
                
                <!-- ç¯„ä¾‹ï¼šéšæ®µæ¨™é¡Œ -->
                <!-- <div class="stage-header p-3 border-b border-r border-slate-200">éšæ®µ 1</div> -->
                
                <!-- ç¯„ä¾‹ï¼šæ³³é“æ¨™é¡Œ -->
                <!-- <div class="lane-header p-3 border-b border-r border-slate-200">æ³³é“ 1</div> -->
                
                <!-- ç¯„ä¾‹ï¼šå„²å­˜æ ¼ -->
                <!-- <div class="grid-cell p-3 border-b border-r border-slate-200">å…§å®¹</div> -->
            </div>
        </div>

    </div>

    <!-- å½ˆå‡ºå¼ç·¨è¼¯è¦–çª— (Modal) -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- é®ç½©èƒŒæ™¯ -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black/30 backdrop-blur-sm"></div>
        
        <!-- è¦–çª—é¢æ¿ -->
        <div id="modal-panel" class="relative w-full max-w-lg bg-white rounded-lg shadow-xl p-6">
            <h3 id="modal-title" class="text-xl font-semibold mb-4">ç·¨è¼¯å…§å®¹</h3>
            
            <!-- ç·¨è¼¯å€åŸŸ -->
            <div id="modal-content">
                <!-- æ–‡å­—è¼¸å…¥ (å¡ç‰‡ã€æ¨™é¡Œ) -->
                <div id="text-editor" class="hidden">
                    <!-- NEW: æ¨™é¡Œè¼¸å…¥ -->
                    <label for="modal-title-input" class="block text-sm font-medium text-slate-700">æ¨™é¡Œ</label>
                    <input type="text" id="modal-title-input" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">

                    <label for="modal-content-input" class="block text-sm font-medium text-slate-700 mt-4">å…§å®¹</label>
                    <textarea id="modal-content-input" rows="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                
                    <!-- NEW: é¡è‰²é¸æ“‡å™¨ (for cards) -->
                    <label class="block text-sm font-medium text-slate-700 mt-4">æ¨™ç±¤é¡è‰²</label>
                    <div id="modal-color-picker" class="flex space-x-2 mt-2">
                        <!-- é¡è‰²æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ³³é“é¡å‹é¸æ“‡ (æ–°å¢æ³³é“æ™‚) -->
                <div id="lane-type-editor" class="hidden">
                    <label for="modal-lane-name" class="block text-sm font-medium text-slate-700">æ³³é“åç¨±</label>
                    <input type="text" id="modal-lane-name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    
                    <label class="block text-sm font-medium text-slate-700 mt-4">æ³³é“é¡å‹</label>
                    <select id="modal-lane-type" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="text" selected>æ–‡å­—æ³³é“ (æ”¾ç½®å¡ç‰‡)</option>
                        <option value="emotion">æƒ…ç·’æ³³é“ (ç¹ªè£½æ›²ç·š)</option>
                    </select>
                </div>

                <!-- NEW: ç¢ºèªåˆªé™¤ -->
                <div id="confirm-delete-editor" class="hidden">
                    <p id="modal-confirm-text" class="text-slate-700">æ‚¨ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰éˆ• -->
            <div class="flex justify-end space-x-3 mt-6">
                <button id="modal-close-btn" class="bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 transition duration-200">
                    å–æ¶ˆ
                </button>
                <button id="modal-save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition duration-200">
                    å„²å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- 
    ====================================================================
    NEW: èªªæ˜å½ˆå‡ºè¦–çª— (ä¾†è‡ªè¦æ ¼æ›¸ 5)
    ====================================================================
    -->
    <div id="help-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
       <!-- é®ç½©èƒŒæ™¯ (é»æ“Šå¯é—œé–‰) -->
       <div id="help-modal-overlay" class="fixed inset-0 w-full h-full bg-black/50 backdrop-blur-sm"></div>
       
       <!-- å…§å®¹å®¹å™¨ -->
       <div class="flex items-center justify-center min-h-screen p-4">
           <div id="help-modal-content" class="relative w-full max-w-3xl bg-white p-6 md:p-8 rounded-lg shadow-xl overflow-y-auto" style="max-height: 85vh;">
               
               <!-- é—œé–‰æŒ‰éˆ• (è¦æ ¼è¦‹ 3.2) -->
               <button id="help-modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                   </svg>
               </button>
               
               <!-- å½ˆçª—å…§å®¹ (å·²æ›¿æ›ç‚º CJM ä»‹ç´¹ + æ“ä½œæŒ‡å—) -->
               <div class="space-y-8">
                   <h2 class="text-2xl font-bold text-slate-800">æ–¹æ³•ä»‹ç´¹ï¼šä½¿ç”¨è€…åœ°åœ– (CJM)</h2>
                   
                   <div class="prose max-w-none text-slate-700">
                       <table class="w-full border-collapse border border-slate-200">
                           <tbody class="align-baseline">
                               <tr class="border-b border-slate-200">
                                   <td class="p-3 bg-slate-50 font-semibold w-1/4">æ–¹æ³•åç¨±</td>
                                   <td class="p-3">ä½¿ç”¨è€…åœ°åœ– (Customer Journey Map)</td>
                               </tr>
                               <tr class="border-b border-slate-200">
                                   <td class="p-3 bg-slate-50 font-semibold">ä¸€å¥è©±ç¸½çµ</td>
                                   <td class="p-3">ç«™åœ¨é¡§å®¢çš„è¦–è§’ï¼Œç¹ªè£½å‡ºå®Œæ•´çš„é«”é©—æ­·ç¨‹ï¼Œä»¥ç™¼ç¾é—œéµçš„ç—›é»èˆ‡æ©Ÿæœƒé»ã€‚</td>
                               </tr>
                               <tr class="border-b border-slate-200">
                                   <td class="p-3 bg-slate-50 font-semibold">æ ¸å¿ƒæ¦‚å¿µ</td>
                                   <td class="p-3">é€™æ˜¯ä¸€ç¨®è¦–è¦ºåŒ–å·¥å…·ï¼Œç”¨ä¾†æç¹ªä¸€å€‹ã€Œç‰¹å®šé¡§å®¢ï¼ˆPersonaï¼‰ã€ç‚ºäº†é”æˆæŸå€‹ç›®æ¨™ï¼ˆä¾‹å¦‚ï¼šè³¼è²·å•†å“ã€ç²å¾—æœå‹™ï¼‰æ™‚ï¼Œæ‰€ç¶“æ­·çš„æ¯ä¸€å€‹æ¥è§¸é»ã€æ¡å–çš„è¡Œå‹•ã€å…§å¿ƒçš„æƒ³æ³•èˆ‡æƒ…ç·’æ„Ÿå—ã€‚å®ƒå°‡é›¶æ•£çš„äº’å‹•ä¸²è¯æˆä¸€å€‹å®Œæ•´çš„æ•…äº‹ã€‚</td>
                               </tr>
                               <tr class="border-b border-slate-200">
                                   <td class="p-3 bg-slate-50 font-semibold">è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ</td>
                                   <td class="p-3">æ‰“ç ´ä¼æ¥­å…§éƒ¨çš„ã€Œæµç¨‹æœ¬ä½ã€æˆ–ã€Œéƒ¨é–€æœ¬ä½ã€æ€è€ƒã€‚å®ƒå¹«åŠ©åœ˜éšŠè·³è„«å„è‡ªçš„æ¥­å‹™ç¯„ç–‡ï¼ˆå¦‚è¡ŒéŠ·ã€æ¥­å‹™ã€å®¢æœï¼‰ï¼ŒçœŸæ­£ç†è§£é¡§å®¢åœ¨ã€Œè·¨æ¸ é“ã€ã€ã€Œè·¨éšæ®µã€æ™‚æ‰€æ„Ÿå—åˆ°çš„æ–·é»ã€æŒ«æŠ˜ï¼ˆç—›é»ï¼‰ï¼Œä¸¦æ‰¾å‡ºèƒ½å‰µé€ é«˜å³°é«”é©—ï¼ˆGain Pointï¼‰çš„å¥‘æ©Ÿã€‚</td>
                               </tr>
                               <tr class="border-b border-slate-200">
                                   <td class="p-3 bg-slate-50 font-semibold">æœ€ä½³ä½¿ç”¨æ™‚æ©Ÿ</td>
                                   <td class="p-3"><strong>å°ˆæ¡ˆçš„ã€Œæ¢ç´¢æœŸã€èˆ‡ã€Œæœå‹™è¨­è¨ˆå‰æœŸã€ã€‚</strong><br>ç•¶æ‚¨éœ€è¦æ·±å…¥åŒç†ç¾æœ‰é¡§å®¢çš„é«”é©—ï¼Œæˆ–åœ¨è¦åŠƒæ–°æœå‹™/ç”¢å“æ™‚ï¼Œç”¨ä¾†å®šç¾©ç†æƒ³çš„é¡§å®¢é«”é©—è—åœ–æ™‚ã€‚</td>
                               </tr>
                               <tr class="border-b border-slate-200">
                                   <td class="p-3 bg-slate-50 font-semibold">ä½¿ç”¨æµç¨‹èªªæ˜</td>
                                   <td class="p-3">
                                       <ol class="list-decimal list-inside space-y-1">
                                           <li><strong>è¨­å®šç¯„åœï¼š</strong> æ˜ç¢ºå®šç¾©é€™ä»½åœ°åœ–çš„ä¸»è§’ï¼ˆPersonaï¼‰æ˜¯èª°ï¼Ÿä»–/å¥¹æƒ³é”æˆçš„ã€Œç›®æ¨™ã€æ˜¯ä»€éº¼ï¼Ÿ</li>
                                           <li><strong>åŠƒåˆ†éšæ®µï¼š</strong> æ‹†è§£é¡§å®¢å¾ã€Œé–‹å§‹ã€åˆ°ã€ŒçµæŸã€æ‰€ç¶“æ­·çš„ä¸»è¦éšæ®µã€‚</li>
                                           <li><strong>å¡«å…¥ç´°ç¯€ï¼š</strong> åœ¨æ¯å€‹éšæ®µä¸‹ï¼Œè©³ç´°æè¿°é¡§å®¢çš„ã€Œè¡Œå‹•ã€ã€ã€Œæƒ³æ³•ã€ã€ã€Œæƒ…ç·’ã€åŠã€Œæ¥è§¸é»ã€ã€‚</li>
                                           <li><strong>æ‰¾å‡ºæ–·é»ï¼š</strong> æª¢è¦–æ•´å€‹æµç¨‹ï¼Œç‰¹åˆ¥æ³¨æ„ã€Œæƒ…ç·’ä½è°·ã€ï¼ˆç—›é»ï¼‰å’Œã€Œæµç¨‹å¡é—œã€çš„åœ°æ–¹ã€‚</li>
                                           <li><strong>ç™¼æ˜æ©Ÿæœƒï¼š</strong> é‡å°ç—›é»æ€è€ƒæ”¹å–„æ–¹æ¡ˆï¼Œæˆ–æ€è€ƒå¦‚ä½•å°‡ã€Œæ™®é€šã€çš„é«”é©—è®Šæˆã€Œé©šå–œã€çš„é«”é©—ï¼ˆæ©Ÿæœƒé»ï¼‰ã€‚</li>
                                       </ol>
                                   </td>
                               </tr>
                               <tr>
                                   <td class="p-3 bg-slate-50 font-semibold">å¦‚ä½•è§£è®€åœ°åœ–</td>
                                   <td class="p-3">
                                       <ul class="list-disc list-inside space-y-1">
                                           <li><strong>æ°´å¹³é–±è®€ï¼ˆæ•…äº‹ç·šï¼‰ï¼š</strong> è·Ÿéš¨ä¸€å€‹æ³³é“ï¼ˆå¦‚ï¼šè¡Œå‹•ï¼‰å¾é ­åˆ°å°¾é–±è®€ï¼Œç†è§£é¡§å®¢çš„å®Œæ•´æ•˜äº‹æµç¨‹ã€‚</li>
                                           <li><strong>å‚ç›´é–±è®€ï¼ˆå–®é»åˆ†æï¼‰ï¼š</strong> æª¢è¦–ä¸€å€‹éšæ®µï¼ˆå¦‚ï¼šæ¯”è¼ƒæ–¹æ¡ˆï¼‰ï¼Œå°‡è©²æ¬„ä½ä¸­æ‰€æœ‰çš„è¡Œå‹•ã€æƒ³æ³•ã€ç—›é»ä¸€èµ·çœ‹ï¼Œæ‰¾å‡ºç‰¹å®šæ™‚åˆ»çš„å•é¡Œã€‚</li>
                                           <li><strong>æ‰¾å‡ºé—œéµæ™‚åˆ»ï¼š</strong> ç‰¹åˆ¥é—œæ³¨ã€Œæƒ…ç·’ä½è°·ã€ï¼ˆæœ€éœ€æ”¹å–„ï¼‰ã€ã€Œæƒ…ç·’é«˜å³°ã€ï¼ˆå¯è¤‡è£½çš„æˆåŠŸé»ï¼‰åŠã€Œç—›é»å¢é›†ã€ï¼ˆæœå‹™ç“¶é ¸ï¼‰ã€‚</li>
                                       </ul>
                                   </td>
                               </tr>
                           </tbody>
                       </table>
                   </div>

                   <div class="border-t border-slate-200 pt-6">
                       <h3 class="text-xl font-semibold text-slate-800 mb-3">åŠŸèƒ½æ“ä½œæŒ‡å—</h3>
                       <p class="text-slate-600 mb-4">å¿«é€ŸæŒæ¡ä½¿ç”¨è€…åœ°åœ–å·¥å…·çš„ä¸»è¦æŒ‰éˆ•èˆ‡äº’å‹•æ“ä½œï¼Œæ–¹ä¾¿åœ¨å·¥ä½œåŠæˆ–å°ˆæ¡ˆè¨è«–æ™‚å³æ™‚æŸ¥é–±ã€‚</p>
                       <div class="overflow-x-auto">
                           <table class="w-full border-collapse border border-slate-200 text-sm">
                               <thead class="bg-slate-50 text-left">
                                   <tr>
                                       <th class="p-3 font-semibold border border-slate-200 w-1/3">æ“ä½œ</th>
                                       <th class="p-3 font-semibold border border-slate-200">æ“ä½œèªªæ˜</th>
                                   </tr>
                               </thead>
                               <tbody>
                                   <tr class="border-b border-slate-200">
                                       <td class="p-3 font-medium text-slate-700">æ–°å¢éšæ®µ</td>
                                       <td class="p-3 text-slate-600">é»é¸ <code>#add-stage-btn</code> æ–°å¢æ™‚é–“/éšæ®µæ¬„ï¼Œä¸¦å¯é€éæ‹–æ›³é‡æ–°æ’åºã€‚</td>
                                   </tr>
                                   <tr class="border-b border-slate-200">
                                       <td class="p-3 font-medium text-slate-700">æ–°å¢æ³³é“</td>
                                       <td class="p-3 text-slate-600">é»é¸ <code>#add-lane-btn</code> å»ºç«‹æ–‡å­—æˆ–æƒ…ç·’æ³³é“ï¼ˆä¾‹å¦‚æ¥è§¸é»ã€æƒ…ç·’æ›²ç·šç­‰ï¼‰ã€‚</td>
                                   </tr>
                                   <tr class="border-b border-slate-200">
                                       <td class="p-3 font-medium text-slate-700">ç·¨è¼¯å¡ç‰‡</td>
                                       <td class="p-3 text-slate-600">é»æ“Šå¡ç‰‡å³å¯é–‹å•Ÿç·¨è¼¯å½ˆçª—ï¼Œèª¿æ•´æ¨™é¡Œã€å…§å®¹æˆ–é¡è‰²ï¼›å„²å­˜å¾Œç«‹å³æ›´æ–°ã€‚</td>
                                   </tr>
                                   <tr class="border-b border-slate-200">
                                       <td class="p-3 font-medium text-slate-700">æ‹–æ›³æ’åº</td>
                                       <td class="p-3 text-slate-600">ç›´æ¥æ‹–æ›³å¡ç‰‡åœ¨å„éšæ®µ/æ³³é“é–“ç§»å‹•ï¼Œæ”¾æ‰‹å³è‡ªå‹•å¯«å…¥è³‡æ–™ã€‚</td>
                                   </tr>
                                   <tr class="border-b border-slate-200">
                                       <td class="p-3 font-medium text-slate-700">åŒ¯å…¥ / åŒ¯å‡º</td>
                                       <td class="p-3 text-slate-600">ä½¿ç”¨ <code>#export-btn</code> ä¸‹è¼‰ JSON å‚™ä»½ï¼Œæˆ–é€é <code>#import-btn</code>/<code>#import-file</code> è¼‰å…¥æ—¢æœ‰è³‡æ–™ã€‚</td>
                                   </tr>
                                   <tr class="border-b border-slate-200">
                                       <td class="p-3 font-medium text-slate-700">æˆªåœ–</td>
                                       <td class="p-3 text-slate-600">é»æ“Š <code>#screenshot-btn</code> ç”± html2canvas ç”¢å‡ºæ•´å¼µåœ°åœ– PNGï¼Œé©åˆç°¡å ±æˆ–æ–‡ä»¶ã€‚</td>
                                   </tr>
                                   <tr>
                                       <td class="p-3 font-medium text-slate-700">å‚™ä»½èˆ‡é‚„åŸ</td>
                                       <td class="p-3 text-slate-600">å»ºè­°å®šæœŸåŒ¯å‡ºå‚™ä»½ï¼›ç³»çµ±äº¦æœƒå°‡æœ€æ–°ç‹€æ…‹å­˜æ–¼ localStorage ä»¥é˜²æ„å¤–ã€‚</td>
                                   </tr>
                               </tbody>
                           </table>
                       </div>
                   </div>
               </div>
           </div>
       </div>
    </div>

    <!-- è¨­å®šå½ˆçª— -->
    <div id="settings-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
        <div class="fixed inset-0 w-full h-full bg-black/50 backdrop-blur-sm" id="settings-modal-overlay"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative w-full max-w-md bg-white p-6 rounded-lg shadow-xl">
                <button id="settings-modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-6">è¨­å®š</h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="api-key-input" class="block text-sm font-medium text-slate-700 mb-2">Gemini API Key</label>
                        <input type="password" id="api-key-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key" 
                               class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-slate-500 mt-2">
                            æ‚¨çš„ API Key åƒ…å„²å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">å–å¾— API Key</a>
                        </p>
                    </div>
                    
                    <div>
                        <label for="font-size-input" class="block text-sm font-medium text-slate-700 mb-2">å­—é«”å¤§å°</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="font-size-input" min="10" max="20" value="14" step="1"
                                   class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            <span id="font-size-display" class="text-sm font-semibold text-slate-700 min-w-[3rem]">14px</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">
                            èª¿æ•´æ—…ç¨‹åœ°åœ–å…§å®¹çš„å­—é«”å¤§å°ï¼ˆ10-20pxï¼‰
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI ç”Ÿæˆæ—…ç¨‹å½ˆçª— -->
    <div id="ai-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
        <div class="fixed inset-0 w-full h-full bg-black/50 backdrop-blur-sm" id="ai-modal-overlay"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative w-full max-w-3xl bg-white p-6 rounded-lg shadow-xl" style="max-height: 85vh; overflow-y: auto;">
                <button id="ai-modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-4">âœ¨ AI ç”Ÿæˆä½¿ç”¨è€…æ—…ç¨‹</h2>
                <p class="text-sm text-slate-600 mb-6">
                    ä¸Šå‚³å®¢æˆ¶ç•«åƒè³‡æ–™ä¸¦å®šç¾©ç”¢å“è³‡è¨Šï¼ŒAI å°‡è‡ªå‹•ç”Ÿæˆå®Œæ•´çš„ä½¿ç”¨è€…æ—…ç¨‹åœ°åœ–ã€‚
                </p>
                
                <!-- æ­¥é©Ÿ 1: ä¸Šå‚³æª”æ¡ˆ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">ğŸ“ æ­¥é©Ÿ 1: ä¸Šå‚³å®¢æˆ¶ç•«åƒè³‡æ–™</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">é—œéµå­—è©é›² CSV</label>
                            <div class="flex items-center space-x-2">
                                <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-md file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-blue-50 file:text-blue-700
                                    hover:file:bg-blue-100">
                            </div>
                            <p id="csv-file-status" class="text-xs text-slate-500 mt-1">å°šæœªä¸Šå‚³</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">å®¢æˆ¶ç•«åƒå´å¯« HTMLï¼ˆé¸å¡«ï¼‰</label>
                            <div class="flex items-center space-x-2">
                                <input type="file" id="html-file-input" accept=".html,.txt" class="block w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-md file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-blue-50 file:text-blue-700
                                    hover:file:bg-blue-100">
                            </div>
                            <p id="html-file-status" class="text-xs text-slate-500 mt-1">é¸å¡«ï¼Œå¯æä¾›æ›´è©³ç´°çš„å´å¯«è³‡æ–™</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                è£œå……è³‡æ–™æª”æ¡ˆï¼ˆé¸å¡«ï¼‰
                                <span class="text-xs text-slate-500 font-normal">ï¼ˆå¯ä¸Šå‚³å¤šå€‹æª”æ¡ˆï¼‰</span>
                            </label>
                            <div class="flex items-center space-x-2">
                                <input type="file" id="attachment-file-input" accept=".txt,.md,.pdf,.doc,.docx" multiple class="block w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-md file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-green-50 file:text-green-700
                                    hover:file:bg-green-100">
                            </div>
                            <div id="attachment-file-list" class="mt-2 space-y-1 text-xs text-slate-600">
                                <!-- æª”æ¡ˆåˆ—è¡¨å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                            </div>
                            <p class="text-xs text-slate-500 mt-1">å¯ä¸Šå‚³ TXTã€MDã€PDFã€Word ç­‰è£œå……è³‡æ–™</p>
                        </div>
                    </div>
                </div>
                
                <!-- æ­¥é©Ÿ 2: å®šç¾©æ—…ç¨‹ç¯„åœ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">ğŸ¯ æ­¥é©Ÿ 2: å®šç¾©ä½¿ç”¨è€…æ—…ç¨‹ç¯„åœ</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="journey-scope-input" class="block text-sm font-medium text-slate-700 mb-2">
                                æ—…ç¨‹æ´»å‹•ç¯„åœ
                                <span class="text-xs text-slate-500 font-normal">ï¼ˆä¾‹å¦‚ï¼šå¾ç™¼ç¾éœ€æ±‚åˆ°å®Œæˆè³¼è²·çš„æ•´å€‹éç¨‹ï¼‰</span>
                            </label>
                            <textarea id="journey-scope-input" rows="3" 
                                placeholder="ä¾‹å¦‚ï¼šå¾æ„è­˜åˆ°å¯µç‰©éœ€è¦å¯µç‰©ä¿éšªé–‹å§‹ï¼Œåˆ°å®Œæˆä¿éšªæŠ•ä¿ä¸¦ç²å¾—ä¿å–®çš„å®Œæ•´æµç¨‹"
                                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="stage-count-input" class="block text-sm font-medium text-slate-700 mb-2">
                                    æ—…ç¨‹éšæ®µæ•¸é‡
                                    <span class="text-xs text-slate-500 font-normal">ï¼ˆå»ºè­° 3-5 å€‹ï¼‰</span>
                                </label>
                                <input type="number" id="stage-count-input" value="5" min="3" max="7"
                                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label for="lane-mode-select" class="block text-sm font-medium text-slate-700 mb-2">
                                    æ³³é“æ¨¡å¼
                                    <span class="text-xs text-slate-500 font-normal">ï¼ˆåˆ†æç¶­åº¦ï¼‰</span>
                                </label>
                                <select id="lane-mode-select" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="standard">æ¨™æº–æ¨¡å¼ï¼ˆ5 æ³³é“ï¼‰</option>
                                    <option value="custom">è‡ªè¨‚æ³³é“</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- è‡ªè¨‚æ³³é“å€åŸŸ -->
                        <div id="custom-lanes-container" class="hidden mt-4 p-4 bg-slate-50 rounded-md border border-slate-200">
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                è‡ªè¨‚æ³³é“åˆ—è¡¨
                                <span class="text-xs text-slate-500 font-normal">ï¼ˆæ¯è¡Œä¸€å€‹æ³³é“ï¼Œæ ¼å¼ï¼šåœ–ç¤º åç¨±ï¼‰</span>
                            </label>
                            <textarea id="custom-lanes-input" rows="8" 
                                placeholder="ğŸ¯ è¡Œå‹• (Doing)&#10;ğŸ¤” æƒ³æ³• (Thinking)&#10;ğŸ˜Š æƒ…ç·’ (Feeling)&#10;ğŸ’” ç—›é» (Pain Point)&#10;ğŸ’¡ æ©Ÿæœƒ (Opportunity)"
                                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm">ğŸ¯ è¡Œå‹• (Doing)
ğŸ¤” æƒ³æ³• (Thinking)
ğŸ˜Š æƒ…ç·’ (Feeling)
ğŸ’” ç—›é» (Pain Point)
ğŸ’¡ æ©Ÿæœƒ (Opportunity)</textarea>
                            <p class="text-xs text-slate-500 mt-2">
                                ğŸ’¡ æç¤ºï¼šå¯ä»¥æ ¹æ“šåˆ†æé‡é»è‡ªè¨‚æ³³é“ï¼Œä¾‹å¦‚ã€ŒğŸ” è³‡è¨Šä¾†æºã€ã€ã€ŒğŸ‘¥ æ¥è§¸é»ã€ã€ã€Œâ±ï¸ æ™‚é–“é»ã€ç­‰
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- æ­¥é©Ÿ 3: å®šç¾©ç”¢å“ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">ğŸ“¦ æ­¥é©Ÿ 3: å®šç¾©ç”¢å“/æœå‹™</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="product-name-input" class="block text-sm font-medium text-slate-700 mb-2">ç”¢å“/æœå‹™åç¨±</label>
                            <input type="text" id="product-name-input" placeholder="ä¾‹å¦‚ï¼šå¯µç‰©ä¿éšª App"
                                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="product-desc-input" class="block text-sm font-medium text-slate-700 mb-2">ç”¢å“æè¿°</label>
                            <textarea id="product-desc-input" rows="4" 
                                placeholder="è«‹æè¿°ç”¢å“çš„æ ¸å¿ƒåŠŸèƒ½ã€ç‰¹è‰²ã€ç›®æ¨™ä½¿ç”¨è€…ç­‰..."
                                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- ç”ŸæˆæŒ‰éˆ• -->
                <div class="flex justify-end space-x-3">
                    <button id="ai-cancel-btn" class="px-4 py-2 border border-slate-300 rounded-md text-slate-700 hover:bg-slate-50">
                        å–æ¶ˆ
                    </button>
                    <button id="ai-generate-journey-btn" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-md hover:from-blue-700 hover:to-purple-700 font-semibold">
                        ğŸš€ é–‹å§‹ç”Ÿæˆ
                    </button>
                </div>
                
                <!-- è¼‰å…¥ä¸­ -->
                <div id="ai-loading" class="hidden mt-6 text-center">
                    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-slate-600">AI æ­£åœ¨åˆ†æè³‡æ–™ä¸¦ç”Ÿæˆæ—…ç¨‹åœ°åœ–ï¼Œè«‹ç¨å€™...</p>
                </div>
                
                <!-- çµæœé¡¯ç¤º -->
                <div id="ai-result" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-md">
                    <p class="text-green-800 font-semibold">âœ“ ç”Ÿæˆå®Œæˆï¼</p>
                    <p class="text-sm text-green-700 mt-1">ä½¿ç”¨è€…æ—…ç¨‹å·²æˆåŠŸåŒ¯å…¥åˆ°åœ°åœ–ä¸­ã€‚</p>
                </div>
                
                <div id="ai-error" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-md">
                    <p class="text-red-800 font-semibold">ç”Ÿæˆå¤±æ•—</p>
                    <p class="text-sm text-red-700 mt-1" id="ai-error-message">è«‹æª¢æŸ¥æ‚¨çš„è¨­å®šä¸¦é‡è©¦ã€‚</p>
                </div>
            </div>
        </div>
    </div>


    <!-- 
    ====================================================================
    JavaScript æ‡‰ç”¨ç¨‹å¼é‚è¼¯
    ====================================================================
    -->
    <script type="module">
        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç®¡ç† ---

        // NEW: å¡ç‰‡é¡è‰²
        const CARD_COLORS = [
            '#FFFFFF', // White
            '#FFF9C4', // Yellow
            '#C8E6C9', // Green
            '#BBDEFB', // Blue
            '#FFCDD2', // Red
            '#E1BEE7', // Purple
        ];

        // é è¨­è³‡æ–™
        const getDefaultData = () => ({
            persona: {
                name: 'ç‹å¤§æ˜ (é è¨­ Persona)',
                desc: 'é€™æ˜¯ä¸€ä½ 30 æ­²çš„ä¸Šç­æ—ï¼Œä»–å¸Œæœ›åœ¨ä¸‹ç­å¾Œèƒ½å¿«é€Ÿæ‰¾åˆ°å¥åº·çš„æ™šé¤é¸æ“‡ã€‚ä»–å°ç§‘æŠ€ç”¢å“ç†Ÿæ‚‰ï¼Œä½†ç¼ºä¹è€å¿ƒã€‚',
                img: 'https://placehold.co/80x80/e2e8f0/64748b?text=Persona'
            },
            stages: [
                { id: 's1', name: '1. å¯Ÿè¦ºéœ€æ±‚' },
                { id: 's2', name: '2. æœå°‹è³‡æ–™' },
                { id: 's3', name: '3. æ¯”è¼ƒæ–¹æ¡ˆ' },
                { id: 's4', name: '4. è³¼è²·é«”é©—' },
                { id: 's5', name: '5. å”®å¾Œåˆ†äº«' },
            ],
            lanes: [
                { id: 'l1', name: 'ğŸ¯ è¡Œå‹• (Doing)', type: 'text' },
                { id: 'l2', name: 'ğŸ¤” æƒ³æ³• (Thinking)', type: 'text' },
                { id: 'l3', name: 'ğŸ˜Š æƒ…ç·’ (Feeling)', type: 'emotion' },
                { id: 'l4', name: 'ğŸ’” ç—›é» (Pain Point)', type: 'text' },
                { id: 'l5', name: 'ğŸ’¡ æ©Ÿæœƒ (Opportunity)', type: 'text' },
            ],
            // å„²å­˜æ ¼å…§å®¹
            // 'grid' ç‰©ä»¶çš„ key æ˜¯ 'laneId_stageId'
            // 'text' é¡å‹æ³³é“: å„²å­˜å¡ç‰‡é™£åˆ— [ {id: 'c1', title: '...', content: '...', color: '...'} ]
            // 'emotion' é¡å‹æ³³é“: å„²å­˜ 1-5 çš„ åˆ†æ•¸
            grid: {
                'l1_s1': [{ id: 'c1', title: 'è‚šå­é¤“äº†', content: 'æƒ³åƒé»å¥åº·çš„', color: '#FFF9C4' }],
                'l1_s2': [{ id: 'c2', title: 'æœå°‹ã€Œå¥åº·é¤ã€', content: 'æ‰“é–‹æ‰‹æ©Ÿ APP æœå°‹', color: '#FFFFFF' }],
                'l1_s3': [{ id: 'c3', title: 'æ¯”è¼ƒæ–¹æ¡ˆ', content: 'æ¯”è¼ƒå„å®¶åº—çš„è©•åƒ¹å’Œåƒ¹æ ¼', color: '#FFFFFF' }],
                'l1_s4': [{ id: 'c4', title: 'ä¸‹å–®', content: 'ç­‰å¾…å¤–é€', color: '#BBDEFB' }],
                'l1_s5': [{ id: 'c5', title: 'çµ¦äº”æ˜Ÿå¥½è©•', content: 'é¤é»å¥½åƒ', color: '#C8E6C9' }],
                
                'l2_s1': [{ id: 'c6', title: 'ä¸æƒ³åƒæ²¹ç‚¸çš„', content: '', color: '#FFFFFF' }],
                'l2_s2': [{ id: 'c7', title: 'é€™å®¶åº—ä¸éŒ¯', content: 'çœ‹èµ·ä¾†ä¹¾æ·¨', color: '#FFFFFF' }, { id: 'c8', title: 'å»£å‘Šå¤ªå¤š', content: 'æ€éº¼é€™éº¼å¤šå»£å‘Šï¼Ÿ', color: '#FFCDD2' }],
                'l2_s3': [{ id: 'c9', title: 'é¸æ“‡å›°é›£', content: 'A åº—å¥½åƒä»½é‡å¤šï¼Œä½† B åº—è©•åƒ¹å¥½', color: '#FFFFFF' }],
                'l2_s4': [{ id: 'c10', title: 'å¸Œæœ›æº–æ™‚', content: 'è‚šå­å¾ˆé¤“äº†', color: '#FFFFFF' }],
                'l2_s5': [{ id: 'c11', title: 'ä¸‹æ¬¡å†é»', content: 'åŠ å…¥æ”¶è—', color: '#FFFFFF' }],

                'l3_s1': 3, // æƒ…ç·’åˆ†æ•¸ (1-5)
                'l3_s2': 4,
                'l3_s3': 2,
                'l3_s4': 3,
                'l3_s5': 5,
                
                'l4_s2': [{ id: 'c12', content: 'æœå°‹çµæœå¤ªå¤šï¼Œçœ¼èŠ±æ’©äº‚', color: '#FFCDD2' }],
                'l4_s3': [{ id: 'c13', content: 'é¤é»çš„å¯¦éš›ç…§ç‰‡å¤ªå°‘', color: '#FFCDD2' }],
                'l4_s4': [{ id: 'c14', content: 'ä»˜æ¬¾æµç¨‹å¡äº†ä¸€ä¸‹', color: '#FFCDD2' }],
            }
        });

        // æ‡‰ç”¨ç¨‹å¼ä¸»ç‹€æ…‹
        let state = {
            mapData: getDefaultData(),
            modal: {
                isOpen: false,
                type: null, // 'stage', 'lane', 'card', 'newLane'
                context: {}, // { stageId, laneId, cellId, cardId }
            },
            drag: {
                isDragging: false,
                type: null, // NEW: 'card', 'stage', 'lane'
                cardId: null,
                id: null, // NEW: for stage/lane id
                sourceCellId: null
            },
            emotionDrag: {
                isDragging: false,
                stageId: null,
                laneId: null,
                svgRect: null
            }
        };

        // DOM å…ƒç´ å¿«å–
        const dom = {
            mapWrapper: document.getElementById('map-wrapper'),
            mapGrid: document.getElementById('map-grid'),
            personaName: document.getElementById('persona-name'),
            personaDesc: document.getElementById('persona-desc'),
            personaImg: document.getElementById('persona-img'),
            addStageBtn: document.getElementById('add-stage-btn'),
            addLaneBtn: document.getElementById('add-lane-btn'),
            modal: document.getElementById('modal'),
            modalBackdrop: document.getElementById('modal-backdrop'),
            modalPanel: document.getElementById('modal-panel'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            textEditor: document.getElementById('text-editor'),
            modalTitleInput: document.getElementById('modal-title-input'), // NEW
            modalContentInput: document.getElementById('modal-content-input'), // RENAMED
            modalColorPicker: document.getElementById('modal-color-picker'), // NEW
            laneTypeEditor: document.getElementById('lane-type-editor'),
            modalLaneName: document.getElementById('modal-lane-name'),
            modalLaneType: document.getElementById('modal-lane-type'),
            confirmDeleteEditor: document.getElementById('confirm-delete-editor'), // NEW
            modalConfirmText: document.getElementById('modal-confirm-text'), // NEW
            modalSaveBtn: document.getElementById('modal-save-btn'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importFile: document.getElementById('import-file'),
            screenshotBtn: document.getElementById('screenshot-btn'), // NEW
            
            // NEW: èªªæ˜æŒ‰éˆ•
            helpButton: document.getElementById('help-button'),
            helpModal: document.getElementById('help-modal'),
            helpModalOverlay: document.getElementById('help-modal-overlay'),
            helpModalCloseBtn: document.getElementById('help-modal-close-btn'),
            
            // AI åŠŸèƒ½
            aiBtn: document.getElementById('ai-btn'),
            aiModal: document.getElementById('ai-modal'),
            aiModalOverlay: document.getElementById('ai-modal-overlay'),
            aiModalCloseBtn: document.getElementById('ai-modal-close-btn'),
            csvFileInput: document.getElementById('csv-file-input'),
            htmlFileInput: document.getElementById('html-file-input'),
            attachmentFileInput: document.getElementById('attachment-file-input'),
            csvFileStatus: document.getElementById('csv-file-status'),
            htmlFileStatus: document.getElementById('html-file-status'),
            attachmentFileList: document.getElementById('attachment-file-list'),
            journeyScopeInput: document.getElementById('journey-scope-input'),
            stageCountInput: document.getElementById('stage-count-input'),
            laneModeSelect: document.getElementById('lane-mode-select'),
            customLanesContainer: document.getElementById('custom-lanes-container'),
            customLanesInput: document.getElementById('custom-lanes-input'),
            productNameInput: document.getElementById('product-name-input'),
            productDescInput: document.getElementById('product-desc-input'),
            aiCancelBtn: document.getElementById('ai-cancel-btn'),
            aiGenerateJourneyBtn: document.getElementById('ai-generate-journey-btn'),
            aiLoading: document.getElementById('ai-loading'),
            aiResult: document.getElementById('ai-result'),
            aiError: document.getElementById('ai-error'),
            aiErrorMessage: document.getElementById('ai-error-message'),
            
            // è¨­å®š
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            settingsModalOverlay: document.getElementById('settings-modal-overlay'),
            settingsModalCloseBtn: document.getElementById('settings-modal-close-btn'),
            apiKeyInput: document.getElementById('api-key-input'),
            fontSizeInput: document.getElementById('font-size-input'),
            fontSizeDisplay: document.getElementById('font-size-display'),
        };

        // --- è³‡æ–™å„²å­˜ ---

        const STORAGE_KEY = 'cjm_tool_data';

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.mapData));
                console.log('Data saved.');
            } catch (e) {
                console.error('Error saving data to localStorage:', e);
            }
        }

        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    state.mapData = JSON.parse(data);
                    console.log('Data loaded.');
                } else {
                    console.log('No local data found, using default.');
                    state.mapData = getDefaultData();
                }
            } catch (e) {
                console.error('Error loading data from localStorage:', e);
                state.mapData = getDefaultData();
            }
        }

        // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---

        /**
         * é‡æ–°æ¸²æŸ“æ•´å€‹æ‡‰ç”¨ç¨‹å¼ä»‹é¢
         */
        function render() {
            renderPersona();
            renderMapGrid();
            
            // ç§»é™¤ lucide.createIcons()
            
            // æ‡‰ç”¨å­—é«”å¤§å°è¨­å®š
            const savedFontSize = localStorage.getItem('journey_font_size') || '14';
            setTimeout(() => applyFontSize(savedFontSize), 50);
        }

        /**
         * æ¸²æŸ“ Persona å€åŸŸ
         */
        function renderPersona() {
            dom.personaName.value = state.mapData.persona.name;
            dom.personaDesc.value = state.mapData.persona.desc;
            dom.personaImg.src = state.mapData.persona.img || 'https://placehold.co/80x80/e2e8f0/64748b?text=Persona';
        }

        /**
         * æ¸²æŸ“ä¸»è¦çš„åœ°åœ–ç¶²æ ¼
         */
        function renderMapGrid() {
            const { stages, lanes } = state.mapData;
            
            // æ¸…ç©ºç¶²æ ¼
            dom.mapGrid.innerHTML = '';
            
            // è¨­å®š CSS è®Šæ•¸ï¼Œå‘Šè¨´ Grid æœ‰å¹¾æ¬„
            dom.mapGrid.style.setProperty('--stage-count', stages.length);

            // 1. æ¸²æŸ“å·¦ä¸Šè§’
            const corner = document.createElement('div');
            corner.className = 'grid-corner p-3 border-b border-r border-slate-200';
            dom.mapGrid.appendChild(corner);

            // 2. æ¸²æŸ“éšæ®µæ¨™é¡Œ (ç¬¬ä¸€åˆ—)
            stages.forEach(stage => {
                const header = document.createElement('div');
                header.className = 'stage-header group relative bg-slate-50 p-3 border-b border-r border-slate-200 font-semibold';
                header.draggable = true; // NEW: å¯æ‹–æ›³
                header.dataset.id = stage.id; // NEW: ç¶å®š ID
                header.innerHTML = `
                    <div class="editable-text pointer-events-none" data-type="stage" data-id="${stage.id}">${stage.name}</div>
                    <button class="icon-button absolute top-1 right-1 w-6 h-6 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-red-100 rounded-full" data-action="delete-stage" data-id="${stage.id}">
                        <span class="font-semibold text-lg leading-none pointer-events-none">&times;</span>
                    </button>
                `;
                dom.mapGrid.appendChild(header);
            });

            // 3. æ¸²æŸ“æ³³é“å’Œå„²å­˜æ ¼ (å‰©ä¸‹çš„åˆ—)
            lanes.forEach(lane => {
                // 3a. æ¸²æŸ“æ³³é“æ¨™é¡Œ (ç¬¬ä¸€æ¬„)
                const laneHeader = document.createElement('div');
                laneHeader.className = 'lane-header group relative bg-slate-50 p-3 border-b border-r border-slate-200 font-semibold';
                laneHeader.draggable = true; // NEW: å¯æ‹–æ›³
                laneHeader.dataset.id = lane.id; // NEW: ç¶å®š ID
                laneHeader.innerHTML = `
                    <div class="editable-text pointer-events-none" data-type="lane" data-id="${lane.id}">${lane.name}</div>
                    <button class="icon-button absolute top-1 right-1 w-6 h-6 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-red-100 rounded-full" data-action="delete-lane" data-id="${lane.id}">
                        <span class="font-semibold text-lg leading-none pointer-events-none">&times;</span>
                    </button>
                `;
                dom.mapGrid.appendChild(laneHeader);

                // 3b. æ ¹æ“šæ³³é“é¡å‹æ¸²æŸ“å„²å­˜æ ¼
                if (lane.type === 'emotion') {
                    // OLD: renderEmotionLane(lane);
                    dom.mapGrid.appendChild(renderEmotionLane(lane)); // NEW: æ’å…¥å›å‚³çš„å…ƒç´ 
                } else if (lane.type === 'text') {
                    renderTextCells(lane);
                }
            });
        }

        /**
         * æ¸²æŸ“ 'text' é¡å‹çš„æ‰€æœ‰å„²å­˜æ ¼
         */
        function renderTextCells(lane) {
            state.mapData.stages.forEach(stage => {
                const cellId = `${lane.id}_${stage.id}`;
                const cell = document.createElement('div');
                cell.className = 'grid-cell bg-white';
                cell.dataset.cellId = cellId;
                
                // å–å¾—æ­¤å„²å­˜æ ¼çš„å¡ç‰‡è³‡æ–™
                const cards = state.mapData.grid[cellId] || [];
                
                // æ¸²æŸ“å¡ç‰‡
                cards.forEach(card => {
                    cell.appendChild(createCardElement(card, cellId));
                });
                
                // æ–°å¢å¡ç‰‡æŒ‰éˆ•
                const addCardBtn = document.createElement('button');
                addCardBtn.className = 'mt-2 flex items-center justify-center w-full text-sm text-slate-400 hover:text-blue-600 p-2 rounded-lg hover:bg-slate-100 transition';
                addCardBtn.dataset.action = 'add-card';
                addCardBtn.dataset.cellId = cellId;
                addCardBtn.innerHTML = `<span class="text-lg font-light mr-1 leading-none pointer-events-none">+</span> æ–°å¢å¡ç‰‡`;
                cell.appendChild(addCardBtn);

                dom.mapGrid.appendChild(cell);
            });
        }
        
        /**
         * å»ºç«‹ä¸€å¼µå¡ç‰‡çš„ DOM å…ƒç´ 
         */
        function createCardElement(card, cellId) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card group relative rounded-lg shadow-sm border border-slate-200 hover:border-blue-400';
            cardEl.draggable = true;
            cardEl.dataset.cardId = card.id;
            cardEl.dataset.cellId = cellId;

            // NEW: è¨­å®šå¡ç‰‡é¡è‰² (æ”¹è¨­å®šåœ¨æ¨™é¡Œä¸Š)
            const bgColor = card.color || CARD_COLORS[0];
            const isLightBg = bgColor === '#FFFFFF' || bgColor === '#FFF9C4' || bgColor === '#BBDEFB'; // æ·ºè‰²èƒŒæ™¯
            
            // æ¨™é¡Œ (å¯æ‘ºç–Š)
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header flex justify-between items-center';
            cardHeader.style.backgroundColor = bgColor;
            
            const cardTitle = document.createElement('div');
            cardTitle.className = `card-title flex-grow ${isLightBg ? 'text-slate-800' : 'text-white'} truncate`;
            cardTitle.dataset.action = 'toggle-card';
            cardTitle.textContent = card.title || '(ç„¡æ¨™é¡Œ)';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = `icon-button flex-shrink-0 mr-1 w-5 h-5 flex items-center justify-center ${isLightBg ? 'text-slate-400 hover:text-red-600' : 'text-white/60 hover:text-white'} rounded-full`;
            deleteBtn.dataset.action = 'delete-card';
            deleteBtn.dataset.id = card.id;
            deleteBtn.dataset.cellId = cellId;
            deleteBtn.innerHTML = `<span class="font-semibold text-base leading-none pointer-events-none">&times;</span>`;

            cardHeader.appendChild(cardTitle);
            cardHeader.appendChild(deleteBtn);
            
            // å…§å®¹ (é è¨­éš±è—)
            const cardContent = document.createElement('div');
            cardContent.className = 'card-content hidden';
            cardContent.dataset.action = 'edit-card'; // é»æ“Šå…§å®¹å€å¡Šä¾†ç·¨è¼¯
            // å°‡æ›è¡Œç¬¦è™Ÿè½‰ç‚º <br>
            cardContent.innerHTML = card.content ? card.content.replace(/\n/g, '<br>') : '<span class="text-slate-400">é»æ­¤æ–°å¢å…§å®¹...</span>';
            
            cardEl.appendChild(cardHeader);
            cardEl.appendChild(cardContent);
            
            return cardEl;
        }

        /**
         * æ¸²æŸ“ 'emotion' é¡å‹çš„æ³³é“ (ä¸€å€‹æ©«è·¨çš„ SVG)
         */
        function renderEmotionLane(lane) {
            const { stages } = state.mapData;
            
            const cell = document.createElement('div');
            cell.className = 'grid-cell emotion-lane-cell bg-white';
            // è®“æ­¤å„²å­˜æ ¼æ©«è·¨æ‰€æœ‰ "éšæ®µ" æ¬„
            cell.style.gridColumn = `2 / ${stages.length + 2}`;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${stages.length * 100} 100`);
            svg.setAttribute('preserveAspectRatio', 'none');
            svg.dataset.laneId = lane.id;
            
            // ç¹ªè£½èƒŒæ™¯è¼”åŠ©ç·š
            const labels = ['é«˜èˆˆ', 'æ„‰å¿«', 'æ™®é€š', 'ä¸å¿«', 'æ²®å–ª'];
            for (let i = 0; i < 5; i++) {
                const y = 10 + i * 20; // 10, 30, 50, 70, 90
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 0);
                line.setAttribute('x2', stages.length * 100);
                line.setAttribute('y1', y);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'grid-line'); // *** ä¿®æ­£ 1: ä½¿ç”¨ setAttribute ***
                svg.appendChild(line);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', -5);
                text.setAttribute('y', y + 3);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('class', 'emotion-label'); // *** ä¿®æ­£ 2: ä½¿ç”¨ setAttribute ***
                text.textContent = labels[i];
                svg.appendChild(text);
            }

            // è¨ˆç®—é»ä½ä¸¦ç¹ªè£½æŠ˜ç·š
            const points = [];
            stages.forEach((stage, index) => {
                const cellId = `${lane.id}_${stage.id}`;
                const score = state.mapData.grid[cellId] || 3; // é è¨­ 3 (æ™®é€š)
                const x = 50 + index * 100;
                const y = 110 - score * 20; // 5 -> 10, 4 -> 30, 3 -> 50, 2 -> 70, 1 -> 90
                points.push({ x, y, stageId: stage.id });
            });

            // ç¹ªè£½æŠ˜ç·š
            const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('class', 'emotion-line'); // *** ä¿®æ­£ 3: ä½¿ç”¨ setAttribute ***
            svg.appendChild(path);

            // ç¹ªè£½å¯æ‹–æ›³çš„é»
            points.forEach(p => {
                const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                point.setAttribute('cx', p.x);
                point.setAttribute('cy', p.y);
                point.setAttribute('r', 8);
                point.setAttribute('class', 'emotion-point'); // *** ä¿®æ­£ 4: ä½¿ç”¨ setAttribute ***
                point.dataset.stageId = p.stageId;
                point.dataset.laneId = lane.id;
                svg.appendChild(point);
            });
            
            cell.appendChild(svg);
            // OLD: dom.mapGrid.appendChild(cell);
            return cell; // NEW: å›å‚³ cell å…ƒç´ 
        }

        // --- å½ˆå‡ºè¦–çª— (Modal) é‚è¼¯ ---
        
        /**
         * NEW: æ¸²æŸ“é¡è‰²é¸æ“‡å™¨
         */
        function renderColorPicker(selectedColor) {
            dom.modalColorPicker.innerHTML = '';
            CARD_COLORS.forEach(color => {
                const swatch = document.createElement('button');
                swatch.type = 'button';
                swatch.className = `w-8 h-8 rounded-full border-2 transition`;
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;
                if (color === selectedColor) {
                    swatch.classList.add('border-blue-500', 'ring-2', 'ring-blue-300');
                } else {
                    swatch.classList.add('border-slate-200', 'hover:border-slate-400');
                }
                dom.modalColorPicker.appendChild(swatch);
            });
        }

        function openModal(type, context = {}) {
            state.modal.type = type;
            state.modal.context = context;
            
            // éš±è—æ‰€æœ‰ç·¨è¼¯å™¨
            dom.textEditor.classList.add('hidden');
            dom.laneTypeEditor.classList.add('hidden');
            dom.confirmDeleteEditor.classList.add('hidden'); // NEW
            
            switch (type) {
                case 'stage':
                    dom.modalTitle.textContent = 'ç·¨è¼¯éšæ®µåç¨±';
                    dom.textEditor.classList.remove('hidden');
                    dom.modalTitleInput.classList.add('hidden'); // éš±è—å¡ç‰‡æ¨™é¡Œ
                    dom.modalContentInput.value = state.mapData.stages.find(s => s.id === context.id)?.name || '';
                    dom.modalColorPicker.classList.add('hidden'); // éš±è—é¡è‰²
                    break;
                case 'lane':
                    dom.modalTitle.textContent = 'ç·¨è¼¯æ³³é“åç¨±';
                    dom.textEditor.classList.remove('hidden');
                    dom.modalTitleInput.classList.add('hidden'); // éš±è—å¡ç‰‡æ¨™é¡Œ
                    dom.modalContentInput.value = state.mapData.lanes.find(l => l.id === context.id)?.name || '';
                    dom.modalColorPicker.classList.add('hidden'); // éš±è—é¡è‰²
                    break;
                case 'card':
                    dom.modalTitle.textContent = 'ç·¨è¼¯å¡ç‰‡å…§å®¹';
                    dom.textEditor.classList.remove('hidden');
                    dom.modalTitleInput.classList.remove('hidden'); // é¡¯ç¤ºå¡ç‰‡æ¨™é¡Œ
                    dom.modalColorPicker.classList.remove('hidden'); // é¡¯ç¤ºé¡è‰²
                    
                    const cards = state.mapData.grid[context.cellId] || [];
                    const card = cards.find(c => c.id === context.id);
                    dom.modalTitleInput.value = card?.title || '';
                    dom.modalContentInput.value = card?.content || '';
                    renderColorPicker(card?.color || CARD_COLORS[0]); // NEW
                    break;
                case 'newCard':
                    dom.modalTitle.textContent = 'æ–°å¢å¡ç‰‡';
                    dom.textEditor.classList.remove('hidden');
                    dom.modalTitleInput.classList.remove('hidden'); // é¡¯ç¤ºå¡ç‰‡æ¨™é¡Œ
                    dom.modalColorPicker.classList.remove('hidden'); // é¡¯ç¤ºé¡è‰²
                    
                    dom.modalTitleInput.value = '';
                    dom.modalContentInput.value = '';
                    renderColorPicker(CARD_COLORS[0]); // NEW
                    break;
                case 'newLane':
                    dom.modalTitle.textContent = 'æ–°å¢æ³³é“';
                    dom.laneTypeEditor.classList.remove('hidden');
                    dom.modalLaneName.value = '';
                    dom.modalLaneType.value = 'text';
                    break;
                // NEW: åˆªé™¤ç¢ºèª
                case 'confirmDelete':
                    dom.modalTitle.textContent = 'ç¢ºèªåˆªé™¤';
                    dom.confirmDeleteEditor.classList.remove('hidden');
                    let deleteName = '';
                    if (context.deleteType === 'stage') {
                        deleteName = state.mapData.stages.find(s => s.id === context.id)?.name || '';
                    } else if (context.deleteType === 'lane') {
                        deleteName = state.mapData.lanes.find(l => l.id === context.id)?.name || '';
                    }
                    dom.modalConfirmText.textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${deleteName}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`;
                    break;
            }
            
            dom.modal.classList.remove('hidden');
            dom.modalContentInput.focus();
            dom.modalLaneName.focus();
        }

        function closeModal() {
            dom.modal.classList.add('hidden');
            state.modal.isOpen = false;
            state.modal.type = null;
            state.modal.context = {};
        }
        
        function handleModalSave() {
            const { type, context } = state.modal;
            let needsSaveAndRender = true; // NEW: Flag to control re-render
            
            switch (type) {
                case 'stage':
                    const stage = state.mapData.stages.find(s => s.id === context.id);
                    if (stage) stage.name = dom.modalContentInput.value; // ä¾†è‡ª content input
                    break;
                case 'lane':
                    const lane = state.mapData.lanes.find(l => l.id === context.id);
                    if (lane) lane.name = dom.modalContentInput.value; // ä¾†è‡ª content input
                    break;
                case 'card':
                    const cards = state.mapData.grid[context.cellId] || [];
                    const card = cards.find(c => c.id === context.id);
                    if (card) {
                        card.title = dom.modalTitleInput.value; // NEW
                        card.content = dom.modalContentInput.value; // RENAMED
                        // NEW: å„²å­˜é¡è‰²
                        const selectedColor = dom.modalColorPicker.querySelector('[class*="border-blue-500"]')?.dataset.color;
                        card.color = selectedColor || CARD_COLORS[0];
                    }
                    break;
                case 'newCard':
                    if (!state.mapData.grid[context.cellId]) {
                        state.mapData.grid[context.cellId] = [];
                    }
                    // NEW: å„²å­˜é¡è‰²
                    const selectedColorNew = dom.modalColorPicker.querySelector('[class*="border-blue-500"]')?.dataset.color;
                    state.mapData.grid[context.cellId].push({
                        id: `c${Date.now()}`,
                        title: dom.modalTitleInput.value || '(ç„¡æ¨™é¡Œ)', // NEW
                        content: dom.modalContentInput.value, // RENAMED
                        color: selectedColorNew || CARD_COLORS[0] // NEW
                    });
                    break;
                case 'newLane':
                    const newLane = {
                        id: `l${Date.now()}`,
                        name: dom.modalLaneName.value || 'æ–°æ³³é“',
                        type: dom.modalLaneType.value
                    };
                    state.mapData.lanes.push(newLane);
                    // å¦‚æœæ˜¯æƒ…ç·’æ³³é“ï¼Œç‚ºæ‰€æœ‰éšæ®µè¨­å®šé è¨­å€¼
                    if (newLane.type === 'emotion') {
                        state.mapData.stages.forEach(stage => {
                            state.mapData.grid[`${newLane.id}_${stage.id}`] = 3;
                        });
                    }
                    break;
                // NEW: è™•ç†åˆªé™¤
                case 'confirmDelete':
                    if (context.deleteType === 'stage') {
                        deleteStage(context.id);
                    } else if (context.deleteType === 'lane') {
                        deleteLane(context.id);
                    }
                    needsSaveAndRender = false; // åˆªé™¤å‡½æ•¸æœƒè‡ªå·±è™•ç† save/render
                    break;
            }
            
            closeModal();
            // NEW: æ ¹æ“š Flag æ±ºå®šæ˜¯å¦ re-render
            if (needsSaveAndRender) {
                saveData();
                render();
            }
        }

        // --- äº‹ä»¶è™•ç†èˆ‡å‹•ä½œ ---

        /**
         * è™•ç†åœ°åœ–ä¸Šçš„æ‰€æœ‰é»æ“Šäº‹ä»¶ (äº‹ä»¶å§”æ´¾)
         */
        function handleGridClick(e) {
            const target = e.target.closest('[data-action], .editable-text');
            if (!target) return;

            // NEW: å¦‚æœé»æ“Šçš„æ˜¯ .editable-text (åƒ…é™ stage/lane), è¦å¾ parent æ‰¾ ID
            if (target.classList.contains('editable-text')) {
                const parent = target.closest('.stage-header, .lane-header');
                if (!parent) return; // å¦‚æœæ˜¯å¡ç‰‡ï¼Œå¿½ç•¥ (å¡ç‰‡ç·¨è¼¯å·²æ”¹)
                
                const type = target.dataset.type;
                const id = parent.dataset.id;
                openModal(type, { id });
                return;
            }

            const action = target.dataset.action;
            const id = target.dataset.id;
            
            // ç·¨è¼¯æ–‡å­— (èˆŠé‚è¼¯ï¼Œä¿ç•™çµ¦ stage/lane)
            if (target.classList.contains('editable-text')) {
                const type = target.dataset.type;
                openModal(type, { id });
                return;
            }
            
            // å‹•ä½œæŒ‰éˆ•
            switch (action) {
                case 'delete-stage':
                    // OLD: if (confirm(...))
                    openModal('confirmDelete', { deleteType: 'stage', id }); // NEW
                    break;
                case 'delete-lane':
                     // OLD: if (confirm(...))
                    openModal('confirmDelete', { deleteType: 'lane', id }); // NEW
                    break;
                case 'add-card':
                    openModal('newCard', { cellId: target.dataset.cellId });
                    break;
                case 'delete-card':
                    deleteCard(target.dataset.cellId, id);
                    break;
                // NEW: å¡ç‰‡æ‘ºç–Š
                case 'toggle-card':
                    const cardEl = target.closest('.card');
                    const content = cardEl.querySelector('.card-content');
                    content.classList.toggle('hidden');
                    break;
                // NEW: é»æ“Šå…§å®¹å€å¡Šç·¨è¼¯
                case 'edit-card':
                    const parentCard = target.closest('.card');
                    openModal('card', { 
                        id: parentCard.dataset.cardId, 
                        cellId: parentCard.dataset.cellId 
                    });
                    break;
            }
        }
        
        function addStage() {
            const newStage = {
                id: `s${Date.now()}`,
                name: 'æ–°éšæ®µ'
            };
            state.mapData.stages.push(newStage);
            
            // ç‚ºæ–°éšæ®µçš„æƒ…ç·’æ³³é“è¨­å®šé è¨­å€¼
            state.mapData.lanes.filter(l => l.type === 'emotion').forEach(lane => {
                state.mapData.grid[`${lane.id}_${newStage.id}`] = 3;
            });

            saveData();
            render();
        }

        function deleteStage(stageId) {
            state.mapData.stages = state.mapData.stages.filter(s => s.id !== stageId);
            // TODO: ä¹Ÿæ‡‰åˆªé™¤ grid ä¸­ç›¸é—œçš„è³‡æ–™
            // (ç‚ºæ±‚ç°¡å–®ï¼Œæš«ä¸åˆªé™¤ grid å­¤å³¶è³‡æ–™ï¼Œå®ƒå€‘ä¸æœƒè¢«æ¸²æŸ“)
            saveData();
            render();
        }
        
        function addLane() {
            openModal('newLane');
        }

        function deleteLane(laneId) {
            state.mapData.lanes = state.mapData.lanes.filter(l => l.id !== laneId);
            // TODO: ä¹Ÿæ‡‰åˆªé™¤ grid ä¸­ç›¸é—œçš„è³‡æ–™
            saveData();
            render();
        }

        function deleteCard(cellId, cardId) {
            if (state.mapData.grid[cellId]) {
                state.mapData.grid[cellId] = state.mapData.grid[cellId].filter(c => c.id !== cardId);
                saveData();
                render();
            }
        }
        
        // --- å¡ç‰‡æ‹–æ›³ (Drag & Drop) é‚è¼¯ ---
        
        function handleDragStart(e) {
            const card = e.target.closest('.card');
            const stageHeader = e.target.closest('.stage-header');
            const laneHeader = e.target.closest('.lane-header');

            if (card) {
                state.drag.isDragging = true;
                state.drag.type = 'card';
                state.drag.cardId = card.dataset.cardId;
                state.drag.sourceCellId = card.dataset.cellId;
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', card.dataset.cardId);
                
                // æ‹–æ›³æ™‚å¼·åˆ¶æ‘ºç–Š
                card.querySelector('.card-content').classList.add('hidden');
                
                setTimeout(() => card.classList.add('dragging'), 0);

            } else if (stageHeader) {
                state.drag.isDragging = true;
                state.drag.type = 'stage';
                state.drag.id = stageHeader.dataset.id;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => stageHeader.classList.add('dragging'), 0);

            } else if (laneHeader) {
                state.drag.isDragging = true;
                state.drag.type = 'lane';
                state.drag.id = laneHeader.dataset.id;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => laneHeader.classList.add('dragging'), 0);
            }
        }
        
        function handleDragEnd(e) {
            document.querySelectorAll('.card.dragging, .stage-header.dragging, .lane-header.dragging').forEach(el => {
                el.classList.remove('dragging');
            });

            state.drag = {
                isDragging: false,
                type: null,
                cardId: null,
                id: null,
                sourceCellId: null
            };
            
            // ç§»é™¤æ‰€æœ‰ 'drag-over' æ¨£å¼
            document.querySelectorAll('.grid-cell.drag-over, .stage-header.drag-over-before, .lane-header.drag-over-before').forEach(cell => {
                cell.classList.remove('drag-over', 'drag-over-before');
            });
        }
        
        function handleDragOver(e) {
            e.preventDefault(); // å¿…é ˆï¼Œæ‰èƒ½è§¸ç™¼ drop
            const { type, id } = state.drag;

            if (type === 'card') {
                const cell = e.target.closest('.grid-cell');
                if (cell && cell.dataset.cellId !== state.drag.sourceCellId) {
                    // é¿å…å°‡å¡ç‰‡æ‹–åˆ°æƒ…ç·’æ³³é“
                    const laneId = cell.dataset.cellId.split('_')[0];
                    const lane = state.mapData.lanes.find(l => l.id === laneId);
                    if (lane && lane.type === 'text') {
                        cell.classList.add('drag-over');
                        e.dataTransfer.dropEffect = 'move';
                    } else {
                        e.dataTransfer.dropEffect = 'none';
                    }
                }
            } else if (type === 'stage') {
                const targetHeader = e.target.closest('.stage-header');
                document.querySelectorAll('.stage-header.drag-over-before').forEach(h => h.classList.remove('drag-over-before'));
                if (targetHeader && targetHeader.dataset.id !== id) {
                    targetHeader.classList.add('drag-over-before');
                    e.dataTransfer.dropEffect = 'move';
                }
            } else if (type === 'lane') {
                const targetHeader = e.target.closest('.lane-header');
                document.querySelectorAll('.lane-header.drag-over-before').forEach(h => h.classList.remove('drag-over-before'));
                if (targetHeader && targetHeader.dataset.id !== id) {
                    targetHeader.classList.add('drag-over-before');
                    e.dataTransfer.dropEffect = 'move';
                }
            }
        }
        
        function handleDragLeave(e) {
            const cell = e.target.closest('.grid-cell');
            if (cell) {
                cell.classList.remove('drag-over');
            }
            const header = e.target.closest('.stage-header, .lane-header');
            if (header) {
                header.classList.remove('drag-over-before');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const { type, cardId, id, sourceCellId } = state.drag;
            
            if (type === 'card') {
                const cell = e.target.closest('.grid-cell');
                if (!cell || !state.drag.isDragging) return;
                
                const targetCellId = cell.dataset.cellId;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ‹–æ”¾
                if (!targetCellId || targetCellId === sourceCellId) return;

                // å¾ä¾†æº cell ç§»é™¤å¡ç‰‡
                const sourceCards = state.mapData.grid[sourceCellId] || [];
                const cardIndex = sourceCards.findIndex(c => c.id === cardId);
                
                if (cardIndex > -1) {
                    const [movedCard] = sourceCards.splice(cardIndex, 1);
                    
                    // åŠ å…¥åˆ°ç›®æ¨™ cell
                    if (!state.mapData.grid[targetCellId]) {
                        state.mapData.grid[targetCellId] = [];
                    }
                    state.mapData.grid[targetCellId].push(movedCard);
                    
                    saveData();
                    render(); // é‡æ–°æ¸²æŸ“
                }
            } else if (type === 'stage') {
                const targetHeader = e.target.closest('.stage-header');
                if (targetHeader && targetHeader.dataset.id !== id) {
                    moveItemInArray(state.mapData.stages, id, targetHeader.dataset.id);
                    saveData();
                    render();
                }
            } else if (type === 'lane') {
                const targetHeader = e.target.closest('.lane-header');
                if (targetHeader && targetHeader.dataset.id !== id) {
                    moveItemInArray(state.mapData.lanes, id, targetHeader.dataset.id);
                    saveData();
                    render();
                }
            }
        }

        /**
         * NEW: é™£åˆ—é …ç›®æ‹–æ›³æ’åº
         * @param {Array} array 
         * @param {string} sourceId 
         * @param {string} targetId 
         */
        function moveItemInArray(array, sourceId, targetId) {
            const sourceIndex = array.findIndex(item => item.id === sourceId);
            const targetIndex = array.findIndex(item => item.id === targetId);

            if (sourceIndex === -1 || targetIndex === -1) return;
            
            // å¾é™£åˆ—ä¸­å–å‡º source item
            const [movedItem] = array.splice(sourceIndex, 1);
            
            // è¨ˆç®—æ–°çš„ targetIndex (å› ç‚º splice æ”¹è®Šäº†é™£åˆ—)
            const newTargetIndex = array.findIndex(item => item.id === targetId);
            
            // æ’å…¥åˆ° target item ä¹‹å‰
            array.splice(newTargetIndex, 0, movedItem);
        }
        
        // --- æƒ…ç·’æ›²ç·šæ‹–æ›³é‚è¼¯ ---
        
        function handleEmotionDragStart(e) {
            const point = e.target.closest('.emotion-point');
            if (!point) return;
            
            e.preventDefault(); // é˜²æ­¢ç€è¦½å™¨é è¨­æ‹–æ›³
            
            const svg = e.target.closest('svg');
            
            state.emotionDrag = {
                isDragging: true,
                stageId: point.dataset.stageId,
                laneId: point.dataset.laneId,
                svgRect: svg.getBoundingClientRect() // å–å¾— SVG åº§æ¨™
            };
            
            // åœ¨ window ä¸Šè¨»å†Šäº‹ä»¶ï¼Œä»¥ä¾¿åœ¨ SVG å¤–æ”¾é–‹æ»‘é¼ 
            window.addEventListener('mousemove', handleEmotionDrag);
            window.addEventListener('mouseup', handleEmotionDragEnd);
        }
        
        function handleEmotionDrag(e) {
            if (!state.emotionDrag.isDragging) return;
            
            const { svgRect, laneId, stageId } = state.emotionDrag;
            
            // è¨ˆç®—æ»‘é¼  Y åº§æ¨™ç›¸å°æ–¼ SVG çš„ç™¾åˆ†æ¯”
            const relativeY = e.clientY - svgRect.top;
            const height = svgRect.height;
            let yPercent = relativeY / height;
            
            // å°‡ yPercent è½‰æ›ç‚º 1-5 åˆ† (y è¶Šå°ï¼Œåˆ†æ•¸è¶Šé«˜)
            // 10% (é«˜èˆˆ 5) -> 90% (æ²®å–ª 1)
            let score = 5.5 - (yPercent * 5); // ç²—ç•¥è½‰æ›
            
            // é™åˆ¶åˆ†æ•¸åœ¨ 1-5 ä¹‹é–“ï¼Œä¸¦å››æ¨äº”å…¥
            score = Math.round(Math.max(1, Math.min(5, score)));
            
            // æ›´æ–°ç‹€æ…‹
            const cellId = `${laneId}_${stageId}`;
            if (state.mapData.grid[cellId] !== score) {
                state.mapData.grid[cellId] = score;
                
                // --- FIX: å„ªåŒ–æ¸²æŸ“é‚è¼¯ ---
                // èˆŠçš„é‚è¼¯æœƒå°è‡´æ³³é“è·³åˆ°æœ«ç«¯ï¼Œæ­¤ç‚ºä¿®æ­£ç‰ˆ
                const lane = state.mapData.lanes.find(l => l.id === laneId);
                const oldLaneEl = dom.mapGrid.querySelector(`[data-lane-id="${laneId}"]`).closest('.emotion-lane-cell');
                
                if (oldLaneEl) {
                    const parent = oldLaneEl.parentNode;
                    const nextSibling = oldLaneEl.nextSibling; // è¨˜ä½ä¸‹ä¸€å€‹å…ƒç´ æ˜¯èª°
                    
                    oldLaneEl.remove(); // ç§»é™¤èˆŠçš„
                    
                    const newLaneEl = renderEmotionLane(lane); // å»ºç«‹æ–°çš„
                    
                    // æ’å…¥å›åŸæœ¬çš„ä½ç½®
                    parent.insertBefore(newLaneEl, nextSibling);
                }
                // --- END FIX ---
            }
        }
        
        function handleEmotionDragEnd(e) {
            if (!state.emotionDrag.isDragging) return;
            
            state.emotionDrag.isDragging = false;
            window.removeEventListener('mousemove', handleEmotionDrag);
            window.removeEventListener('mouseup', handleEmotionDragEnd);
            
            saveData(); // æ‹–æ›³çµæŸå¾Œæ‰å„²å­˜
        }
        
        // --- åŒ¯å‡º/åŒ¯å…¥ ---
        function exportData() {
            const dataStr = JSON.stringify(state.mapData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'customer_journey_map.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function importData() {
            dom.importFile.click();
        }
        
        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    // ç°¡å–®é©—è­‰
                    if (importedData.stages && importedData.lanes && importedData.grid) {
                        state.mapData = importedData;
                        saveData();
                        render();
                        alert('æˆåŠŸåŒ¯å…¥åœ°åœ–ï¼');
                    } else {
                        alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚');
                    }
                } catch (err) {
                    console.error('Error parsing imported JSON:', err);
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆéæœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©º inputï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸åŒä¸€å€‹æª”æ¡ˆ
            e.target.value = null;
        }

        // --- NEW: æˆªåœ– ---
        async function takeScreenshot() {
            const button = dom.screenshotBtn;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'æˆªåœ–ä¸­... (è«‹ç¨å€™)';

            // ç§»é™¤ sticky è®“æˆªåœ–å®Œæ•´
            document.querySelectorAll('.stage-header, .lane-header, .grid-corner').forEach(el => el.style.position = 'relative');
            
            // *** NEW FIX (V3) ***
            // æš«æ™‚ç§»é™¤ wrapper çš„ overflow é™åˆ¶ï¼Œä¸¦å¼·åˆ¶è¨­å®š wrapper å°ºå¯¸ç­‰æ–¼ grid å®Œæ•´å°ºå¯¸
            const wrapper = dom.mapWrapper;
            const grid = dom.mapGrid;
            
            // å„²å­˜åŸå§‹æ¨£å¼
            const originalOverflow = wrapper.style.overflow;
            const originalWrapperWidth = wrapper.style.width;
            const originalWrapperHeight = wrapper.style.height;
            
            // è®€å– grid çš„å®Œæ•´æ²å‹•å°ºå¯¸
            const gridWidth = grid.scrollWidth;
            const gridHeight = grid.scrollHeight;

            // *** NEW: éš±è— UI å…ƒç´  ***
            const elementsToHide = grid.querySelectorAll('[data-action="add-card"], .icon-button');
            elementsToHide.forEach(el => el.classList.add('screenshot-hidden'));
            // *** END NEW ***

            // å¥—ç”¨æˆªåœ–ç”¨æ¨£å¼
            wrapper.style.overflow = 'visible'; 
            wrapper.style.width = `${gridWidth}px`;
            wrapper.style.height = `${gridHeight}px`;
            // *** END NEW FIX (V3) ***

            try {
                // ç­‰å¾…ä¸€é»é»æ™‚é–“è®“ DOM æ›´æ–° (150ms)
                await new Promise(resolve => setTimeout(resolve, 150));

                const canvas = await html2canvas(dom.mapGrid, {
                    scale: 2, // 2 å€è§£æåº¦
                    useCORS: true, 
                    backgroundColor: '#ffffff',
                    // ç¢ºä¿ html2canvas ä½¿ç”¨æˆ‘å€‘æä¾›çš„å®Œæ•´å¯¬é«˜
                    width: gridWidth,
                    height: gridHeight
                });
                
                // å»ºç«‹é€£çµä¸¦ä¸‹è¼‰
                const link = document.createElement('a');
                link.download = 'customer-journey-map.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

            } catch (err) {
                console.error('Error taking screenshot:', err);
                alert('æˆªåœ–å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console ç²å–æ›´å¤šè³‡è¨Šã€‚');
            } finally {
                // æ¢å¾© sticky
                document.querySelectorAll('.stage-header').forEach(el => el.style.position = 'sticky');
                document.querySelectorAll('.lane-header').forEach(el => el.style.position = 'sticky');
                document.querySelectorAll('.grid-corner').forEach(el => el.style.position = 'sticky');
                
                // *** NEW: æ¢å¾© UI å…ƒç´  ***
                elementsToHide.forEach(el => el.classList.remove('screenshot-hidden'));
                // *** END NEW ***

                // *** NEW FIX (V3) ***
                // æ¢å¾© wrapper çš„åŸå§‹æ¨£å¼
                wrapper.style.overflow = originalOverflow;
                wrapper.style.width = originalWrapperWidth;
                wrapper.style.height = originalWrapperHeight;
                // *** END NEW FIX (V3) ***
                
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // --- AI åŠŸèƒ½ ---
        
        // å„²å­˜ä¸Šå‚³çš„æª”æ¡ˆå…§å®¹
        let uploadedCSVContent = null;
        let uploadedHTMLContent = null;
        let uploadedAttachments = [];
        
        function handleCSVFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                uploadedCSVContent = event.target.result;
                dom.csvFileStatus.textContent = `âœ“ å·²ä¸Šå‚³: ${file.name}`;
                dom.csvFileStatus.classList.add('text-green-600');
            };
            reader.readAsText(file);
        }
        
        function handleHTMLFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                uploadedHTMLContent = event.target.result;
                dom.htmlFileStatus.textContent = `âœ“ å·²ä¸Šå‚³: ${file.name}`;
                dom.htmlFileStatus.classList.add('text-green-600');
            };
            reader.readAsText(file);
        }
        
        function handleAttachmentFileUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            uploadedAttachments = [];
            dom.attachmentFileList.innerHTML = '<p class="text-slate-500">æ­£åœ¨è®€å–æª”æ¡ˆ...</p>';
            
            let loadedCount = 0;
            const fileListHTML = [];
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedAttachments.push({
                        name: file.name,
                        type: file.type,
                        content: event.target.result
                    });
                    
                    fileListHTML.push(`<div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-green-700">${file.name}</span>
                        <span class="text-slate-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>`);
                    
                    loadedCount++;
                    if (loadedCount === files.length) {
                        dom.attachmentFileList.innerHTML = fileListHTML.join('');
                        console.log(`ğŸ“ å·²ä¸Šå‚³ ${loadedCount} å€‹é™„ä»¶`);
                    }
                };
                reader.readAsText(file);
            });
        }
        
        async function generateJourneyWithAI() {
            // é©—è­‰è¼¸å…¥
            const apiKey = (localStorage.getItem('gemini_api_key') || '').trim();
            console.log('ğŸ”‘ API Key é•·åº¦:', apiKey.length);
            console.log('ğŸ”‘ API Key å‰ 10 å­—å…ƒ:', apiKey.substring(0, 10));
            
            if (!apiKey) {
                dom.aiError.classList.remove('hidden');
                dom.aiErrorMessage.textContent = 'è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Gemini API Key';
                return;
            }
            
            if (!uploadedCSVContent) {
                dom.aiError.classList.remove('hidden');
                dom.aiErrorMessage.textContent = 'è«‹å…ˆä¸Šå‚³é—œéµå­—è©é›² CSV æª”æ¡ˆ';
                return;
            }
            
            const journeyScope = dom.journeyScopeInput.value.trim();
            const stageCount = parseInt(dom.stageCountInput.value);
            const laneMode = dom.laneModeSelect.value;
            const customLanes = dom.customLanesInput.value.trim();
            const productName = dom.productNameInput.value.trim();
            const productDesc = dom.productDescInput.value.trim();
            
            if (!journeyScope || !productName || !productDesc) {
                dom.aiError.classList.remove('hidden');
                dom.aiErrorMessage.textContent = 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½';
                return;
            }
            
            if (laneMode === 'custom' && !customLanes) {
                dom.aiError.classList.remove('hidden');
                dom.aiErrorMessage.textContent = 'è«‹è¨­å®šè‡ªè¨‚æ³³é“åˆ—è¡¨';
                return;
            }
            
            // éš±è—éŒ¯èª¤ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
            dom.aiError.classList.add('hidden');
            dom.aiResult.classList.add('hidden');
            dom.aiLoading.classList.remove('hidden');
            dom.aiGenerateJourneyBtn.disabled = true;
            
            try {
                // è§£æ CSV å…§å®¹ç²å–é—œéµå­—
                const keywords = parseCSVKeywords(uploadedCSVContent);
                
                // æ§‹å»º Prompt
                const prompt = buildAIPrompt(keywords, uploadedHTMLContent, uploadedAttachments, journeyScope, stageCount, laneMode, customLanes, productName, productDesc);
                
                // å‘¼å« Gemini API
                console.log('ğŸ“¤ ç™¼é€è«‹æ±‚åˆ° Gemini API...');
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 16000,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_NONE"
                            }
                        ]
                    })
                });
                
                console.log('ğŸ“¥ æ”¶åˆ° API å›æ‡‰ï¼Œç‹€æ…‹:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    console.error('âŒ API éŒ¯èª¤è©³æƒ…:', errorData);
                    throw new Error(`API å›æ‡‰éŒ¯èª¤: ${response.status}${errorData ? ' - ' + JSON.stringify(errorData) : ''}`);
                }
                
                const data = await response.json();
                console.log('âœ… API å›æ‡‰æˆåŠŸ');
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('âŒ API å›æ‡‰æ ¼å¼ç•°å¸¸:', data);
                    throw new Error('API å›æ‡‰æ ¼å¼ç•°å¸¸ï¼Œè«‹æª¢æŸ¥ Console');
                }
                
                const generatedText = data.candidates[0].content.parts[0].text;
                console.log('ğŸ“ ç”Ÿæˆçš„æ–‡å­—é•·åº¦:', generatedText.length);
                console.log('ğŸ“ ç”Ÿæˆçš„æ–‡å­—å…§å®¹ï¼ˆå‰ 500 å­—ï¼‰:', generatedText.substring(0, 500));
                
                // å˜—è©¦å¤šç¨®æ–¹å¼è§£æ JSON
                let journeyData = null;
                
                // æ–¹æ³• 1: å°‹æ‰¾ JSON å€å¡Šï¼ˆåŒ…å« ```json æ¨™è¨˜ï¼‰
                const codeBlockMatch = generatedText.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    console.log('ğŸ” æ‰¾åˆ° JSON ç¨‹å¼ç¢¼å€å¡Š');
                    try {
                        journeyData = JSON.parse(codeBlockMatch[1]);
                        console.log('âœ… æˆåŠŸè§£æ JSONï¼ˆæ–¹æ³• 1ï¼‰');
                    } catch (e) {
                        console.warn('âš ï¸ æ–¹æ³• 1 å¤±æ•—:', e.message);
                    }
                }
                
                // æ–¹æ³• 2: å°‹æ‰¾æœ€å¤§çš„ JSON ç‰©ä»¶
                if (!journeyData) {
                    let jsonText = generatedText.match(/\{[\s\S]*\}/)?.[0];
                    if (jsonText) {
                        console.log('ğŸ” æ‰¾åˆ° JSON ç‰©ä»¶');
                        
                        // æ¸…ç† JSONï¼ˆç§»é™¤ ```json æ¨™è¨˜ï¼‰
                        jsonText = jsonText.replace(/```json\s*/g, '').replace(/```\s*$/g, '');
                        
                        try {
                            journeyData = JSON.parse(jsonText);
                            console.log('âœ… æˆåŠŸè§£æ JSONï¼ˆæ–¹æ³• 2ï¼‰');
                        } catch (e) {
                            console.warn('âš ï¸ æ–¹æ³• 2 å¤±æ•—:', e.message);
                            console.log('ğŸ“„ JSON å…§å®¹ï¼ˆå‰ 1000 å­—ï¼‰:', jsonText.substring(0, 1000));
                            
                            // æ–¹æ³• 3: å˜—è©¦ä¿®å¾©æˆªæ–·çš„ JSON
                            console.log('ğŸ”§ å˜—è©¦ä¿®å¾© JSON...');
                            try {
                                // æ‰¾åˆ°æœ€å¾Œä¸€å€‹å®Œæ•´çš„ grid é …ç›®
                                const lastCompleteMatch = jsonText.match(/(.*"l\d+_s\d+":\s*(?:\d+|\[[^\]]*\]))\s*,?\s*"l\d+_s\d+":\s*[^}]*$/);
                                if (lastCompleteMatch) {
                                    // ç§»é™¤ä¸å®Œæ•´çš„æœ€å¾Œä¸€é …ï¼Œé—œé–‰ JSON
                                    jsonText = lastCompleteMatch[1] + '\n  }\n}';
                                    journeyData = JSON.parse(jsonText);
                                    console.log('âœ… æˆåŠŸä¿®å¾©ä¸¦è§£æ JSONï¼ˆæ–¹æ³• 3ï¼‰');
                                }
                            } catch (e2) {
                                console.warn('âš ï¸ æ–¹æ³• 3 ä¹Ÿå¤±æ•—:', e2.message);
                            }
                        }
                    }
                }
                
                if (!journeyData) {
                    console.error('âŒ å®Œæ•´çš„ AI å›æ‡‰:', generatedText);
                    throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ JSONã€‚è«‹æŸ¥çœ‹ Console çš„å®Œæ•´å›æ‡‰ã€‚');
                }
                
                // åŒ¯å…¥åˆ°åœ°åœ–ä¸­
                importJourneyData(journeyData);
                
                // é¡¯ç¤ºæˆåŠŸ
                dom.aiLoading.classList.add('hidden');
                dom.aiResult.classList.remove('hidden');
                
                // 3 ç§’å¾Œé—œé–‰ Modal
                setTimeout(() => {
                    dom.aiModal.classList.add('hidden');
                    dom.aiResult.classList.add('hidden');
                }, 3000);
                
            } catch (err) {
                console.error('AI ç”Ÿæˆå¤±æ•—:', err);
                dom.aiLoading.classList.add('hidden');
                dom.aiError.classList.remove('hidden');
                dom.aiErrorMessage.textContent = `ç”Ÿæˆå¤±æ•—: ${err.message}`;
            } finally {
                dom.aiGenerateJourneyBtn.disabled = false;
            }
        }
        
        function parseCSVKeywords(csvContent) {
            console.log('ğŸ“Š é–‹å§‹è§£æ CSV...');
            const lines = csvContent.split('\n');
            const keywords = [];
            
            if (lines.length < 2) {
                console.error('âŒ CSV æª”æ¡ˆå¤ªçŸ­');
                return [];
            }
            
            // è§£æè¡¨é ­
            const header = lines[0].split(',').map(h => h.trim());
            console.log('ğŸ“‹ CSV è¡¨é ­:', header);
            
            // æ‰¾åˆ°æ¬„ä½ç´¢å¼•
            const themeIdx = header.findIndex(h => h.includes('ä¸»é¡Œ') || h.includes('æƒ…å¢ƒ'));
            const emotionIdx = header.findIndex(h => h.includes('æƒ…ç·’') || h.includes('æ…‹åº¦'));
            const eventIdx = header.findIndex(h => h.includes('äº‹ä»¶'));
            const keyword1Idx = header.findIndex(h => h.includes('é—œéµå­—1'));
            const keyword2Idx = header.findIndex(h => h.includes('é—œéµå­—2'));
            const weightIdx = header.findIndex(h => h.includes('æ¬Šé‡'));
            
            console.log('ğŸ“ æ¬„ä½ç´¢å¼•:', { themeIdx, emotionIdx, eventIdx, keyword1Idx, keyword2Idx, weightIdx });
            
            // è§£ææ¯ä¸€è¡Œ
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // è™•ç†å«å¼•è™Ÿçš„ CSVï¼ˆç°¡å–®ç‰ˆï¼‰
                const parts = [];
                let current = '';
                let inQuote = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        parts.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                parts.push(current.trim());
                
                if (parts.length >= 6) {
                    const theme = themeIdx >= 0 ? parts[themeIdx] : parts[0];
                    const emotion = emotionIdx >= 0 ? parts[emotionIdx] : parts[1];
                    const event = eventIdx >= 0 ? parts[eventIdx] : parts[2];
                    const keyword1 = keyword1Idx >= 0 ? parts[keyword1Idx] : parts[3];
                    const keyword2 = keyword2Idx >= 0 ? parts[keyword2Idx] : parts[4];
                    const weight = weightIdx >= 0 ? parts[weightIdx] : parts[5];
                    
                    if (keyword1) keywords.push({ keyword: keyword1, theme, emotion, event, weight });
                    if (keyword2) keywords.push({ keyword: keyword2, theme, emotion, event, weight });
                }
            }
            
            console.log(`âœ… è§£æå®Œæˆï¼Œå…± ${keywords.length} å€‹é—œéµå­—`);
            
            // ä¾æ¬Šé‡æ’åºï¼Œå–å‰ 50 å€‹
            keywords.sort((a, b) => {
                const weightA = parseFloat(String(a.weight).replace('%', '')) || 0;
                const weightB = parseFloat(String(b.weight).replace('%', '')) || 0;
                return weightB - weightA;
            });
            
            const top50 = keywords.slice(0, 50);
            console.log('ğŸ” å‰ 50 å€‹é—œéµå­—å·²é¸å–');
            
            return top50;
        }
        
        function buildAIPrompt(keywords, htmlContent, attachments, journeyScope, stageCount, laneMode, customLanes, productName, productDesc) {
            const keywordSummary = keywords.map(k => 
                `[${k.theme}] ${k.keyword} (æƒ…ç·’: ${k.emotion}, æ¬Šé‡: ${k.weight})`
            ).join('\n');
            
            // è§£ææ³³é“è¨­å®š
            let lanesPrompt = '';
            if (laneMode === 'custom' && customLanes) {
                const laneLines = customLanes.split('\n').filter(line => line.trim());
                lanesPrompt = `ã€æ³³é“è¨­å®šã€‘ï¼ˆè‡ªè¨‚æ¨¡å¼ï¼‰\nè«‹ä¾ç…§ä»¥ä¸‹æ³³é“ä¾†è¨­è¨ˆæ—…ç¨‹åœ°åœ–ï¼š\n`;
                laneLines.forEach((line, index) => {
                    lanesPrompt += `${index + 1}. ${line.trim()}\n`;
                });
                lanesPrompt += `\næ³¨æ„ï¼š\n- æ³³é“åç¨±ä¸­å¦‚æœæœ‰ã€Œæƒ…ç·’ã€ã€ã€ŒFeelingã€ç­‰å­—ï¼Œè©²æ³³é“é¡å‹ç‚º "emotion"ï¼Œå…§å®¹ç‚º 1-5 çš„åˆ†æ•¸\n- å…¶ä»–æ³³é“é¡å‹éƒ½æ˜¯ "text"ï¼Œå…§å®¹ç‚ºå¡ç‰‡é™£åˆ—\n`;
            } else {
                lanesPrompt = `ã€æ³³é“è¨­å®šã€‘ï¼ˆæ¨™æº–æ¨¡å¼ï¼‰\nä½¿ç”¨æ¨™æº–çš„ 5 å€‹æ³³é“ï¼š\n1. ğŸ¯ è¡Œå‹• (Doing) - type: text\n2. ğŸ¤” æƒ³æ³• (Thinking) - type: text\n3. ğŸ˜Š æƒ…ç·’ (Feeling) - type: emotionï¼ˆåˆ†æ•¸ 1-5ï¼‰\n4. ğŸ’” ç—›é» (Pain Point) - type: text\n5. ğŸ’¡ æ©Ÿæœƒ (Opportunity) - type: text\n`;
            }
            
            let prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä½¿ç”¨è€…é«”é©—è¨­è¨ˆå¸«ï¼Œæ“…é•·åˆ†æå®¢æˆ¶ç•«åƒä¸¦è¨­è¨ˆä½¿ç”¨è€…æ—…ç¨‹åœ°åœ–ã€‚

ã€ä»»å‹™ã€‘
è«‹æ ¹æ“šä»¥ä¸‹å®¢æˆ¶ç•«åƒè³‡æ–™ï¼Œç‚ºç”¢å“ã€Œ${productName}ã€è¨­è¨ˆä¸€å€‹å®Œæ•´çš„ä½¿ç”¨è€…æ—…ç¨‹åœ°åœ–ï¼ˆCustomer Journey Mapï¼‰ã€‚

ã€ç”¢å“è³‡è¨Šã€‘
ç”¢å“åç¨±: ${productName}
ç”¢å“æè¿°: ${productDesc}

ã€æ—…ç¨‹ç¯„åœã€‘
${journeyScope}

${lanesPrompt}

ã€å®¢æˆ¶ç•«åƒ - é—œéµå­—åˆ†æã€‘ï¼ˆæ¬Šé‡å‰ 50 åï¼‰
${keywordSummary}
`;

            if (htmlContent) {
                // æå– HTML ä¸­çš„æ–‡å­—å…§å®¹ï¼ˆç°¡å–®è™•ç†ï¼‰
                const textContent = htmlContent.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                prompt += `\nã€å®¢æˆ¶ç•«åƒå´å¯«ã€‘\n${textContent.substring(0, 2000)}\n`;
            }
            
            // åŠ å…¥é™„ä»¶å…§å®¹
            if (attachments && attachments.length > 0) {
                prompt += `\nã€è£œå……è³‡æ–™ã€‘\n`;
                attachments.forEach((att, index) => {
                    const content = att.content.replace(/\s+/g, ' ').trim();
                    prompt += `\nğŸ“ æª”æ¡ˆ ${index + 1}: ${att.name}\n${content.substring(0, 1500)}\n`;
                });
            }

            // æ§‹å»º lanes JSON ç¯„ä¾‹
            let lanesJsonExample = '';
            if (laneMode === 'custom' && customLanes) {
                const laneLines = customLanes.split('\n').filter(line => line.trim());
                lanesJsonExample = laneLines.map((line, index) => {
                    const isEmotion = /æƒ…ç·’|emotion|feeling/i.test(line);
                    const type = isEmotion ? 'emotion' : 'text';
                    return `    { "id": "l${index + 1}", "name": "${line.trim()}", "type": "${type}" }`;
                }).join(',\n');
            } else {
                lanesJsonExample = `    { "id": "l1", "name": "ğŸ¯ è¡Œå‹• (Doing)", "type": "text" },
    { "id": "l2", "name": "ğŸ¤” æƒ³æ³• (Thinking)", "type": "text" },
    { "id": "l3", "name": "ğŸ˜Š æƒ…ç·’ (Feeling)", "type": "emotion" },
    { "id": "l4", "name": "ğŸ’” ç—›é» (Pain Point)", "type": "text" },
    { "id": "l5", "name": "ğŸ’¡ æ©Ÿæœƒ (Opportunity)", "type": "text" }`;
            }

            prompt += `
ã€è¼¸å‡ºè¦æ±‚ã€‘
è«‹ä»¥ JSON æ ¼å¼è¼¸å‡ºï¼ŒåŒ…å«ä»¥ä¸‹çµæ§‹ï¼š
{
  "persona": {
    "name": "ä½¿ç”¨è€…åç¨±ï¼ˆæ ¹æ“šç•«åƒæ¨æ¸¬ï¼‰",
    "desc": "ä½¿ç”¨è€…ç°¡çŸ­æè¿°ï¼ˆ2-3 å¥è©±ï¼‰",
    "img": "https://placehold.co/80x80/e2e8f0/64748b?text=User"
  },
  "stages": [
    { "id": "s1", "name": "éšæ®µ 1 åç¨±" },
    { "id": "s2", "name": "éšæ®µ 2 åç¨±" },
    ...ï¼ˆå…± ${stageCount} å€‹éšæ®µï¼‰
  ],
  "lanes": [
${lanesJsonExample}
  ],
  "grid": {
    "l1_s1": [
      { "id": "c1", "title": "å¡ç‰‡æ¨™é¡Œ", "content": "å¡ç‰‡å…§å®¹", "color": "#FFFFFF" }
    ],
    "l3_s1": 3,ï¼ˆæƒ…ç·’æ³³é“ä½¿ç”¨ 1-5 çš„åˆ†æ•¸ï¼‰
    ...
  }
}

ã€é‡è¦æç¤ºã€‘
1. éšæ®µåç¨±è¦æ¸…æ¥šæè¿°ä½¿ç”¨è€…åœ¨è©²éšæ®µçš„ä¸»è¦ç›®æ¨™æˆ–æ´»å‹•
2. æ¯å€‹å„²å­˜æ ¼ï¼ˆtext é¡å‹ï¼‰å¯ä»¥æœ‰ 1-3 å¼µå¡ç‰‡
3. å¡ç‰‡å…§å®¹è¦å…·é«”ä¸”ç¬¦åˆå®¢æˆ¶ç•«åƒçš„ç‰¹å¾µ
4. æƒ…ç·’åˆ†æ•¸: 1=éå¸¸è² é¢, 3=ä¸­æ€§, 5=éå¸¸æ­£é¢
5. ç—›é»è¦é‡å°ä½¿ç”¨è€…çš„çœŸå¯¦å›°æ“¾
6. æ©Ÿæœƒè¦æå‡ºç”¢å“å¦‚ä½•è§£æ±ºé€™äº›ç—›é»
7. **æ¥µç‚ºé‡è¦ï¼šåªè¼¸å‡ºç´” JSON æ ¼å¼ï¼Œä¸è¦ä»»ä½•èªªæ˜æ–‡å­—ã€ä¸è¦ markdown æ¨™è¨˜ã€ä¸è¦å‰å¾Œç¶´**

è«‹ç›´æ¥è¼¸å‡º JSONï¼ˆä¸è¦åŒ…å«ç¨‹å¼ç¢¼å€å¡Šæ¨™è¨˜ï¼‰ï¼š
`;

            return prompt;
        }
        
        function importJourneyData(journeyData) {
            // æ›´æ–° Persona
            state.mapData.persona = journeyData.persona;
            dom.personaName.value = journeyData.persona.name;
            dom.personaDesc.value = journeyData.persona.desc;
            dom.personaImg.value = journeyData.persona.img;
            
            // æ›´æ–°éšæ®µå’Œæ³³é“
            state.mapData.stages = journeyData.stages;
            state.mapData.lanes = journeyData.lanes;
            state.mapData.grid = journeyData.grid;
            
            // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
            saveData();
            render();
        }

        // --- å­—é«”å¤§å°è¨­å®š ---
        
        /**
         * æ‡‰ç”¨å­—é«”å¤§å°è¨­å®šåˆ°æ—…ç¨‹åœ°åœ–
         */
        function applyFontSize(size) {
            const fontSize = parseInt(size);
            const journeyMap = dom.mapGrid;
            
            if (!journeyMap) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°åœ°åœ–å®¹å™¨');
                return;
            }
            
            // è¨­å®š CSS è®Šæ•¸ä¾›å…¨åŸŸä½¿ç”¨
            journeyMap.style.setProperty('--journey-font-size', fontSize + 'px');
            
            // æ›´æ–°å¡ç‰‡æ¨™é¡Œçš„å­—é«”å¤§å°
            const cardTitles = journeyMap.querySelectorAll('.card-title');
            cardTitles.forEach(title => {
                title.style.fontSize = fontSize + 'px';
            });
            
            // æ›´æ–°å¡ç‰‡å…§å®¹çš„å­—é«”å¤§å°
            const cardContents = journeyMap.querySelectorAll('.card-content');
            cardContents.forEach(content => {
                content.style.fontSize = (fontSize - 1) + 'px';
                content.style.lineHeight = '1.5';
            });
            
            // æ›´æ–°éšæ®µæ¨™é¡Œçš„å­—é«”å¤§å°ï¼ˆç¨å¤§ä¸€äº›ï¼‰
            const stageHeaders = journeyMap.querySelectorAll('.stage-header .editable-text');
            stageHeaders.forEach(header => {
                header.style.fontSize = (fontSize + 2) + 'px';
            });
            
            // æ›´æ–°æ³³é“æ¨™é¡Œçš„å­—é«”å¤§å°
            const laneHeaders = journeyMap.querySelectorAll('.lane-header .editable-text');
            laneHeaders.forEach(lane => {
                lane.style.fontSize = (fontSize + 1) + 'px';
            });
            
            // æ›´æ–°æ–°å¢å¡ç‰‡æŒ‰éˆ•çš„å­—é«”å¤§å°
            const addCardBtns = journeyMap.querySelectorAll('[data-action="add-card"]');
            addCardBtns.forEach(btn => {
                btn.style.fontSize = (fontSize - 1) + 'px';
            });
            
            console.log('âœ… å­—é«”å¤§å°å·²æ‡‰ç”¨:', fontSize + 'px');
        }
        
        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ---
        
        function initializeApp() {
            // 1. è¼‰å…¥è³‡æ–™
            loadData();
            
            // 2. åˆå§‹æ¸²æŸ“
            render();
            
            // 3. è¼‰å…¥ä¸¦æ‡‰ç”¨å­—é«”å¤§å°è¨­å®š
            const savedFontSize = localStorage.getItem('journey_font_size') || '14';
            if (dom.fontSizeInput) {
                dom.fontSizeInput.value = savedFontSize;
                dom.fontSizeDisplay.textContent = savedFontSize + 'px';
            }
            // å»¶é²æ‡‰ç”¨ä»¥ç¢ºä¿ DOM å·²å®Œå…¨æ¸²æŸ“
            setTimeout(() => applyFontSize(savedFontSize), 100);
            
            // 3. ç¶å®šå…¨åŸŸäº‹ä»¶ç›£è½
            
            // Persona ç·¨è¼¯ (è‡ªå‹•å„²å­˜)
            dom.personaName.addEventListener('change', (e) => {
                state.mapData.persona.name = e.target.value;
                saveData();
            });
            dom.personaDesc.addEventListener('change', (e) => {
                state.mapData.persona.desc = e.target.value;
                saveData();
            });
            dom.personaImg.addEventListener('change', (e) => {
                state.mapData.persona.img = e.target.value;
                saveData();
            });
            
            // ä¸»è¦æŒ‰éˆ•
            dom.addStageBtn.addEventListener('click', addStage);
            dom.addLaneBtn.addEventListener('click', addLane);
            
            // åœ°åœ–ä¸Šçš„é»æ“Š (äº‹ä»¶å§”æ´¾)
            dom.mapGrid.addEventListener('click', handleGridClick);

            // Modal æŒ‰éˆ•
            dom.modalSaveBtn.addEventListener('click', handleModalSave);
            dom.modalCloseBtn.addEventListener('click', closeModal);
            dom.modalBackdrop.addEventListener('click', closeModal);

            // å¡ç‰‡æ‹–æ›³ (äº‹ä»¶å§”æ´¾)
            dom.mapGrid.addEventListener('dragstart', handleDragStart);
            dom.mapGrid.addEventListener('dragend', handleDragEnd);
            dom.mapGrid.addEventListener('dragover', handleDragOver);
            dom.mapGrid.addEventListener('dragleave', handleDragLeave);
            dom.mapGrid.addEventListener('drop', handleDrop);
            
            // æƒ…ç·’æ›²ç·šæ‹–æ›³ (äº‹ä»¶å§”æ´¾)
            dom.mapGrid.addEventListener('mousedown', handleEmotionDragStart);
            
            // åŒ¯å‡º/åŒ¯å…¥
            dom.exportBtn.addEventListener('click', exportData);
            dom.importBtn.addEventListener('click', importData);
            dom.importFile.addEventListener('change', handleFileImport);
            
            // NEW: æˆªåœ–
            dom.screenshotBtn.addEventListener('click', takeScreenshot);

            // NEW: èªªæ˜æŒ‰éˆ•äº‹ä»¶
            dom.helpButton.addEventListener('click', () => {
                dom.helpModal.classList.remove('hidden');
            });
            dom.helpModalOverlay.addEventListener('click', () => {
                dom.helpModal.classList.add('hidden');
            });
            dom.helpModalCloseBtn.addEventListener('click', () => {
                dom.helpModal.classList.add('hidden');
            });
            
            // AI åŠŸèƒ½äº‹ä»¶
            dom.aiBtn.addEventListener('click', () => {
                dom.aiModal.classList.remove('hidden');
            });
            dom.aiModalOverlay.addEventListener('click', () => {
                dom.aiModal.classList.add('hidden');
            });
            dom.aiModalCloseBtn.addEventListener('click', () => {
                dom.aiModal.classList.add('hidden');
            });
            dom.aiCancelBtn.addEventListener('click', () => {
                dom.aiModal.classList.add('hidden');
            });
            dom.csvFileInput.addEventListener('change', handleCSVFileUpload);
            dom.htmlFileInput.addEventListener('change', handleHTMLFileUpload);
            dom.attachmentFileInput.addEventListener('change', handleAttachmentFileUpload);
            dom.aiGenerateJourneyBtn.addEventListener('click', generateJourneyWithAI);
            
            // æ³³é“æ¨¡å¼åˆ‡æ›
            dom.laneModeSelect.addEventListener('change', () => {
                if (dom.laneModeSelect.value === 'custom') {
                    dom.customLanesContainer.classList.remove('hidden');
                } else {
                    dom.customLanesContainer.classList.add('hidden');
                }
            });
            
            // è¨­å®šåŠŸèƒ½äº‹ä»¶
            dom.settingsBtn.addEventListener('click', () => {
                // è¼‰å…¥ç¾æœ‰çš„ API Key
                const apiKey = localStorage.getItem('gemini_api_key') || '';
                dom.apiKeyInput.value = apiKey;
                
                // è¼‰å…¥ç¾æœ‰çš„å­—é«”å¤§å°
                const fontSize = localStorage.getItem('journey_font_size') || '14';
                dom.fontSizeInput.value = fontSize;
                dom.fontSizeDisplay.textContent = fontSize + 'px';
                
                dom.settingsModal.classList.remove('hidden');
            });
            dom.settingsModalOverlay.addEventListener('click', () => {
                dom.settingsModal.classList.add('hidden');
            });
            dom.settingsModalCloseBtn.addEventListener('click', () => {
                dom.settingsModal.classList.add('hidden');
            });
            dom.apiKeyInput.addEventListener('change', () => {
                // è‡ªå‹•å„²å­˜ API Keyï¼ˆæ¸…é™¤å‰å¾Œç©ºæ ¼ï¼‰
                const apiKey = dom.apiKeyInput.value.trim();
                localStorage.setItem('gemini_api_key', apiKey);
                console.log('âœ… API Key å·²å„²å­˜ï¼Œé•·åº¦:', apiKey.length);
            });
            
            // å­—é«”å¤§å°èª¿æ•´
            dom.fontSizeInput.addEventListener('input', () => {
                const size = dom.fontSizeInput.value;
                dom.fontSizeDisplay.textContent = size + 'px';
                localStorage.setItem('journey_font_size', size);
                applyFontSize(size);
                console.log('âœ… å­—é«”å¤§å°å·²è¨­å®šç‚º:', size + 'px');
            });

            // NEW: é¡è‰²é¸æ“‡å™¨é»æ“Š
            dom.modalColorPicker.addEventListener('click', (e) => {
                const target = e.target.closest('[data-color]');
                if (!target) return;
                
                // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
                dom.modalColorPicker.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'ring-2', 'ring-blue-300');
                    btn.classList.add('border-slate-200', 'hover:border-slate-400');
                });
                
                // ç‚ºè¢«é»æ“Šçš„æŒ‰éˆ•æ·»åŠ é¸ä¸­ç‹€æ…‹
                target.classList.add('border-blue-500', 'ring-2', 'ring-blue-300');
            });

            // NEW: Shift + Scroll è™•ç†æ°´å¹³æ²å‹•
            dom.mapWrapper.addEventListener('wheel', (e) => {
                if (e.shiftKey) {
                    e.preventDefault();
                    dom.mapWrapper.scrollLeft += e.deltaY;
                }
            });
        }
        
        // å•Ÿå‹•ï¼
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
