<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“æ•¸æ“šåˆ†æå„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .chart-container { position: relative; width: 100%; transition: height 0.3s ease-in-out; }
        .filter-dropdown summary {
            cursor: pointer; padding: 0.5rem 1rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; background-color: white; transition: background-color 0.2s;
        }
        .filter-dropdown summary:hover { background-color: #f9fafb; }
        .filter-dropdown[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .filter-dropdown .filter-panel {
            max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db; border-top: none;
            padding: 0.75rem; background-color: white; z-index: 10; position: absolute;
            width: 100%; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem;
        }
        .filter-dropdown { position: relative; }
        /* éš±è— Chart.js é è¨­çš„æç¤ºæ¡† */
        .chartjs-tooltip {
            opacity: 0 !important;
        }
        /* è‡ªè¨‚çš„åœ–ç‰‡æç¤ºæ¡†æ¨£å¼ */
        #custom-tooltip {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            pointer-events: none;
            position: absolute;
            z-index: 1000;
            transition: all 0.1s ease;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            max-width: 300px;
        }
        #custom-tooltip p {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        #custom-tooltip img {
            width: 120px;
            height: auto;
            margin-top: 0.5rem;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800">ç”¢å“æ•¸æ“šåˆ†æå„€è¡¨æ¿</h1>
            <p class="text-gray-600 mt-2">Makita & Kyocera ç”¢å“åˆ†æ</p>
        </header>

        <div id="setupInstructions" class="max-w-4xl mx-auto mb-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-lg">
            <h2 class="text-xl font-bold text-blue-800 mb-4">ğŸ“‹ è¨­å®šæ­¥é©Ÿ (è‡ªå‹•è¼‰å…¥ä¸­...)</h2>
            <p class="mb-4">ç¨‹å¼ç¢¼å·²è¨­å®šç‚ºè‡ªå‹•ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ Apps Script URL è¼‰å…¥è³‡æ–™ã€‚</p>
            
            <div class="bg-white p-4 rounded border border-blue-300 mb-4">
                <h3 class="font-bold mb-2">Apps Script ç¨‹å¼ç¢¼</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li>Google Sheet: <a href="https://docs.google.com/spreadsheets/d/1FPtr7FMECRs3Pk_ONl60KKmrWFPWD6tlmN-HpD4Nx7U/edit" class="text-blue-600 underline" target="_blank">é»æ­¤é–‹å•Ÿ</a></li>
                    <li>è«‹ç¢ºèªä»¥ä¸‹ç¨‹å¼ç¢¼å·²æ­£ç¢ºéƒ¨ç½²ç‚ºã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€ä¸¦å…è¨±ã€Œä»»ä½•äººã€å­˜å–ï¼š</li>
                </ol>
                
                <div class="mt-3 bg-gray-900 text-green-400 p-3 rounded text-xs overflow-x-auto">
<pre>function doGet(e) {
  const ss = SpreadsheetApp.openById('1FPtr7FMECRs3Pk_ONl60KKmrWFPWD6tlmN-HpD4Nx7U');
  const gid = e.parameter.gid || '272605958';
  
  const sheets = ss.getSheets();
  let targetSheet = null;
  
  for (let sheet of sheets) {
    if (sheet.getSheetId().toString() === gid) {
      targetSheet = sheet;
      break;
    }
  }
  
  if (!targetSheet) {
    return ContentService.createTextOutput(JSON.stringify({error: 'Sheet not found'}))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  const data = targetSheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);
  
  const jsonData = rows.map(row => {
    const obj = {};
    headers.forEach((header, index) => {
      obj[header] = row[index];
    });
    return obj;
  });
  
  return ContentService.createTextOutput(JSON.stringify(jsonData))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
                </div>
            </div>

            <div class="bg-white p-4 rounded border border-blue-300">
                <h3 class="font-bold mb-2">å·²ä½¿ç”¨çš„ Apps Script URL</h3>
                <p class="text-sm break-all text-blue-700">https://script.google.com/macros/s/AKfycbyOIAyXbxXBatI8D4Z1Ir1L79fxAZIHmeXpAZ8VNWaShLiMz2I5_IXKw0tWIpj24lzA/exec</p>
            </div>
        </div>
        <div id="loading" class="hidden text-center p-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-lg" id="loadingMessage">æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
            <div id="debugInfo" class="mt-4 text-sm text-gray-600 max-w-4xl mx-auto text-left bg-white p-4 rounded shadow"></div>
        </div>

        <main id="dashboard" class="hidden">
            <div class="space-y-4 mb-6">
                <div class="p-4 bg-white rounded-lg shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="xAxisSelect" class="block text-sm font-medium text-gray-700">X è»¸ (æ•¸å€¼)</label>
                            <select id="xAxisSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="yAxisSelect" class="block text-sm font-medium text-gray-700">Y è»¸ (åˆ†é¡)</label>
                            <select id="yAxisSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">æ™ºæ…§ç¯©é¸ (å¯è¤‡é¸)</label>
                        <label class="flex items-center text-sm text-gray-600">
                            <input type="checkbox" id="autoCloseFilters" class="mr-2 h-4 w-4 rounded border-gray-300" checked>
                            é»é¸å¾Œè‡ªå‹•æ”¶åˆ
                        </label>
                    </div>
                    <div id="filtersContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                <div class="mb-4 flex items-center gap-4">
                    <label class="text-sm font-medium text-gray-700">ä¾é¡è‰²å€åˆ†:</label>
                    <select id="colorBySelect" class="py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="none">ä¸å€åˆ† (å–®ä¸€é¡è‰²)</option>
                    </select>
                    <div id="colorLegend" class="flex flex-wrap gap-2 ml-4"></div>
                </div>
                <div class="chart-container" style="height: 65vh;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-blue-700 mb-4">å°ˆæ¥­åˆ†æå»ºè­°</h2>
                <div id="analysisText" class="space-y-3 text-gray-700"></div>
            </div>
        </main>
    </div>

    <div id="custom-tooltip" class="hidden"></div>

    <script>
        // ç¡¬ç·¨ç¢¼ä½ çš„ Apps Script URL
        const HARDCODED_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOIAyXbxXBatI8D4Z1Ir1L79fxAZIHmeXpAZ8VNWaShLiMz2I5_IXKw0tWIpj24lzA/exec';

        const SHEETS_CONFIG = [
            { name: 'ç›®éŒ„_Makita', gid: '272605958' },
            { name: 'ç›®éŒ„_Kyocera', gid: '393225108' }
        ];

        const NUMERIC_VARS = {
            rating: { label: 'è©•åˆ†', prefix: '', suffix: '' },
            reviews: { label: 'è©•è«–æ•¸é‡', prefix: '', suffix: '' },
            price_usd: { label: 'ç¾é‡‘', prefix: '$', suffix: '' },
            price_jpy: { label: 'æ—¥å¹£', prefix: 'Â¥', suffix: '' }
        };

        const CATEGORICAL_VARS = { 
            brand: { label: 'å“ç‰Œ' },
            category: { label: 'é¡åˆ¥' }, 
            operation: { label: 'æ“ä½œ' }, 
            model: { label: 'æ©Ÿå‹' }, 
            material: { label: 'æ–™ä»¶' }, 
            voltage: { label: 'é›»å£“' },
            current: { label: 'é›»æµ' }
        };
        const CATEGORICAL_KEYS = Object.keys(CATEGORICAL_VARS);

        // é¡è‰²é…ç½®
        const COLOR_PALETTE = [
            '#1e40af', '#dc2626', '#16a34a', '#ea580c', '#9333ea', '#0891b2', '#ca8a04', '#db2777',
            '#65a30d', '#7c3aed', '#0d9488', '#c026d3',
        ];

        let colorByKey = 'none';
        let colorMap = {};
        let chart;
        let rawData = [];
        let controls = {};
        let isUpdatingFilters = false;

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            const setupInstructions = document.getElementById('setupInstructions');
            const loading = document.getElementById('loading');
            
            // ç«‹å³éš±è—è¨­å®šå€å¡Š
            if (setupInstructions) {
                setupInstructions.classList.add('hidden');
            }
            
            // ç«‹å³é¡¯ç¤ºè¼‰å…¥å€å¡Š
            if (loading) {
                loading.classList.remove('hidden');
            }
            
            // ç›´æ¥é–‹å§‹è¼‰å…¥è³‡æ–™
            initDashboard(HARDCODED_SCRIPT_URL);
        });

        // é»æ“Šç©ºç™½è™•æ”¶æŠ˜ç¯©é¸å™¨çš„äº‹ä»¶ç›£è½ (ä¿ç•™ä¸Šæ¬¡çš„ä¿®å¾©)
        document.addEventListener('click', (e) => {
            const openFilters = document.querySelectorAll('.filter-dropdown[open]');
            openFilters.forEach(filter => {
                // å¦‚æœé»æ“Šçš„ç›®æ¨™ä¸åœ¨ç¯©é¸å™¨å…§éƒ¨ï¼Œå°±æ”¶æŠ˜å®ƒ
                if (!filter.contains(e.target)) {
                    filter.open = false;
                }
            });
        });

        async function loadData(scriptUrl) {
            const debugInfo = document.getElementById('debugInfo');
            const loadingMessage = document.getElementById('loadingMessage');
            
            try {
                let allData = [];
                debugInfo.innerHTML = '<p class="font-bold text-blue-700">é–‹å§‹è¼‰å…¥è³‡æ–™...</p>';
                
                for (const sheet of SHEETS_CONFIG) {
                    loadingMessage.textContent = `æ­£åœ¨è¼‰å…¥ ${sheet.name}...`;
                    debugInfo.innerHTML += `<p class="mt-2">ğŸ“¥ è¼‰å…¥: <strong>${sheet.name}</strong></p>`;
                    
                    try {
                        const url = `${scriptUrl}?gid=${sheet.gid}`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            debugInfo.innerHTML += `<p class="text-red-600 ml-4">âŒ HTTP ${response.status}</p>`;
                            continue;
                        }
                        
                        const jsonData = await response.json();
                        debugInfo.innerHTML += `<p class="text-green-600 ml-4">âœ… æ‰¾åˆ° ${jsonData.length} ç­†è³‡æ–™</p>`;
                        
                        let validCount = 0;
                        jsonData.forEach(row => {
                            const priceUsdString = String(row['ç¾é‡‘'] || '0');
                            const priceJpyString = String(row['æ—¥å¹£'] || '0');
                            const cleanedPriceUsd = priceUsdString.replace(/[$,]/g, '');
                            const cleanedPriceJpy = priceJpyString.replace(/[Â¥,]/g, '');
                            const price_usd = parseFloat(cleanedPriceUsd) || 0;
                            const price_jpy = parseFloat(cleanedPriceJpy) || 0;

                            if ((price_usd > 0 || price_jpy > 0) && row['ç”¢å“æ¨™é¡Œ']) {
                                allData.push({
                                    name: row['ç”¢å“æ¨™é¡Œ'],
                                    brand: row['å“ç‰Œ'] || 'N/A',
                                    category: row['é¡åˆ¥'] || 'N/A',
                                    operation: row['æ“ä½œ'] || 'N/A',
                                    model: row['æ©Ÿå‹'] || 'N/A',
                                    material: row['æ–™ä»¶'] || 'N/A',
                                    voltage: row['é›»å£“'] || 'N/A',
                                    current: row['é›»æµ'] || 'N/A',
                                    rating: parseFloat(row['è©•åˆ†']) || 0,
                                    reviews: parseInt(String(row['è©•è«–æ•¸é‡'] || '0').replace(/,/g, '')) || 0,
                                    price_usd: price_usd,
                                    price_jpy: price_jpy,
                                    photo: row['ç”¢å“ç…§ç‰‡'] || null
                                });
                                validCount++;
                            }
                        });
                        
                        debugInfo.innerHTML += `<p class="text-blue-600 ml-4">âœ“ æœ‰æ•ˆç”¢å“: ${validCount} ç­†</p>`;
                        
                    } catch (error) {
                        debugInfo.innerHTML += `<p class="text-red-600 ml-4">âŒ éŒ¯èª¤: ${error.message}</p>`;
                    }
                }
                
                debugInfo.innerHTML += `<p class="mt-4 text-lg font-bold text-green-700">ğŸ‰ ç¸½å…± ${allData.length} ç­†ç”¢å“</p>`;
                
                if (allData.length === 0) {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™');
                }
                
                return allData;
                
            } catch (error) {
                // è¼‰å…¥å¤±æ•—æ™‚ï¼Œé‡æ–°é¡¯ç¤ºè¨­å®šæ­¥é©Ÿå€å¡Šä¾›ä½¿ç”¨è€…æª¢æŸ¥å•é¡Œ
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('setupInstructions').classList.remove('hidden');
                document.getElementById('setupInstructions').innerHTML = `
                    <div class="max-w-4xl mx-auto p-6 bg-red-50 border-2 border-red-200 rounded-lg">
                        <h3 class="text-xl font-bold text-red-800 mb-3">âŒ è¼‰å…¥å¤±æ•—</h3>
                        <p class="text-red-700">${error.message}</p>
                        <p class="mt-4 text-sm">è«‹æª¢æŸ¥ Apps Script æ˜¯å¦å·²æ­£ç¢ºéƒ¨ç½²ï¼Œä¸¦ä¸”æ¬Šé™è¨­å®šç‚ºã€Œä»»ä½•äººã€ã€‚</p>
                    </div>
                `;
                return [];
            }
        }

        async function initDashboard(scriptUrl) {
            rawData = await loadData(scriptUrl);
            
            if (rawData.length > 0) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                setupControls();
                createChart();
                updateChart();
            }
        }

        function setupControls() {
            controls.xAxisSelect = document.getElementById('xAxisSelect');
            controls.yAxisSelect = document.getElementById('yAxisSelect');
            controls.colorBySelect = document.getElementById('colorBySelect');

            Object.keys(NUMERIC_VARS).forEach(key => {
                controls.xAxisSelect.innerHTML += `<option value="${key}">${NUMERIC_VARS[key].label}</option>`;
            });
            CATEGORICAL_KEYS.forEach(key => {
                controls.yAxisSelect.innerHTML += `<option value="${key}">${CATEGORICAL_VARS[key].label}</option>`;
                controls.colorBySelect.innerHTML += `<option value="${key}">${CATEGORICAL_VARS[key].label}</option>`;
            });

            const filtersContainer = document.getElementById('filtersContainer');
            CATEGORICAL_KEYS.forEach(catKey => {
                const details = document.createElement('details');
                details.className = 'filter-dropdown';
                details.innerHTML = `
                    <summary class="text-sm font-medium">${CATEGORICAL_VARS[catKey].label}</summary>
                    <div class="filter-panel space-y-2" id="filter-${catKey}-panel"></div>
                `;
                filtersContainer.appendChild(details);
            });
            
            controls.xAxisSelect.addEventListener('change', updateChart);
            controls.yAxisSelect.addEventListener('change', updateChart);
            controls.colorBySelect.addEventListener('change', () => {
                colorByKey = controls.colorBySelect.value;
                updateChart();
            });
            
            updateFilterOptions(true);
        }

        function updateFilterOptions(isInitial = false) {
            if (isUpdatingFilters) return;
            
            const selections = {};
            CATEGORICAL_KEYS.forEach(key => {
                const panel = document.getElementById(`filter-${key}-panel`);
                if (panel) {
                    const checked = panel.querySelectorAll('input:checked');
                    selections[key] = Array.from(checked).map(cb => cb.value);
                }
            });

            CATEGORICAL_KEYS.forEach(targetKey => {
                const availableValues = [...new Set(rawData.map(d => d[targetKey]))].sort();
                const panel = document.getElementById(`filter-${targetKey}-panel`);
                if (!panel) return;
                
                const currentSelections = selections[targetKey] || [];
                
                panel.innerHTML = '';

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex gap-2 mb-2';
                buttonsDiv.innerHTML = `
                    <button class="select-all-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">å…¨é¸</button>
                    <button class="deselect-all-btn text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">æ¸…é™¤</button>
                `;
                panel.appendChild(buttonsDiv);

                availableValues.forEach(val => {
                    const checkboxId = `cb-${targetKey}-${val.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const isChecked = isInitial || currentSelections.includes(val);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${val}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 filter-checkbox" ${isChecked ? 'checked' : ''}>
                        <label for="${checkboxId}" class="ml-2 block text-sm text-gray-900">${val}</label>
                    `;
                    panel.appendChild(itemDiv);
                });

                panel.querySelector('.select-all-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    panel.querySelectorAll('input').forEach(cb => cb.checked = true);
                    updateChartOnly();
                });
                panel.querySelector('.deselect-all-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    panel.querySelectorAll('input').forEach(cb => cb.checked = false);
                    updateChartOnly();
                });
                panel.querySelectorAll('.filter-checkbox').forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateChartOnly();
                    });
                });
            });
        }

        function updateChartOnly() {
            if (!chart) return;
            
            isUpdatingFilters = true;
            
            const yCategoryKey = controls.yAxisSelect.value;
            const xCategoryKey = controls.xAxisSelect.value;
            const xConfig = NUMERIC_VARS[xCategoryKey];

            const activeFilters = {};
            CATEGORICAL_KEYS.forEach(catKey => {
                const panel = document.getElementById(`filter-${catKey}-panel`);
                if (panel) {
                    const checkedCbs = panel.querySelectorAll('input:checked');
                    activeFilters[catKey] = Array.from(checkedCbs).map(cb => cb.value);
                }
            });

            let filteredData = rawData.filter(d => {
                return CATEGORICAL_KEYS.every(key => {
                    return activeFilters[key].length === 0 || activeFilters[key].includes(d[key]);
                });
            });
            
            const yLabels = [...new Set(filteredData.map(d => d[yCategoryKey]))].sort();
            
            const chartContainer = document.querySelector('.chart-container');
            const baseHeight = 150; 
            const heightPerLabel = 35; 
            const newHeight = baseHeight + yLabels.length * heightPerLabel;
            const finalHeight = Math.min(Math.max(newHeight, 400), 5000); 
            chartContainer.style.height = `${finalHeight}px`;
            
            if (chart) chart.resize();

            if (colorByKey !== 'none') {
                const uniqueValues = [...new Set(filteredData.map(d => d[colorByKey]))].sort();
                colorMap = {};
                uniqueValues.forEach((val, idx) => {
                    colorMap[val] = COLOR_PALETTE[idx % COLOR_PALETTE.length];
                });
                
                const legendEl = document.getElementById('colorLegend');
                legendEl.innerHTML = uniqueValues.map(val => `
                    <div class="flex items-center gap-1 px-2 py-1 bg-gray-100 rounded">
                        <div style="width: 12px; height: 12px; background-color: ${colorMap[val]}; border-radius: 2px;"></div>
                        <span class="text-xs">${val}</span>
                    </div>
                `).join('');
                
                chart.data.datasets = uniqueValues.map(val => {
                    const dataForValue = filteredData.filter(d => d[colorByKey] === val).map(d => ({
                        x: d[xCategoryKey],
                        y: d[yCategoryKey],
                        ...d
                    }));
                    
                    return {
                        label: val,
                        data: dataForValue,
                        backgroundColor: colorMap[val] + 'AA',
                        borderColor: colorMap[val],
                        pointRadius: 5,
                        pointHoverRadius: 8,
                    };
                });
            } else {
                document.getElementById('colorLegend').innerHTML = '';
                const chartData = filteredData.map(d => ({
                    x: d[xCategoryKey],
                    y: d[yCategoryKey],
                    ...d
                }));
                
                chart.data.datasets = [{
                    label: 'ç”¢å“',
                    data: chartData,
                    backgroundColor: 'rgba(30, 64, 175, 0.6)',
                    borderColor: 'rgba(30, 64, 175, 1)',
                    pointRadius: 5,
                    pointHoverRadius: 8,
                }];
            }
            
            chart.options.scales.y.labels = yLabels;
            chart.options.scales.y.title.text = CATEGORICAL_VARS[yCategoryKey].label;
            chart.options.scales.x.title.text = xConfig.label;
            
            chart.update('none');
            updateAnalysisText(yCategoryKey, xCategoryKey);
            
            isUpdatingFilters = false;
        }

        function updateChart() {
            updateChartOnly();
        }
        
        function updateAnalysisText(yCategoryKey, xCategoryKey) {
            const analysisTextEl = document.getElementById('analysisText');
            const yCategoryName = CATEGORICAL_VARS[yCategoryKey].label;
            const xCategoryName = NUMERIC_VARS[xCategoryKey].label;
            analysisTextEl.innerHTML = `
                <p><strong><i class="fas fa-chart-line"></i> åœ–è¡¨è§£è®€ (Xè»¸: ${xCategoryName}, Yè»¸: ${yCategoryName})</strong></p>
                <p>é€™å¼µåœ–å°‡ç”¢å“ä¾ã€Œ${yCategoryName}ã€åˆ†é¡,ä¸¦å±•ç¤ºå…¶ã€Œ${xCategoryName}ã€çš„åˆ†ä½ˆã€‚</p>
                <ul class="list-disc list-inside space-y-2 mt-2">
                    <li><strong>è§€å¯Ÿé›†ä¸­è¶¨å‹¢ï¼š</strong>æ³¨æ„æ¯å€‹åˆ†é¡ä¸­é»æœ€å¯†é›†çš„å€åŸŸ</li>
                    <li><strong>æ¯”è¼ƒåˆ†ä½ˆç¯„åœï¼š</strong>ç·šæ¢è¶Šé•·ä»£è¡¨æ•¸å€¼ç¯„åœè¶Šå»£</li>
                    <li><strong>è­˜åˆ¥æ¥µç«¯å€¼ï¼š</strong>æœ€å³å´æ˜¯é«˜æ•¸å€¼ç”¢å“,æœ€å·¦å´æ˜¯ä½æ•¸å€¼ç”¢å“</li>
                    <li><strong>æ´»ç”¨ç¯©é¸å™¨ï¼š</strong>çµ„åˆä½¿ç”¨å¤šé‡ç¯©é¸å™¨è§€å¯Ÿç´°åˆ†å¸‚å ´</li>
                </ul>
            `;
        }
        
        // åœ–ç‰‡æç¤ºæ¡†é‚è¼¯
        function createChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const customTooltip = document.getElementById('custom-tooltip');
            
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'ç”¢å“',
                        data: [],
                        backgroundColor: 'rgba(30, 64, 175, 0.6)',
                        borderColor: 'rgba(30, 64, 175, 1)',
                        pointRadius: 5,
                        pointHoverRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Xè»¸', font: { size: 16 } }
                        },
                        y: {
                            type: 'category',
                            title: { display: true, text: 'Yè»¸', font: { size: 16 } },
                            offset: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            // ç¦ç”¨ Chart.js å…§å»ºçš„æç¤ºæ¡†ï¼Œæ”¹ç”¨æˆ‘å€‘è‡ªè¨‚çš„
                            enabled: false, 
                            external: function(context) {
                                // éš±è—è‡ªè¨‚æç¤ºæ¡†
                                const tooltipModel = context.tooltip;
                                if (tooltipModel.opacity === 0) {
                                    customTooltip.classList.add('hidden');
                                    return;
                                }

                                // é¡¯ç¤ºè‡ªè¨‚æç¤ºæ¡†ä¸¦æ›´æ–°ä½ç½®
                                customTooltip.classList.remove('hidden');
                                const position = context.chart.canvas.getBoundingClientRect();
                                const x = position.left + window.scrollX + tooltipModel.caretX;
                                const y = position.top + window.scrollY + tooltipModel.caretY;
                                customTooltip.style.left = `${x}px`;
                                customTooltip.style.top = `${y}px`;

                                // å–å¾—æ•¸æ“š
                                const dataPoint = context.tooltip.dataPoints[0].raw;
                                
                                // å»ºç«‹æç¤ºæ¡†å…§å®¹
                                let tooltipContent = `
                                    <p class="font-bold">${dataPoint.name}</p>
                                    <p>å“ç‰Œ: ${dataPoint.brand}</p>
                                    <p>é¡åˆ¥: ${dataPoint.category}</p>
                                    <p>æ—¥å¹£: Â¥${dataPoint.price_jpy.toLocaleString()}</p>
                                    <p>ç¾é‡‘: ${dataPoint.price_usd.toLocaleString()}</p>
                                    <p>è©•åˆ†: ${dataPoint.rating}</p>
                                    <p>è©•è«–æ•¸: ${dataPoint.reviews.toLocaleString()}</p>
                                `;

                                // å¦‚æœæœ‰åœ–ç‰‡ç¶²å€ï¼Œå°±åŠ ä¸Šåœ–ç‰‡
                                if (dataPoint.photo && dataPoint.photo.endsWith('.jpg')) {
                                    tooltipContent += `<img src="${dataPoint.photo}" alt="ç”¢å“åœ–ç‰‡">`;
                                }

                                customTooltip.innerHTML = tooltipContent;
                            }
                        },
                        legend: { 
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
